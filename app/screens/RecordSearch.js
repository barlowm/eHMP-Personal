define(["backbone","underscore","marionette","handlebars"],function(e,t,r,n){"use strict";function i(e){var t=[];if($("[data-uid='"+e+"']").find(".cpe-search-term-match").contents().each(function(){var e={key:$(this).text().toString().toLowerCase(),nextChar:""};if(e.key.length<4){var r=$(this).parent().parent().get(0),n=r.innerHTML,i=$(this).parent().clone();i.wrap("<div>");var a=i.parent().html(),o=n.indexOf(a)+a.length;r.id.substring("ResultSummary")?e.nextChar=n.substring(o,o+1):r.parentElement.id.substring("ResultHighlightssubgroupItem")&&(n=n.substring(3),n=n.substring(0,n.length-3),o=n.indexOf(a)+a.length,e.nextChar=n.substring(o,o+1)," "===e.nextChar&&10===n.charCodeAt(o+2)&&(e.nextChar=n.charAt(o+2)))}t.push(e)}),t.length<1){var r=ADK.SessionStorage.getAppletStorageModel("search","searchText");t.push({key:r.searchTerm.toString().toLowerCase(),nextChar:r.searchTerm.length<4?" ":""})}return t.sort(function(e,t){return e.key.length<t.key.length}),t.filter(function(e,r){for(var n=0;n<t.length;n++)return t[n].key+t[n].nextChar===e.key+e.nextChar&&n!==r?!1:!0;return!0})}function a(e,t){$(e).find("*").contents().each(function(){3==this.nodeType&&$(this).replaceWith(o($(this).text(),t))})}function o(e,t){for(var r=e.toString().toLowerCase(),n=e,i='<mark class="cpe-search-term-match">',a="</mark>",o=0;o<t.length;o++)for(var s=0,l=t[o],h=l.key.toString().toLowerCase()+l.nextChar.toLowerCase();r.indexOf(h,s)>-1;){s=r.indexOf(h,s);var d=s+h.length-l.nextChar.length,g=n.substring(s,d);n=n.substring(0,s)+i+g+a+n.substring(d),r=r.substring(0,s)+i+h.substring(0,h.length-l.nextChar.length)+a+r.substring(d),s=d+i.length+a.length+l.nextChar.length}return n}function s(e){e&&a(e,g)}function l(r){var n=r.uid.split(":")[2],s=c[n];if(g=i(r.uid),s){var l=ADK.Messaging.getChannel(s),u=l.request("detailView",r);if(!u)return;var m=new ADK.UI.Modal({view:ADK.Views.Loading.create(),options:{size:"large",title:"Loading..."}});m.show(),u.done(function(e){var t={size:"large",title:o(e.title,g)};e.headerView&&(t.headerView=e.headerView,a(e.headerView.$el,g)),e.footerView&&(t.footerView=e.footerView);var r=new ADK.UI.Modal({view:e.view,options:t});r.show(),a(e.view.$el,g)}),u.fail(function(r){var n=t.isString(r)?r:r&&t.isString(r.statusText)?r.statusText:"An error occurred",i=new ADK.UI.Modal({view:new d({model:new e.Model({error:n})}),options:{size:"large",title:"An Error Occurred"}});i.show()})}else{var p=new ADK.UI.Modal({view:new h,options:{size:"large",title:"Detail - Placeholder"}});p.show()}}var h=e.Marionette.ItemView.extend({template:n.compile("<div>A detail view for this domain is not yet implemented.</div>")}),d=e.Marionette.ItemView.extend({template:n.compile("<div>{{ error }}</div>")}),g=[],c={med:"medication_review_v2",allergy:"allergy_grid",immunization:"immunizations",problem:"problems",vital:"vitals",lab:"labresults_timeline_detailview",document:"documents",order:"orders",surgery:"documents",procedure:"documents",consult:"documents",image:"documents"},u={id:"record-search",contentRegionLayout:"gridOne",appletHeader:"navigation",appLeft:"patientInfo",applets:[{id:"search",title:"Search",region:"center"}],onStart:function(){ADK.SessionStorage.setAppletStorageModel("search","useTextSearchFilter",!0);var e=ADK.Messaging.getChannel("search");e.on("resultClicked",l),e.on("documentsLoaded",s)},onStop:function(){ADK.SessionStorage.setAppletStorageModel("search","useTextSearchFilter",!1);var e=ADK.Messaging.getChannel("search");e.off("resultClicked",l),e.off("documentsLoaded",s)},patientRequired:!0,globalDatepicker:!1};return u});