define(["underscore","backbone","app/applets/activeMeds/appUtil","moment","hbs!app/applets/activeMeds/templates/tooltip"],function(e,t,a,s,i){var o={initialized:!1,fetchMedsCollection:function(t,a){var i=ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass");"INPATIENT"===i.toUpperCase()?filterOptions='and(ne(vaStatus,"CANCELLED"),or(eq(vaType, "I"),eq(vaType, "IV"),eq(vaType,"V")))':"OUTPATIENT"===i.toUpperCase()&&(filterOptions='and(ne(vaStatus,"CANCELLED"),or(eq(vaType, "O"),eq(vaType, "N")))');var o=t;return o.criteria.filter=filterOptions,o.patient=ADK.PatientRecordService.getCurrentPatient(),o.collectionConfig={collectionParse:function(e){var t=function(e){var t=!1,a=e.get("calculatedStatus").toUpperCase();return("EXPIRES"===a||"START"===a||e.get("recent")===!0)&&(t=!0),t},a=ADK.ResourceService.filterCollection(e,t);return a}},this.allMedications=ADK.PatientRecordService.fetchCollection(o),this.allMedications.comparator=function(e,t){var a=s(e.get("lastAction"),"YYYYMMDDHHmmssSSS"),i=s(t.get("lastAction"),"YYYYMMDDHHmmssSSS");return i>a?1:a>i?-1:0},this.allMedications.on("sync",function(t){e.each(t.models,function(e){e.set("infobuttonContext","MLREV")})}),this.allMedications},initCollections:function(){this.initialized=!0},resetCollections:function(){},getActiveMedicationGroupbyData:function(e){var t,a;return e.get("qualifiedName")?(a="qualifiedName",t=e.get(a)):(a="name",t=e.get(a).split(",")[0].toUpperCase(),t=t.split(" ")[0].toUpperCase()),{groupbyValue:t,groupbyField:a}},getFirstFiveMeds:function(e){return firstFiveMeds=[],void 0!==e[0]&&firstFiveMeds.push(e[0]),void 0!==e[1]&&firstFiveMeds.push(e[1]),void 0!==e[2]&&firstFiveMeds.push(e[2]),void 0!==e[3]&&firstFiveMeds.push(e[3]),void 0!==e[4]&&firstFiveMeds.push(e[4]),firstFiveMeds},afterGroupingParse:function(t){var o=t;t.doseArrowClass="",t.popoverMeds=this.getFirstFiveMeds(t.meds);var n=t.meds.length-t.popoverMeds.length;if(n>0&&(t.numberOfMedsNotShownInPopover=n),void 0!==t.meds&&(o=t.meds[0].attributes,t.doseChange="NONE",t.meds.length>1)){var l=t.meds[1].attributes;void 0!==l.dosages&&void 0!==l.dosages[0]&&void 0!==o.dosages&&void 0!==o.dosages[0]&&(parseFloat(o.dosages[0].dose)>parseFloat(l.dosages[0].dose)?t.doseChange="UPARROW":parseFloat(o.dosages[0].dose)<parseFloat(l.dosages[0].dose)&&(t.doseChange="DOWNARROW"))}"PENDING"===o.calculatedStatus.toUpperCase()?t.doseChange="NEW":"EXPIRED"===o.calculatedStatus.toUpperCase()?t.doseChange="EXPIRED":("DISCONTINUED"===o.calculatedStatus.toUpperCase()||"CANCELLED"===o.calculatedStatus.toUpperCase())&&(t.doseChange="EXCLAMATION-CIRCLE");var r=s(o.lastAction,"YYYYMMDDHHmmssSSS"),d=s();"DISCONTINUED"===o.calculatedStatus.toUpperCase()&&(console.log(r.toDate()),console.log(d.toDate()));var p=s.duration(d.diff(r));parseFloat(p.asDays());void 0!==t.meds&&e.each(t.meds,function(e){e.set("overallStartFormat",ADK.utils.formatDate(e.get("lastAction")))});var c=!1;return("DISCONTINUED"===o.calculatedStatus.toUpperCase()||"CANCELLED"===o.calculatedStatus.toUpperCase()||"EXPIRED"===o.calculatedStatus.toUpperCase())&&(c=!0,t.totalFillsRemaining="0"),"I"===o.vaType.toUpperCase()||"V"===o.vaType.toUpperCase()?t.totalFillsRemaining="-1":"PENDING"===o.calculatedStatus.toUpperCase()?void 0!==o.orders[0].fillsAllowed?t.totalFillsRemaining=o.orders[0].fillsAllowed.toString():t.totalFillsRemaining="-1":c||(void 0!==o.expirationDate&&o.orders[0].daysSupply?t.effectiveFillsRemaining=a.getCalculatedEffectiveFillsRemaining(o.expirationDate,o.orders[0].daysSupply,o.orders[0].fillsRemaining,o.calculatedStatus):t.effectiveFillsRemaining=o.orders[0].fillsRemaining,t.totalFillsRemaining=t.effectiveFillsRemaining),t.tooltip=i(t),t.infobuttonContext="MLREV",t}};return e.extend(o,t.Events),o});