define(["backbone","underscore","app/applets/newsfeed/newsfeedUtils","app/applets/newsfeed/eventHandlers"],function(e,t,i,r){function a(e){var i=t.filter(e.fullCollection.models,function(e){return r.isValidDate(e.toJSON())},this),a=t.sortBy(i,function(e){return-1*e.get("activityDateTime").slice(0,8)},this);e.fullCollection.reset(a)}var o={queryCollection:function(e,t,r){var o={};void 0!==t&&(o.isOverrideGlobalDate=!0,o.fromDate=t.from,o.toDate=t.to);var n=(ADK.SessionStorage.getModel("globalDate"),{cache:!1,criteria:{filter:"or("+e.buildJdsDateFilter("dateTime",o)+","+e.buildJdsDateFilter("administeredDateTime",o)+","+e.buildJdsDateFilter("observed",o)+")",order:"activityDateTime DESC"},onSuccess:a,pageable:!0,resourceTitle:"patient-record-timeline",viewModel:{parse:function(e){e.primaryProviderDisplay=i.getPrimaryProviderDisplay(e),e.displayType=i.getDisplayType(e);var t=moment(e.activityDateTime,"YYYYMMDDHHmmss");return e.activityDateTimeByIso=t.format("YYYY-MM-DD HH:mm"),e.activityDateTimeByIsoWithSlashes=t.format("YYYY/MM/DD HH:mm"),e.isFuture=t.isAfter(moment()),"procedure"===e.kind.toLowerCase()&&(e.displayName=e.name||e.typeName||e.summary||"Unknown"),e}}});ADK.PatientRecordService.fetchCollection(n,r)}};return t.extend(o,e.Events),o});