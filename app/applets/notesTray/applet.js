define(["backbone","marionette","jquery","handlebars","app/applets/notesTray/tray/trayView","app/applets/notesTray/writeback/noteForm","app/applets/notesTray/preview/preview","app/applets/notesTray/tray/visitConfirmationView","app/applets/notesTray/writeback/templateHelpers","hbs!app/applets/notesTray/preview/previewHeaderTemplate","app/applets/notesTray/writeback/adkNoteForm","app/applets/visit/writeback/addselectVisit","app/applets/notesTray/operations/operationConfirmationView","app/applets/notesTray/writeback/errorView"],function(e,t,o,i,n,r,s,a,l,c,p,w,d,g){var v=!1,u=!0;i.registerHelper("formatRelativeTime",l.formatRelativeTime);var f=e.Marionette.ItemView.extend({template:c,events:{"click #preview-close-btn":"closePreview"},closePreview:function(e){e.preventDefault(),e.stopImmediatePropagation(),ADK.UI.Modal.hide(),v&&console.log("NOTES applet--->> close preview button clicked"),ADK.Messaging.getChannel("notesTray").trigger("close:preview",this.model)},changeFocus:function(){o("#patientDemographic-notes").focus()}}),h={id:"notesTray",viewTypes:[{type:"expanded",view:n,chromeEnabled:!0},{type:"writeback",view:r,chromeEnabled:!1},{type:"writeback-adk",view:p,chromeEnabled:!1},{type:"previewModal",view:s,chromeEnabled:!1}],defaultViewType:"expanded",getRootView:function(){return n}};return function(){v&&console.log("NOTES applet--->> initMessaging");var t=h.getRootView(),o=new t,i=ADK.Messaging.getChannel("notesTray"),n=(ADK.Messaging.getChannel("visit"),ADK.ResourceService.patientRecordService.getCurrentPatient()),r={actionItems:[{label:"Preview",onClick:function(){i.trigger("preview-note-action-btn")}}],closeButtonOptions:{title:"Save and Close",onClick:function(){i.trigger("close-note-action-btn")}}};i.on("notestray:selectvisit",function(){v&&console.log("NOTES applet--->> selectVisit");var t=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),o={size:"large",title:"New Note",showProgress:!1,keyboard:!0,headerOptions:r,steps:[{view:w,viewModel:t}]},i=new ADK.UI.Workflow(o);i.show()}),i.on("notestray:selectvisit",function(){v&&console.log("NOTES applet--->> selectVisit CONSOLIDATED FORM");var t=ADK.utils.appletUtils.getAppletView("notesTray","writeback-adk"),o=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),n=new e.Model({add:"true"}),r={size:"large",title:"Provider and Location for Current Activities",showProgress:!1,keyboard:!0,steps:[{view:w,viewModel:o},{viewModel:n,view:t,onBeforeShow:function(){s.changeHeaderTitle("New Note"),s.changeHeaderActionItems([{label:"Preview",onClick:function(){i.trigger("preview-note-action-btn")}}]),s.changeHeaderCloseButtonOptions({title:"Save and Close",onClick:function(){i.trigger("close-note-action-btn")}}),ADK.Messaging.getChannel("notesTray").trigger("visit:ready")}}]},s=new ADK.UI.Workflow(r);s.show()}),i.on("addNewNote-btn",function(t){if(u=t?!0:!1,v&&console.log("NOTES applet--->> new note button clicked"),n=ADK.ResourceService.patientRecordService.getCurrentPatient(),n.get("visit")){v&&console.log("visit: %o",n.get("visit"));var o=ADK.utils.appletUtils.getAppletView("notesTray","writeback-adk"),i=new e.Model({add:"true"}),s={title:"New Note",size:"large",showProgress:!1,keyboard:!0,headerOptions:r,steps:[{view:o,viewModel:i,stepTitle:"Step 1",showHeader:!1}]},l=new ADK.UI.Workflow(s);l.show()}else{var c=new a;c.showModal()}}),i.on("note:saved",function(e){v&&console.log("NOTES applet--->> note saved"),ADK.UI.Workflow.hide(),u&&(i.trigger("notestray:select",e),i.trigger("notestray:open"))}),i.on("show:preview",function(e){v&&console.log("NOTES applet--->> show preview"),ADK.UI.Workflow.hide();var t=ADK.utils.appletUtils.getAppletView("notesTray","previewModal"),o=new t({model:e}),i=f.extend({model:e});o.render();var n={footerView:"none",replaceContents:!0,headerView:i,callShow:!0},r=new ADK.UI.Modal({view:o,options:n});r.show()}),i.on("close:preview",function(e){v&&console.log("NOTES applet--->> close preview");var t=e.get("previewSource");v&&console.log("previewSource: %s",t),ADK.UI.Modal.hide();var n,s;if("form"===t){n=ADK.utils.appletUtils.getAppletView("notesTray","writeback-adk");var a="Add Note";e.get("deriv_isEditForm")===!0&&(a="Edit Note"),s={title:a,size:"large",showProgress:!1,keyboard:!0,headerOptions:r,steps:[{view:n,viewModel:e,stepTitle:"Step 1"}]};var l=new ADK.UI.Workflow(s);l.show()}else i.trigger("notestray:select",e.get("uid")),i.trigger("notestray:show",o),i.trigger("notestray:open")}),i.on("editNote-btn",function(e){v&&console.log("NOTES applet--->> edit note button clicked");var t=ADK.utils.appletUtils.getAppletView("notesTray","writeback-adk"),o={size:"large",title:"Edit Note",showProgress:!1,keyboard:!0,headerOptions:r,steps:[{view:t,viewModel:e,stepTitle:"Step 1"}]},i=new ADK.UI.Workflow(o);i.show()}),i.on("notes:init",function(){v&&console.log("NOTES applet--->> init notes"),n=ADK.ResourceService.patientRecordService.getCurrentPatient();var e=h.getRootView();o=new e,i.trigger("notestray:show",o)}),i.on("notes:view",function(){v&&console.log("NOTES applet--->> get view"),i.trigger("notestray:show",o)}),i.on("notes:sign",function(t){v&&console.log("NOTES applet--->> sign note");var o=e.Model.extend({}),i=new o({}),n=[];t.set("uid","urn:va:document:9E7A:3:114551"),t.set("stampTime",t.get("referenceDateTime")),t.set("summary",t.get("localTitle")),n.push(t.toJSON()),i.set("items",n),ADK.SignApi.sign(i,function(e){console.log("NOTES applet--->> signed note model"),console.log(e)})}),i.on("note:promptDelete",function(e,t){t=t||{};var o={message:"<h3>Are you sure you want to delete this note?</h3>",title:"Confirm Delete",title_icon:"fa-exclamation-triangle",yes_callback:function(){i.trigger("note:delete",e,t)},no_callback:function(){_.isFunction(t.completeCallback)&&t.completeCallback()}},n=new d(o);n.showModal()}),i.on("note:delete",function(e,t){t=t||{};var o=e.get("localId")?e.get("localId").replace("\n",""):"";"UNSIGNED"===e.get("status")&&"ehmp"===e.get("app")&&o.length>0?(e.url="/resource/write-health-data/patient/"+e.get("pid")+"/notes/"+o,e.destroy({error:function(e,o){v&&console.log("Error delete note.");_.isUndefined(t.errorMessage)&&(t.errorMessage="There was an error deleting your note. Please contact your System Administrator for assistance.");var i={message:t.errorMessage},n=new g(i);n.showModal(),_.isFunction(t.completeCallback)&&t.completeCallback()},success:function(e,o){if(v&&console.log("Successfully deleted note."),i.trigger("notes:deselected",e),i.trigger("notes:refresh-tray-btn"),_.isFunction(t.completeCallback)&&t.completeCallback(),_.isFunction(t.successCallback)&&t.successCallback(),i.trigger("notestray:opening"),!t.silentOnSuccess){var n=new ADK.UI.Notification({title:"Success!",message:"Deleted Successfully.",type:"success"});n.show()}}})):_.isFunction(t.completeCallback)&&t.completeCallback()})}(),h});