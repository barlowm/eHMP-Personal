define(["backbone","marionette","underscore"],function(e,t,r){"use strict";var n,i=!1,o=80,s={NOTE_GROUP_RECENT_TITLES:"Recent Note Titles",retrieveTitleModel:function(){var t=$.Deferred();if(n)setTimeout(function(){t.resolve(n)},0);else{var r=new e.Collection,i=ADK.UserService.getUserSession().get("site");r.url="/resource/write-pick-list?type=progress-notes-titles&class=3&site="+i,r.fetch({success:function(e,r){n=e,t.resolve(e)},error:function(e,r){t.reject(r)}})}return t.promise()},retrieveRecentTitles:function(){var e=$.Deferred(),t={resourceTitle:"notes-titles-getUserRecentTitles",criteria:{},onSuccess:function(t){e.resolve(t)},onError:function(t,r){i&&console.log("error: "+r.responseText),e.reject(r)}};return ADK.ResourceService.fetchCollection(t),e.promise()},fetchTitles:function(e,t,r,n){var i=this,o=null,s=null,a=this.retrieveRecentTitles(),l=this.retrieveTitleModel(),u=!1,c=!1;a.done(function(r){o=r,t(e,i.getOptions(o,s))}),a.fail(function(e){n("Unable to retrieve list of recent note titles.")}),a.always(function(){u=!0,c&&r&&r()}),l.done(function(r){s=r,t(e,i.getOptions(o,s))}),l.fail(function(e){n("Unable to retrieve full list of note titles.")}),l.always(function(){c=!0,u&&r&&r()})},getOptions:function(e,t){var n=[];if(n.push({group:"",pickList:[{value:"",label:""}]}),e){var i=[];r.each(e.models,function(e){var t={value:e.get("documentDefUid")+"_"+e.get("localTitle")+"_last",label:e.get("localTitle")};i.push(t)}),i.length>0&&n.push({group:this.NOTE_GROUP_RECENT_TITLES,pickList:i})}if(t){var o=[];r.each(t.models,function(e){var t={value:"urn:va:doc-def:"+ADK.UserService.getUserSession().get("site")+":"+e.get("ien")+"_"+e.get("name")+"_all",label:e.get("name")};o.push(t)}),o.length>0&&n.push({group:"All Note Titles",pickList:o})}return n},validateTime:function(e){var t=e.get("derivReferenceDate"),r=e.get("derivReferenceTime");if(null===r||void 0===r||""===r)return!0;if(r=r.split(":"),moment(t).startOf("day").isSame(moment().startOf("day"))){var n=moment().hours(),i=moment().minutes(),o=1*r[0],s=1*r[1];if(o>n||o===n&&s>i)return e.errorModel.set({derivReferenceTime:"Time must not be in the future"}),!1}return!0},validateRequiredTime:function(e){var t=e.get("derivReferenceDate"),r=e.get("derivReferenceTime");if(null===r||void 0===r||""===r||!this.isTime(r))return e.errorModel.set({derivReferenceTime:"Please enter a valid time."}),!1;if(r=r.split(":"),moment(t).startOf("day").isSame(moment().startOf("day"))){var n=moment().hours(),i=moment().minutes(),o=1*r[0],s=1*r[1];if(o>n||o===n&&s>i)return e.errorModel.set({derivReferenceTime:"Time must not be in the future"}),!1}return!0},validateRequiredDate:function(e){var t=e.get("derivReferenceDate");return t&&this.isDate(t)?t&&moment(t).startOf("day").isAfter(moment().startOf("day"))?(e.errorModel.set({derivReferenceDate:"Reference Date must not be in the future"}),!1):!0:(e.errorModel.set({derivReferenceDate:"Please enter a valid date"}),!1)},isDate:function(e){var t=moment(e,"MM/DD/YYYY",!0).isValid();return t},isTime:function(e){var t=moment(e,"HH:mm",!0).isValid();return t},validateDate:function(e){var t=e.get("derivReferenceDate");return t&&this.isDate(t)&&moment(t).startOf("day").isAfter(moment().startOf("day"))?(e.errorModel.set({derivReferenceDate:"Reference Date must not be in the future"}),!1):!0},validateTitle:function(e){return r.isEmpty(e.get("documentDefUid"))?(e.errorModel.set({documentDefUidUnique:"Select a title here"}),!1):!0},validateText:function(e){return e.get("text")&&e.get("text")[0].content?!0:(e.errorModel.set({text:"Please enter note details."}),!1)},formatTextContent:function(e){if(e.get("text"))for(var t=e.get("text"),r=0;r<t.length;r++){for(var n=t[r].content,i=n.split("\n"),s=[],a=0;a<i.length;a++){for(var l=i[a].trim();l.length>o;){var u=l.match(new RegExp(".{0,"+o+"}\\s+")),c=u?u[0].trim():l.substring(0,o);s.push(c.trim()),l=l.substring(c.length).trim()}s.push(l)}n=s.join("\n"),t[r].content=n}return e}};return s});