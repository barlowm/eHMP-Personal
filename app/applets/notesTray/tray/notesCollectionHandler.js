define(["backbone","marionette","underscore","api/SessionStorage","api/ResourceService","main/Utils","moment"],function(e,t,i,n,r,o,s){"use strict";function c(e){return e.get("referenceDateTime")?1*s(e.get("referenceDateTime"),["YYYYMMDDHHmmss"]).format("YYYYMMDDHHmmss"):10*s(e.get("entered"),["YYYYMMDDHHmmss"]).format("YYYYMMDDHHmmss")}function a(){var e=f.toJSON(),t=l.length;i.each(e,function(e,i,n){e.count=t,t+=1,e.displayGroup="signed",e.id=e.uid,e.app="vista",e.documentDefUidUnique=e.documentDefUid+"_"+e.localTitle+"_all";var r=l.find(function(t){return t.get("noteUid")===e.uid});r||l.add(e)}),l.sort(),v=t}var d=e.Collection.extend(),u=function(e,t){var i=c(e),n=c(t);return i===n?0:n>i?1:-1},l=new d;l.comparator=u;var g=new d;g.comparator=u;var f,D=new d,S=!1,m=!1,U=-1,v=-1,p=-1,Y=e.Model.extend({}),M=(e.Collection.extend({model:Y}),e.Model.extend({})),N=e.Collection.extend({model:M}),h=function(){var e=ADK.UserService.getUserSession().get("site"),t=ADK.UserService.getUserSession().get("duz")&&ADK.UserService.getUserSession().get("duz")[e];return'eq("status","UNSIGNED"),eq("documentClass","PROGRESS NOTES"),like("authorUid","%'+t+'"),like("uid","%'+e+'%")'},T={resourceTitle:"patient-record-document-view",criteria:{},onError:function(e,t){console.log("error: "+t.responseText),m=!0},onSuccess:function(e,t){f=e,m=!0}},C={resourceTitle:"patient-record-document-view",criteria:{},onError:function(e,t){console.log("error: "+t.responseText),p=0},onSuccess:function(e,t){var n=ADK.UserService.getUserSession().get("site"),r=ADK.UserService.getUserSession().get("duz")[n],o=0;i.each(e.models,function(e){var t=i.find(e.get("clinicians"),{role:"EC"});i.isUndefined(t)||i.last(t.uid.split(/\:/))!==r||(e.set("count",o),e.set("displayGroup","uncosigned"),e.set("app","vista"),e.set("documentDefUidUnique",e.get("documentDefUid")+"_"+e.get("localTitle")+"_all"),o++,g.add(e))}),p=g.size()}},E={resourceTitle:"patient-record-document-view",criteria:{order:"signedDateTime DESC"},onError:function(e,t){console.log("error: "+t.responseText),U=0},onSuccess:function(e,t){var n=0,r=e.toJSON();i.each(r,function(e,t,i){e.count=n,e.displayGroup="signed",n+=1,e.id=e.uid,e.app="vista",e.documentDefUidUnique=e.documentDefUid+"_"+e.localTitle+"_all"}),D.reset(r),U=n}},R={getModel:function(){var e=new M({id:"unsigned",name:"Unsigned",notes:l}),t=new M({id:"uncosigned",name:"Un-Cosigned",notes:g}),i=new M({id:"signed",name:"Recently Signed",notes:D}),n=new N([e,t,i]);return n},initNotes:function(e){S=!1,m=!1,U=-1,v=-1,p=-1,l.reset(),g.reset(),D.reset();var t;t=setInterval(function(){if(m&&S)if(-1==v)a();else if(-1!=U&&-1!=p){clearInterval(t);var e=v+U+p;ADK.Messaging.getChannel("notesTray").trigger("notes:retrieved",e)}},200),this.initEcrudUnsignedNotes(e),this.initVistaUnsignedNotes(e),this.initUncosignedNotes(e),this.initSignedNotes(e)},getUnsignedNotes:function(){return l},getUncosignedNotes:function(){return g},getSignedNotes:function(){return D},initEcrudUnsignedNotes:function(e){var t=r.patientRecordService.getCurrentPatient();l.url="/resource/write-health-data/patient/"+t.get("pid")+"/notes?pid="+t.get("icn"),l.fetch({error:function(e,t){console.log("error: "+t.responseText),l.reset(),S=!0},success:function(e,t){var n=t.data.notes,r=0;i.each(n,function(e,t,i){e.count=r,r+=1,e.displayGroup="unsigned",e.id=e.uid=e.localId.toString(),e.app="ehmp",e.documentDefUidUnique=e.documentDefUid+"_"+e.localTitle+"_all"}),l.reset(n),S=!0}})},initVistaUnsignedNotes:function(e){var t=r.patientRecordService.getCurrentPatient(),i={pid:t.get("pid")};T.criteria.param=JSON.stringify(i),T.criteria.filter=h(),ADK.PatientRecordService.fetchCollection(T)},initUncosignedNotes:function(e){var t=ADK.UserService.getUserSession().get("site"),i=ADK.UserService.getUserSession().get("duz")[t],n='in("status",["UNSIGNED","UNCOSIGNED"]),eq("documentClass","PROGRESS NOTES"),like("clinicians[].uid","%'+i+'"),like("uid","%'+t+'%")';C.criteria.filter=n,ADK.PatientRecordService.fetchCollection(C)},initSignedNotes:function(e){var t=r.patientRecordService.getCurrentPatient(),i={pid:t.get("pid")},n=this.getDateFilter(),o=ADK.UserService.getUserSession().get("site"),s='in("status",["COMPLETED","UNCOSIGNED"]),eq("documentClass","PROGRESS NOTES"),like("uid","%'+o+'%"),'+n;E.criteria.filter=s,E.criteria.param=JSON.stringify(i),ADK.PatientRecordService.fetchCollection(E)},getDateFilter:function(){var e=s().format("MM/DD/YYYY"),t=s().subtract("days",30).format("MM/DD/YYYY"),i="signedDateTime";return t='"'+o.formatDate(t,"YYYYMMDD","MM/DD/YYYY")+'"',e='"'+o.formatDate(e,"YYYYMMDD","MM/DD/YYYY")+'235959"',"between("+i+","+t+","+e+")"},getModelByUid:function(e,t){var n=this.getModel().find({id:t});if(!i.isUndefined(n))for(var r=n.get("notes").models,o=0;o<r.length;o++)if(r[o].get("uid")===e.toString())return r[o];return null}};return R});