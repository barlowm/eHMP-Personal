define(["backbone","marionette","underscore","hbs!app/applets/notesTray/tray/trayTemplate","app/applets/notesTray/tray/noteTypesAccordionView","app/applets/notesTray/tray/visitConfirmationView"],function(e,t,s,n,i,o){"use strict";var d=ADK.Messaging.getChannel("notesTray"),a={unsign_ehmp:[1,1,1,1],unsign_vista:[0,0,0,1],sign:[0,0,0,1],uncosigned_ehmp:[0,1,1,1],uncosigned_vista:[0,0,0,1],btn:["delete","edit","sign","preview"]},r=e.Marionette.LayoutView.extend({id:"notes-tray-outer",template:n,className:"notes-sidebar-wrapper",regions:{accordionRegion:"#notes-list-container"},events:{"mousedown .btn":"resetFocus","click #add-note-btn":"addNote","mouseup #tray-delete-note-btn":"deleteNote","mouseup #tray-edit-note-btn":"editNote","mouseup #tray-sign-note-btn":"signNote","mouseup #tray-preview-note-btn":"showPreview"},initialize:function(){this.selectedNotes=[],this.savedNoteUid=null;var e=this;d.on("notes:selected",function(t){e.selectedNotes=[],e.selectedNotes.push(t),e.setButtonVisibility()}),d.on("notes:retrieved",function(t){0===t&&e.showNoNotesMessage()}),d.on("notes:refresh-tray-btn",function(){e.setButtonVisibility(),e.selectedNotes.length>0&&(s.isUndefined(e.selectedNotes[0].id)||e.$("div[data-uid='"+e.selectedNotes[0].id+"']").addClass("list-item-selected"))}),d.on("notes:deselected",function(t){e.selectedNotes.length>0&&e.selectedNotes[0].get("uid")===t.get("uid")&&(e.selectedNotes=[],e.btnHideAll())})},resetFocus:function(e){e.preventDefault(),$("#notes-tray").focus()},addNote:function(e){e.preventDefault(),(13===e.which||32===e.which||1===e.which)&&d.trigger("addNewNote-btn",!0)},setButtonVisibility:function(){var e;if(1===this.selectedNotes.length){var t=(this.selectedNotes[0].get("status"),this.selectedNotes[0].get("displayGroup"));switch(t){case"unsigned":e="unsign_"+this.selectedNotes[0].get("app");break;case"uncosigned":e="uncosigned_"+this.selectedNotes[0].get("app");break;case"signed":e="sign"}for(var s=0;s<a.btn.length;s++)1===a[e][s]&&(this.$("#tray-"+a.btn[s]+"-note-btn").removeClass("hide"),"sign"===a.btn[s]&&(this.isSignReady(this.selectedNotes[0])?this.$("#tray-"+a.btn[s]+"-note-btn").removeClass("disabled"):this.$("#tray-"+a.btn[s]+"-note-btn").addClass("disabled")))}else this.btnHideAll()},btnHideAll:function(){for(var e=0;e<a.btn.length;e++)this.$("#tray-"+a.btn[e]+"-note-btn").addClass("hide")},deleteNote:function(e){d.trigger("note:promptDelete",this.selectedNotes[0])},editNote:function(e){if(this.selectedNotes.length>0){var t=this.selectedNotes[0].clone();d.trigger("editNote-btn",t)}},signNote:function(e){if(this.selectedNotes.length>0){var t=this.selectedNotes[0].clone();d.trigger("notes:sign",t)}},showPreview:function(){if(this.selectedNotes.length>0){var e=this.selectedNotes[0].clone();e.attributes.previewSource="tray",d.trigger("show:preview",e)}},onRender:function(){var e=new i;this.accordionRegion.show(e)},onShow:function(){this.hideNoNotesMessage()},showNoNotesMessage:function(){0===this.$(".no-notes-indicator").length&&this.$("#signed-notes-header").after($('<div class="no-notes-indicator">No Notes</div>')),this.$(".no-notes-indicator").removeClass("hide")},hideNoNotesMessage:function(){this.$(".no-notes-indicator").addClass("hide")},isSignReady:function(e){if(!s.isUndefined(e)){var t=!1,n=!1;if(!s.isUndefined(e.get("referenceDateTime"))){var i=e.get("derivReferenceTime");"Invalid date"!==i&&null!==i&&""!==i&&(n=!0)}if(!s.isUndefined(e.get("text"))){var o="",d=e.get("text");s.each(d,function(e){s.isUndefined(e.content)||(o+=e.content)}),o.length>0&&(t=!0)}if(n&&t)return!0}return!1}});return r});