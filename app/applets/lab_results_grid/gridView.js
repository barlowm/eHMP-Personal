define(["backbone","marionette","underscore","app/applets/lab_results_grid/appletHelpers","app/applets/lab_results_grid/appletUiHelpers","app/applets/lab_results_grid/details/detailsView","app/applets/lab_results_grid/modal/modalView","app/applets/lab_results_grid/meta/columns","hbs!app/applets/lab_results_grid/templates/tooltip","app/applets/orders/writeback/addOrders","app/applets/visit/writeback/addselectVisit"],function(e,t,a,r,i,l,s,o,n,p,d){var c={resourceTitle:"patient-record-labsbypanel",pageable:!0,cache:!1,viewModel:{parse:function(e){var t=[],a=[];e.codes&&e.codes.forEach(function(e){-1!=e.system.indexOf("loinc")&&(t.push(" "+e.code),a.push(" "+e.display))}),e.loinc=t,e.stdTestNames=a;var i=e.low,l=e.high;if(i&&l&&(e.referenceRange=i+"-"+l),e.interpretationCode){var s=e.interpretationCode.split(":").pop(),o="",n="label-danger";"HH"===s&&(s="H*",o="Critical High"),"LL"===s&&(s="L*",o="Critical Low"),"H"===s&&(o="Abnormal High",n="label-warning"),"L"===s&&(o="Abnormal Low",n="label-warning"),e.interpretationCode=s,e.flagTooltip=o,e.labelClass=n}if(e.categoryCode){var p=e.categoryCode.slice(e.categoryCode.lastIndexOf(":")+1);switch(p){case"EM":case"MI":case"SP":case"CY":case"AP":e.result="View Report",e.typeName||(e.typeName=e.categoryName),e.pathology=!0}}return e.observed&&(e.observedFormatted=r.getObservedFormatted(e.observed)),e}}},u=e.Model.extend({parse:c.viewModel.parse}),g=(e.Model.extend({defaults:{type:"panel"}}),ADK.AppletViews.GridView.extend({initialize:function(t){this._super=ADK.AppletViews.GridView.prototype,this.summaryColumns=[o.dateCol(),o.testCol(),o.flagCol(),o.resultAndUnitCol()],this.fullScreenColumns=[o.dateCol(),o.testCol(),o.flagCol(),o.resultNoUnitCol(),o.unitCol(),o.refCol(),o.facilityCol()];var r={filterFields:["observedFormatted","typeName","flag","result","specimen","groupName","isPanel","units","referenceRange","facilityMoniker","labs.models",this.getLoincValues],formattedFilterFields:{observed:function(e,t){var a=e.get(t);return a=a.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/,"$2/$3/$1 $4:$5")}},DetailsView:l,filterDateRangeField:{name:"observed",label:"Date",format:"YYYYMMDD"},events:{"click tr.selectable":function(e){var t=$(e.target).closest("tr"),a=t.data("model");"Panel"===e.target.innerHTML&&this.options.onClickRow(a,e,this),this.options.AppletView.prototype.onClickRow.apply(this,[e])}},onClickAdd:function(t){t.preventDefault();var a=(ADK.utils.appletUtils.getAppletView("orders","writeback"),new e.Model),r=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),i={size:"large",title:"Order a Lab Test",showProgress:!1,keyboard:!0,steps:[]},l=ADK.PatientRecordService.getCurrentPatient().get("visit");l||i.steps.push({view:d,viewModel:r}),i.steps.push({view:p,viewModel:a});var s=new ADK.UI.Workflow(i);s.show()},onClickRow:function(e,a,l){if(a.preventDefault(),"expanded"===t.appletConfig.viewType?e.set("isFullscreen",!0):e.set("isFullscreen",!1),e.get("isPanel")){if($(a.currentTarget).data("isOpen")){var s=$(a.currentTarget).data("isOpen");s=!s,$(a.currentTarget).data("isOpen",s)}else $(a.currentTarget).data("isOpen",!0);var o=$(a.currentTarget).find(".js-has-panel i");o.length&&(o.hasClass("fa-chevron-up")?(o.removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(a.currentTarget).data("isOpen",!0)):(o.removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(a.currentTarget).data("isOpen",!1))),l.expandRow(e,a)}else i.getDetailView(e,a.currentTarget,r.collection,!0,i.showModal,i.showErrorModal)},tblRowSelector:"#data-grid-lab_results_grid tbody tr"};"expanded"===this.columnsViewType?r.columns=this.fullScreenColumns:"summary"===this.columnsViewType?r.columns=this.summaryColumns:(r.summaryColumns=this.summaryColumns,r.fullScreenColumns=this.fullScreenColumns);var s=this;c.onSuccess=function(t){var i=t.fullCollection||t;i.each(function(t){t.set("infobuttonContext","LABRREV");var r=a.values(t.attributes);if("object"==typeof r[0][0]){var i=r[0],l=i[0],s=a.keys(t.attributes)[0],o=s,n=(o.replace(/\s/g,""),""),p="",d="";a.each(i,function(e,t){e=new u(u.prototype.parse(e)),"H*"==e.attributes.interpretationCode?(n="H*",p="Critical High",d="label-danger"):"L*"==e.attributes.interpretationCode?("H"==n||"L"==n||""===n)&&(n="L*",p="Critical Low",d="label-danger"):"H"==e.attributes.interpretationCode?("L"==n||""===n)&&(n="H",p="Abnormal High",d="label-warning"):"L"==e.attributes.interpretationCode&&""===n&&(n="L",p="Abnormal Low",d="label-warning"),i[t]=e});var c=s.replace(/\s/g,"")+"_"+l.groupUid.replace(/\s/g,"");c=c.replace("#",""),t.set({labs:new e.Collection(i),observed:l.observed,isPanel:"Panel",typeName:o,panelGroupName:s,facilityCode:l.facilityCode,facilityMoniker:l.facilityMoniker,interpretationCode:n,flagTooltip:p,labelClass:d,uid:c,type:"panel"})}});var l=a.sortBy(i.models,function(e){return e.attributes.observed}).reverse();i.reset(l),"expanded"===r.appletConfig.viewType&&r.collection.setPageSize(i.length)};var n='eq(categoryCode , "urn:va:lab-category:CH")';c.criteria={filter:this.buildJdsDateFilter("observed")+","+n},this.listenTo(ADK.Messaging,"globalDate:selected",function(e){s.dateRangeRefresh("observed",{customFilter:n})}),this.gridCollection=ADK.PatientRecordService.fetchCollection(c),r.collection=this.gridCollection,this.appletOptions=r,this._super.initialize.apply(this,arguments);var g=ADK.Messaging.getChannel("lab_results");g.reply("gridCollection",function(){return s.gridCollection})},getLoincValues:function(e){if(void 0===e.codes)return"";var t=a.filter(e.codes,function(e){return"http://loinc.org"===e.system});return a.pluck(t,"code").join(" ")},onBeforeDestroy:function(){var e=ADK.Messaging.getChannel("lab_results");e.stopReplying("gridCollection"),c.onSuccess=null}}));return g});