define(["backbone","marionette","underscore","app/applets/lab_results_grid/appletHelpers","app/applets/lab_results_grid/appletUiHelpers","app/applets/lab_results_grid/gridView","app/applets/lab_results_grid/details/detailsView","app/applets/lab_results_grid/modal/modalView","hbs!app/applets/lab_results_grid/list/dateTemplate","hbs!app/applets/lab_results_grid/list/labTestCoverSheetTemplate","hbs!app/applets/lab_results_grid/list/labTestSinglePageTemplate","hbs!app/applets/lab_results_grid/list/resultTemplate","hbs!app/applets/lab_results_grid/list/siteTemplate","hbs!app/applets/lab_results_grid/list/flagTemplate","hbs!app/applets/lab_results_grid/list/referenceRangeTemplate","hbs!app/applets/lab_results_grid/templates/tooltip","app/applets/lab_results_grid/modal/stackedGraph","app/applets/orders/writeback/addOrders","app/applets/visit/writeback/addselectVisit"],function(e,t,i,a,s,l,r,o,d,n,p,u,c,m,g,b,h,f,v){var y,w={resourceTitle:"patient-record-lab",pageable:!0,cache:!1,viewModel:{parse:function(e){var t=[],i=[];e.codes&&e.codes.forEach(function(e){-1!=e.system.indexOf("loinc")&&(t.push(" "+e.code),i.push(" "+e.display))}),e.loinc=t,e.stdTestNames=i;var a=e.low,s=e.high;if(a&&s&&(e.referenceRange=a+"-"+s),e.interpretationCode){var l=e.interpretationCode.split(":").pop(),r="",o="label-danger";"HH"===l&&(l="H*",r="Critical High"),"LL"===l&&(l="L*",r="Critical Low"),"H"===l&&(r="Abnormal High",o="label-warning"),"L"===l&&(r="Abnormal Low",o="label-warning"),e.interpretationCode=l,e.flagTooltip=r,e.labelClass=o}if(e.categoryCode){var d=e.categoryCode.slice(e.categoryCode.lastIndexOf(":")+1);switch(d){case"EM":case"MI":case"SP":case"CY":case"AP":e.result="View Report",e.typeName||(e.typeName=e.categoryName),e.pathology=!0}}return e}}},C={gistModel:[{id:"shortName",field:"shortName"},{id:"displayName",field:"normalizedName"},{id:"result",field:"result"},{id:"previousInterpretationCode",field:"previousInterpretationCode"},{id:"previousResult",field:"previousResult"},{id:"units",field:"units"},{id:"timeSince",field:"timeSince"},{id:"observationType",field:"observationType"},{id:"tooltip",field:"tooltip"}],filterFields:["observedFormatted","shortName","typeName","normalizedName","timeSince","result","units"],gistHeaders:{header1:{title:"Lab Test",sortable:!0,sortType:"alphabetical",key:"shortName",hoverTip:"labresults_description"},header2:{title:"Result",sortable:!0,sortType:"numeric",key:"result",hoverTip:"labresults_results"},header3:{title:"",sortable:!1},header4:{title:"Last",sortable:!0,sortType:"date",key:"observed",hoverTip:"labresults_last"}},defaultView:"observation",enableHeader:"true",graphOptions:{height:"19",width:"90",id:"",hasCriticalInterpretation:!0}},T=e.Model.extend({parse:w.viewModel.parse}),_=ADK.Applets.BaseGridApplet.extend({initialize:function(t){this._super=ADK.Applets.BaseGridApplet.prototype;var a={filterFields:C.filterFields,formattedFilterFields:{observed:function(e,t){var i=e.get(t);return i=i.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/,"$2/$3/$1 $4:$5")}},gistView:!0,appletConfiguration:C,DetailsView:r,onClickRow:function(e,t,i){if(t.preventDefault(),e.get("isPanel")){if($(t.currentTarget).data("isOpen")){var l=$(t.currentTarget).data("isOpen");l=!l,$(t.currentTarget).data("isOpen",l)}else $(t.currentTarget).data("isOpen",!0);var r=$(t.currentTarget).find(".js-has-panel i");r.length&&(r.hasClass("fa-chevron-up")?(r.removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(t.currentTarget).data("isOpen",!0)):(r.removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(t.currentTarget).data("isOpen",!1))),i.expandRow(e,t)}else s.getDetailView(e,t.currentTarget,a.collection,!0,s.showModal,s.showErrorModal)},onClickAdd:function(t){t.preventDefault();var i=(ADK.utils.appletUtils.getAppletView("orders","writeback"),new e.Model),a=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),s={size:"large",title:"Order a Lab Test",showProgress:!1,keyboard:!0,steps:[]},l=ADK.PatientRecordService.getCurrentPatient().get("visit");l||s.steps.push({view:v,viewModel:a}),s.steps.push({view:f,viewModel:i});var r=new ADK.UI.Workflow(s);r.show()},filterDateRangeEnabled:!0,filterDateRangeField:{name:"observed",label:"Date",format:"YYYYMMDD"}},l=this;this.listenTo(ADK.Messaging,"globalDate:selected",function(e){var i=ADK.SessionStorage.getModel("globalDate").get("selectedId");"all-range-global"!==i?l.dataGridOptions.collection.fetchOptions.criteria.filter=l.buildJdsDateFilter("observed",t):delete l.dataGridOptions.collection.fetchOptions.criteria.filter,l.loading(),l.createDataGridView(),ADK.ResourceService.fetchCollection(l.dataGridOptions.collection.fetchOptions,l.dataGridOptions.collection)}),w.onSuccess=function(s){var r=s.fullCollection||s;r.each(function(t){var a=i.values(t.attributes);if("object"==typeof a[0][0]&&!a[0][0].code){var s=a[0],l=s[0],r=i.keys(t.attributes)[0],o=r,d=(o.replace(/\s/g,""),""),n="",p="";i.each(s,function(e,t){e=new T(T.prototype.parse(e)),"H*"==e.attributes.interpretationCode?(d="H*",n="Critical High",p="label-danger"):"L*"==e.attributes.interpretationCode?("H"==d||"L"==d||""===d)&&(d="L*",n="Critical Low",p="label-danger"):"H"==e.attributes.interpretationCode?("L"==d||""===d)&&(d="H",n="Abnormal High",p="label-warning"):"L"==e.attributes.interpretationCode&&""===d&&(d="L",n="Abnormal Low",p="label-warning"),s[t]=e});var u=r.replace(/\s/g,"")+"_"+l.groupUid.replace(/\s/g,"");u=u.replace("#",""),t.set({labs:new e.Collection(s),observed:l.observed,isPanel:"Panel",typeName:o,panelGroupName:r,facilityCode:l.facilityCode,facilityMoniker:l.facilityMoniker,interpretationCode:d,flagTooltip:n,labelClass:p,uid:u,type:"panel"})}});var o=i.sortBy(r.models,function(e){return-e.attributes.observed});if(r.set(o),void 0!==t.appletConfig&&void 0!==t.appletConfig.viewType&&"gist"===t.appletConfig.viewType){var d=l.modifyModel(r);d=l.addTooltips(d,4),r.set(d.models)}a.collection.setPageSize(r.length)},w.criteria={filter:this.buildJdsDateFilter("observed")+',eq(categoryCode , "urn:va:lab-category:CH")'},a.collection=ADK.PatientRecordService.fetchCollection(w),this.listenTo(a.collection,"sync",function(){l.onSync()}),this.dataGridOptions=a,l.isFullscreen||a.gistView===!0&&(this.dataGridOptions.SummaryView=ADK.Views.LabresultsGist.getView(),this.dataGridOptions.SummaryViewOptions={gistHeaders:C.gistHeaders,enableTileSorting:!0}),this._super.initialize.apply(this,arguments),ADK.Messaging.getChannel("lab_results_grid").on("addItem",function(e){var t=ADK.Messaging.getChannel("addALabOrdersRequestChannel");t.trigger("addLabOrdersModal",event,y)}),ADK.Applets.BaseGridApplet.prototype.initialize.apply(this,arguments);var o=ADK.Messaging.getChannel("lab_results");o.reply("gridCollection",function(){return l.gridCollection})},onDestroy:function(){ADK.Messaging.getChannel("lab_results_grid").off("addItem")},onRender:function(){this._super.onRender.apply(this,arguments)},addTooltips:function(e,t){for(var i=0;i<e.models.length;i++){var a=e.models[i].attributes;a.oldValues&&(a.limitedoldValues=a.oldValues.splice(0,t-1),a.oldValues.length-a.limitedoldValues.length>0&&(a.moreresultsCount=a.oldValues.length-a.limitedoldValues.length)),e.models[i].attributes.tooltip=b(a)}return e},modifyModel:function(e){var t={},s=this.dataGridOptions.appletId;i.extend(t,e),t.models=[];for(var l=0;l<e.models.length;l++)if(void 0!==e.models[l].attributes.kind&&"Laboratory"===e.models[l].attributes.kind)if(e.models[l].attributes.applet_id=s,e.models[l].attributes.timeSince=a.setTimeSince(e.models[l].attributes.observed),e.models[l].attributes.observedFormatted=a.getObservedFormatted(e.models[l].attributes.observed),e.models[l].attributes.numericTime=a.getNumericTime(e.models[l].attributes.timeSince),e.models[l].attributes.observationType="labs",e.models[l].attributes.shortName=e.models[l].attributes.typeName,e.models[l].attributes.typeName.indexOf(",")>=0&&(e.models[l].attributes.shortName=e.models[l].attributes.typeName.substring(0,e.models[l].attributes.typeName.indexOf(","))),e.models[l].attributes.graphOptions=C.graphOptions,e.models[l].attributes.normalizedName=e.models[l].attributes.typeName.replace(/\W/g,"_"),0===t.models.length)t.models.push(e.models[l]);else{for(var r=!1,o=0;o<t.models.length;o++)("DOD"===t.models[o].attributes.facilityCode&&"DOD"===e.models[l].facilityCode&&t.models[o].attributes.codes[0].code===e.models[l].attributes.codes[0].code||t.models[o].attributes.typeCode&&t.models[o].attributes.typeCode===e.models[l].attributes.typeCode||t.models[o].attributes.typeName===e.models[l].attributes.typeName)&&(void 0===t.models[o].attributes.oldValues&&(t.models[o].attributes.oldValues=[],t.models[o].attributes.previousResult=e.models[l].attributes.result,t.models[o].attributes.previousInterpretationCode=e.models[l].attributes.interpretationCode),t.models[o].attributes.oldValues.push(e.models[l]),r=!0);r||t.models.push(e.models[l])}return t.length=t.models.length,t}}),D={id:"lab_results_grid",viewTypes:[{type:"summary",view:l.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:l.extend({columnsViewType:"expanded"}),chromeEnabled:!0},{type:"gist",view:_.extend({columnsViewType:"gist"}),chromeEnabled:!0},{type:"writeback",view:f,chromeEnabled:!1}],defaultViewType:"summary"},V=ADK.Messaging.getChannel(D.id);return V.on("detailView",function(e){var t=new o.ModalView({model:e.model,navHeader:!1}),i={fullScreen:self.isFullscreen,size:"large",title:e.model.get("typeName")},a=new ADK.UI.Modal({view:t,options:i});a.show()}),ADK.Messaging.getChannel("labresults_timeline_detailview").reply("detailView",function(t){var i={criteria:{uid:t.uid},patient:new e.Model({icn:t.patient.icn,pid:t.patient.pid}),resourceTitle:"uid",viewModel:{parse:w.viewModel.parse}},a=$.Deferred(),l=ADK.PatientRecordService.fetchCollection(i);return l.on("sync",function(){var e=l.first(),t=function(e){a.resolve(e)},i=a.reject;s.getDetailView(e,null,l,!1,t,i)},this),a.promise()}),V.reply("chartInfo",function(t){var i=t.typeName,a=e.Model.extend({}),s=new a({typeName:t.typeName,displayName:i,requesterInstanceId:t.instanceId,graphType:t.graphType,applet_id:D.id}),l=$.Deferred(),r=new h({model:s,target:null});return l.resolve({view:r}),l.promise()}),D});