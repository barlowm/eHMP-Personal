define(["jquery","jquery.inputmask","moment","backbone","marionette","underscore","highcharts","highcharts-more","app/applets/lab_results_grid/appletHelpers","hbs!app/applets/lab_results_grid/list/dateTemplate","hbs!app/applets/lab_results_grid/list/resultTemplate","hbs!app/applets/lab_results_grid/list/siteTemplate","hbs!app/applets/lab_results_grid/list/flagTemplate","hbs!app/applets/lab_results_grid/list/referenceRangeTemplate","hbs!app/applets/lab_results_grid/modal/modalTemplate","hbs!app/applets/lab_results_grid/modal/chartView","hbs!app/applets/lab_results_grid/modal/totalTestsTemplate","app/applets/lab_results_grid/modal/filterDateRangeView"],function(e,t,l,a,i,o,s,r,n,d,h,c,u,p,m,f,g,b){"use strict";var v,w,C,y,O,_,D,x,T,V,M,R={};y=a.Collection.extend({}),C=[{name:"observed",label:"Date",template:d,cell:"handlebars",sortable:!1},{name:"flag",label:"Flag",template:u,cell:"handlebars",sortable:!1},{name:"result",label:"Result",template:h,cell:"handlebars",sortable:!1},{name:"facilityMoniker",label:"Facility",template:c,cell:"handlebars",sortable:!1}],R.columns=C,R.appletConfig={name:"lab_results_modal",id:"lab_results_grid-modalView"};var I,L=a.Model.extend({defaults:{fromDate:null,toDate:null,customFromDate:null,customToDate:null,selectedId:null}}),k=new L,F=(new b({model:k}),function(){I=new L}),S=a.Marionette.ItemView.extend({template:f,id:"chart-container",initialize:function(e){var t=this;this.collection=e.collection,this.first=this.collection.first(),this.chartOptions=e.chartOptions,this.fullCollection=this.collection.fullCollection,x=this.fullCollection.map(function(e){return e.has("low")?e.get("low"):null}),T=this.fullCollection.map(function(e){return e.has("high")?e.get("high"):null}),x=o.map(x,function(e){return null===e?e:1*e}),T=o.map(T,function(e){return null===e?e:1*e});var a=[];o.each(x,function(e,t){var l=[];l.push(x[t]),l.push(T[t]),a.push(l)}),a.reverse(),_=this.fullCollection.pluck("observed"),_=o.map(_,function(e){return l(e,"YYYYMMDDHHmm").format("MMM DD YYYY HH:mm")}),_.reverse(),D=this.fullCollection.pluck("result"),D=o.map(D,function(e){return o.isNaN(1*e)?null:1*e}),D.reverse();var i=this.fullCollection.pluck("flagTooltip");i.reverse();var s=this.fullCollection.pluck("labelClass");s.reverse();var r=this.fullCollection.pluck("interpretationCode");r.reverse();var n=this.fullCollection.pluck("showFlagIcon");n.reverse(),this.chartOptions.series[0].data=[],o.forEach(i,function(e,i){var o=l(_[i]);if(e){var n=s[i];n=n.match("warning")?"#f0ad4e":"#d9534f",t.chartOptions.series[0].data.push({y:D[i],dataLabels:{enabled:!0,useHTML:!1,backgroundColor:n,borderRadius:2.25,formatter:function(){return r[i]},style:{color:"#ffffff",fontSize:"9px",padding:"1.8px 5.4px 2.7px 5.4px"}},x:Date.UTC(o.year(),o.month(),o.date(),o.hour(),o.minute())})}else t.chartOptions.series[0].data.push({y:D[i],dataLabels:{enabled:!1},x:Date.UTC(o.year(),o.month(),o.date(),o.hour(),o.minute())});a[i].unshift(Date.UTC(o.year(),o.month(),o.date(),o.hour(),o.minute()))}),this.chartOptions.series[0].zIndex=1,this.chartOptions.yAxis.title.text=this.first.get("units"),this.chartOptions.tooltip={valueSuffix:" "+this.first.get("units"),crosshairs:!0,shared:!0,style:{padding:10,zIndex:9999},useHTML:!0,xDateFormat:"%m/%d/%Y %H:%M"},this.chartOptions.series[1]={name:"Ref Range",data:a,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1}},onShow:function(){var t=this,l=setInterval(function(){t.$el.length&&(clearInterval(l),O=new s.Chart(t.chartOptions),e("body").on("mouseover.modalChart","#data-grid-lab_results_grid-modalView tbody tr",t.highLightChartPoint),e("body").on("mouseout.modalChart","#data-grid-lab_results_grid-modalView tbody tr",t.highLightChartPoint))},500)},onBeforeDestroy:function(){e("body").off(".modalChart")},highLightChartPoint:function(t){switch(t.type){case"mouseover":O.tooltip.shared=!1;var a=e(this),i=a.find("td:eq(2)"),o=(a.find("td:eq(0)"),1*i.text().replace(/[^\d\.-]/g,"")),s=l(n.getDateForChart(a.data("model").get("observed")));s=Date.UTC(s.year(),s.month(),s.date(),s.hour(),s.minute()),e.each(O.series[0].points,function(e,t){return t.y===o&&t.x===s?(t.onMouseOver(),!1):void 0});break;default:O.tooltip.shared=!0}}}),H=a.Marionette.ItemView.extend({template:g,tagName:"span",initialize:function(){this.listenTo(this.model,"change",this.render)}});V=a.Model.extend({defaults:{totalTests:0}});var N=new V,P=a.Marionette.LayoutView.extend({template:m,fetchOptions:{},initialize:function(t){var l=this;this.tableLoadingView=ADK.Views.Loading.create(),this.chartLoadingView=ADK.Views.Loading.create(),this.isFromPanel=t.isFromPanel,this.isFromNonPanel=t.isFromNonPanel,this.fullScreen=t.fullScreen,M=t.gridCollection,this.showNavHeader&&(this.model.attributes.navHeader=!0),this.fetchOptions.resourceTitle="patient-record-lab",this.fetchOptions.criteria={pid:this.model.attributes.pid},"DOD"===this.model.attributes.facilityCode&&l.model.attributes.codes[0].code?this.fetchOptions.criteria.filter='eq("codes[].code",'+l.model.attributes.codes[0].code+")":this.model.attributes.typeCode?this.fetchOptions.criteria.filter='eq(typeCode,"'+l.model.attributes.typeCode+'")':this.fetchOptions.criteria.filter='eq(typeName,"'+l.model.attributes.typeName+'")',this.fetchOptions.criteria.filterHold=this.fetchOptions.criteria.filter,this.fetchOptions.viewModel={parse:n.parseLabResponse},this.fetchOptions.pageable=!0,this.fetchOptions.cache=!1,this.fetchOptions.onSuccess=function(a,i){l.collection=a,l.$el.find(".labResultsNext, .labResultsPrev").attr("disabled",!1);var s=l.collection.fullCollection.pluck("result");s=o.map(s,function(e){return o.isNaN(1*e)}),s=o.without(s,!1),l.showNavHeader&&(l.model.attributes.navHeader=!0);var r;void 0!==l.chart&&null!==l.chart&&l.chart.reset(),0!==a.length&&s.length!==l.collection.fullCollection.length?(r=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(r),e("#lr-data-table-view").removeClass("col-md-12").addClass("col-md-5"),e("#lr-graph").removeClass("hidden"))},500),l.chart.show(new S({chartOptions:n.chartOptions,model:l.model,data:D,collection:l.collection}))):r=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(r),e("#lr-data-table-view").removeClass("col-md-5").addClass("col-md-12"),e("#lr-graph").addClass("hidden"))},500),R.collection=l.collection,R.filterDateRangeEnabled=!0,v=t.model,l.model=t.model,w=t.collection,N.set({totalTests:R.collection.fullCollection.length}),l.dataGrid=ADK.Views.DataGrid.create(R),void 0!==l.leftColumn&&null!==l.leftColumn&&(l.leftColumn.reset(),l.leftColumn.show(l.dataGrid)),R.collection=l.collection,0!==a.length?(l.paginatorView=ADK.Views.Paginator.create({collection:R.collection,windowSize:4}),e(".js-backgrid").append(l.paginatorView.render().el)):e("#data-grid-lab_results_grid-modalView").find("tbody").append(e('<tr class="empty"><td colspan="4">No Records Found</td></tr>'))}},regions:{leftColumn:".js-backgrid",chart:"#js-chart",totalTests:"#total-tests",dateRangeFilter:"#date-range-filter"},resetSharedModalDateRangeOptions:F,onRender:function(){var e;(void 0===I||null===I)&&this.resetSharedModalDateRangeOptions(),e=void 0!==I&&null!==I&&void 0!==I.get("selectedId")&&null!==I.get("selectedId")?I.clone():new L;var t=new b({model:e,parentView:this,fullScreen:this.fullScreen});t.setFetchOptions(this.fetchOptions),t.setSharedDateRange(I),this.dateRangeFilter.show(t),this.leftColumn.show(this.tableLoadingView),this.chart.show(this.chartLoadingView),this.totalTests.show(new H({model:N}))},onShow:function(){}});return{ModalView:P,resetSharedModalDateRangeOptions:F}});