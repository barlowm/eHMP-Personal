define(["backbone","marionette","underscore","handlebars","moment","hbs!app/applets/addAllergy/templates/allergySelectedGridTemplate","hbs!app/applets/addAllergy/templates/allergySelectedFooter","app/applets/addAllergy/symptomsView","app/applets/addAllergy/symptomsSelectedView","app/applets/addAllergy/symptomsScrollEventHandler","app/applets/addAllergy/symptomsSearchEventHandler","app/applets/addAllergy/utils/allergiesUtil","app/applets/addAllergy/utils/symptomsUtil","app/applets/addAllergy/utils/modelBindingUtil","app/applets/addAllergy/models/allergenModel"],function(e,t,s,i,r,a,o,l,n,m,d,c,h,p,y){"use strict";var v=e.Marionette.ItemView.extend(p).extend({template:o,className:"add-allergy-styles",events:{"click #add-allergy":"addAllergy","click #btn-add-allergy-back":"navToSearch"}}),g=e.Marionette.LayoutView.extend(p).extend({template:a,className:"add-allergy-styles",initialize:function(){this.model=new y,this.model.get("param").symptoms.reset(),this.errorView=new ADK.Views.ServerSideError,this.loadingIndicatorView=ADK.Views.Loading.create(),this.symptomsView=new l,this.symptomsSelectedView=new n({collection:this.model.get("param").symptoms}),m.setView(this),d.setView(this),this.initializeBinding(),this.listenTo(this.model,"change",function(){var e=this.$("#obs-time"),t=!this.model.get("obs-date");$("#add-allergy").prop("disabled",!(this.model.isValid()&&this.model.get("param").symptoms.isValid())),t&&e.val("").change(),e.prop("disabled",t)},this)},regions:{symptomsInnerList:"#symptoms-inner-list",symptomsSelectedList:"#symptoms-selected",symptomsLoadingIndicator:"#symptomsLoadingIndicator",errorContainer:"#error-container"},onRender:function(){this.loadSymptoms(),this.$el.find("#symptomSearchInput").val("");var e,t;e=this.$("#obs-date"),t=this.$("#obs-time"),ADK.utils.dateUtils.datepicker(e,{endDate:(new r).format(ADK.utils.dateUtils.defaultOptions().placeholder)}),e.parent().find(".glyphicon-calendar").on("click",function(){e.datepicker("show")}),t.inputmask("Regex",{placeholder:"hh:mm a/p",clearIncomplete:!0,onincomplete:function(e){$(this).val("").trigger("change")}}),this.errorContainer.show(this.errorView)},loadSymptoms:function(){this.symptomsInnerList.show(this.symptomsView),this.symptomsSelectedList.show(this.symptomsSelectedView),this.symptomsLoadingIndicator.show(this.loadingIndicatorView),this.$el.find("#symptomsList").on("scroll",m.symptomsEventHandler)},modelEvents:{"change:name":"setAllergyName","change:IEN":"setAllergyName","change:location":"setAllergyName","change:obs-date":"setObsTime","change:obs-time":"setObsTime","change:nature":function(){var e=this.model.get("nature")?this.model.get("nature").split("^"):"";this.model.get("param").natureOfReaction=e.length>1?e[1]:""},"change:historicalOrObserved":function(){this.model.get("param").historicalOrObserved=this.model.get("historicalOrObserved")||""},"change:comments":function(){this.model.get("param").cmtText=this.model.get("comments")||""},"change:severity":function(){this.setSeverity(),this.model.get("param").severity=this.model.get("severity")||""}},events:{"keyup #comments":"navigateToSymptomsFromComments","keydown #symptomSearchInput":"navigateToSymptomsFromSearch","keyup #symptomSearchInput":"submitSearchSymptoms",'click button[data-dismiss="modal"]':"clearErrors","click #add-allergy":function(e){this.addAllergy(e),this.clearErrors(e)},"click #btn-severe":function(){this.model.set({severity:"3"},{validate:!0})},"click #btn-moderate":function(){this.model.set({severity:"2"},{validate:!0})},"click #btn-mild":function(){this.model.set({severity:"1"},{validate:!0})},"click #btn-observer":function(){this.showObserver(),this.model.set({historicalOrObserved:$("#btn-observer").attr("data-value")},{validate:!0})},"click #btn-historical":function(){this.hideObserver(),this.model.set({historicalOrObserved:$("#btn-historical").attr("data-value")},{validate:!0})}},clearErrors:function(){this.errorView.clearErrors()},showError:function(e){this.errorView.addError(e.responseText,"Save Failed")},setAllergyName:function(){this.model.get("name")&&this.model.get("IEN")&&this.model.get("location")&&(this.model.get("param").allergyName=this.model.get("name")+"^"+this.model.get("IEN")+";"+this.model.get("location").split('"')[0])},setObsTime:function(){var e,t=this.model.get("obs-date"),s=this.model.get("obs-time");t&&(e=s?ADK.utils.dateUtils.getRdkDateTimeFormatter().getDateTimeFromDateTimeStrings(t,s):ADK.utils.dateUtils.getRdkDateTimeFormatter().getDateFromDateString(t)),this.model.get("param").observedDate=e||""},setAllergen:function(e){s.each(e.attributes,function(e,t){this.model.set(t,e)},this)},addAllergy:function(){this.clearErrors(),$("#add-allergy").prop("disabled",!0),this.model.get("param").eventDateTime=ADK.utils.dateUtils.getRdkDateTimeFormatter().getCurrentDate()+ADK.utils.dateUtils.getRdkDateTimeFormatter().getCurrentTimeWithZeroSeconds();var e=this,t={beforeSend:e.model.beforeSend,error:function(t,s){e.showError(s),$("#add-allergy").prop("disabled",!1)},success:function(t,s){ADK.UI.Modal.hide(),setTimeout(function(){e.gridView.refresh({})},2e3)}};console.log(JSON.stringify(this.model)),this.model.save(null,t)},setSeverity:function(e){var t=this.model.get("severity");switch(t){case"3":$("#btn-severe").attr("is-active","true"),$("#btn-severe").removeClass("severity-none"),$("#btn-severe").addClass("severity-severe"),$("#btn-moderate").attr("is-active","false"),$("#btn-moderate").removeClass("severity-moderate"),$("#btn-moderate").addClass("severity-none"),$("#btn-mild").attr("is-active","false"),$("#btn-mild").removeClass("severity-mild"),$("#btn-mild").addClass("severity-none");break;case"2":$("#btn-severe").attr("is-active","false"),$("#btn-severe").removeClass("severity-severe"),$("#btn-severe").addClass("severity-none"),$("#btn-moderate").attr("is-active","true"),$("#btn-moderate").removeClass("severity-none"),$("#btn-moderate").addClass("severity-moderate"),$("#btn-mild").attr("is-active","false"),$("#btn-mild").removeClass("severity-mild"),$("#btn-mild").addClass("severity-none");break;case"1":$("#btn-severe").attr("is-active","false"),$("#btn-severe").removeClass("severity-severe"),$("#btn-severe").addClass("severity-none"),$("#btn-moderate").attr("is-active","false"),$("#btn-moderate").removeClass("severity-moderate"),$("#btn-moderate").addClass("severity-none"),$("#btn-mild").attr("is-active","true"),$("#btn-mild").removeClass("severity-none"),$("#btn-mild").addClass("severity-mild")}},validObserverDate:function(e,t){return $(".errorMessage").remove(),e.length&&!c.requiredDateFormat(e)?(t&&this.showError("Please enter the date in format HH:MMa or HH:MMp"),!1):!0},showObserver:function(){$("#obs-form").css("visibility","visible"),$("#btn-historical").removeClass("toggle-on"),$("#btn-historical").addClass("toggle-off"),$("#btn-observer").removeClass("toggle-off"),$("#btn-observer").addClass("toggle-on"),$("#btn-observer").attr("is-active","true"),$("#btn-historical").attr("is-active","false")},hideObserver:function(){$("#obs-form").css("visibility","hidden"),$("#btn-historical").removeClass("toggle-off"),$("#btn-historical").addClass("toggle-on"),$("#btn-observer").removeClass("toggle-on"),$("#btn-observer").addClass("toggle-off"),$("#btn-observer").attr("is-active","false"),$("#btn-historical").attr("is-active","true")},navigateToSymptomsFromSearch:function(e){9!==e.keyCode||e.shiftKey||(e.preventDefault(),h.isSymptomsListEmpty()&&!h.isSelectedSymptomsEmpty()?$("#symptoms-selected-tbl > tbody").find("input")[0].focus():h.isSymptomsListEmpty()&&h.isSelectedSymptomsEmpty()?$("#comments").focus():$("#symptoms-ul:first > li:first > a").focus())},submitSearchSymptoms:function(e){9!==e.keyCode&&c.performActionWhileTyping(e,"keyup",2,500,d.symptomsEventHandler)},navigateToSymptomsFromComments:function(e){if(9===e.keyCode&&e.shiftKey)if(e.preventDefault(),!h.isSymptomsListEmpty()&&h.isSelectedSymptomsEmpty())$("#symptoms-ul:first > li:first > a").focus(),$("#symptomsList").scrollTop(0);else if(h.isSymptomsListEmpty()&&h.isSelectedSymptomsEmpty())$("#symptomSearchInput").focus();else{var t=$("#symptoms-selected-tbl > tbody").find(".xbutton"),s=t.length-2;t[s].focus()}},showModal:function(t){var s=v.extend({navToSearch:this.navToSearch,addAllergy:this.addAllergy,showError:this.showError,clearErrors:this.clearErrors,errorView:this.errorView,model:this.model,gridView:this.gridView}),r=e.Marionette.ItemView.extend({template:i.compile("<button type='button' class='close' data-dismiss='modal'><span aria-hidden='true'>Ã—</span><span class='sr-only'>Close</span></button><h4 class='modal-title'>Enter Allergy/Adverse Reaction for <b> {{name}} </b></h4>")});new ADK.UI.Modal(this,{title:"Enter Allergy/Adverse Reaction",headerView:r.extend({model:this.model}),footerView:s,regionName:"addEditAllergy",replaceContents:t});moda.show()}});return g});