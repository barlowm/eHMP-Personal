define(["backbone","marionette","underscore","hbs!app/applets/addAllergy/templates/allergenSearchResultTemplate","hbs!app/applets/addAllergy/templates/allergenSearchTemplate","app/applets/addAllergy/allergySelectedView","hbs!app/applets/addAllergy/templates/AllergenSearchResultCompositeViewTemplate","app/applets/addAllergy/utils/allergiesUtil","app/applets/addAllergy/utils/modelBindingUtil","app/applets/addAllergy/models/allergenModel","app/applets/addAllergy/allergenSearchEventHandler"],function(e,l,t,a,r,n,i,o,s,c,d){var h,p={title:"Add New Allergy",regionName:"allergySearch"},u=e.Marionette.ItemView.extend({tagName:"li",className:"list-unstyled row-layout",template:a,events:{click:"selectAllergen"},initialize:function(){},selectAllergen:function(e){e.preventDefault();var l=n.extend({navToSearch:this.navToSearch,gridView:h});this.selectedView||(this.selectedView=new l);var t=this.selectedView.model.get("IEN")===this.model.get("IEN")?!1:!0;this.selectedView.setAllergen(this.model),this.selectedView.showModal(t)},navToSearch:function(e){e.preventDefault();var l=new ADK.UI.Modal({view:w,options:p});l.show()}}),g=e.Marionette.CompositeView.extend({initialize:function(){this.collection=new e.Collection(this.model.get("results"))},childView:u,childViewContainer:"#allergen-search-result-item-container",template:i}),m=e.Marionette.CollectionView.extend({onAddChild:function(e){e.collection.isEmpty()&&e.destroy()},onRender:function(){var e="undefined"!=typeof this.collection;if(e){var l=0;if(this.collection.each(function(e){l+=e.get("results").length}),0===l){var t=$("#allergen-search-results .allergen-list-group");t.append($("<li id='allergen-search-results-empty'>No Results Found.</li>"))}else $("#allergen-search-results-empty").remove()}},childView:g,tagName:"li",className:"allergen-list-group"}),w=e.Marionette.LayoutView.extend(s).extend({template:r,className:"add-allergy-styles",regions:{allergenSearchResults:"#allergen-search-results",allergenSearchError:"#error-container"},initialize:function(){this.errorView=new ADK.Views.ServerSideError,this.model=new c},onRender:function(){this.loadSearchResults(""),o.enableLoadingIndicator(!0),this.allergenSearchError.show(this.errorView)},events:{"click #allergenSearchButton":"search","keyup #allergenSearchInput":"search"},search:function(l){var t=this;if(allergenSearchInput.value.length>=3){o.enableLoadingIndicator(!0);var a={resourceTitle:"allergy-op-data-search",reset:!0,data:$.param({searchParam:allergenSearchInput.value.toUpperCase()}),error:function(e,l){o.enableLoadingIndicator(!1),t.showError(l)},success:function(e,l){o.enableLoadingIndicator(!1),$("#allergy-loading-annoucement").hide(),$("#allergy-loading-annoucement").text("Lookup complete"),$("#allergy-loading-annoucement").show()}},r=e.Collection.extend({url:ADK.ResourceService.buildUrl(a.resourceTitle)}),n=new r;n.fetch(a),this.collection=n,this.loadSearchResults(l)}},submitAllergenSearch:function(e){9!==e.keyCode&&(d.setView(this),o.performActionWhileTyping(e,"keyup",2,500,d.allergenEventHandler))},showError:function(e){this.errorView.addError(e.responseText)},showModal:function(e,l){e.preventDefault(),h=l;var t=new ADK.UI.Modal({view:this,options:p});t.show()},loadSearchResults:function(e){var l=new m({collection:this.collection});this.allergenSearchResults.show(l),$("#allergen-search-result-composite-outer-div").find("a").attr("tabindex",0),this.submitAllergenSearch(e)}});return w});