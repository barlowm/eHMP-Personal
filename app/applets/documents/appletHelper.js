define(["backbone","marionette","underscore","app/applets/documents/debugFlag"],function(e,t,i,o){var r=o.flag,a="localTitle",n={isComplexDoc:function(e){return"surgery"==e.toLowerCase()||"consult"==e.toLowerCase()||"procedure"==e.toLowerCase()||"imaging"==e.toLowerCase()||"radiology report"==e.toLowerCase()?!0:!1},hasChildDocs:function(e){return(e.get("isInterdisciplinary")===!0||"true"===e.get("isInterdisciplinary"))&&"parent"===e.get("interdisciplinaryType").toLowerCase()},isRadiology:function(e){return"radiology"==e.toLowerCase()?!0:!1},isImaging:function(e){return"imaging"==e.toLowerCase()?!0:!1},isConsult:function(e){return"consult"==e.toLowerCase()?!0:!1},isSurgery:function(e){return"surgery"==e.toLowerCase()?!0:!1},hasAddenda:function(e){return void 0!==e.text&&e.text.length>1?!0:!1},formatAddenda:function(e){if("Progress Note"==e.kind&&this.hasAddenda(e)){for(var t=[],i=1;i<e.text.length;i++)e.text[i].dateTime?e.text[i].addendaDateTime=this.formatDateTime(e.text[i].dateTime,"YYYYMMDDHHmmssSSS","datetime"):e.text[i].addendaDateTime=!1,t.push(e.text[i]);return t}return!1},formatDateTime:function(e,t,i){return"datetime"==i?i="MM/DD/YYYY - HH:mm":"date"==i&&(i="MM/DD/YYYY"),moment(e,t).format(i)},getResultsFromUid:function(t,o){i.isUndefined(o)||i.isFunction(o)||(r&&(console.log("Callback is not a function. Using Default function."),console.log(o)),o=void 0);var s=new e.Collection;if(this.isComplexDoc(t.get("kind"))&&t.get("results")&&!t.get("dodComplexNoteUri")&&t.get("results").length>0){var l=i.map(t.get("results"),function(e){return e.uid}),c={resourceTitle:"patient-record-document",viewModel:{parse:function(e){return n.parseDocResponse(e)}},criteria:{filter:'in("uid",'+JSON.stringify(l)+")",order:a+" ASC"},onSuccess:o||function(e){e.each(function(e){"none"===e.get("authorDisplayName").toLowerCase()&&e.get("signerDisplayName")&&(e.set("authorDisplayName",e.get("signerDisplayName")),e.set("providerDisplayName",e.get("signerDisplayName")))}),s.reset(e.models),r&&(console.log("Fetch Success"),console.log(s))},onError:function(e,t){r&&console.log("Fetch Error")}};ADK.PatientRecordService.fetchCollection(c)}return s},getChildDocs:function(t){if(this.hasChildDocs(t)){var i=new e.Collection,o={resourceTitle:"patient-record-document",viewModel:{parse:function(e){return n.parseDocResponse(e)}},criteria:{filter:'eq(parentUid,"'+t.get("uid")+'")',order:a+" ASC"},onSuccess:function(e){i.reset(e.models)}};return ADK.PatientRecordService.fetchCollection(o),i}return null},parseDocResponse:function(e){if(e.kind&&(e.kind=e.kind,e.complexDoc=n.isComplexDoc(e.kind),e.surgeryBool=n.isSurgery(e.kind),e.consultBool=n.isConsult(e.kind),e.imagingBool=n.isImaging(e.kind),e.radiologyBool=n.isRadiology(e.kind),("Radiology"==e.kind||"Imaging"==e.kind)&&(e.typeName&&(e.localTitle=e.typeName),e.dateTime&&(e.referenceDateTime=e.dateTime),e.providerDisplayName&&(e.authorDisplayName=e.providerDisplayName)),"Surgery"==e.kind&&(e.typeName&&(e.localTitle=e.typeName),e.dateTime&&(e.referenceDateTime=e.dateTime),e.providerDisplayName&&(e.authorDisplayName=e.providerDisplayName)),"Consult"==e.kind&&(e.typeName&&(e.localTitle=e.typeName),e.dateTime&&(e.referenceDateTime=e.dateTime),e.providerDisplayName&&(e.authorDisplayName=e.providerDisplayName),e.results&&e.results[0]&&e.results[0].localTitle&&(e.resultsTitle=e.results[0].localTitle)),"Imaging"==e.kind&&e.dateTime&&(e.referenceDateTime=e.dateTime),"Procedure"==e.kind&&(e.typeName?e.localTitle=e.typeName:e.summary?e.localTitle=e.summary:e.name&&(e.localTitle=e.name),e.referenceDateTime?e.referenceDateTime=e.referenceDateTime:e.dateTime&&(e.referenceDateTime=e.dateTime),e.providerDisplayName&&(e.authorDisplayName=e.providerDisplayName)),e.radiologyReportBool="radiology report"===e.kind.toLowerCase()),(void 0===e.authorDisplayName||""===e.authorDisplayName)&&(e.authorDisplayName="None"),e.localTitle&&(e.displayTitle=e.localTitle.toLowerCase()),e.referenceDateTime&&(e.dateDisplay=n.formatDateTime(e.referenceDateTime,"YYYYMMDDHHmmssSSS","date"),e.dateTimeDisplay=n.formatDateTime(e.referenceDateTime,"YYYYMMDDHHmmssSSS","datetime")),void 0!==e.text&&e.text&&e.text[0]?(e.text[0].authorDisplayName&&(e.textAuthor=e.text[0].authorDisplayName),e.text[0].content?e.content=e.text[0].content:e.content="No Content",e.text[0].dateTime&&(e.textDateTime=n.formatDateTime(e.text[0].dateTime,"YYYYMMDDHHmmssSSS","datetime")),e.text[0].authorDisplayName&&(e.textAuthor=e.text[0].authorDisplayName)):e.facilityCode&&"dod"===e.facilityCode.toLowerCase()?e.content="No Document Found":e.text=!1,e.statusDisplayName){var t=e.statusDisplayName.toLowerCase();"completed"===t?e.statusDisplayClass="text-success":"rejected"===t&&(e.statusDisplayClass="text-danger")}if(e.statusName){var i=e.statusName.toLowerCase();("complete"===i||"completed"===i)&&(e.statusClass="text-success")}return"true"!==e.isInterdisciplinary&&e.isInterdisciplinary!==!0||"parent"!==e.interdisciplinaryType?e.interdisciplinaryBool=!1:e.interdisciplinaryBool=!0,e.addendaText=n.formatAddenda(e),e},globalFilterStatus:function(e){return null!==e.attributes.fromDate&&null!==e.attributes.toDate?!0:!1},hideAppFilter:function(){r&&console.log($("#grid-filter-documents").find("form").find("input").val()),r&&console.log($("form.form-search").find("input").val()),$("#grid-filter-documents").hasClass("collapse in")&&$("#grid-filter-button-documents").click(),$("#grid-filter-button-documents").hide(),$("form.form-search").find("input").val().length>0&&$("#grid-filter-documents").find(".clear").click()},showAppFilter:function(){$("#grid-filter-button-documents").show()},scrollToResultDoc:function(e,t){var i=this.getScrollParent(e,!1);if(t.length>0){for(var o=0,r=t,a=0,n=$(document.body);!r.is(n)&&!r.is(i)&&a++<100;)o+=r.position().top,r=r.offsetParent();var s=i.scrollTop()+o;i.scrollTop(s)}},getScrollParent:function(e,t){var i=e.css("position"),o="absolute"===i,r=t?/(auto|scroll|hidden)/:/(auto|scroll)/,a=e.parents().filter(function(){var e=$(this);return o&&"static"===e.css("position")?!1:r.test(e.css("overflow")+e.css("overflow-y")+e.css("overflow-x"))}).eq(0);return"fixed"!==i&&a.length?a:$(e[0].ownerDocument||document)}};return n});