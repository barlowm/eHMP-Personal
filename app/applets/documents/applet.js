define(["backbone","marionette","underscore","moment","app/applets/documents/debugFlag","app/applets/documents/appletHelper","app/applets/documents/docDetailsDisplayer","app/applets/documents/detail/overviewDetailView","app/applets/documents/detailCommunicator","app/applets/documents/collectionHandler","hbs!app/applets/documents/detail/detailWrapperTemplate","hbs!app/applets/documents/summary/facilityNameTemplate","hbs!app/applets/allergy_grid/list/summaryItemViewTemplate","hbs!app/applets/allergy_grid/list/summaryViewTemplate"],function(e,t,i,o,a,n,l,s,r,d,p,c,u,h){var g,m=a.flag,f=a.serverDateFilter,b=a.GroupByView,D=null,w=[{name:"dateDisplay",label:"Date",editable:!1,cell:"string",sortValue:function(e,t){return e.get("referenceDateTime")},groupable:!0,groupableOptions:{primary:!0,innerSort:"referenceDateTime",groupByDate:!0,groupByFunction:function(e){return e.model.get("referenceDateTime").substr(0,6)},groupByRowFormatter:function(e){return o(e,"YYYYMM").format("MMMM YYYY")}},hoverTip:"documents_date"},{name:"localTitle",label:"Description",editable:!1,cell:"string",groupable:!0,groupableOptions:{innerSort:"referenceDateTime"},hoverTip:"documents_description"},{name:"kind",label:"Type",editable:!1,cell:"string",groupable:!0,groupableOptions:{innerSort:"referenceDateTime"},hoverTip:"documents_type"},{name:"authorDisplayName",label:"Author or Verifier",editable:!1,cell:"string",groupable:!0,groupableOptions:{innerSort:"referenceDateTime"},hoverTip:"documents_enteredby"},{name:"facilityName",label:"Facility",editable:!1,cell:"handlebars",groupable:!0,groupableOptions:{innerSort:"referenceDateTime"},template:c,hoverTip:"documents_facility"}],T=[w[0],w[2],w[3]],y={filterEnabled:!0,onClickRow:function(e,t){var i,o=e.get("kind"),a=e.get("complexDoc"),l=n.getChildDocs(e);if(a&&(i=n.getResultsFromUid(e)),$("#center").hasClass("col-md-12")){var s=$(t.target).closest("tr"),r=s.offset().top;$("#center").find(".data-grid").removeClass("col-md-12"),$("#center").find(".data-grid").addClass("col-md-6"),0===$("#doc-detail-region").length?($("#center").find(".grid-container div:first-child").append(p({})),this.parent.addRegion("docDetail","#doc-detail-region")):$("#doc-detail-wrapper").removeClass("hide"),void 0!==this.parent&&(this.parent.hiddenColumns=!0,this.parent.changeView(e,o,i,l));var d=s.closest(".data-grid").scrollTop(),c=s.offset().top,u=c-r,h=d+u;s.closest(".data-grid").scrollTop(h),D=$(":focus"),$(".docDetailTitle").focus()}else void 0!==this.parent&&this.parent.changeModelView(e,o,i,l)}},v=ADK.Applets.BaseGridApplet,V=v.extend({className:"docApp",lastTypeClicked:"unk",hiddenColumns:!1,events:function(){return i.extend({},v.prototype.events,{"click .hideDetail":"hideDetail","focus #data-grid-documents tr":"activateRow"})},showGridView:function(){this.refreshGrid(!1)},groupByView:function(){this.refreshGrid(!0)},initialize:function(e){m&&console.log("Doc Tab App -----> init start"),g=this.options=e,this.options.groupView=b,_super=v.prototype,y.parent=this;var t=this;y.collection=ADK.PatientRecordService.createEmptyCollection({pageable:!0}),y.appletConfig=e.appletConfig,y.groupable=this.options.groupView,y.onClickAdd=function(e){ADK.Messaging.getChannel("notesTray").trigger("addNewNote-btn",!1)},"summary"===this.columnsViewType?y.columns=T:y.columns=w,this.listenTo(d,"resetCollection",function(e){m&&console.log("Doc Tab App -----> resetCollection event"),t.dataGridOptions.collection.url=e.url,t.dataGridOptions.collection.fetchOptions=e.fetchOptions,t.dataGridOptions.collection.reset(e.models),t.dataGridOptions.collection.originalModels=t.dataGridOptions.collection.models,this.onSync()}),this.listenTo(ADK.Messaging,"globalDate:selected",function(e){m&&console.log("Doc Tab date filter range----->"+JSON.stringify(e)),f?(t.hideDetail(),m&&console.log("Doc Tab server side filter refresh"),t.fetchData()):(n.globalFilterStatus(e)?n.hideAppFilter():n.showAppFilter(),t.hideDetail(),m&&console.log("Doc Tab client side filter refresh"),d.queryCollection(e.attributes.fromDate,e.attributes.toDate))},this),this.dataGridOptions=y,_super.initialize.apply(this,arguments)},refreshGrid:function(e){m&&console.log("Doc Tab App -----> refreshGrid"),this.showLoading(),this.options.groupView=e,this.initialize(this.options)},onRender:function(){m&&console.log("Doc Tab App -----> onRender"),_super.onRender.apply(this,arguments)},onShow:function(){m&&console.log("Doc Tab App -----> onShow"),b||(0===$("#gridView-documents").length&&$("#center").find(".grid-filter-button").before('<button id="gridView-documents" class="btn btn-sm btn-link" title="Grid View"><span  class="gridView applet-title-button fa fa-th" ><span class="sr-only">Grid View</span></span></button>'),0===$("#groupByView-documents").length&&$("#center").find(".grid-filter-button").before('<button id="groupByView-documents" class="btn btn-sm btn-link" title="Group by View"><span class="groupByView applet-title-button fa fa-th-list" ><span class="sr-only">Group by View</span></span></button>')),this.fetchData(),_super.onShow.apply(this,arguments)},fetchData:function(){d.queryCollection(this,this.dataGridOptions.collection)},changeView:function(e,t,i,o){if(m&&console.log("Doc Tab App -----> changeView"),this.lastTypeClicked===t)this.updateDetailView(e),this.updateDetailTitle(l.getTitle(e,t));else{var a=l.getView(e,t,i,o),n=this;a.done(function(i){n.docDetail.show(i.view),n.updateDetailTitle(i.title||l.getTitle(e,t))})}this.$("#doc-detail-wrapper").scrollTop(0)},changeModelView:function(e,t,i,o){m&&console.log("Doc Tab App -----> changeView");var a=l.getView(e,t,i,o);a.done(function(i){var o={title:i.title||l.getTitle(e,t),size:"large"},a=new ADK.UI.Modal({view:i.view,options:o});a.show()})},updateDetailTitle:function(e){$("#doc_detail_top .docDetailTitle").html(e)},updateDetailView:function(e){m&&console.log("Doc Tab App -----> updateDetailView"),this.docDetailView.model=e,this.docDetailView.render()},hideColumns:function(){m&&console.log("Doc Tab App -----> hideColumns"),this.hiddenColumns===!0&&($("#data-grid-documents tr *:nth-child(4)").addClass("hide"),$("#data-grid-documents tr *:nth-child(5)").addClass("hide"))},hideDetail:function(){m&&console.log("Doc Tab App -----> hideDetail"),$("#doc-detail-wrapper").addClass("hide"),$("#center").find(".data-grid").removeClass("col-md-6"),$("#center").find(".data-grid").addClass("col-md-12"),this.hiddenColumns=!1,D&&D.focus()},activateRow:function(e){var t=$(e.target);$("#data-grid-documents").find("tr.active").removeClass("active"),t.hasClass("selectable")&&t.addClass("active")}}),C={id:"documents",viewTypes:[{type:"expanded",view:V,chromeEnabled:!0},{type:"summary",view:V.extend({columnsViewType:"summary"}),chromeEnabled:!0}],defaultViewType:"expanded"};return r.initialize(C.id),C});