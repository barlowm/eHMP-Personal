define(["backbone","marionette","async","app/applets/documents/docUtils","app/applets/documents/modal/unknownDocumentModalView","app/applets/documents/detail/simple/docDetailView","app/applets/documents/detail/complex/complexDetailView","app/applets/documents/detail/dodComplexNoteUtil","app/applets/documents/debugFlag","app/applets/documents/appletHelper"],function(e,o,t,r,l,n,i,a,s,c){"use strict";function d(e,o){t.forEach(e,function(e,o){var t=e.get("dodComplexNoteUri");if(void 0===t||null===t||e.get("dodComplexNoteContent"))p&&console.log("Already have DoD Complex Note, not re-fetching"),o();else{p&&console.log("Fetching DoD Complex Note...");var r={resourceTitle:"patient-record-complexnote",criteria:{uid:e.get("uid")},viewModel:{parse:a.parseModel},onSuccess:function(t){t.models.length>0&&e.set("dodComplexNoteContent",t.models[0].get("complexNote")),p&&console.log("Success fetching DoD Complex Note content"),o()},onError:function(e,t){var r="Error fetching DoD Complex Note";p&&console.log(r),o(r)}};ADK.PatientRecordService.fetchCollection(r)}},function(t){o(t,e)})}function u(e,o,t,r,l){var a=o.toLowerCase(),s=e.attributes.stub&&"true"===e.attributes.stub;if("surgery report"===a||"discharge summary"===a&&!s){var d=m.getExternalView(e,o,t);d.done(function(e){l(null,e)}),d.fail(function(e){l(e)})}else{var u;u=s?new n({model:e}):c.hasChildDocs(e)?new i({resultDocCollection:t,childDocCollection:r,model:e}):"advance directive"===o.toLowerCase()?new n({model:e}):"administrative note"===o.toLowerCase()?new n({model:e}):"consult"===o.toLowerCase()?new i({resultDocCollection:t,model:e}):"crisis note"===o.toLowerCase()?new n({model:e}):"laboratory report"===o.toLowerCase()?new n({model:e}):"procedure"===o.toLowerCase()?new i({resultDocCollection:t,model:e}):"progress note"===o.toLowerCase()?new n({model:e}):"radiology"===o.toLowerCase()?new n({model:e}):"imaging"===o.toLowerCase()?new i({resultDocCollection:t,model:e}):"surgery"===o.toLowerCase()?new i({resultDocCollection:t,model:e}):new n("clinical procedure"===o.toLowerCase()?{model:e}:{model:e}),l(null,{view:u,title:m.getTitle(e,o)})}}var p=s.flag,m={getDocType:function(e){return e.get("kind")},getDocId:function(e){return e.get("uid")},getTitle:function(e,o){switch(o.toLowerCase()){case"clinical procedure":return"Clinical Procedure Details";case"discharge summary":return"Discharge Summary Details";case"surgery report":return"Surgery Report Details";case"advance directive":case"administrative note":case"crisis note":case"laboratory report":case"progress note":case"radiology":case"consult":case"procedure":case"imaging":case"surgery":return e.get("displayTitle")+" Details";default:return e.get("displayTitle")+" Details"}},getExternalView:function(e,o,t){var r=ADK.Messaging.getChannel("documents"),l=r.request("extDetailView",{model:e,kind:o,uid:e.get("uid")});return l},getView:function(e,o,r,l){var n=$.Deferred(),i=[];return r&&r.length>0?i=r.models:e.get("dodComplexNoteUri")&&(i=[e]),t.series([d.bind(null,i),u.bind(null,e,o,r,l)],function(e,o){e?n.reject(e):n.resolve(o[1])}),n.promise()}};return m});