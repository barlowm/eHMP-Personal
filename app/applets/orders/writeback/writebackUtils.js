define(["backbone","marionette","underscore","moment","app/applets/orders/writeback/filemanDateUtil"],function(e,t,o,l,i){function r(e,t,o,l){e.model.unset(o),e.callControlFunction({controlType:t,controlName:o,functionName:"setPickList",options:{pickList:l}})}function n(e){var t=e.split(" "),o="",l="0:00";return t.length>0&&(o=t[0]),t.length>1&&(l=t[1]),{date:o,time:l}}var a="4",c="6",s="15",d="28",m="29",g="153",u="126",p="127",f="180",h={resetForm:function(e){e.model.unset("labTestText"),e.model.unset("collectionSample"),e.model.unset("collectionSampleText"),e.model.unset("collectionSampleListCache"),r(e,"select","collectionSample",[]),e.model.unset("otherCollectionSample"),e.model.unset("specimen"),e.model.unset("specimenListCache"),r(e,"select","specimen"),e.model.unset("otherSpecimen"),e.model.unset("specimenText"),e.model.unset("urgency"),e.model.unset("urgencyText"),r(e,"select","urgency",[]),e.model.unset("howOften"),e.model.unset("howLong"),e.model.unset("howOftenText"),r(e,"select","howOften",[]),e.model.unset("collectionType"),r(e,"select","collectionType",[]),e.model.unset("collectionDateTimePicklist"),r(e,"select","collectionDateTimePicklist",[]),e.model.unset("sampleDrawnAt"),e.model.unset("additionalComments"),e.model.unset("anticoagulant"),e.model.unset("anticoagulantText"),e.model.unset("orderComment"),e.model.unset("orderCommentText"),e.model.unset("doseDate"),e.model.unset("doseTime"),e.model.unset("drawDate"),e.model.unset("drawTime"),e.model.unset("doseDrawText"),e.model.unset("forTest"),e.model.unset("labCanCollect"),e.model.unset("alertMessage"),e.model.unset("errorMessage"),e.model.unset("savedTime"),e.$(".acceptDrpDwnContainer").find("button").attr("disabled",!0).addClass("disabled"),e.hideAll()},resetRequiredFields:function(e){e.$(".collectionDate").trigger("control:required",!1),e.$(".collectionTime").trigger("control:required",!1),e.$(".collectionDateTimePicklist").trigger("control:required",!1),e.$(".otherCollectionSample").trigger("control:required",!1),e.$(".otherSpecimen").trigger("control:required",!1),e.$(".futureLabCollectDate").trigger("control:required",!1),e.$(".futureLabCollectTime").trigger("control:required",!1),e.$(".howLong").trigger("control:required",!1),e.$(".immediateCollectionDate").trigger("control:required",!1),e.$(".immediateCollectionTime").trigger("control:required",!1),e.$(".sampleDrawnAt").trigger("control:required",!1)},setInitialCollectionDateTimeValues:function(e){e.model.set("collectionDate",moment().format("MM/DD/YYYY")),e.model.set("collectionTime","0:00"),e.model.set("immediateCollectionTime","0:00"),e.model.set("collectionDateTime","TODAY")},disableAllFields:function(e,t){e.$(".availableLabTests").trigger("control:disabled",t),e.$(".urgency").trigger("control:disabled",t),e.model.get("howOftenAlwaysDisabled")===!0?e.$(".howOften").trigger("control:disabled",!0):e.$(".howOften").trigger("control:disabled",t),e.$(".howLong").trigger("control:disabled",t),e.$(".collectionType").trigger("control:disabled",t),e.$(".collectionDateTimePicklist").trigger("control:disabled",t),e.$(".collectionDate").trigger("control:disabled",t),e.$(".collectionTime").trigger("control:disabled",t),e.$(".specimen").trigger("control:disabled",t),e.$(".otherSpecimen").trigger("control:disabled",t),e.$(".collectionSample").trigger("control:disabled",t),e.$(".otherCollectionSample").trigger("control:disabled",t),e.$(".anticoagulant").trigger("control:disabled",t),e.$(".sampleDrawnAt").trigger("control:disabled",t),e.$(".additionalComments").trigger("control:disabled",t),e.$(".immediateCollection").trigger("control:disabled",t),e.$(".immediateCollectionDate").trigger("control:disabled",t),e.$(".immediateCollectionTime").trigger("control:disabled",t),e.$(".orderComment").trigger("control:disabled",t),e.$(".doseDate").trigger("control:disabled",t),e.$(".doseTime").trigger("control:disabled",t),e.$(".drawDate").trigger("control:disabled",t),e.$(".drawTime").trigger("control:disabled",t)},save:function(e,t){var o={contentType:"application/json"};if("edit"===$("#acceptDrpDwnContainer").attr("action")){var l=ADK.UserService.getUserSession().get("site");e.url="/resource/write-health-data/patient/"+e.get("pid")+"/orders/"+e.get("orderId")+"?site="+l+"&pid="+e.get("pid"),e.set("id",1)}else e.url="/resource/write-health-data/patient/"+e.get("pid")+"/orders?pid="+e.get("pid");e.save(o,t)},discontinue:function(e,t){var o=ADK.PatientRecordService.getCurrentPatient().get("visit").localId,l={contentType:"application/json",data:JSON.stringify({kind:"Laboratory",location:o,orderId:e.get("orderId"),pid:e.get("pid"),provider:e.get("provider")})};l=$.extend(l,t),e.destroy(l)},processExistingLabOrder:function(e){var t=e.model.get("existingOrder");if(t&&t.length>0){var o,l,i,r,a,h;if(t.forEach(function(t){switch(t.keyId){case c:o=t.valueName;break;case s:var T=t.valueName.split("\r\n");if(T&&T.length>0){var C="";T.forEach(function(t){if(""!==t)if(-1!==t.indexOf("~For Test:"))e.model.set("forTest",t);else if(-1!==t.indexOf("~Last dose:")){var o=t.replace("~Last dose: ","").split(" draw time: ");if(o.length>0){var l=o[0],i=n(l);e.model.set("doseDate",i.date),e.model.set("doseTime",i.time)}if(o.length>1){var r=o[1],a=n(r);e.model.set("drawDate",a.date),e.model.set("drawTime",a.time)}}else-1!==t.indexOf("~ANTICOAGULANT:")?e.model.set("anticoagulant",t.replace("~ANTICOAGULANT: ","")):-1!==t.indexOf("~Dose is expected to be at")?(e.model.set("sampleDrawnAt",t),C="sampleDrawnAt"):"sampleDrawnAt"===C?e.model.set("additionalComments",t):e.model.set("orderComment",t.substring(1))})}break;case d:collectionTypeId=t.valueId;break;case m:l=t.valueId;break;case g:i=t.valueId;break;case u:r=t.valueId;break;case p:a=t.valueId;break;case f:h=t.valueId}}),collectionTypeId)switch(e.model.set("collectionType",collectionTypeId),collectionTypeId){case"SP":case"WC":if("TODAY"===o)e.model.set("collectionDate",moment().format("MM/DD/YYYY")),e.model.set("collectionTime","0:00"),e.model.set("collectionDateTime","TODAY");else{var T=n(o);e.model.set("collectionDate",T.date),e.model.set("collectionTime",T.time)}break;case"LC":e.model.set("collectionDateTimePicklist","L"+o);break;case"I":var C=n(o);e.model.set("immediateCollectionDate",C.date),e.model.set("immediateCollectionTime",C.time)}h&&e.model.set("urgency",h),l&&e.model.set("howOften",l),i&&e.model.set("howLong",i),r&&("-1"===e.model.get("collectionSample")?e.model.set("otherCollectionSample",r):e.model.set("collectionSample",r)),a&&("-1"===e.model.get("specimen")?e.model.set("otherSpecimen",a):e.model.set("specimen",a)),e.$(".availableLabTests").trigger("control:disabled",!1),e.model.unset("existingOrder")}},retrieveCollectionTypesUrgencyAndSchedules:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){o.data.forEach(function(e){switch(e.categoryName){case"Collection Types":t.model.set("collectionTypeListCache",e.values);break;case"Default Urgency":var o=[];e.values.forEach(function(e){o.push({ien:e.code,name:e.name})}),t.model.set("urgencyListCache",o),t.model.set("urgencyDefaultCache",e["default"].code);break;case"Schedules":t.model.set("howOftenListCache",e.values),t.model.set("howOftenDefaultCache",e["default"].code);break;case"Lab Collection Times":t.model.set("collectionDateTimeLC",e.values);break;case"Ward Collection Times":t.model.set("collectionDateTimeWC",e.values);break;case"Send Patient Times":t.model.set("collectionDateTimeSP",e.values)}})}},l=ADK.UserService.getUserSession().get("site"),i="/resource/write-pick-list?site="+l+"&type=lab-order-dialog-def",r=e.Model.extend({url:i,parse:function(e){return e.data}}),n=new r;n.fetch(o)},retrieveOrderableItems:function(t){t.$(".availableLabTests").trigger("control:disabled",!0);var o={error:function(e,t){console.log(t)},success:function(e,o){r(t,"typeahead","availableLabTests",o.data),t.model.get("orderId")||t.$(".availableLabTests").trigger("control:disabled",!1)}},l=ADK.UserService.getUserSession().get("site"),i="/resource/write-pick-list?type=lab-order-orderable-items&labType=S.LAB&site="+l,n=e.Model.extend({url:i,parse:function(e){return e.data}}),a=new n;a.fetch(o)},retrieveExisting:function(t){t.$(".acceptDrpDwnContainer").find("button").attr("disabled",!0).addClass("disabled");var o={error:function(e,t){console.log(t)},success:function(e,o){t.model.set("existingOrder",o.data.items);var l;o.data.items.forEach(function(e){switch(e.keyId){case a:l=e.valueId}}),$("#acceptDrpDwnContainer").attr("action","edit"),t.model.set("availableLabTests",l)}},l=ADK.PatientRecordService.getCurrentPatient().get("pid"),i=ADK.UserService.getUserSession().get("site"),r="/resource/write-health-data/patient/"+l+"/orders/"+t.model.get("orderId")+"?site="+i,n=e.Model.extend({url:r,parse:function(e){return e.data}}),c=new n;c.fetch(o)},retrieveIen:function(t){var l={error:function(e,t){console.log(t)},success:function(e,l){var i=o.find(l.data,function(e){return e.name==t.model.get("orderName")});t.model.set("ien",i.ien),t.model.set("availableLabTests",i.ien),t.model.set("collectionSample",t.model.orderModel.attributes.collectionSample)}},i="/app/applets/orders/assets/orderableLabTests.json",r=e.Model.extend({url:i,parse:function(e){return e.data}}),n=new r;n.fetch(l)},retrieveOrderableItemLoad:function(t,o){var l=this,i={error:function(e,o){console.log(o),t.hideInProgress()},success:function(e,o){var i,n,a,c,s=o.data,d=!1,m=!1,g=!1,u=!1;s.forEach(function(e){switch(e.categoryName){case"Test Name":t.model.set("labTestText",e["default"].name);break;case"Unique CollSamp":g=!0;break;case"Default CollSamp":i=e["default"].value;break;case"Lab CollSamp":t.model.set("labCanCollect",e["default"].value);break;case"CollSamp":var o,l=[],n="";e.values.forEach(function(e){e.text?n+=e.text:e.ien&&(o&&(""!==n&&(o.text=n,n=""),l.push(o)),o=e)}),""!==n&&(o.text=n),l.push(o),t.model.set("collectionSampleListCache",l),r(t,"select","collectionSample",l),t.$(".collectionSample").trigger("control:disabled",!1),d=!0;break;case"Specimens":t.model.set("specimenListCache",e.values),r(t,"select","specimen",e.values),m=!0;break;case"Default Urgency":a=e["default"].ien;break;case"Urgencies":t.model.set("urgencyList",e.values),u=!0;break;case"OIMessage":e.values.length>0&&t.model.set("alertMessage",e.values[0].text0);break;case"ReqCom":c=e["default"].name}});var p=t.model.get("collectionTypeListCache");if(t.model.get("labCanCollect"))r(t,"select","collectionType",p);else{var f=[];p.forEach(function(e){"LC"!==e.code&&"I"!==e.code&&f.push(e)}),r(t,"select","collectionType",f)}if(t.model.set("collectionType","SP"),t.$(".collectionType").trigger("control:disabled",!1),c&&l.handleReqCom(t,c),d){var h=t.model.get("collectionSampleListCache");if(i){var T=$.grep(h,function(e){return e.n==i});t.model.set("collectionSample",T[0].ien)}else t.model.set("collectionSample",h[0].ien);t.$(".otherCollectionSampleContainer").trigger("control:hidden",!0)}else r(t,"select","collectionSample",[{ien:"-1",name:"Other"}]),t.$(".otherCollectionSampleContainer").trigger("control:hidden",!1),t.$(".collectionSample").trigger("control:disabled",!1),t.$(".otherCollectionSample").trigger("control:required",!0),t.model.set("collectionSample","-1");g&&t.$(".collectionSample").trigger("control:disabled",!0),m&&(n&&t.model.set("specimen",n),t.$(".otherSpecimenContainer").trigger("control:hidden",!0)),u||t.model.set("urgencyList",t.model.get("urgencyListCache")),r(t,"select","urgency",t.model.get("urgencyList")),a?t.model.set("urgency",a):t.model.set("urgency",t.model.get("urgencyDefaultCache")),t.$(".urgency").trigger("control:disabled",!1),r(t,"select","howOften",t.model.get("howOftenListCache")),t.model.get("howOftenDefaultCache")&&t.model.set("howOften",t.model.get("howOftenDefaultCache")),t.$(".specimen").trigger("control:disabled",!1),t.model.get("existingOrder")&&l.processExistingLabOrder(t),t.hideInProgress(),t.$(".acceptDrpDwnContainer").find("button").attr("disabled",!1).removeClass("disabled")}},n=ADK.UserService.getUserSession().get("site"),a="/resource/write-pick-list?site="+n+"&type=lab-sample-specimen-urgency&labTestIEN="+o,c=e.Model.extend({url:a,async:!1,parse:function(e){return e.data}}),s=new c;s.fetch(i)},retrieveAllCollectionSamples:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){o.data.forEach(function(e){"CollSamp"===e.categoryName&&(r(t,"typeahead","otherCollectionSample",e.values),t.$(".otherCollectionSample").trigger("control:disabled",!1))})}},l=ADK.UserService.getUserSession().get("site"),i="/resource/write-pick-list?site="+l+"&type=lab-all-samples",n=e.Model.extend({url:i,parse:function(e){return e.data}}),a=new n;a.fetch(o)},retrieveAllSpecimens:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){r(t,"typeahead","otherSpecimen",o.data),t.$(".otherSpecimen").trigger("control:disabled",!1)}},l=ADK.UserService.getUserSession().get("site"),i="/resource/write-pick-list?site="+l+"&type=lab-order-specimens",n=e.Model.extend({url:i,parse:function(e){return e.data}}),a=new n;a.fetch(o)},retrieveImmediateCollection:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){console.log("Immediate Collection:"),console.log(o);var l=[],i=0;o.data.forEach(function(e){e["text"+i]&&l.push(e["text"+i]),i++}),t.model.set("immediateCollection",l)}},l=ADK.UserService.getUserSession().get("site"),i="/resource/write-pick-list?site="+l+"&type=lab-collect-times",r=e.Model.extend({url:i,parse:function(e){return e.data}}),n=new r;n.fetch(o)},retrieveMaxDays:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){console.log(o),-1===o.data.value?t.model.set("howOftenAlwaysDisabled",!0):(t.model.set("howOftenAlwaysDisabled",!1),t.$(".howOften").trigger("control:disabled",!1))}},l=ADK.UserService.getUserSession().get("site"),i=ADK.PatientRecordService.getCurrentPatient().get("visit").localId,r="/resource/write-pick-list?site="+l+"&type=lab-order-max-days-continuous&location="+i+"&schedule=0",n=e.Model.extend({url:r,parse:function(e){return e.data}}),a=new n;a.fetch(o)},generateInputList:function(e){var t="-1"!==e.get("collectionSample").toString()?e.get("collectionSample").toString():e.get("otherCollectionSample").toString(),o="-1"!==e.get("specimen").toString()?e.get("specimen").toString():e.get("otherSpecimen").toString(),l=e.get("collectionDateTime"),r=e.get("collectionDate"),n=e.get("collectionTime");if("TODAY"!==l&&(l="0:00"!==n&&"00:00"!==n?i.getFilemanDateTime(new Date(r+" "+n)):i.getFilemanDate(new Date(r))),"LC"===e.get("collectionType").toString()&&"LO"===e.get("collectionDateTimePicklist")){var s=e.get("futureLabCollectDate")+" "+e.get("futureLabCollectTime");l=i.getFilemanDateTime(new Date(s))}else if("LC"===e.get("collectionType").toString())l=e.get("collectionDateTimePicklist").length>0?e.get("collectionDateTimePicklist").substr(1):"";else if("I"===e.get("collectionType").toString()){var h=e.get("immediateCollectionDate")+" "+e.get("immediateCollectionTime");l=i.getFilemanDateTime(new Date(h))}var T=[{inputKey:a,inputValue:e.get("availableLabTests").toString()},{inputKey:u,inputValue:t},{inputKey:p,inputValue:o},{inputKey:f,inputValue:e.get("urgency").toString()},{inputKey:d,inputValue:e.get("collectionType").toString()},{inputKey:c,inputValue:l},{inputKey:m,inputValue:e.get("howOften").toString()}];return e.get("howLong")&&""!==e.get("howLong")&&T.push({inputKey:g,inputValue:e.get("howLong").toString()}),T},generateCommentList:function(e){var t=[];return e.model.get("forTest")&&t.push({comment:e.model.get("forTest")}),e.model.get("sampleDrawnAt")&&t.push({comment:e.model.get("sampleDrawnAt")}),e.model.get("additionalComments")&&t.push({comment:e.model.get("additionalComments")}),e.model.get("anticoagulantText")&&t.push({comment:e.model.get("anticoagulantText")}),e.model.get("orderCommentText")&&t.push({comment:e.model.get("orderCommentText")}),e.model.get("doseDrawText")&&t.push({comment:e.model.get("doseDrawText")}),t},setSpecimenToOther:function(e){r(e,"select","specimen",[{ien:"-1",name:"Other"}]),e.model.set("specimen","-1"),e.$(".otherSpecimenContainer").trigger("control:hidden",!1),e.$(".otherSpecimen").trigger("control:required",!0)},handleCollectionType:function(e){switch(e.$(".immediateCollectionContainer").trigger("control:hidden",!0),e.$(".collectionDateTimePicklist").trigger("control:hidden",!0),e.$(".collectionDate").trigger("control:hidden",!0),e.$(".collectionTime").trigger("control:hidden",!0),e.$(".collectionDate").trigger("control:required",!1),e.$(".collectionTime").trigger("control:required",!1),e.$(".collectionDateTimePicklist").trigger("control:required",!1),e.$(".futureLabCollectTimesContainer").trigger("control:hidden",!0),e.model.get("collectionType")){case"WC":e.$(".collectionDate").trigger("control:hidden",!1),e.$(".collectionTime").trigger("control:hidden",!1),e.$(".collectionDate").trigger("control:disabled",!1),e.$(".collectionTime").trigger("control:disabled",!1),e.$(".collectionDate").trigger("control:required",!0),e.$(".collectionTime").trigger("control:required",!0);break;case"LC":e.model.get("collectionDateTimeLC")&&e.model.get("collectionDateTimeLC").length>0&&(r(e,"select","collectionDateTimePicklist",e.model.get("collectionDateTimeLC")),e.model.set("collectionDateTimePicklist",e.model.get("collectionDateTimeLC")[0].code)),e.$(".collectionDateTimePicklist").trigger("control:hidden",!1),e.$(".collectionDateTimePicklist").trigger("control:disabled",!1),e.$(".collectionDateTimePicklist").trigger("control:required",!0);break;case"SP":e.$(".collectionDate").trigger("control:hidden",!1),e.$(".collectionTime").trigger("control:hidden",!1),e.$(".collectionDate").trigger("control:disabled",!1),e.$(".collectionTime").trigger("control:disabled",!1),e.$(".collectionDate").trigger("control:required",!0),e.$(".collectionTime").trigger("control:required",!0);break;case"I":e.$(".immediateCollectionContainer").trigger("control:hidden",!1),e.$(".immediateCollection").trigger("control:disabled",!1),e.$(".immediateCollectionDate").trigger("control:disabled",!1),e.$(".immediateCollectionTime").trigger("control:disabled",!1)}},handleCollectionDateTime:function(e){var t=e.model.get("collectionDate");"0:00"!==e.model.get("collectionTime")&&"00:00"!==e.model.get("collectionTime")&&(t+=" "+e.model.get("collectionTime"));var o=i.getFilemanDateTime(new Date(t));e.model.set("collectionDateTime",o)},handleFutureLabCollectDate:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){t.$(".futureLabCollectInProgress").trigger("control:hidden",!0);var l,i=[];o.data.forEach(function(e){if(-1!==e.indexOf("-1"))t.model.set("futureLabCollectErrorMessage",e.replace("-1^",""));else{t.$(".futureLabCollectTime").trigger("control:hidden",!1);var o=e.substr(0,2),r=e.substr(2,2),n=o+":"+r,a=" Collection: "+n;a=parseInt(o)<12?"AM"+a:"PM"+a,i.push({label:a,value:n}),l||(l=n)}}),r(t,"select","futureLabCollectTime",i),t.model.set("futureLabCollectTime",l),t.$(".futureLabCollectTime").trigger("control:size",i.length)}};t.model.unset("futureLabCollectErrorMessage"),r(t,"select","futureLabCollectTime",[]),t.$(".futureLabCollectTime").trigger("control:size",1),t.$(".futureLabCollectInProgress").trigger("control:hidden",!1);var l=i.getFilemanDate(new Date(t.model.get("futureLabCollectDate"))),n=ADK.UserService.getUserSession().get("site"),a=ADK.PatientRecordService.getCurrentPatient().get("visit").localId,c="/resource/write-health-data/labSupportData?site="+n+"&type=lab-collect-times&dateSelected="+l+"&location="+a,s=e.Model.extend({url:c,parse:function(e){return e.data}}),d=new s;d.fetch(o)},validateImmediateCollectDateTime:function(t){if("I"===t.model.get("collectionType")){var o={error:function(e,o){t.model.set("errorMessage","[Immediate Collection Times] - Error occurred validating."),t.model.set("immediateCollectionIsComplete",!0)},success:function(e,o){"1"!==o.data[0].isValid&&t.model.set("errorMessage","[Immediate Collection Times] - "+o.data[0].validationMessage),t.model.set("immediateCollectionIsComplete",!0)}},l=i.getFilemanDateTime(new Date(t.model.get("immediateCollectionDate")+" "+t.model.get("immediateCollectionTime"))),r=ADK.UserService.getUserSession().get("site"),n="/resource/write-health-data/labSupportData?site="+r+"&type=lab-valid-immediate-collect-time&timestamp="+l,a=e.Model.extend({url:n,parse:function(e){return e.data}}),c=new a;c.fetch(o)}},validateHowLong:function(t){var o={error:function(e,t){console.log(t)},success:function(e,o){var l=o.data.value;if(-1!==t.model.get("howLong").toLowerCase().indexOf("x")){var i=$.grep(t.model.get("howOftenListCache"),function(e){return e.code===t.model.get("howOften")});if(i[0]){var r=parseInt(i[0].frequency),n=r/1440*parseInt(t.model.get("howLong").toLowerCase().replace("x","")),a=1440*l/r,c=r/60;if(n>l){var s="For this frequency, the maximum number of times allowed is: X"+a+" (Every "+c+" hours for a maximum of "+l+" days.)";t.model.set("errorMessage","[How Long] - "+s)}}}else t.model.get("howLong")==parseInt(t.model.get("howLong"))&&parseInt(t.model.get("howLong"))>l&&t.model.set("errorMessage","[How Long] - Maximum number of days allowed is "+l);t.model.set("howLongIsComplete",!0)}},l=ADK.UserService.getUserSession().get("site"),i=ADK.PatientRecordService.getCurrentPatient().get("visit").localId,r=t.model.get("howOften"),n="/resource/write-pick-list?site="+l+"&type=lab-order-max-days-continuous&location="+i+"&schedule="+r,a=e.Model.extend({url:n,parse:function(e){return e.data}}),c=new a;c.fetch(o)},handleCollectionDateTimePicklist:function(e){e.$(".futureLabCollectTimesContainer").trigger("control:hidden",!0),e.$(".futureLabCollectTime").trigger("control:hidden",!0),e.$(".futureLabCollectDate").trigger("control:required",!1),e.$(".futureLabCollectTime").trigger("control:required",!1),"LO"===e.model.get("collectionDateTimePicklist")&&(e.$(".futureLabCollectTimesContainer").trigger("control:hidden",!1),e.$(".futureLabCollectDate").trigger("control:required",!0),e.$(".futureLabCollectTime").trigger("control:required",!0),e.model.set("futureLabCollectDate",moment().format("MM/DD/YYYY")))},handleUrgency:function(e){if(e.model.get("urgencyList")){var t=$.grep(e.model.get("urgencyList"),function(t){return t.ien===e.model.get("urgency")||t.code===e.model.get("urgency")});t&&t[0]&&e.model.set("urgencyText",t[0].name)}},handleSpecimen:function(e){this.updateSpecimenText(e)},handleCollectionSample:function(e){var t=e.model.get("collectionSampleListCache");if(t){var o=$.grep(t,function(t){return t.ien==e.model.get("collectionSample")});if(o.length>0){o[0].text&&e.model.set("alertMessage",o[0].text),o[0].unused1&&""!==o[0].unused1&&this.handleReqCom(e,o[0].unused1),o[0].unused2&&""!==o[0].unused2&&this.handleReqCom(e,o[0].unused2),o[0].unused3&&""!==o[0].unused3&&this.handleReqCom(e,o[0].unused3);var l=e.model.get("specimenListCache");e.$(".otherSpecimen").trigger("control:required",!1),""===o[0].specPtr?this.setSpecimenToOther(e):l?(r(e,"select","specimen",l),e.model.set("specimen",o[0].specPtr),e.model.set("specimenText",o[0].specName),e.$(".otherSpecimenContainer").trigger("control:hidden",!0)):(r(e,"select","specimen",[{ien:o[0].specPtr,name:o[0].specName}]),e.model.set("specimen",o[0].specPtr),e.model.set("specimenText",o[0].specName),e.$(".otherSpecimenContainer").trigger("control:hidden",!0))}this.updateCollectionSampleText(e)}else this.setSpecimenToOther(e)},handleHowOften:function(e){var t=$.grep(e.model.get("howOftenListCache"),function(t){return t.code===e.model.get("howOften")});t&&t[0]&&("O"===t[0].frequencyType?(e.$(".howLong").trigger("control:disabled",!0),e.model.unset("howLong"),e.$(".howLong").trigger("control:required",!1)):(e.$(".howLong").trigger("control:disabled",!1),e.$(".howLong").trigger("control:required",!0)),e.model.set("howOftenText",t[0].name))},handleReqCom:function(e,t){switch(e.model.set("reqCom",t),t){case"ANTICOAGULATION":e.$(".anticoagulant").trigger("control:hidden",!1),e.$(".anticoagulant").trigger("control:disabled",!1);break;case"TDM (PEAK-TROUGH)":e.$(".sampleDrawnAtContainer").trigger("control:hidden",!1),e.$(".sampleDrawnAt").trigger("control:disabled",!1),e.$(".sampleDrawnAt").trigger("control:required",!0),e.$(".additionalCommentsContainer").trigger("control:hidden",!1),e.$(".additionalComments").trigger("control:disabled",!1);break;case"DOSE/DRAW TIMES":e.$(".doseContainer").trigger("control:hidden",!1),e.$(".doseDate").trigger("control:disabled",!1),e.$(".doseTime").trigger("control:disabled",!1),e.model.set("doseTime","0:00"),e.$(".drawContainer").trigger("control:hidden",!1),e.$(".drawDate").trigger("control:disabled",!1),e.$(".drawTime").trigger("control:disabled",!1),e.model.set("drawTime","0:00");break;case"ORDER COMMENT":e.$(".orderComment").trigger("control:hidden",!1),e.$(".orderComment").trigger("control:disabled",!1)}},handleDoseDrawTimes:function(e){var t="",o="";e.model.get("doseDate")&&(e.model.set("forTest","~For Test: "+e.model.get("labTestText")),t="~Last dose: "+e.model.get("doseDate")+" "+e.model.get("doseTime")),e.model.get("drawDate")?(e.model.set("forTest","~For Test: "+e.model.get("labTestText")),o="  draw time: "+e.model.get("drawDate")+" "+e.model.get("drawTime")):e.model.get("doseDate")&&(o="  draw time: UNKNOWN"),e.model.set("doseDrawText",t+o)},handleDoseDate:function(e){var t=e.model.get("doseDate");t!==moment().format("MM/DD/YYYY")&&e.model.set("doseTime","00:00")},handleDoseTime:function(e){e.model.get("doseTime")&&"00:00"!==e.model.get("doseTime")&&"0:00"!==e.model.get("doseTime")&&e.model.set("doseDate",moment().format("MM/DD/YYYY"))},handleDrawDate:function(e){var t=e.model.get("drawDate");t!==moment().format("MM/DD/YYYY")&&e.model.set("drawTime","00:00")},handleDrawTime:function(e){e.model.get("drawTime")&&"00:00"!==e.model.get("drawTime")&&"0:00"!==e.model.get("drawTime")&&e.model.set("drawDate",moment().format("MM/DD/YYYY"))},handleOrderComment:function(e){e.model.set("forTest","~For Test: "+e.model.get("labTestText")),e.model.set("orderCommentText","~"+e.model.get("orderComment"))},handleSampleDrawnAt:function(e){e.model.set("forTest","~For Test: "+e.model.get("labTestText"))},handleAnticoagulant:function(e){e.model.set("forTest","~For Test: "+e.model.get("labTestText")),e.model.set("anticoagulantText","~ANTICOAGULANT: "+e.model.get("anticoagulant"))},handleAlertMessage:function(e,t){t&&e.model.set("alertMessage",t)},updateSpecimenText:function(e){e.model.get("specimen")&&-1!=e.model.get("specimen")?e.model.set("specimenText",e.$(".specimen").find("select").find(":selected").text()):e.model.set("specimenText",e.$(".otherSpecimen").find("#otherSpecimen").val())},updateCollectionSampleText:function(e){e.model.get("collectionSample")&&"-1"!==e.model.get("collectionSample")?e.model.set("collectionSampleText",e.$(".collectionSample").find("select").find(":selected").text()):e.model.set("collectionSampleText",e.$(".otherCollectionSample").find("#otherCollectionSample").val())}};return h});