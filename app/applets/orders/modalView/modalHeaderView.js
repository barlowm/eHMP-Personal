define(["main/ADK","backbone","marionette","underscore","handlebars","hbs!app/applets/orders/modalView/headerTemplate","app/applets/orders/writeback/writebackUtils"],function(e,t,r,i,s,o,l){"use strict";var n=t.Marionette.ItemView.extend({template:s.compile(["<h4>Order</h4>","<p>{{summary}}</p><br/>","{{#if orderCheck}}<h4>Order Check</h4>",'<div class="well">{{orderCheck}}</div>{{/if}}'].join("\n"))}),a=function(e){var t=i.contains(["UNRELEASED","UNSIGNED"],e)?"":"disabled";return t},d=t.Marionette.ItemView.extend({template:s.compile(['{{ui-button "Cancel" classes="btn-default alert-cancel" title="Click to cancel"}}','{{ui-button "Discontinue Order" classes="btn-danger alert-continue" title="Click to Discontinue" }}'].join("\n")),events:{"click .alert-cancel":"alertCancel","click .alert-continue":"alertContinue"},alertCancel:function(){e.UI.Alert.hide()},alertContinue:function(){var r=new t.Model({id:1}),i=e.PatientRecordService.getCurrentPatient(),s=e.UserService.getUserSession(),o=s.get("site"),n=s.get("duz")[o],a=this.model.attributes.orderNumber+";1",d="/resource/write-health-data/patient/"+i.get("pid")+"/orders/"+a+"?site="+o+"&pid="+i.get("pid");r.url=d,r.set({orderId:a}),r.set({pid:i.get("pid")}),r.set("provider",n),r.set("location","23");var c={error:function(e,t){console.log("error resp: "+t)},success:function(t,r){$('div[data-appletid="orders"] .applet-refresh-button').trigger("click"),e.UI.Alert.hide(),e.UI.Modal.hide()}};l.discontinue(r,c)}});return t.Marionette.ItemView.extend({template:o,events:{"click #orders-previous, #orders-next":"navigateResults","keydown #orders-previous, #orders-next":"accessibility","click #orders-change-order":"openOrdersPopup","click #orders-discontinue-order":"showAlert","click #orders-sign-order":"openOrderSummary"},modelEvents:{change:"render"},accessibility:function(e){32===e.keyCode&&this.$("#"+e.currentTarget.id).trigger("click")},showAlert:function(r){r.preventDefault();var i=this,o=i.model.get("localId")+";1",l=this.model.get("statusName"),a=e.UserService.getUserSession().get("site"),c=this.model.get("pid"),u="/resource/write-health-data/patient/"+c+"/orders/detail/"+o+"?site="+a+"&pid="+c,h=new t.Model({});h.set("summary",this.model.attributes.summary),h.url=u;var m={error:function(e,t){console.log(t)},success:function(r,o){var a=o.data[0],c=a.substring(a.search("Current Status:"),a.length).split("\r")[0].split(" "),u=c[c.length-1];if(l!==u){r.set("errorMessage","- connot be discontinued."),"CANCELLED"===u?(r.set("errorTitle","DELETED: "+h.get("summary")),r.set("errorReason","This order has been deleted.")):(r.set("errorTitle",h.get("summary")),r.set("errorReason","Lab orders that have been collected may not be discontinued!"));var m=t.Marionette.ItemView.extend({template:s.compile(["<h4>{{errorTitle}}</h4>","<h6>{{errorMessage}}</h6>","<h6>Reason: {{errorReason}}</h6>"].join("\n")),model:r}),p=new e.UI.Alert({title:"Unable to Discontinue",messageView:m,footerView:t.Marionette.ItemView.extend({template:s.compile('{{ui-button "OK" classes="btn-primary" title="Click button to close."}}'),tagName:"span",events:{"click .btn-primary":function(){e.UI.Alert.hide(),e.UI.Workflow.hide()}}})});p.show()}else{var g=a.substring(a.search("Order Checks:"),a.length).split("\n"),b=g[1].trim();b&&r.set("orderCheck",b);var v=new e.UI.Alert({title:"DISCONTINUE/CANCEL ORDERS",messageView:n.extend({model:r}),footerView:d.extend({model:i.model})});v.show()}}};h.fetch(m)},openOrdersPopup:function(r){r.preventDefault();var i=e.utils.appletUtils.getAppletView("orders","writeback"),s=new t.Model;s.orderModel=this.model;var o={size:"large",title:"Edit a Lab Test",showProgress:!1,keyboard:!0,steps:[{view:i,viewModel:s,stepTitle:"Step 1"}]},l=new e.UI.Workflow(o);l.show()},openOrderSummary:function(e){e.preventDefault()},navigateResults:function(e){if("orders-previous"===e.currentTarget.id)this.modelIndex>0&&(this.modelIndex--,this.pageable?this.currentModel=this.collection.fullCollection.at(this.modelIndex):this.currentModel=this.collection.at(this.modelIndex),this.currentModel.attributes.enableOrDisableClass=a(this.currentModel.attributes.statusName),this.model.clear(),this.model.set(this.currentModel.attributes));else{var t=this.pageable?this.collection.fullCollection.length-1:this.collection.length-1;this.modelIndex<t&&(this.modelIndex++,this.pageable?this.currentModel=this.collection.fullCollection.at(this.modelIndex):this.currentModel=this.collection.at(this.modelIndex),this.currentModel.attributes.enableOrDisableClass=a(this.currentModel.attributes.statusName),this.model.clear(),this.model.set(this.currentModel.attributes))}this.$("#"+e.currentTarget.id).focus()}})});