define(["main/ADK","underscore","backbone","marionette","moment","app/applets/orders/modalView/modalContentView","app/applets/orders/modalView/modalHeaderView","hbs!app/applets/orders/list/orderDateTemplate","hbs!app/applets/orders/list/orderStatusTemplate","hbs!app/applets/orders/list/siteTemplate","hbs!app/applets/orders/list/startDateTemplate","hbs!app/applets/orders/list/stopDateTemplate","hbs!app/applets/orders/list/orderSummaryTemplate","app/applets/orders/toolBar/toolBarView","hbs!app/applets/orders/toolBar/ordersFilterTemplate","app/applets/orders/detailCommunicator","app/applets/orders/util","app/applets/orders/writeback/addOrders","app/applets/visit/writeback/addselectVisit"],function(e,t,i,r,s,a,l,n,o,d,p,c,m,u,h,v,g,f,w){"use strict";var b,M,S,y,k,T,A,C,D,x,I,V,R,L,O,N,P,F,_,E;D={name:"statusName",label:"Status",cell:"handlebars",template:o,hoverTip:"orders_status"},x={name:"name",label:"Order",cell:"string",hoverTip:"orders_order"},M={name:"summary",label:"Order",cell:"handlebars",template:m,hoverTip:"orders_order"},O={name:"summary",label:"Order",cell:"string",hoverTip:"orders_order"},I={name:"entered",label:"Order Date",cell:"handlebars",template:n,hoverTip:"orders_orderdate"},N={name:"start",label:"Start Date",cell:"handlebars",template:p,hoverTip:"orders_startdate"},P={name:"stop",label:"Stop Date",cell:"handlebars",template:c,hoverTip:"orders_stopdate"},V={name:"kind",label:"Type",cell:"string",hoverTip:"orders_type"},F={name:"nurse",label:"Nurse",cell:"string"},_={name:"clerk",label:"Clerk",cell:"string"},E={name:"chart",label:"Chart",cell:"string"},R={name:"facilityMoniker",label:"Facility",cell:"handlebars",template:d,hoverTip:"orders_facility"},L={name:"providerDisplayName",label:"Provider Name",cell:"string",hoverTip:"orders_providername"},b=[I,D,M,R],S=[I,D,O,V,L,N,P,R],y="patient-record-order",T=e.AppletViews.GridView;var H=i.Model.extend({defaults:{service:"ALL",kind:"All",show:!0}}),U=i.Collection.extend({model:H}),W=new U([{service:"ALL",kind:"All",show:!0},{service:"GMRA",kind:"Allergy/Adverse Reaction",show:!1},{service:"GMRC",kind:"Consult",show:!0},{service:"FH",kind:"Dietetics Order",show:!0},{service:"LR",kind:"Laboratory",show:!0},{service:"PSIV",kind:"Medication, Infusion",show:!0},{service:"PSJ",kind:"Medication, Inpatient",show:!0},{service:"PSH",kind:"Medication, Non-VA",show:!0},{service:"PSO",kind:"Medication, Outpatient",show:!0},{service:"OR",kind:"Text Order",show:!0},{service:"RA",kind:"Radiology",show:!0},{service:"GMRV",kind:"Vitals",show:!1}]),Y=i.Model.extend({defaults:{service:"ALL"}});A=T.extend({className:"app-size-2",initialize:function(r){var n,o,d,p,c,m,h,v,M,A,C,D,x,I={};if(v={resourceTitle:y,cache:!1,pageable:!0},this.expandedAppletId=this.options.appletConfig.instanceId,this.options.appletConfig.fullScreen){this.parentWorkspace=e.Messaging.request("get:current:workspace");var V=e.SessionStorage.get.sessionModel("expandedAppletId");t.isUndefined(V)||t.isUndefined(V.get("id"))||(this.expandedAppletId=V.get("id"))}x=e.SessionStorage.getAppletStorageModel(this.expandedAppletId,"activeMenuItem",!0,this.parentWorkspace)||"ALL",void 0===this.sharedModel&&(this.sharedModel=new Y({service:x})),p=function(t){var i=this;x=t.get("service"),M='nin("service",['+D.toString()+"])";this.listenTo(e.Messaging,"globalDate:selected",function(e){i.dateRangeRefresh("entered",{customFilter:M})}),"ALL"!==x?e.utils.filterCollectionByValue(h,"service",x):e.utils.resetCollection(h),this.refresh()},this.listenTo(this.sharedModel,"change:service",p),k=T.prototype;var R=this;if(void 0===e.SessionStorage.getAppletStorageModel(this.options.appletConfig.instanceId,"excludeMenuItems",!0,this.parentWorkspace)){D=[];for(var L=0;L<W.models.length;L++)W.models[L].get("show")||D.push(W.models[L].get("service"));e.SessionStorage.setAppletStorageModel(this.options.appletConfig.instanceId,"excludeMenuItems",D,!0,this.parentWorkspace)}else D=e.SessionStorage.getAppletStorageModel(this.options.appletConfig.instanceId,"excludeMenuItems",!0,this.parentWorkspace);M='nin("service",['+D.toString()+"])",A="and("+this.buildJdsDateFilter("entered")+',nin("service",['+D.toString()+"]))";this.listenTo(e.Messaging,"globalDate:selected",function(e){R.dateRangeRefresh("entered",{customFilter:M})}),c=function(e){return e.filter(function(e){return-1===D.indexOf(e.get("service"))?(e.set(g.parseOrderResponse(e.attributes,x)),!0):!1})},v.criteria={filter:A},v.collectionConfig={comparator:function(e){var t=s().diff(s(e.get("entered"),"YYYYMMDDHHmmssSSS"));return[e.get("kind"),t]},collectionParse:c},v.onSuccess=function(t){"ALL"!==x&&e.utils.filterCollectionByValue(t,"service",x)},h=e.PatientRecordService.fetchCollection(v),n=new u({instanceId:r.appletConfig.instanceId,collection:this.collection,menuItems:W,sharedModel:this.sharedModel,expandedAppletId:this.expandedAppletId,parentWorkspace:this.parentWorkspace}),C=this,d=function(t){t.preventDefault();var r=(e.utils.appletUtils.getAppletView("orders","writeback"),new i.Model),s=new i.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),a={size:"large",title:"Order a Lab Test",showProgress:!1,keyboard:!0,steps:[]},l=e.PatientRecordService.getCurrentPatient().get("visit");l||a.steps.push({view:w,viewModel:s}),a.steps.push({view:f,viewModel:r});var n=new e.UI.Workflow(a);n.show()},m=function(e){var i=t.contains(["UNRELEASED","UNSIGNED"],e)?"":"disabled";return i},o=function(t,s){var n=i.Model.extend({});t.attributes.enableOrDisableClass=m(t.attributes.statusName);var o=new n(t.attributes),d=this.collection.indexOf(t),p=new a({model:o,collection:I.collection,modelIndex:d,pageable:!r.appletConfig.fullScreen}),c={size:"normal",title:t.get("summary")};c.headerView=l.extend({model:o,theView:p,collection:I.collection,modelIndex:d,pageable:!r.appletConfig.fullScreen});var u=new e.UI.Modal({view:p,options:c});u.show(),this.model=t},I={summaryColumns:b,fullScreenColumns:S,enableModal:!0,toolbarView:n,collection:h,onClickRow:o,onClickAdd:d,filterFields:["statusName","summary","enteredFormatted","kind","providerDisplayName","facilityMoniker"],filterDateRangeEnabled:!0,filterDateRangeField:{name:"entered",label:"Date",format:"YYYYMMDD"},formattedFilterFields:{entered:function(e,t){var i=e.get(t);return i=i.replace(/(\d{4})(\d{2})(\d{2})/,"$2/$3/$1")}}},"summary"===this.columnsViewType?I.columns=b:"expanded"===this.columnsViewType&&(I.columns=S),this.appletOptions=I,k.initialize.apply(this,arguments)},onRender:function(){k.onRender.apply(this,arguments)}}),C={id:"orders",viewTypes:[{type:"summary",view:A.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:A.extend({columnsViewType:"expanded"}),chromeEnabled:!0},{type:"writeback",view:f,chromeEnabled:!1}],defaultViewType:"summary"};var z=e.Messaging.getChannel(C.id);return z.reply("detailView",function(t){var r={criteria:{uid:t.uid},patient:new i.Model({icn:t.patient.icn,pid:t.patient.pid}),resourceTitle:"uid",viewModel:{parse:AppletHelper.parseLabResponse}},s=$.Deferred(),a=e.PatientRecordService.fetchCollection(r);return a.on("sync",function(){var e=a.first(),t=function(t){s.resolve({view:t,title:AppletHelper.getModalTitle(e)})},i=function(e){s.reject(e)};AppletUiHelper.getDetailView(e,null,a,!1,t,i)},this),s.promise()}),v.initialize(C.id,y),C});