var MR_Hchart;define(["backbone","marionette","underscore","moment","highcharts","app/applets/medication_review/medicationCollectionHandler","hbs!app/applets/medication_review/charts/graphTemplate","app/applets/medication_review/charts/chartHelper"],function(e,t,a,r,o,s,n,i){var l=e.Marionette.ItemView.extend({template:n,opChart:null,events:{"click .mr_reset":"mr_buttonReset"},initialize:function(){this.model=new e.Model;var t=this;ADK.Messaging.getChannel("medication_review").on("chartData_ready",function(){t.model.clear(),t.model.set(s.allGraphMedications.models)})},getTemplate:function(){return s.allGraphMedications.models.length<=0?a.template('<div id="medicationsAccordion" class="panel-group"><span class="col-layout-md"><strong>No Records </strong></span><div id="graphContainer" class="hidden"></div><div>'):n},mr_buttonReset:function(){MR_Hchart.xAxis[0].setExtremes(null,null),MR_Hchart.yAxis[0].setExtremes(null,null),MR_Hchart.setSize(MR_Hchart.originalSize.width,MR_Hchart.originalSize.height,!1),MR_Hchart.zoomMode=!1,$(".mr_reset").hide()},onRender:function(){$.isEmptyObject(this.model.attributes)||(this.showChart(),$(".mr_reset").hide())},onBeforeDestroy:function(){ADK.Messaging.getChannel("medication_review").off("chartData_ready")},modelEvents:{change:"render"},toTitleCase:function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},showChart:function(){for(var e=this.model.attributes,t=[],a=[],n=[],l=[],Y=0;Y<s.allGraphMedications.models.length;Y++){var d=e[Y],m=d.attributes.meds.models;void 0!==d.attributes.subcategory?this.category=this.toTitleCase(d.attributes.name)+" - "+d.attributes.subcategory:this.category=this.toTitleCase(d.attributes.name),t[Y]={Medication:this.category,data:[],plotLines:[],medType:m[0].get("groupType")},t[Y].data[0]={id:"orders",index:0,legendIndex:0,name:"Order",color:"rgba(183, 220, 237, 0.5)",lineWidth:20,marker:{enabled:!1},intervals:[]},t[Y].data[1]={id:"fills",index:1,legendIndex:1,name:"Fill",color:"rgba(1, 152, 117, 0.7)",lineWidth:12,lineColor:"rgba(1, 152, 117, 0.7)",shadow:!0,marker:{enabled:!1},intervals:[]},t[Y].data[2]={index:2,legendIndex:2,name:"Order",lineWidth:0,showInLegend:!0,linkedTo:"orders",marker:{symbol:"circle",enabled:!0,radius:10,fillColor:"rgba(183, 220, 237, 0.7)",lineColor:"rgba(183, 220, 237, 0.7)"},intervals:[]},t[Y].data[3]={index:3,legendIndex:3,name:"Fill",lineWidth:0,linkedTo:"fills",showInLegend:!0,marker:{enabled:!0,symbol:"circle",radius:6,fillColor:"rgba(1, 152, 117, 0.7)",lineColor:"rgba(1, 152, 117, 0.7)"},intervals:[]},t[Y].data[4]={index:4,legendIndex:4,name:"Discontinued",marker:{symbol:"square",enabled:!0,fillColor:"rgba(159, 26, 8, 0.7)",radius:4},intervals:[]},t[Y].data[5]={index:5,legendIndex:5,name:"Expired",marker:{symbol:"diamond",enabled:!0,radius:3,fillColor:"rgba(0, 0, 0, 0.7)",lineColor:"rgba(0, 0, 0, 0.7)"},intervals:[]},t[Y].data[6]={index:6,legendIndex:6,name:"Hold",lineWidth:20,color:"rgba(227, 227, 229, 0.3)",marker:{enabled:!1},intervals:[]};var D=e[Y].attributes.meds.models[0].get("groupType"),p=D.indexOf("O"),M=D.indexOf("N"),g=D.indexOf("I");0===p&&a.push({medication:this.category,type:"O"}),0===M&&l.push({medication:this.category,type:"N"}),0===g&&n.push({medication:this.category,type:"I"});for(var h=0;h<m.length;h++){var f,c,u,v,H,C,y,b,T,S,U,x,I,_,w=m[h].get("fills");m[h].get("dosages");14===m[h].get("overallStart").length?(f=r(m[h].get("overallStart"),"YYYYMMDDHHmmss").format("YYYY"),c=r(m[h].get("overallStart"),"YYYYMMDDHHmmss").format("MM"),u=r(m[h].get("overallStart"),"YYYYMMDDHHmmss").format("DD")):12===m[h].get("overallStart").length?(f=r(m[h].get("overallStart"),"YYYYMMDDHHmm").format("YYYY"),c=r(m[h].get("overallStart"),"YYYYMMDDHHmm").format("MM"),u=r(m[h].get("overallStart"),"YYYYMMDDHHmm").format("DD")):(f=r(m[h].get("overallStart"),"YYYYMMDD").format("YYYY"),c=r(m[h].get("overallStart"),"YYYYMMDD").format("MM"),u=r(m[h].get("overallStart"),"YYYYMMDD").format("DD")),14===m[h].get("overallStop").length?(b=r(m[h].get("overallStop"),"YYYYMMDDHHmmss").format("YYYY"),T=r(m[h].get("overallStop"),"YYYYMMDDHHmmss").format("MM"),S=r(m[h].get("overallStop"),"YYYYMMDDHHmmss").format("DD")):12===m[h].get("overallStop").length?(b=r(m[h].get("overallStop"),"YYYYMMDDHHmm").format("YYYY"),T=r(m[h].get("overallStop"),"YYYYMMDDHHmm").format("MM"),S=r(m[h].get("overallStop"),"YYYYMMDDHHmm").format("DD")):(b=r(m[h].get("overallStop"),"YYYYMMDD").format("YYYY"),T=r(m[h].get("overallStop"),"YYYYMMDD").format("MM"),S=r(m[h].get("overallStop"),"YYYYMMDD").format("DD"));var O=f+""+c+u,R=b+""+T+S;if(R>O?t[Y].data[0].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(b,T-1,S)}):O===R&&(w.length>0?(v=r(w[0].dispenseDate,"YYYYMMDD").format("YYYY"),H=r(w[0].dispenseDate,"YYYYMMDD").format("MM"),y=r(w[0].dispenseDate,"YYYYMMDD").format("DD"),void 0!==w[0].daysSupplyDispensed?1===w[0].daysSupplyDispensed?t[Y].data[2].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(b,T-1,S)}):w[0].daysSupplyDispensed>1&&(C=r.duration({days:w[0].daysSupplyDispensed}),_=r([v,H,y]).add(C),t[Y].data[0].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(_.year(),_.months()-1,_.days())})):t[Y].data[0].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(b,T-1,S)})):t[Y].data[0].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(b,T-1,S)})),void 0!==m[h].get("stopped")&&(14===m[h].get("stopped").length?(U=r(m[h].get("stopped"),"YYYYMMDDHHmmss").format("YYYY"),x=r(m[h].get("stopped"),"YYYYMMDDHHmmss").format("MM"),I=r(m[h].get("stopped"),"YYYYMMDDHHmmss").format("DD")):12===m[h].get("stopped").length?(U=r(m[h].get("stopped"),"YYYYMMDDHHmm").format("YYYY"),x=r(m[h].get("stopped"),"YYYYMMDDHHmm").format("MM"),I=r(m[h].get("stopped"),"YYYYMMDDHHmm").format("DD")):(U=r(m[h].get("stopped"),"YYYYMMDD").format("YYYY"),x=r(m[h].get("stopped"),"YYYYMMDD").format("MM"),I=r(m[h].get("stopped"),"YYYYMMDD").format("DD")),("DISCONTINUED"===m[h].get("vaStatus").toUpperCase()||"DISCONTINUED/EDIT"===m[h].get("vaStatus").toUpperCase())&&t[Y].data[4].intervals.push({from:Date.UTC(U,x-1,I),to:Date.UTC(U,x-1,I)}),"EXPIRED"===m[h].get("vaStatus").toUpperCase()&&t[Y].data[5].intervals.push({from:Date.UTC(U,x-1,I),to:Date.UTC(U,x-1,I)}),"HOLD"===m[h].get("vaStatus").toUpperCase()&&t[Y].data[6].intervals.push({from:Date.UTC(f,c-1,u),to:Date.UTC(b,T-1,S)})),w.length>0)for(var E=0;E<w.length;E++){var N,k,A;if(14===w[E].dispenseDate.length?(N=r(w[E].dispenseDate,"YYYYMMDDHHmmss").format("YYYY"),k=r(w[E].dispenseDate,"YYYYMMDDHHmmss").format("MM"),A=r(w[E].dispenseDate,"YYYYMMDDHHmmss").format("DD")):12===w[E].dispenseDate.length?(N=r(w[E].dispenseDate,"YYYYMMDDHHmm").format("YYYY"),k=r(w[E].dispenseDate,"YYYYMMDDHHmm").format("MM"),A=r(w[E].dispenseDate,"YYYYMMDDHHmm").format("DD")):(N=r(w[E].dispenseDate,"YYYYMMDD").format("YYYY"),k=r(w[E].dispenseDate,"YYYYMMDD").format("MM"),A=r(w[E].dispenseDate,"YYYYMMDD").format("DD")),void 0===w[E].daysSupplyDispensed)t[Y].data[3].intervals.push({from:Date.UTC(N,k-1,A),to:Date.UTC(N,k-1,A)});else{fillDuration=r.duration({days:w[E].daysSupplyDispensed});var L=r([N,k,A]).add(fillDuration);t[Y].data[1].intervals.push({from:Date.UTC(N,k-1,A),to:Date.UTC(L.year(),L.months()-1,L.days())})}}}}$.each(t,function(e,t){a.length>0&&a[0].medication===t.Medication&&a[0].type===t.medType&&t.plotLines.push({label:{text:"OUTPATIENT"}}),n.length>0&&n[0].medication===t.Medication&&n[0].type===t.medType&&t.plotLines.push({label:{text:"INPATIENT"}}),l.length>0&&l[0].medication===t.Medication&&l[0].type===t.medType&&t.plotLines.push({label:{text:"NON-VA"}})});var z=i.returnChartOptions(t.reverse()),W=setInterval(function(){$("#graphContainer")&&(clearInterval(W),MR_Hchart=new o.Chart(z.outpatientChartOptions))},500)}});return l});