define(["app/applets/medication_review/appletHelper"],function(e){function t(){var t={defaults:{fillsAllowed:"Unk"},parse:function(t){return e.parseMedResponse(t)}};return t}var a=Backbone.Model.extend({initialize:function(){var e=this.get("type").toUpperCase();"O"===e?this.set("type","Outpatient"):"I"===e?this.set("type","Inpatient"):"N"===e&&(this.set("type","Non-VA"),this.set("isNonVa","true"))}}),r=Backbone.Model.extend({}),i={initialized:!1,fetchAllMeds:function(){var e=ADK.SessionStorage.getModel("globalDate"),a=this,r={resourceTitle:"patient-record-med",cache:!1,criteria:{},viewModel:t()};r.onSuccess=function(e,t){a.resetCollections()};var i=ADK.utils.formatDate(e.get("fromDate"),"YYYYMMDD","MM/DD/YYYY");if(e.get("fromDate")&&"null"!==e.get("fromDate"))r.criteria.filter='or(gte(overallStart,"'+i+'"),gte(lastFilled,"'+i+'"),gte(lastAdmin,"'+i+'"))';else if("all-range-global"===e.get("selectedId"))r.criteria.filter="";else if("custom-range-apply-global"===e.get("selectedId")){var n=(ADK.utils.formatDate(e.get("customFromDate"),"YYYYMMDD","MM/DD/YYYY"),ADK.utils.formatDate(e.get("customToDate"),"YYYYMMDD","MM/DD/YYYY"));r.criteria.filter='and(or(gte(overallStart,"'+i+'"),gte(lastFilled,"'+i+'"),gte(lastAdmin,"'+i+'")),lte(overallStop,"'+n+'"))'}this.allMedications=ADK.PatientRecordService.fetchCollection(r);var l=function(e){var t=e.toUpperCase();switch(t){case"PENDING":return 1;case"ACTIVE":return 2;case"SUSPEND":return 2;case"HOLD":return 2;case"EXPIRED":return 3;case"DISCONTINUED/EDIT":return 4;case"DISCONTINUED":return 5;case"COMPLETE":return 6;default:return 100}};this.allMedications.comparator=function(e,t){var a=["O","Supplies","N","Clinic Orders","I"],r=l(e.get("vaStatus")),i=l(t.get("vaStatus")),n=e.get("name"),o=t.get("name"),s=e.get("groupType"),c=t.get("groupType"),u=a.indexOf(s),g=a.indexOf(c);return e===t?0:u===g?r==i?n===o?e.get("overallStart")<t.get("overallStart")?1:e.get("overallStart")>t.get("overallStart")?-1:0:n>o?1:o>n?-1:0:r>i?1:-1:g>u?-1:1}},initCollections:function(){this.allMedGroups=new Backbone.Collection,this.allGraphMedications=new Backbone.Collection,this.initialized=!0},resetCollections:function(){var e=this.allMedications.groupBy(function(e){return e.get("groupType")}),t=_.map(e,function(e,t){return new a({type:t,isNonVa:!1,meds:new Backbone.Collection(e)})});this.allMedGroups.reset(t);var i=this.allMedications.filter(function(e){return"Clinic Orders"!==e.get("groupType")&&"Supplies"!==e.get("groupType")}),n=_.groupBy(i,function(e){if(e.get("qualifiedName"))return e.get("qualifiedName")+e.get("facilityName")+e.get("groupType");var t=e.get("name").split(",");return t=t[0].split(" "),t[0]+e.get("facilityName")}),l=_.map(n,function(e,t){return new r({name:e[0].get("name"),meds:new Backbone.Collection(e)})});this.allGraphMedications.reset(l),ADK.Messaging.getChannel("medication_review").trigger("chartData_ready")}};return i});