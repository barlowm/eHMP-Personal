define(["backbone","marionette","moment","app/applets/search/searchUtil","hbs!app/applets/search/templates/searchTemplate","hbs!app/applets/search/templates/searchSuggestTemplate","hbs!app/applets/search/templates/searchResultTemplate","hbs!app/applets/search/templates/searchResultGroupTemplate","jquery.inputmask","bootstrap-datepicker","underscore"],function(e,t,a,r,s,i,o,l,n,c,h){var u=(e.Model.extend({defaults:{}}),null),d=null,m=e.Marionette.ItemView.extend({util:r,template:s,searchSuggestTemplate:i,searchResultTemplate:o,searchResultGroupTemplate:l,isSearching:null,suggestResults:{},suggestionsLocked:!1,lastQuery:"",drillDownCount:0,totalResults:0,fromDate:null,toDate:null,searchTerm:null,initialize:function(){var e=this,t=ADK.SessionStorage.getAppletStorageModel("search","searchText");this.clearDateFilters(),this.listenTo(ADK.Messaging.getChannel("search"),"newSearch",function(){if(t=ADK.SessionStorage.getAppletStorageModel("search","searchText")){if(e.searchTerm=t.searchTerm,e.filterType=ADK.SessionStorage.getAppletStorageModel("search","filterType"),"all"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#all-range-text-search").addClass("active-range");else if("2y"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#2yr-range-text-search").addClass("active-range");else if("1y"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#1yr-range-text-search").addClass("active-range");else if("3m"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#3mo-range-text-search").addClass("active-range");else if("1m"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#1mo-range-text-search").addClass("active-range");else if("7d"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#7d-range-text-search").addClass("active-range");else if("72hr"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#72hr-range-text-search").addClass("active-range");else if("24hr"===e.filterType)e.$(".active-range").removeClass("active-range"),e.$("#24hr-range-text-search").addClass("active-range");else if("custom"===e.filterType){e.$(".active-range").removeClass("active-range");var a=ADK.SessionStorage.getAppletStorageModel("search","customDates");this.toDate=moment(a.toDate).format("MM/DD/YYYY"),this.fromDate=moment(a.fromDate).format("MM/DD/YYYY"),$("#fromDateText").datepicker("update",e.fromDate),$("#toDateText").datepicker("update",e.toDate)}e.doSubmitSearch()}})},onRender:function(e){this.formatDates()},events:{"keydown #searchtext":"onSearchTextKey","keydown #suggestList a":"onSuggestionKey","click #submit":"doSubmitSearch","keydown .text-search-accessible":"onAccessibilityKeydown","click .searchResultItem":"onSelectSearchResult","click #search-results-header .badge":"onSelectFilter","show.bs.collapse .collapse":"onExpandGroup","hide.bs.collapse .collapse":"onCollapseGroup","click #all-range-text-search":"doAllDateFilter","click #24hr-range-text-search":"do24HrDateFilter","click #72hr-range-text-search":"do72HrDateFilter","click #7d-range-text-search":"do7DDateFilter","click #1mo-range-text-search":"do1MDateFilter","click #3mo-range-text-search":"do3MDateFilter","click #1yr-range-text-search":"do1YDateFilter","click #2yr-range-text-search":"do2YDateFilter","click #custom-range-apply":"doCustomDateFilter","focus #fromDateText":"hideFromCalendar","focus #toDateText":"hideToCalendar","click #fromCalendar":"showFromCalendar","click #toCalendar":"showToCalendar","keyup input":"monitorCustomDateRange","blur input":"monitorCustomDateRange","change input":"monitorCustomDateRange"},doSubmitSearch:function(){var e={criteria:{query:this.searchTerm}};e.patient=ADK.PatientRecordService.getCurrentPatient(),e.resourceTitle="patient-record-search-text",this.searchResults=ADK.PatientRecordService.fetchCollection(e),this.preSearchTime=(new Date).getTime(),this.listenTo(this.searchResults,"sync",this.fillSearchResultsTemplate),this.suggestionsLocked=!0,$("#searchSpinner").show()},fillSearchResultsTemplate:function(){var e=[],t=(new Date).getTime(),a=((t-this.preSearchTime)/1e3,this),r=$("#searchResults"),s=0,i=[],o={};r.empty(),this.searchResults.forEach(function(e){var t=e.attributes.kind;e.attributes.type,e.attributes.where,(e.attributes.summary||"").replace("\n",""),e.attributes.uid;"undefined"!=typeof e.attributes.count?s+=parseInt(e.attributes.count,10):s++,t&&(o[t]?o[t].push(e):o[t]=[e])}),this.totalResults=s;var l={},n=0;for(var c in o){var u=o[c],d=c.replace(/[^a-zA-Z0-9]/g,""),m="result-group-"+d,p=this.addSearchResultElementHighlighting(c),g=$(a.searchResultGroupTemplate({groupName:p,titleElemId:"result-group-title-"+d,groupId:m,subGroupClass:"mainGroup dataFetched",mainGroup:"mainGroupIndent"})),D=g.find("#"+m+" .groupContent");i=[];for(var f=0;f<u.length;f++){n++;var v=u[f],y=v.attributes.where,b=(v.attributes.summary||"").replace("\n",""),S=v.attributes.uid,C=a.util.doDatetimeConversion(v.attributes.datetime),T="1",x="";if("undefined"!=typeof v.attributes.count&&(T=v.attributes.count.toString()),"undefined"!=typeof v.attributes.highlights)for(var F=v.attributes.highlights,Y=0;Y<F.length;Y++){var R=F[Y].toString().replace(/\uFFFD/g,"");x=x+"... "+R+" ...<br>"}var k=v.get("kind").toLowerCase();"laboratory"===k&&void 0!==v.get("observed")&&(C=a.util.doDatetimeConversion(v.get("observed")));var M=v.get("type"),A="pathology"===k||"surgical pathology"===k||"microbiology"===k;if((A||"document"===M||"problem"===M)&&T>1){var w="",G=b;"problem"===M&&(G=v.attributes.icd_code);var I=M;"surgical pathology"===k&&(I=k,G=v.attributes.group_name);var K=b.replace(/[^a-zA-Z0-9]/g,""),_=l[K]=(l[K]||0)+1,E="result-subGroup-"+K+"-"+_,H=this.addSearchResultElementHighlighting(b),P=a.searchResultGroupTemplate({groupName:H,titleElemId:"result-subGroup-title-"+K+"-"+_,groupId:E,count:T.toString(),subGroup:!0,subGroupType:I,groupOnText:G,subGroupItems:w,subGroupClass:"topLevelItem documentSubgroup dataUnfetched",datetime:C});i.push({item:P,sortText:b.toString()})}else{var L=b;void 0!==v.attributes.problem_status&&(L=v.attributes.problem_status+":"+b,void 0!==v.attributes.acuity_name&&(L=v.attributes.problem_status+"("+v.attributes.acuity_name+"): "+b));var O=this.addSearchResultElementHighlighting(L),U=this.addSearchResultElementHighlighting(v.attributes.kind),B=a.searchResultTemplate({Class:"topLevelItem searchResultItem text-search-accessible searchResultItemFilterable",resultId:n,uid:S.toString(),count:T.toString(),summary:O,highlights:x,datetime:C,domain:U,facility:y,basicResult:!0,singleResult:!0});i.push({item:B,sortText:b.toString()})}}for(var V=h.sortBy(i,"sortText"),q=0;q<V.length;q++)D.append(V[q].item);var z=c.toString();e.push({group:g,sortText:z})}for(var j=h.sortBy(e,"sortText"),N=0;N<e.length;N++)r.append(j[N].group);var Z=ADK.SessionStorage.getAppletStorageModel("search","filterType");if("all"===Z)this.doAllDateFilter();else if("2y"===Z)this.do2YDateFilter();else if("1y"===Z)this.do1YDateFilter();else if("3m"===Z)this.do3MDateFilter();else if("1m"===Z)this.do1MDateFilter();else if("7d"===Z)this.do7DDateFilter();else if("72hr"===Z)this.do72HrDateFilter();else if("24hr"===Z)this.do24HrDateFilter();else if("custom"===Z){var Q=ADK.SessionStorage.getAppletStorageModel("search","customDates");this.toDate=moment(Q.toDate).format("MM/DD/YYYY"),this.fromDate=moment(Q.fromDate).format("MM/DD/YYYY"),$("#fromDateText").datepicker("update",this.fromDate),$("#toDateText").datepicker("update",this.toDate),this.doCustomDateFilter()}else this.doAllDateFilter();$("#searchSpinner").hide()},getDocumentDrilldownData:function(e,t,a){var r=this.searchTerm,s="local_title";"problem"===a&&(s="icd_code"),("result"===a||"lab"===a)&&(s="qualified_name_units"),"surgical pathology"===a&&(s="group_name");var i={criteria:{query:r,"group.field":s,"group.value":e},cache:!0},o=this;i.onSuccess=function(e,a){o.drillDownCount++;var r=a.data.items.results,s="";"undefined"!==a.data.items.highlights&&(s=a.data.items.highlights);for(var i=0;i<r.length;i++){var l=r[i],n=l.facility_name,c=l.author_display_name,u=l.problem_status,d=l.uid,m=l.signer_display_name,p="";datetime=o.util.doDatetimeConversion(l.datetime),null!==datetime&&""!==datetime&&"Unknown"!==datetime||void 0===l.observed||(datetime=o.util.doDatetimeConversion(l.observed)),void 0!==l.problem_status&&(u=o.addSearchResultElementHighlighting(l.problem_status)),"undefined"===s[d].body||h.isEmpty(s[d])||(p="<p>..."+s[d].body.join(" ... </p><p>...")+"...</p>");var g=o.searchResultTemplate({Class:"subgroupItem searchResultItem text-search-accessible searchResultItemFilterable",resultId:"subgroupItem"+i.toString(),uid:d.toString(),datetime:datetime,count:1,name:c,problemStatus:u,signer:m||c,facility:n,highlights:p,basicResult:!0});t=t.append(g)}t.find($(".subgroupDataFetchSpinner")).hide(),o.refreshDateFilter()},i.patient=ADK.PatientRecordService.getCurrentPatient(),i.resourceTitle="patient-record-search-detail-document",ADK.PatientRecordService.fetchCollection(i)},checkforSubGroups:function(e){var t=e.attr("groupOnText"),a=e.attr("subGroupType"),r=e.find($(".groupContent"));this.getDocumentDrilldownData(t.toString(),r,a),e.removeClass("dataUnfetched"),e.removeClass("searchResultItemFilterable"),e.addClass("dataFetched")},addSearchResultElementHighlighting:function(e){var t=ADK.SessionStorage.getAppletStorageModel("search","searchText").searchTerm.toString().toLowerCase(),a=e.toString().toLowerCase();if(a.indexOf("<"+t+">")<=-1&&a.indexOf(t)>-1){var r=a.indexOf(t),s=r+t.length,i=e.substring(r,s),o=e;return o=o.replace(i,'<mark class="cpe-search-term-match">'+i+"</mark>")}return e},handleResultEvent:function(){},hideToCalendar:function(){this.$("#toDateText").datepicker("remove")},hideFromCalendar:function(){this.$("#fromDateText").datepicker("remove")},showFromCalendar:function(){this.$("#fromDateText").datepicker("show"),this.$("#toDateText").datepicker("remove"),this.formatDates()},showToCalendar:function(){this.$("#toDateText").datepicker("show"),this.$("#fromDateText").datepicker("remove"),this.formatDates()},doDateFilterCommon:function(e,t,a,r){this.fromDate=e,this.toDate=moment(),"all"===a?this.doDateFilter(!0,null,null):this.doDateFilter(!1),this.$(".active-range").removeClass("active-range"),this.$(t).addClass("active-range"),this.clearDateFilters(),ADK.SessionStorage.setAppletStorageModel("search","filterType",a),ADK.SessionStorage.setAppletStorageModel("search","modalOptions",{selectedId:r})},doAllDateFilter:function(){this.doDateFilterCommon(moment().subtract("years",100),"#all-range-text-search","all","all-range")},do2YDateFilter:function(){this.doDateFilterCommon(moment().subtract("years",2),"#2yr-range-text-search","2y","2yr-range")},do1YDateFilter:function(){this.doDateFilterCommon(moment().subtract("years",1),"#1yr-range-text-search","1y","1yr-range")},do3MDateFilter:function(){this.doDateFilterCommon(moment().subtract("months",3),"#3mo-range-text-search","3m","3mo-range")},do1MDateFilter:function(){this.doDateFilterCommon(moment().subtract("months",1),"#1mo-range-text-search","1m","1mo-range")},do7DDateFilter:function(){this.doDateFilterCommon(moment().subtract("days",7),"#7d-range-text-search","7d","7d-range")},do72HrDateFilter:function(){this.doDateFilterCommon(moment().subtract("hours",72),"#72hr-range-text-search","72hr","72hr-range")},do24HrDateFilter:function(){this.doDateFilterCommon(moment().subtract("hours",24),"#24hr-range-text-search","24hr","24hr-range")},doCustomDateFilter:function(){this.$(".active-range").removeClass("active-range");var e=this.$("#toDateText").val(),t=this.$("#fromDateText").val(),a=moment(t,"MM/DD/YYYY"),r=moment(e,"MM/DD/YYYY");this.fromDate=a,this.toDate=r,a>r&&(this.fromDate=r,this.toDate=a);var s={fromDate:this.fromDate,toDate:this.toDate};ADK.SessionStorage.setAppletStorageModel("search","filterType","custom"),ADK.SessionStorage.setAppletStorageModel("search","customDates",s),ADK.SessionStorage.setAppletStorageModel("search","modalOptions",{selectedId:"custom-range-apply",customFromDate:moment(this.fromDate).format("MM/DD/YYYY"),customToDate:moment(this.toDate).format("MM/DD/YYYY")}),this.doDateFilter(!1)},parseDateArray:function(e){var t=parseInt(e[2]),a=parseInt(e[0])-1,r=parseInt(e[1]);return new Date(t,a,r)},clearDateFilters:function(){this.$("#fromDateText").val(""),this.$("#toDateText").val(""),this.toggleApplyBtn()},refreshDateFilter:function(){var e=!1,t=ADK.SessionStorage.getAppletStorageModel("search","filterType");"all"===t&&(e=!0),this.doDateFilter(e)},formatDates:function(){this.$("#fromDateText").datepicker({format:"mm/dd/yyyy",forceParse:!1}),this.$("#toDateText").datepicker({format:"mm/dd/yyyy",forceParse:!1}),this.$("#fromDateText").inputmask("m/d/y",{placeholder:"MM/DD/YYYY"}),this.$("#toDateText").inputmask("m/d/y",{placeholder:"MM/DD/YYYY"})},monitorCustomDateRange:function(e){this.toggleApplyBtn()},toggleApplyBtn:function(){this.formatDates(),this.checkCustomRangeCondition()?this.$("#custom-range-apply").removeAttr("disabled"):this.$("#custom-range-apply").prop("disabled",!0)},checkCustomRangeCondition:function(){var e=!0,t=this.$("#fromDateText").val(),a=this.$("#toDateText").val();return moment(t,"MM/DD/YYYY",!0).isValid()||(e=!1),moment(a,"MM/DD/YYYY",!0).isValid()||(e=!1),e},doDateFilter:function(e){for(var t=$("#searchResults .searchResultItemFilterable"),a=0,r=0;r<t.length;++r){var s=$(t[r]),i=s.attr("date")||null;s.css("display");if("none"!==s.css("display")&&(u=s.css("display")),e===!0)s.css("display",u);else{var o=null===i||""===i||"Unknown"===i;if(o)s.css("display",u);else if(null!==i){var l=i.split("-")||"";nextDate=moment(l[0],"MM/DD/YYYY"),"undefined"!==this.fromDate&&null!==this.toDate&&"undefined"!==this.toDate&&(nextDate>=this.fromDate&&nextDate<=this.toDate?s.css("display",u):s.css("display","none"))}else s.css("display","none")}var n=s.attr("count"),c=parseInt(n);s.css("display")!==u&&(a+=c)}var h=this.totalResults-a;this.$("#numberOfResults").html(h.toString()),this.changeEntireSearchResultGroupVisibility()},changeEntireSearchResultGroupVisibility:function(){for(var e=$(".dataFetched"),t=0;t<e.length;t++){var a=0,r=!1,s=$(e[t]),i=s.find(".searchResultItemFilterable");"none"!==s.css("display")&&(d=s.css("display"));for(var o=0;o<i.length;o++){var l=$(i[o]);l.css("display")===d&&(r=!0,a++)}var n=s.find(".badge");n.length>0&&s.hasClass("documentSubgroup")&&n.html(a.toString()),r===!0?s.css("display",d):s.css("display","none")}},onSelectSearchResult:function(e){var t=$(e.target).closest(".searchResultItem"),a=t.attr("data-uid"),r=ADK.PatientRecordService.getCurrentPatient();ADK.Messaging.getChannel("search").trigger("resultClicked",{uid:a,patient:{icn:r.attributes.icn,pid:r.attributes.pid}})},onAccessibilityKeydown:function(e){(32===e.keyCode||13===e.keyCode)&&$(e.target).trigger("click")},onCollapseGroup:function(e){var t=$(e.target).closest(".searchGroup").children(".searchGroupTitle").children(".searchGroupTitleArrow");t.removeClass("fa-chevron-down"),t.addClass("fa-chevron-right")},onExpandGroup:function(e){var t=$(e.target).closest(".searchGroup").children(".searchGroupTitle").children(".searchGroupTitleArrow"),a=$(e.target).closest(".searchGroup");a.hasClass("dataUnfetched")&&this.checkforSubGroups(a),t.removeClass("fa-chevron-right"),t.addClass("fa-chevron-down")}});return m});