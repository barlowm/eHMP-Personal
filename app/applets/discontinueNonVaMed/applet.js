define(["handlebars","hbs!app/applets/discontinueNonVaMed/assets/templates/discontinueTemplate","hbs!app/applets/discontinueNonVaMed/assets/templates/discontinueFooterTemplate","hbs!app/applets/discontinueNonVaMed/assets/templates/discontinueReasonTemplate"],function(e,t,i,n){var o=new ADK.Views.ServerSideError,r=function(e,t){var i=e,n=i.replace("med","order"),o=i.replace("med","patient");o=o.split(":"),o[o.length-1]=o[o.length-2],o=o.join(":"),ADK.PatientRecordService.fetchCollection({resourceTitle:"order-detail",criteria:{dfn:o.split(":")[5],orderId:n.split(":")[5]},onSuccess:function(e){if(!t.isDestroyed){var i=e.get(n.split(":")[5]);t.model.set({nature:i.get("Activity")["Nature of Order"].split("\\r\\n")[0],specialty:i.get("Current Data")["Treating Specialty"],instructions:i.get("Order").Instructions})}}}),ADK.PatientRecordService.fetchCollection({resourceTitle:"patient-record-patient",criteria:{uid:o},viewModel:{idAttribute:"uid"},onSuccess:function(e){if(!t.isDestroyed){var i=e.get(o);t.model.set({patientRecord:i,attending:i.get("teamInfo").attendingProvider.name}),t.render()}}}),ADK.PatientRecordService.fetchCollection({resourceTitle:"patient-record-order",criteria:{uid:n},viewModel:{idAttribute:"uid"},onSuccess:function(e){if(!t.isDestroyed){var i,o=e.get(n);i="undefined"==typeof o.get("clinicians")?"NOT REQUIRED":o.get("clinicians")[0].name,t.model.set({orderRecord:o,orderedBy:o.get("providerDisplayName"),comments:o.get("summary").split("  ")[2],signature:i}),t.render()}}})},s=Backbone.Marionette.CollectionView.extend({childView:Backbone.Marionette.ItemView.extend({template:n}),childViewOptions:function(e,t){e.set({index:t})}}),a=Backbone.Marionette.LayoutView.extend({template:t,regions:{errorContainer:"#error-container",reasonsContainer:"#reasons-container"},initialize:function(){var e,t=ADK.UserService.getUserSession(),i=t.get("duz"),n=this;e="undefined"==typeof i[0]?i[t.get("site")]:i[0];var o=ADK.ResourceService.fetchCollection({resourceTitle:"med-op-data-discontinuereason",onSuccess:function(e){n.isDestroyed||n.render()}});this.model=new Backbone.Model({medication:"LOADING",start:"LOADING",status:"LOADING",location:"LOADING",orderNo:"LOADING",attending:"LOADING",orderedBy:"LOADING",nature:"LOADING",signature:"LOADING",specialty:"LOADING",sig:"LOADING",instructions:"LOADING",comments:"LOADING",patientIen:e,reasonsCollection:o})},events:{'click input[name="reason"]':"updateReason"},onRender:function(){ADK.UserService.hasPermission("remove-patient-med")&&this.pidSiteCode===this.siteCode&&this.reasonsContainer.show(new s({collection:this.model.get("reasonsCollection")}))},showModal:function(t,n){var o=this;this.model.set("name",n.model.get("name").toUpperCase());var s=Backbone.Marionette.ItemView.extend({template:e.compile("<button type='button' class='close' data-dismiss='modal'><span aria-hidden='true'>Ã—</span><span class='sr-only'>Close</span></button><h4 class='modal-title'><span class='text-danger'>Discontinue</span> {{name}}</h4>")});r(n.uid,this),ADK.PatientRecordService.fetchCollection({resourceTitle:"patient-record-med",criteria:{uid:n.uid},viewModel:{idAttribute:"uid"},onSuccess:function(e){var t=e.get(n.uid),r=!1;o.siteCode=ADK.UserService.getUserSession().get("site"),o.pidSiteCode=o.model.get("patientRecord").get("pid")?o.model.get("patientRecord").get("pid").split(";")[0]:"",ADK.UserService.hasPermission("remove-patient-med")&&o.pidSiteCode===o.siteCode&&(r=!0);var a=Backbone.Marionette.ItemView.extend({template:i,events:{"click button.btn-danger":function(){o.save()}},model:new Backbone.Model({data:r})});o.model.set({medRecord:t,medication:t.get("summary"),start:t.get("overallStart"),status:t.get("medStatusName"),sig:t.get("sig"),location:t.get("orders")[0].locationName,orderNo:t.get("uid").split(":").splice(-1)});var d={title:"Discontinue",headerView:s.extend({model:o.model}),footerView:a,callShow:!0},c=new ADK.UI.Modal({view:o,options:d});c.show()}})},updateReason:function(e){this.model.set({reason:e.currentTarget.value}),$("#discontinueSubmit").attr("disabled",!1)},save:function(e){var t=this,i=ADK.PatientRecordService.getCurrentPatient(),n={contentType:"application/json",data:JSON.stringify({isRemove:!0,param:{orderien:this.model.get("orderNo"),ien:this.model.get("patientIen"),locien:this.model.get("orderRecord").get("locationUid").split(":").splice(-1),reason:this.model.get("reason"),localId:i.get("localId")}}),success:function(e){var t=ADK.Messaging.getChannel("medicationChannel"),i=t.request("refresh"),n=function(e){var t=e.medicationCollectionHandler;t.fetchAllMeds(),ADK.UI.Modal.hide()};_.delay(i.done,6e3,n)},error:function(e,i){o.addError(i.responseText),t.errorContainer.show(o)}};$("#discontinueSubmit").attr("disabled",!0),$("#discontinueSubmit").html('<i class="fa fa-spinner fa-spin"></i> '+$("#discontinueSubmit").html()),this.model.id="destroy",this.model.url=ADK.ResourceService.buildUrl("write-back-save-nonVA-med-discontinue",{pid:i.get("icn")||i.get("pid")||i.get("id")}),this.model.save(null,n)}}),d={id:"discontinueNonVaMed",hasCSS:!0,getRootView:function(){return a}};return function(){var e=ADK.Messaging.getChannel("medicationChannel");e.reply("discontinueNonVaModal",function(){var e=d.getRootView(),t=$.Deferred();return t.resolve({view:new e}),t.promise()})}(),d});