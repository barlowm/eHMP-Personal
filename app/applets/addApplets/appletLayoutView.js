define(["underscore","backbone","marionette","hbs!app/applets/addApplets/list/appletEditor","app/applets/addApplets/list/appletSelectionSlider","app/applets/addApplets/list/switchboardLayoutView","gridster"],function(e,t,i,r,s,a,o){"use strict";var n=function(){var e=$("#gridster2").find($(".view-switchboard"));if(e.is(":visible")){for(var t=0;2>t;t++)$(e).fadeTo(225,.5).fadeTo(225,1);return!0}return!1},d=t.Marionette.CollectionView,l=t.Marionette.LayoutView.extend({template:r,appletUnderSwitchboard:"",initialize:function(){this.gridster=o;var i=this;this.rightmostWidgetGrid=void 0,this.hoverRow=void 0;var r=new t.Model;r.fetch({url:"app.json",async:!1}),this.maxMoves=r.get("numMovesBeforeSaveUDSConfig"),this.gracePeriod=r.get("saveUDSConfigTimeout"),"number"!=typeof this.maxMoves&&(this.maxMoves=6),"number"!=typeof this.gracePeriod&&(this.gracePeriod=5e3),this.model=new t.Model;var s=ADK.ADKApp[t.history.fragment];this.lastSave.currentScreenModule=s;var a=ADK.UserDefinedScreens.getScreensConfigFromSession();i.screenConfig=e.findWhere(a.screens,{id:s.moduleName}),s.buildPromise.done(function(){var e=ADK.UserDefinedScreens.getGridsterTemplateForEditor(s);e.done(function(e){i.model.set("gridsterTemplate",e),i.render()})});var d=ADK.Messaging.getChannel("addApplets");d.reply("addAppletToGridster",function(t){var r=t.appletId,s=t.appletTitle,a=i.getNextAppletId(),o='<li class="new" data-appletid="'+r+'" data-instanceid="'+a+'" id="'+a+'" data-view-type="default" data-min-sizex="4" data-min-sizey="3" data-max-sizex="8" data-max-sizey="12"><div class="edit-applet fa fa-cog"></div><br>'+s+"</li>";n()||(setTimeout(function(){var e,n,d=t.xPos,l=t.yPos,p=i.getGridsterDimension();0!==$(".dragHere").length?(e=$(".dragHere").attr("data-col"),n=$(".dragHere").attr("data-row"),i.gridster.remove_widget($(".dragHere"))):(e=Math.ceil((d-5*Math.floor(d/(4*p[0]+10)))/(p[0]+10)),1>e&&(e=1),n=Math.ceil(l/25),1>n&&(n=1)),i.gridster.add_widget(o,t.sizeX,t.sizeY,e,n),i.displaySwitchboard(r,a,s,function(){i.gridster.arrange_widgets_no_vertical_clipping(i.gridster.$widgets.toArray()),setTimeout(function(){i.setGridsterBaseDimension()},300)})},0),n()||(i.gridster.arrange_widgets_no_vertical_clipping(i.gridster.$widgets.toArray()),setTimeout(function(){i.setGridsterBaseDimension()},300))),e.isUndefined(i.rightmostWidgetGrid)||(i.rightmostWidgetGrid=void 0)}),d.reply("addAppletPlaceholder",function(t){var r,s=i.setPlaceholderFontSize(),a='<li class="preview-holder dragHere" style="font-size:'+s+'">Drag Applet Here</li>',o=t.hoverOverRow>9?9:t.hoverOverRow,n=4,d=4,l=$(".dragHere");e.isUndefined(i.rightmostWidgetGrid)&&(i.rightmostWidgetGrid=i.get_highest_occupied_col_for_all_rows());var p=i.rightmostWidgetGrid[o-1]+1;if(0===l.length)p=1===o?i.get_possible_col_for_placeholder_in_row(o+(d-1),p,n,d):p,i.gridster.add_widget(a,n,d,p,o);else if(0!==$('#gridster2 [id^="applet-"]').length&&Number(l.attr("data-row"))!==o&&i.hoverRow!==o){var c=i.find_any_widgets_above(o,p);p=i.rightmostWidgetGrid[c-1]+1,r=1===c?i.get_possible_col_for_placeholder_in_row(c+(d-1),p,n,d):i.get_possible_col_for_placeholder_in_row(c,p,n,d),l.attr("data-row",c),l.attr("data-col",r),i.hoverRow=o}}),$(window).on("resize.appletLayoutView",function(){i.setGridsterBaseDimension()})},get_highest_occupied_col_for_all_rows:function(){var e,t=this.gridster.gridmap,i=t[1].length,r=[];for(e=1;i>=e;e++){for(var s=[],a=t.length-1;a>=1;a--)if(this.gridster.is_widget(a,e)){s.push(a);break}var o=Math.max.apply(Math,s);o=o===-(1/0)?0:o,r.push(o)}return r},find_any_widgets_above:function(e,t){var i=e-1;if(1===e)return e;for(i;i>=0;i--)if(this.rightmostWidgetGrid[i-1]>=t||0===i)return i+1},get_possible_col_for_placeholder_in_row:function(e,t,i,r){var s=e,a=t;for(a;t+(i-1)>=a;a++)for(s;e+(r-1)>s;s++){var o=this.gridster.is_widget(a,s);if(o&&!o.hasClass("dragHere"))return this.get_possible_col_for_placeholder_in_row(e,t+1,r,i)}return t},getNextAppletId:function(){var e=0;return console.log("outside"),this.$el.find(".gridsterContainer ul li").not(".gridsterContainer ul .dragHere, .gridsterContainer ul li li").each(function(){console.log("inside");var t=$(this).attr("id"),i=t.indexOf("applet-");if(0===i){var r=parseInt(t.substring(7,t.length));r>e&&(e=r)}}),++e,"applet-"+e},setPlaceholderFontSize:function(){var e="",t=this.gridster.min_widget_width;return e=t>=45?'2.5rem"':t>=23?'2rem"':t>=17?'1.5rem"':"1rem"},regions:{appletSlider:".applet-tray"},events:{"keyup #searchApplets":"filterApplets","keydown #searchApplets":function(e){13==e.which&&(e.preventDefault(),this.filterApplets())},"click .editorTop .clear":"clearFilterText","click #exitEditing":"hideOverlay","click .edit-applet":"editClicked","click .applet-exit-options-button":"closeSwitchboard","keydown .options-box":"handleSpacebarOrEnter","keydown .applet-thumbnail":function(e){if(13===e.which){var t=$(e.currentTarget),i=ADK.Messaging.getChannel("addApplets");i.request("addAppletToGridster",{appletId:t.attr("data-appletid"),appletTitle:t.text(),sizeX:4,sizeY:4,col:4,row:4})}}},handleSpacebarOrEnter:function(e){return 13===e.which||32===e.which?(e.preventDefault(),e.stopPropagation(),$(e.target).click(),!1):void 0},hideOverlay:function(){this.saveGridsterAppletsConfig(!0),ADK.UI.FullScreenOverlay.hide(),ADK.Navigation.navigate(t.history.fragment)},onBeforeShow:function(){this.screenConfig&&$(this.el).find("#screen-title").text(this.screenConfig.title),this.appletSlider.show(new s),this.initGridster()},getSwitchboard:function(e,t,i,r,s){var o={region:t,appletId:e,switchOnClick:!1,appletTitle:i};r&&(o.onChangeView=r),s&&(o.currentView=s);var n=new a(o);return n},editClicked:function(e){var t=this;if(!n()){var i;i=void 0!==$(e.target).parent().attr("data-appletid")?$(e.target).parent():$(e.target).parent().parent();var r=i.attr("data-appletid"),s=i.attr("id"),a=i.find(".applet-title").text(),o=i.attr("data-view-type");i.addClass("bringToFront"),this.addRegions({appletRegion:"#"+s}),d=this.getSwitchboard(r,this.appletRegion,a,function(){t.gridster.arrange_widgets_no_vertical_clipping(t.gridster.$widgets.toArray()),t.setGridsterBaseDimension()},o),this.appletRegion.show(d),this.fixSwitchboardPosition(),$(".view-switchboard").find(".applet-exit-options-button").removeClass("hide"),"expanded"===o?($(".view-switchboard").find("div[data-viewtype='expanded']").addClass("options-box-focus-expanded selected-view"),$(".view-switchboard").find("div[data-viewtype='summary']").removeClass("options-box-focus-summary"),$(".view-switchboard").find("div[data-viewtype='gist']").removeClass("options-box-focus")):"summary"===o?($(".view-switchboard").find("div[data-viewtype='summary']").addClass("options-box-focus-summary selected-view"),$(".view-switchboard").find("div[data-viewtype='gist']").removeClass("options-box-focus"),$(".view-switchboard").find("div[data-viewtype='expanded']").removeClass("options-box-focus-expanded")):($(".view-switchboard").find("div[data-viewtype='expanded']").removeClass("options-box-focus-expanded"),$(".view-switchboard").find("div[data-viewtype='summary']").removeClass("options-box-focus-summary"),$(".view-switchboard").find("div[data-viewtype='gist']").addClass("options-box-focus"))}},displaySwitchboard:function(e,t,i,r){this.addRegions({appletRegion:"#"+t}),d=this.getSwitchboard(e,this.appletRegion,i,r),this.appletRegion.show(d),$("#"+t).addClass("bringToFront"),this.fixSwitchboardPosition()},fixSwitchboardPosition:function(){var e=$("div.view-switchboard"),t=e.offset().left,i=e.offset().left+e.width(),r=$(self).width();if(0>t)e.css("margin-left",Math.abs(t)+"px");else if(i>r){var s=i-r;e.css("right",s/2+"px"),e.css("left","-10px")}},closeSwitchboard:function(e){},saveGridsterAppletsConfig:function(e){var t=ADK.ADKApp.currentScreen.id,i=this.$el.find(".gridsterContainer"),r=ADK.UserDefinedScreens.serializeGridsterScreen(i,t);if(ADK.UserDefinedScreens.getGridsterTemplate(this.lastSave.currentScreenModule)===ADK.UserDefinedScreens.getGridsterTemplate(r))return void(this.lastSave.numMoves=0);this.screenConfig.hasCustomize&&ADK.UserDefinedScreens.setHasCustomize(this.screenConfig.id),ADK.UserDefinedScreens.saveGridsterConfigToSession(r,t);var s=this.getSaveTime(),a=s-this.lastSave.time;this.lastSave.numMoves++,1!==this.lastSave.numMoves||e?(e||a>this.gracePeriod||this.lastSave.numMoves>=this.maxMoves)&&(console.log("  saving GridsterConfig screen: "+t),ADK.UserDefinedScreens.saveGridsterConfig(r,t),this.lastSave.time=s,this.lastSave.numMoves=0,this.lastSave.currentScreenModule=r):this.lastSave.time=s},getGridsterDimension:function(){var e=$(window).width(),t=this.gridster.get_highest_occupied_cell().col;if(1>t)return[40,20];var i=Math.floor(e/t)-10;return i>40&&(i=40),[i,20]},setGridsterBaseDimension:function(){this.gridster.resize_widget_dimensions({widget_base_dimensions:this.getGridsterDimension()}),this.setBoundaryIndicator(),this.$el.find(".gridsterContainer").css({left:"0px",position:"relative"}),this.$el.find("#gridster2").css({left:"10px","float":"left",position:"fixed"})},initGridster:function(){function e(e){var i=parseInt(e.attr("data-sizex")),r=i%2;1===r&&t.gridster.resize_widget(e,i+1)}var t=this;this.gridster=this.$el.find(".gridsterContainer ul").gridster({namespace:"#gridster2",widget_selector:"li",widget_base_dimensions:[40,20],widget_margins:[5,5],helper:"clone",avoid_overlapped_widgets:!0,autogrow_cols:!0,min_cols:100,resize:{enabled:!0,resize:function(t,i,r){e(r)},stop:function(i,r,s){e(s),t.setGridsterBaseDimension(),t.saveGridsterAppletsConfig()}},draggable:{drag:function(e,t){},stop:function(e,i){t.setGridsterBaseDimension(),t.saveGridsterAppletsConfig()}}}).data("gridster"),this.gridster&&(this.setGridsterBaseDimension(),this.$el.find(".gridsterContainer #gridster2").height("380px"))},filterApplets:function(){var e=this.$el.find("#searchApplets").val();this.appletSlider.currentView.filterApplets(e)},clearFilterText:function(){this.$el.find("#searchApplets").val(""),this.filterApplets()},lastSave:{time:0,numMoves:0},getSaveTime:function(){var e=new Date;return e.getTime()},setBoundaryIndicator:function(){var e=ADK.utils.resize.getXSize(self),t=Math.floor($(window).width()/(4*e)),i=3>t?3:t,r=$("#center-region").scrollLeft(),s=$("#center-region").width()-20,a=4*this.getGridsterDimension()[0]+45,o=a*i,n=o/s;ADK.UserDefinedScreens.saveScrollPositionToSession(r),$("#boundaryIndicator").css("width",o+15+"px"),$("#boundaryIndicator").css("left",r*n+"px")},onBeforeDestroy:function(){$(window).off("resize.appletLayoutView")}});return l});