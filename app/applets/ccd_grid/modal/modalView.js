define(["backbone","marionette","underscore","app/applets/ccd_grid/util","hbs!app/applets/ccd_grid/modal/modalSectionsTemplate","hbs!app/applets/ccd_grid/modal/modalFullHtmlTemplate","app/applets/ccd_grid/modal/modalHeaderView"],function(e,t,i,l,o,a,n){"use strict";function r(e){var t=$(".ccdContent");if(t.size()>0){var i=t[0].contentWindow.document,l=e;i.open(),i.write(l),i.close(),$("#ccdContent","display","block")}}function d(e){var t=e.get("fullHtml")?e.get("fullHtml"):"",i=$("iframe.dodContent");if(0===i.size()){var l=new MutationObserver(function(e){e.forEach(function(e){for(var o=0;o<e.addedNodes.length;o++)i=$(e.addedNodes[o]).find("iframe.ccdContent"),i.size()>0&&(l.disconnect(),r(t))})});l.observe($("#modal-region")[0],{childList:!0,attributes:!1,characterData:!0,subtree:!0})}}var c,s=[],u={parse:function(e){return e.name&&(e.localTitle=e.name),e.creationTime?e.referenceDateTime=e.creationTime:e.dateTime&&(e.referenceDateTime=e.dateTime),e.referenceDateDisplay=ADK.utils.formatDate(e.referenceDateTime),""===e.referenceDateDisplay&&(e.referenceDateDisplay="N/A"),e.referenceDateTimeDisplay=ADK.utils.formatDate(e.referenceDateTime,"MM/DD/YYYY - HH:mm"),""===e.referenceDateTimeDisplay&&(e.referenceDateTimeDisplay="N/A"),e.authorList&&(e.authorList.length>0?e.authorList[0].institution&&(e.authorDisplayName=e.authorList[0].institution):e.authorDisplayName="N/A"),e.facilityName="VLER",e}},m=e.Marionette.ItemView.extend({getTemplate:function(){return this.model.get("fullHtml")?a:o},initialize:function(e){var t=this;if(t.model=e.model,t.collection=e.collection,c=e.collection,t.getModelUids(),0===e.initCount){e.initCount++;var o=i.indexOf(s,t.model.get("uid")),a=s[o],r={resourceTitle:"patient-record-vlerdocument",pageable:!0,viewModel:u,cache:!0,criteria:{callType:"vler_modal",vler_uid:a}};r.onSuccess=function(){var e=i.find(f.models,function(e){return e.get("uid")===a}),t=new m({model:e,collection:c}),o={title:l.getModalTitle(e),size:"xlarge",headerView:n.extend({model:e,theView:t})};e.get("fullHtml")&&d(e);var r=new ADK.UI.Modal({view:t,options:o});r.show()};var f=ADK.PatientRecordService.fetchCollection(r)}var v=this.model.get("sections");i.each(v,function(e){e.text=e.text.replace(/\s+/g," ")}),this.model.set("sections",v);var g=ADK.PatientRecordService.getCurrentPatient();this.model.set("fullName",g.get("fullName")),this.model.set("birthDate",g.get("birthDate")),this.model.set("genderName",g.get("genderName")),this.model.set("ssn",g.get("ssn"))},events:{"click .ccdNext":"getNextModal","click .ccdPrev":"getPrevModal"},getNextModal:function(e){var t=i.indexOf(s,this.model.get("uid"))+1;t>=s.length&&(this.getModelUids(),t=0);var o=s[t],a={resourceTitle:"patient-record-vlerdocument",pageable:!0,viewModel:u,cache:!0,criteria:{callType:"vler_modal",vler_uid:o}};a.onSuccess=function(){var e=i.find(r.models,function(e){return e.get("uid")===o}),t=new m({model:e,collection:c}),a={title:l.getModalTitle(e),size:"xlarge",headerView:n.extend({model:e,theView:t})};e.get("fullHtml")&&d(e);var s=new ADK.UI.Modal({view:t,options:a});s.show()};var r=ADK.PatientRecordService.fetchCollection(a)},getPrevModal:function(e){var t=i.indexOf(s,this.model.get("uid"))-1;0>t&&(this.getModelUids(),t=s.length-1);var o=s[t],a={resourceTitle:"patient-record-vlerdocument",pageable:!0,viewModel:u,cache:!0,criteria:{callType:"vler_modal",vler_uid:o}};a.onSuccess=function(){var e=i.find(r.models,function(e){return e.get("uid")===o}),t=new m({model:e,collection:c}),a={title:l.getModalTitle(e),size:"xlarge",headerView:n.extend({model:e,theView:t})};e.get("fullHtml")&&d(e);var s=new ADK.UI.Modal({view:t,options:a});s.show()};var r=ADK.PatientRecordService.fetchCollection(a)},getModelUids:function(){s=[],i.each(c.models,function(e,t){if(e.get("vlerdocument")){var l=c.indexOf(e);i.each(e.get("vlerdocument").models,function(t,i){t.set({inAPanel:!0,parentIndex:l,parentModel:e}),s.push(t.get("uid"))})}else s.push(e.get("uid"))})},setNextPrevModal:function(e){this.showNavHeader&&(e.attributes.navHeader=!0);var t=new m({model:e,collection:c}),i={title:l.getModalTitle(e),size:"xlarge",headerView:n.extend({model:e,theView:t})},o=new ADK.UI.Modal({view:t,options:i});o.show()}});return m});