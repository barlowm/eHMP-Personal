define(["backbone","app/applets/problems/modalView/modalView","app/applets/problems/modalView/modalHeaderView","app/applets/problems/modalView/modalFooterView","app/applets/problems/util","hbs!app/applets/problems/list/tooltip","moment"],function(e,t,i,o,a,r,n){"use strict";var s=ADK.Messaging.getChannel("problems"),l=[],p={parse:function(e){return e=a.getStandardizedDescription(e),e=a.getStatusName(e),e=a.getServiceConnected(e),e=a.getProblemText(e),e=a.getICDCode(e),e=a.getAcuityName(e),e=a.getFacilityColor(e),e=a.getOnsetFormatted(e),e=a.getEnteredFormatted(e),e=a.getUpdatedFormatted(e),e=a.getCommentBubble(e),e=a.getICDName(e),e=a.getTimeSince(e)}},c={fetchOptions:{resourceTitle:"patient-record-problem",pageable:!1,criteria:{filter:'ne(removed, true),eq(statusName,"ACTIVE")'},cache:!1,viewModel:p},enableTileSorting:!0,transformCollection:function(t){function i(e){var t=_.groupBy(e,function(e){return e});return t=_.map(t,function(e,t){return{date:t,count:e.length}})}var o=e.Model.extend({}),s=t;s.comparator=function(e){return-e.get("timeSinceDate")};var p,c,m=t.groupBy(function(e){return a.getProblemGroupByData(e).groupbyValue}),d=ADK.Messaging.request("get:current:screen").config.id,u=(d.indexOf("workspace")>-1,_.map(m,function(e,t){return new o({groupName:t,probs:e,allGroupedComments:[],acuityName:e[0].get("acuityName"),statusName:e[0].get("statusDisplayName"),timeSince:e[0].get("timeSince"),age:e[0].get("age"),timeSinceDateString:e[0].get("timeSinceDateString"),timeSinceText:e[0].get("timeSinceText"),uid:e[0].get("uid"),id:e[0].get("uid").replace(/[:|.]/g,"_"),entered:e[0].get("entered"),documents:e[0].get("documents"),encounters:e[0].get("encounters"),problemText:e[0].get("problemText"),locationName:e[0].get("locationName"),facilityMoniker:e[0].get("facilityMoniker"),pid:e[0].get("pid"),summary:e[0].get("summary"),icdCode:e[0].get("icdCode"),snomedCode:e[0].get("snomedCode"),onsetFormatted:e[0].get("onsetFormatted"),providerDisplayName:e[0].get("providerDisplayName"),facilityName:e[0].get("facilityName"),locationDisplayName:e[0].get("locationDisplayName"),updated:e[0].get("updated"),comments:e[0].get("comments"),timeSinceDate:e[0].get("timeSinceDate"),applet_id:"problems",allGroupedEncounters:[]})}));s.reset(u);for(var g=0;g<s.length;g++){c=0;for(var D=s.at(g),f=0;f<D.get("probs").length;f++){var h=D.get("probs")[f];if(p=[],h.get("comments")&&void 0!==h.get("comments"))for(var Y=0;Y<h.get("comments").length;Y++){var b=h.get("comments")[Y];D.get("allGroupedComments").push(b.comment)}if(h.get("encounters")){for(var y=0;y<h.get("encounters").length;y++){var v=h.get("encounters")[y];p.push(n(v.dateTime,"YYYYMMDD").format("YYYYMMDD")),l.push(n(v.dateTime,"YYYYMMDD").format("YYYYMMDD")),D.get("allGroupedEncounters").push({dateTime:n(v.dateTime,"YYYYMMDD").format("MM/DD/YYYY"),stopCodeName:v.facilityName,problemText:D.get("problemText"),acuity:D.get("acuityName")})}h.set("encouterDates",p)}else p.push(n(D.get("timeSinceDate"),"YYYYMMDD").format("YYYYMMDD")),l.push(n(D.get("timeSinceDate"),"YYYYMMDD").format("YYYYMMDD")),D.get("allGroupedEncounters").push({dateTime:n(D.get("timeSinceDate"),"YYYYMMDD").format("MM/DD/YYYY"),stopCodeName:D.get("facilityMoniker"),problemText:D.get("problemText"),acuity:D.get("acuityName")}),h.set("encouterDates",p);a.sortData({problemGroup:D}),D.set("allGroupedEncounters",D.get("allGroupedEncounters").slice(0,5)),c+=p.length;var M,T,C=i(p),S=0,N=[];l.sort(a.compare);for(var w=0;w<C.length;w++)M=C[w].date,T=C[w].count,T>S&&(S=T),N.push([n(M,"YYYYMMDD").valueOf(),T]);D.set("graphData",{series:N})}D.set("encounterCount",c)}var A,x,O=n.utc().startOf("day").valueOf(),V=n.duration({months:6});return A=n.utc(_.first(l),"YYYY").valueOf(),x=n(O).add(V).valueOf(),s.each(function(e){e.get("graphData").oldestDate=A,e.get("graphData").newestDate=x,e.set("tooltip",r(e))}),s},gistHeaders:{name:{title:"Problem",sortable:!0,sortType:"alphabetical",key:"groupName",hoverTip:"conditions_problem"},acuityName:{title:"Acuity",sortable:!0,sortType:"alphabetical",key:"acuityName",hoverTip:"conditions_acuity"},graph:{title:"",sortable:!1},itemsInGraphCount:{title:"Hx Occurrence",sortable:!0,sortType:"numeric",key:"encounterCount",hoverTip:"conditions_hxoccurance"},age:{title:"Last",sortable:!0,sortType:"date",key:"timeSinceDateString",hoverTip:"conditions_last"}},binningOptions:{barPadding:5,debug:!1},gistModel:[{id:"groupName",field:"groupName"},{id:"allGroupedComments",field:"allGroupedComments"},{id:"encounterCount",field:"encounterCount"},{id:"graph",field:"graph"},{id:"age",field:"age"},{id:"acuityName",field:"acuityName"},{id:"problemText",field:"problemText"}],filterFields:["groupName","problemText","acuityName"]},m=ADK.AppletViews.EventsGistView.extend({initialize:function(e){var r=this;this._super=ADK.AppletViews.EventsGistView.prototype,this.appletOptions={filterFields:c.filterFields,collectionParser:c.transformCollection,gistModel:c.gistModel,gistHeaders:c.gistHeaders,enableTileSorting:c.enableTileSorting,binningOptions:c.binningOptions,collection:ADK.PatientRecordService.fetchCollection(c.fetchOptions),onClickRow:this.onClickRow,showLinksButton:!0},ADK.Messaging.getChannel("problems").on("detailView",function(e){var n=e.model,s=ADK.UserService.getUserSession().get("site"),l=n.get("pid")?n.get("pid").split(";")[0]:"",p=new t({model:n,collection:r.appletOptions.collection}),c=({criteria:{uid:e.uid},patient:ADK.PatientRecordService.getCurrentPatient(),resourceTitle:"patient-record-problem",viewModel:p},$.Deferred(),{title:a.getModalTitle(n),size:"normal",headerView:i.extend({model:n,theView:p}),footerView:o.extend({model:n,onRender:function(){this.$el.find(".problemsTooltip").tooltip()},templateHelpers:function(){return(ADK.UserService.hasPermission("edit-patient-problem")||ADK.UserService.hasPermission("remove-patient-problem"))&&l===s?{data:!0}:{data:!1}}})}),m=new ADK.UI.Modal({view:p,options:c});m.show()}),ADK.UserService.hasPermission("add-patient-problem")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(r.appletOptions.onClickAdd=function(){s.command("addProblem")}),this.appletOptions.collection=ADK.PatientRecordService.fetchCollection(c.fetchOptions),this._super.initialize.apply(this,arguments)},onBeforeDestroy:function(){ADK.Messaging.getChannel("problems").off("detailView")}});return m});