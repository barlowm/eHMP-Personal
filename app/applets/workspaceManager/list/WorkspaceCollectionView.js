define(["underscore","backbone","marionette","gridster","app/applets/workspaceManager/list/problems/associationManagerView","hbs!app/applets/workspaceManager/list/screenEditorRow","hbs!app/applets/workspaceManager/list/problems/associationCounterTemplate"],function(e,t,s,n,i,o,r){"use strict";var a=ADK.Messaging.getChannel("managerAddScreen"),c=t.Marionette.ItemView.extend({template:e.template("<i>No Results</i>"),tagName:"p",className:"bold-font top-margin-sm left-margin-xl"}),l=function(t){for(var s=t.replace(/[^a-zA-Z0-9 ]/g,"").toLowerCase().replace(/\s+/g,"-"),n=e.random(1048576),i=ADK.UserDefinedScreens.getScreensConfigFromSession(),o=!0;o;)d(n,i)?n=e.random(1048576):o=!1;var r={newId:s,newScreenId:n},a=e.filter(i.screens,function(e){return e.id===s});return 0===a.length?r:void console.error("Cannot create a screen ID that already exists: "+s)},d=function(t,s){e.filter(s.screens,function(e){return e.screenId===t})},p=function(t,s){var n=e.isUndefined(t)?s:$(t.currentTarget),i=n.find(".fa-star, .fa-star-o");i.hasClass("fa-star-o")?i.removeClass("fa-star-o").addClass("fa-star madeDefault").siblings("span.sr-only").html("This Workspace is selected as your Default screen."):i.addClass("fa-star-o").removeClass("fa-star madeDefault").siblings("span.sr-only").html("Make Default.")},h=t.Marionette.ItemView.extend({template:r}),g=t.Marionette.LayoutView.extend({template:o,attributes:function(){return this.model.get("predefined")===!0?{"class":"tableRow predefined-screen-row",id:this.model.get("id")}:{"class":"tableRow user-defined","data-screen-id":this.model.get("id"),id:this.model.get("id")}},events:{"click .rearrange-worksheet":"rearrangeWorksheet","click .default-workspace-btn":"makeDefault","click .launch-screen":"launchWorksheet","click .customize-screen":"customizeWorksheet","click .duplicate-worksheet":"clone","submit form.workspace-editor":"handleEnterSubmit","blur .editor-input-element":"saveInlineChange","keyup .editor-input-element":"inlineChangeEvent","focus .editor-title-element":"applyInputMasking"},regions:{associationCounterRegion:".associations-counter-region"},initialize:function(){this.screenOptions={id:this.model.get("id"),screenId:this.model.get("screenId"),routeName:this.model.get("routeName"),title:this.model.get("title"),description:this.model.get("description"),predefined:this.model.get("predefined"),defaultScreen:this.model.get("defaultScreen"),hasCustomize:this.model.get("hasCustomize"),problems:e.clone(this.model.get("problems"))||[]},e.isUndefined(this.model.get("author"))||(this.screenOptions.author=this.model.get("author")),this.model.set("hasCustomize",this.screenOptions.hasCustomize);var t=this.model.get("id"),s=this.model.get("screenId"),n=ADK.ADKApp[t],i=ADK.UserDefinedScreens.getGridsterConfigFromSession(this.model.get("id")),o=this.model.get("predefined");o===!0&&n.applets&&n.applets.length>0&&this.model.set("hasApplets",!0),o===!1&&i&&i.applets&&i.applets.length>0&&this.model.set("hasApplets",!0),"documents-list"===s&&this.model.set("documents-list",!0);var r=this;this.listenTo(this.model,"change",function(e){e.changed.problems&&(r.associationCounterRegion.show(new h({model:r.model})),r.saveAssociationChange())})},onRender:function(){var t=this;if(this.screenOptions.defaultScreen){var s=this.$el.find(".default-workspace-btn");p(void 0,s)}this.associationCounterRegion.show(new h({model:this.model}));var n=this.$('.show-associations[data-toggle="popover"]'),o=function(e){if(0===$(e.target).closest(".popover").length){var t=$(e.target).closest('[data-toggle="popover"]').is(n);t||n.popover("hide")}},r=function(e){($(e.target).is(":button")||27===e.keyCode)&&(e.stopPropagation(),n.popover("hide"),n.focus())};n.popup({container:"#"+t.screenOptions.id,placement:e.bind(this.getPopoverPlacement,this,n),halign:"left",title:"Title",delay:0,content:function(){return t.associationManagerView=new i({model:t.model}),t.associationManagerView.render(),t.associationManagerView.$el},template:'<div class="popover association-manager-popover" aria-live="polite" aria-label="Popup dialog used to search for problems and associate them with this workspace"><div class="popover-content"></div></div>'}),n.on("shown.bs.popover",function(e){t.associationManagerView.trigger("show"),$("html").on("click.workspaceCollectionViewPopover",o),$(".association-manager-popover").on("keyup.workspaceCollectionViewPopover",r),$(".association-manager-popover").on("click.association-manager-close-btn",r),n.addClass("active")}),n.on("hidden.bs.popover",function(e){t.cleanupAssociationManager(),n.removeClass("active")})},getPopoverPlacement:function(e){e=e||this.$('[data-toggle="popover"]');var t="bottom",s=e.offset().top+e.outerHeight();return s+250>window.innerHeight&&(t="top"),t},applyInputMasking:function(e){$(e.target).inputmask("Regex",{regex:"^[a-zA-Z0-9\\s]*$"})},rearrangeWorksheet:function(e){$(".rearrange-row").removeClass("rearrange-row"),$('[id="'+this.model.get("id")+'"]').addClass("rearrange-row")},makeDefault:function(e){this.triggerMethod("click:removeDefault"),p(e),ADK.ADKApp.ScreenPassthrough.setNewDefaultScreen(this.screenOptions.id),this.screenOptions.defaultScreen=!0,ADK.ADKApp.ScreenPassthrough.editScreen(this.screenOptions,this.screenOptions.id),this.$el.find(".default-workspace-btn .sr-only").focus()},launchWorksheet:function(e){ADK.UserDefinedScreens.getGridsterConfigFromSession(this.model.get("id"));ADK.Navigation.navigate(this.screenOptions.routeName)},customizeWorksheet:function(e){ADK.Navigation.navigate(this.screenOptions.routeName,{},{dontLoadApplets:!0});var t=ADK.Messaging.getChannel("addAppletsChannel");t.trigger("addApplets")},clone:function(){$(this.el).trigger("clone_screen",this.model)},handleEnterSubmit:function(e){e.preventDefault();var t={currentTarget:$(e.currentTarget).find("input")};this.saveInlineChange(t),t.currentTarget.next().hasClass("glyphicon-ok")&&t.currentTarget.siblings("span.sr-only").focus()},saveInlineChange:function(e){var t=$(e.currentTarget),s=t.val(),n=t.attr("origValue")?t.attr("origValue"):"",i=this.screenOptions.id,o=t.parent().hasClass("editor-title"),r=t.parent().hasClass("editor-description");if(o){if(""!==s&&s!==n){s.trim().toLowerCase()===n.toLowerCase()&&(s=s.trim()),s=$.trim(s);var a=s;s.toLowerCase()!==n.toLowerCase()&&(a=this.processTitleChange(s)),t.val(a);var c=l(a);this.screenOptions.id=c.newId,(void 0===this.screenOptions.screenId||null===this.screenOptions.screenId)&&(this.screenOptions.screenId=c.newScreenId),this.screenOptions.title=a,this.screenOptions.routeName=c.newId,this.model.set("id",this.screenOptions.id),this.model.set("title",this.screenOptions.title),this.model.set("routeName",this.screenOptions.routeName),ADK.ADKApp.ScreenPassthrough.editScreen(this.screenOptions,i),t.attr("origValue",a),this.saveIndicator(t);var d=$(".tableRow#"+i);d.attr({id:c.newId,"data-screen-id":c.newId}),d.find(".previewWorkspace").attr("title","Press enter to preview the applets on the "+a+" workspace."),this.hasApplets&&d.find("a").attr("title","Press enter to launch the "+a+" workspace.")}}else r&&s!=n&&(this.screenOptions.description=s,this.model.set("description",this.screenOptions.description),ADK.ADKApp.ScreenPassthrough.editScreen(this.screenOptions,i),t.attr("origValue",s),this.saveIndicator(t))},inlineChangeEvent:function(e){var t=$(e.currentTarget),s=t.parent().hasClass("editor-title");t.parent().removeClass("has-success").removeClass("has-error"),t.next().removeClass("glyphicon-ok glyphicon-asterisk").siblings("span.sr-only").html(""),s&&""===t.val()&&(t.parent().addClass("has-error"),t.next().addClass("glyphicon-asterisk"))},saveAssociationChange:function(){if(!this.screenOptions.predefined){var e=this.model.get("problems")||[],t=this.screenOptions.problems||[],s=!1;if(e.length!==t.length)s=!0;else for(var n=0;n<t.length&&!s;n++)t[n].snomed!==e[n].snomed&&(s=!0);s&&(this.screenOptions.problems=this.model.get("problems"),this.save(this.screenOptions.id))}},save:function(e){ADK.ADKApp.ScreenPassthrough.editScreen(this.screenOptions,e)},saveIndicator:function(e){e.parent().addClass("has-success"),e.next().addClass("glyphicon-ok"),e.siblings("span.sr-only").html("Your update has been saved.")},processTitleChange:function(e){for(var t=!0,s=e;t;)if(ADK.ADKApp.ScreenPassthrough.titleExists(s)){var n=s.split(" "),i=isNaN(n[n.length-1])?2:parseInt(n[n.length-1])+1;2!==i&&(n.length=n.length-1),s=n.join(" ")+" "+i}else t=!1;return s},onBeforeDestroy:function(){this.cleanupPopover(),this.cleanupAssociationManager()},cleanupAssociationManager:function(){self.associationManagerView&&(self.associationManagerView.destroy(),$("html").off("click.workspaceCollectionViewPopover"),$(".association-manager-popover").off("keyup.workspaceCollectionViewPopover"),$(".association-manager-popover").off("click.association-manager-close-btn"))},cleanupPopover:function(){var e=this.$('[data-toggle="popover"]');e.off("shown.bs.popover"),e.off("hidden.bs.popover"),e.popover("destroy")}}),f=t.Marionette.CollectionView.extend({emptyView:c,childView:g,childEvents:{"click:removeDefault":function(){this.$el.find(".madeDefault").addClass("fa-star-o").removeClass("madeDefault fa-star").siblings("span.sr-only").html("Make Default.")}},initialize:function(){var e=this,s=ADK.UserDefinedScreens.getScreensConfig();e.collection=new t.Collection,s.done(function(t){e.collection.reset(t.screens)}),a.comply("addNewScreen",this.addNewScreen,e)},events:{clone_screen:"cloneScreen"},resetCollection:function(){this.collection.reset(ADK.UserDefinedScreens.getScreensConfigFromSession().screens)},onRender:function(){var e=this;e.setUpDrag(),$(document).bind("keydown.workspaceCollectionView",function(t){var s=e.$el.find(".rearrange-row");if(0!==s.length){var n=s.prev(),i=s.next();38===t.which&&n.length>0?e.moveWorkspaceUp(s,n):40===t.which&&i.length>0?e.moveWorkspaceDown(s,i):38!==t.which&&40!==t.which&&e.$el.find(".rearrange-row").removeClass("rearrange-row")}})},onBeforeDestroy:function(){$(document).unbind("keydown.workspaceCollectionView"),a.stopComplying("addNewScreen")},setUpDrag:function(){var e=this,t=this.$el,s=t.find(".tableRow").parent().drag({items:".tableRow",start:function(e){var s=$(this);s.before('<div class="tableRow toInsert"></div>'),s.addClass("draggingItem");var n=s.height(),i=t.find(".toInsert");i.height(n),s.css({"z-index":99999,position:"fixed",top:e.pageY-n+"px",left:i.offset().left+"px",width:i.width()}),s.hide(),setTimeout(function(){s.show()},50)},drag:function(e){var s=$(this),n=s.height();s.css("position","fixed"),s.css("top",e.pageY-n+"px");var i=t.find(".toInsert");s.css("width",i.width()),s.css("left",i.offset().left+"px"),$("#list-group .tableRow:not(.toInsert)").each(function(){var t=$(this),s=t.offset(),n=t.height(),o=s.top;e.pageY>o&&e.pageY<o+n/2?t.before(i):e.pageY>o+n/2&&e.pageY<o+n&&t.after(i)})},stop:function(s,n){var i=$(this),o=t.find(".toInsert");o.before(i),o.remove(),i.removeAttr("style"),t.find(".draggingItem").removeClass("draggingItem"),e.saveScreensOrders()}});this.listenTo(this,"destroy",function(){s.destroy()})},filterScreens:function(t){this.initialize(),this.collection.reset(e.filter(this.collection.models,function(s){return e.isUndefined(s.get("description"))?s.get("title").toLowerCase().indexOf(t.toLowerCase())>=0:s.get("title").toLowerCase().indexOf(t.toLowerCase())>=0||s.get("description").toLowerCase().indexOf(t.toLowerCase())>=0})),this.render()},moveWorkspaceUp:function(e,t){var s=this;t.fadeOut(500,function(){t.stop(),t.before(e),t.show(),s.saveScreensOrders()})},moveWorkspaceDown:function(e,t){var s=this;t.fadeOut(500,function(){t.stop(),t.after(e),t.show(),s.saveScreensOrders()})},saveScreensOrders:function(){var e=[];$("#list-group .tableRow").each(function(){var t=$(this).attr("id");t&&e.push(t)}),ADK.UserDefinedScreens.sortScreensByIds(e)},addNewScreen:function(){var e,t=this,s=ADK.UserDefinedScreens.getScreensConfigFromSession(),n=t.generateTitle(s),i=l(n),o=i.newId,r=i.newScreenId,a=!1,c=ADK.UserService.getUserSession().get("firstname");c=c+" "+ADK.UserService.getUserSession().get("lastname"),e={id:o,screenId:r,routeName:o,title:n,description:void 0,predefined:!1,defaultScreen:!1,author:c,hasCustomize:a},ADK.ADKApp.ScreenPassthrough.addNewScreen(e,ADK.ADKApp),t.resetCollection(),t.setFocusToScreenInput(o)},setFocusToScreenInput:function(e){var t=$("#"+e+" input:text:first");t.focus(),t.val(t.val())},generateTitle:function(e){var t=0;return e.screens.forEach(function(e){if(-1!==e.title.indexOf("User Defined Workspace")&&!isNaN(Number(e.title.slice(23)))){var s=Number(e.title.slice(23));s>t&&(t=s)}}),"User Defined Workspace "+(t+1)},cloneScreen:function(s){var n=this,i=(ADK.UserDefinedScreens.getScreensConfigFromSession(),$(s.target).find("input")[0]);i=void 0===$(i).val()?$(s.target).find(".predefined-title").text():$(i).val();var o,r=this.generateCloneTitle(i),a=l(r),c=a.newId,d=a.newScreenId,p=!0,h=new t.Collection(ADK.UserDefinedScreens.getScreensConfigFromSession().screens),g=e.find(h.models,function(e,t){return o=t,e.get("title")===i}),f=ADK.UserService.getUserSession().get("firstname");f=f+" "+ADK.UserService.getUserSession().get("lastname");var u={id:c,screenId:d,routeName:c,title:r,description:g.get("description"),predefined:!1,defaultScreen:!1,author:f,hasCustomize:p,problems:g.get("problems")},m=function(e,t,s){if(g.get("predefined")===!0){var i=ADK.ADKApp[g.get("id")].applets,o={applets:i,id:u.id,contentRegionLayout:"gridster",userDefinedScreen:!0};ADK.UserDefinedScreens.saveGridsterConfig(o,u.id,function(){ADK.UserDefinedScreens.cloneScreen(g.get("id"),u.id,!0)})}else ADK.UserDefinedScreens.cloneScreen(g.get("id"),u.id,!1),ADK.UserDefinedScreens.cloneUDScreenToSession(g.get("id"),u.id);ADK.UserDefinedScreens.cloneScreenFiltersToSession(g.get("id"),u.id),ADK.UserDefinedScreens.cloneScreenGraphsToSession(g.get("id"),u.id),n.resetCollection(),n.setFocusToScreenInput(c)};ADK.ADKApp.ScreenPassthrough.addNewScreen(u,ADK.ADKApp,o+1,m)},generateCloneTitle:function(t){var s,n=ADK.UserDefinedScreens.getScreensConfig();return t=t.slice(0,23),n.done(function(n){var i=e.filter(n.screens,function(e){return-1!==e.title.indexOf(t+" Copy")&&-1===e.title.indexOf(t+" Copy Copy")?e:void 0});s=0!==i.length?t+" Copy "+(i.length+1):t+" Copy"}),s}});return f});