define(["underscore","backbone","marionette","jquery","handlebars","typeahead","app/applets/workspaceManager/list/problems/problemAssociationUtil","hbs!app/applets/workspaceManager/list/problems/associationManagerTemplate","hbs!app/applets/workspaceManager/list/problems/problemListItemTemplate","hbs!app/applets/workspaceManager/list/problems/searchResultItemTemplate","hbs!app/applets/workspaceManager/list/problems/emptyResultsTemplate","hbs!app/applets/workspaceManager/list/problems/noAssociationsTemplate"],function(e,t,s,o,r,i,n,a,l,c,p,h){var m=300,d=3,u=t.Marionette.ItemView.extend({template:h}),b=t.Marionette.ItemView.extend({template:l,className:"problem-list-item-wrapper"}),g=t.Marionette.CollectionView.extend({childView:b,emptyView:u}),f=t.Marionette.LayoutView.extend({template:a,regions:{problemListRegion:"#problem-list-region",statusRegion:"#problem-query-status-region"},events:{"keyup #screen-problem-search":function(e){o(e.target).val().length<d&&this.hideStatus(),o(e.target).val().length>0?this.$("#clear-search-problem-btn").show():this.$("#clear-search-problem-btn").hide()},"keyup .association-manager":function(e){27===e.keyCode&&this.closeSearchResultDropdown(e)},"click #clear-search-problem-btn":function(e){e.stopImmediatePropagation(),this.$("#screen-problem-search").val(""),this.$("#screen-problem-search").focus(),this.hideStatus(),this.closeSearchResultDropdown(e),this.$("#clear-search-problem-btn").hide()},"click .problem-result .close":function(e){e.stopPropagation();var t=o(e.currentTarget).attr("data-snomed-ct");this.removeProblemAssociation(t),this.$("#screen-problem-search").focus()}},initialize:function(e){this.problemListColl=new t.Collection(this.model.get("problems")),this.problemResultsColl=new t.Collection},addProblemAssociation:function(s){var o=n.findProblemBySnomedCt(this.problemResultsColl,s),r=n.getTrimmedProblem(o),i=e.clone(this.model.get("problems"))||[];i.push(r),this.model.set("problems",i),n.addProblemAssociation(this.problemListColl,new t.Model(r)),this.disableProblemResult(s)},removeProblemAssociation:function(t){var s=n.findProblemBySnomedCt(this.problemListColl,t),o=this.model.get("problems")||[];o=e.reject(o,function(e){return e.snomed===t}),this.model.set("problems",o),n.removeProblemAssociation(this.problemListColl,s),this.enableProblemResult(t)},onRender:function(){this.problemListRegion.show(new g({collection:this.problemListColl}))},queryProblems:function(t,s){function o(e){this.$("#problem-query-status-region").is(":visible")&&(r.problemResultsColl.reset(e.models),s(e.toJSON()),r.problemListColl.forEach(function(e){var t=e.get("snomed");r.disableProblemResult(t)}))}this.problemResultsColl.reset(),this.showLoadingStatus();var r=this;n.queryGlobalProblems(t,o,e.bind(this.showErrorStatus,this))},closeSearchResultDropdown:function(e){var t=this.$(".twitter-typeahead .tt-dropdown-menu");t.is(":visible")&&(t.hide(),this.$("#screen-problem-search").focus(),e.stopPropagation())},onDomRefresh:function(){var t=this;if(this.model.get("predefined"))this.$("#association-manager-close-btn").focus();else{var s=this.$("#screen-problem-search");s.on("keydown",function(e){switch(e.keyCode){case 27:e.stopImmediatePropagation();break;case 38:e.preventDefault(),e.stopImmediatePropagation(),t.$(".twitter-typeahead").find(".tt-suggestion:last-child .problem-result").focus();break;case 40:e.preventDefault(),e.stopImmediatePropagation(),t.$(".twitter-typeahead").find(".tt-suggestion:first-child .problem-result").focus()}}),s.on("blur",function(e){e.stopImmediatePropagation()}),s.typeahead({hint:!1,highlight:!0,minLength:d},{source:e.debounce(e.bind(this.queryProblems,this),m),templates:{empty:p,suggestion:c}});var o=this.$(".twitter-typeahead .tt-dropdown-menu");this.mutationObserver&&this.mutationObserver.disconnect(),this.mutationObserver=new MutationObserver(function(e,s){for(var r=0;r<e.length;r++){var i=e[r];"style"===i.attributeName&&i.oldValue!==o.attr("style")&&(o.is(":visible")?t.onDropdownShown(o):t.onDropdownHidden(o))}}),this.mutationObserver.observe(o[0],{childList:!1,attributes:!0,characterData:!1,subtree:!1,attributeOldValue:!0}),this.$("#screen-problem-search").focus()}},onDropdownShown:function(e){console.log("on show dropdown"),this.hideStatus(),e.scrollTop(0);var t=this;e.find(".problem-result").each(function(e,s){var r=o(s);r.on("click",function(e){e.stopPropagation();var s=o(e.currentTarget),r=s.attr("data-snomed-ct");s.hasClass("disabled")?t.removeProblemAssociation(r):t.addProblemAssociation(r)}),r.on("keydown",function(e){switch(e.keyCode){case 38:var t=o(e.currentTarget).closest(".tt-suggestion").prev().find(".problem-result");0===t.length&&(t=o("#screen-problem-search")),t.focus(),e.preventDefault();break;case 40:var s=o(e.currentTarget).closest(".tt-suggestion").next().find(".problem-result");0===s.length&&(s=o("#screen-problem-search")),s.focus(),e.preventDefault()}})})},onDropdownHidden:function(e){console.log("on hide dropdown")},disableProblemResult:function(e){this.$(".tt-suggestions").find('[data-snomed-ct="'+e+'"]').addClass("disabled")},enableProblemResult:function(e){this.$(".tt-suggestions").find('[data-snomed-ct="'+e+'"]').removeClass("disabled")},showLoadingStatus:function(){this.$(".tt-dropdown-menu").hide(),this.$("#problem-query-status-region").show(),this.statusRegion.show(ADK.Views.Loading.create())},hideStatus:function(){this.statusRegion.reset(),this.$("#problem-query-status-region").hide()},showErrorStatus:function(){this.$(".tt-dropdown-menu").hide(),this.$("#problem-query-status-region").show(),this.statusRegion.show(ADK.Views.Error.create({model:this.model}))},onBeforeDestroy:function(){this.model.get("predefined")||this.$("#screen-problem-search").typeahead("destroy"),this.dropdownMutationObserver&&this.dropdownMutationObserver.disconnect()}});return f});