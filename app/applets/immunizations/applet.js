define(["backbone","marionette","app/applets/immunizations/util","app/applets/immunizations/modal/modalView","hbs!app/applets/immunizations/list/siteTemplate","hbs!app/applets/immunizations/list/reactionTemplate","hbs!app/applets/immunizations/list/commentTemplate","hbs!app/applets/immunizations/list/administeredDateTimeTemplate","app/applets/immunizations/modal/modalHeaderView","app/applets/immunizations/modal/modalFooterView","app/applets/immunizations/appConfig","app/applets/immunizations/gistUtil","hbs!app/applets/immunizations/templates/tooltip"],function(e,i,t,a,n,o,l,s,r,m,d,c,p){"use strict";var u=d.debug,g=[{name:"name",label:"Vaccine Name",cell:"string",hoverTip:"immunizations_vaccinename"},{name:"reactionName",label:"Reaction",cell:"handlebars",template:o,hoverTip:"immunizations_reaction"},{name:"administeredFormatted",label:"Date",cell:"string",sortValue:function(e,i){return e.get("administeredDateTime")},hoverTip:"immuninizations_date"},{name:"facilityMoniker",label:"Facility",cell:"string",hoverTip:"immuninizations_facility"}],h=g.concat([{name:"",cell:"handlebars",template:l}]);h.splice(1,0,{name:"standardizedName",label:"Standardized Name",cell:"string",hoverTip:"immuninizations_standardizedname"}),h.splice(3,0,{name:"seriesName",label:"Series",cell:"string",hoverTip:"immuninizations_series"},{name:"contraindicatedDisplay",label:"Repeat Contraindicated",cell:"string",hoverTip:"immuninizations_repeatcontraindicated"});var f,v=e.Model.extend({defaults:{type:"panel"}}),w={transformCollection:function(e){u&&console.log("ImmunGist ----->> preare collection (grouping)");var i,t,a=e.clone(),n=[],o=[],l=[];for(i=0;i<a.length;i++)if(e.at(i).set({administeredFormatted:ADK.utils.formatDate(a.at(i).get("administeredDateTime")),timeSince:a.at(i).get("administeredDateTime"),isReaction:c.isReaction(a.at(i).get("reactionName")),seriesNorm:c.seriesNormalization(a.at(i).get("seriesName"))}),u&&console.log(a.at(i).get("name")),!_.contains(o,a.at(i).cid)){for(n=a.where({name:a.at(i).get("name")}),t=0;t<n.length;t++)o.push(n[t].cid);n=_.without(n,a.at(i)),l=_.union(l,n),a.at(i).set({group:n,group_items:n.length+1})}return a.remove(l),e.reset(a.models,{reindex:!0}),_.each(e.models,function(e){e.set("tooltip",p(e.attributes))}),e},gistModel:[{id:"name",field:"name"},{id:"seriesNorm",field:"seriesNorm"},{id:"age",field:"timeSince"}],defaultView:"pill"},z={parse:function(e){return e=t.getAdministeredFormatted(e),e=t.getContraindicated(e),e=t.getFacilityColor(e),e=t.getStandardizedName(e),e=t.getCommentBubble(e)}},T={resourceTitle:"patient-record-immunization",pageable:!0,viewModel:z,cache:!0},y=ADK.Applets.BaseGridApplet,b=ADK.Messaging.getChannel("immunization"),D=y.extend({initialize:function(e){u&&console.log("Immunizations initialization ----->>"),f=y.prototype;var i={};"expanded"===this.columnsViewType?i.columns=h:"summary"===this.columnsViewType?i.columns=g:(i.summaryColumns=g,i.fullScreenColumns=h),i.enableModal=!0,ADK.UserService.hasPermission("add-patient-immunization")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(i.onClickAdd=function(){b.command("addImmunization")}),i.tblRowSelector="#data-grid-immunizations tbody tr";i.onClickRow=function(e,n,o){if(n.preventDefault(),e instanceof v){if($(n.currentTarget).data("isOpen")){var l=$(n.currentTarget).data("isOpen");l=!l,console.log(l),$(n.currentTarget).data("isOpen",l)}else $(n.currentTarget).data("isOpen",!0);var s=$(n.currentTarget).find(".js-has-panel i");s.length&&(s.hasClass("fa-chevron-up")?(s.removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(n.currentTarget).data("isOpen",!0)):(s.removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(n.currentTarget).data("isOpen",!1))),o.expandRow(e,n)}else{e.set("isNotAPanel",!0);var m=new a({model:e,target:n.currentTarget,navHeader:!0,gridCollection:i.collection});m.resetSharedModalDateRangeOptions();var d={title:t.getModalTitle(e),size:"large",headerView:r.extend({model:e,theView:m})},c=new ADK.UI.Modal({view:m,options:d});c.show()}},T.onSuccess=function(){i.collection.length>0&&$("#data-grid-immunizations tbody tr").each(function(){$(this).attr("data-infobutton",$(this).find("td:first").text())})},i.collection=ADK.PatientRecordService.fetchCollection(T),this.dataGridOptions=i,f.initialize.apply(this,arguments)},onRender:function(){f.onRender.apply(this,arguments)}}),V=ADK.Messaging.getChannel("immunizations");V.on("addView",function(){b.command("addImmunization")}),V.on("getDetailView",function(e){u&&console.log("Immunizations gistDetailView ----->>");var i=new a({model:e.model,navHeader:!0,gridCollection:e.collection});i.resetSharedModalDateRangeOptions();var n={title:t.getModalTitle(e.model),size:"large",headerView:r.extend({model:e.model,theView:i})},o=new ADK.UI.Modal({view:i,options:n});o.show()}),V.reply("detailView",function(i){var n={criteria:{uid:i.uid},patient:new e.Model({icn:i.patient.icn,pid:i.patient.pid}),resourceTitle:"patient-record-immunization",viewModel:z},o=$.Deferred(),l=ADK.PatientRecordService.fetchCollection(n);return l.on("sync",function(){var e=l.first();o.resolve({view:new a({model:e,navHeader:!1}),title:t.getModalTitle(e)})},this),o.promise()});var C=ADK.AppletViews.PillsGistView.extend({className:"app-size",initialize:function(e){this._super=ADK.AppletViews.PillsGistView.prototype,this.appletOptions={filterFields:["name"],collectionParser:w.transformCollection,gistModel:w.gistModel,collection:ADK.PatientRecordService.fetchCollection(T)},ADK.UserService.hasPermission("add-patient-immunization")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(this.appletOptions.onClickAdd=function(){b.command("addImmunization")}),this._super.initialize.apply(this,arguments)}}),A={id:"immunizations",viewTypes:[{type:"gist",view:C,chromeEnabled:!0},{type:"summary",view:D.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:D.extend({columnsViewType:"expanded"}),chromeEnabled:!0}],defaultViewType:"summary"};return A});