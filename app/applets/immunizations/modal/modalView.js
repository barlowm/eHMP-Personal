define(["jquery","jquery.inputmask","backbone","marionette","underscore","app/applets/immunizations/util","app/applets/immunizations/appletHelpers","app/applets/immunizations/modal/filterDateRangeView","hbs!app/applets/immunizations/list/resultTemplate","hbs!app/applets/immunizations/list/dateTemplate","hbs!app/applets/immunizations/list/siteTemplate","hbs!app/applets/immunizations/modal/modalTemplate","hbs!app/applets/immunizations/modal/dateRangeTemplate","hbs!app/applets/immunizations/modal/totalTestsTemplate","app/applets/immunizations/modal/modalHeaderView","app/applets/immunizations/modal/modalFooterView"],function(e,t,i,a,n,l,o,s,r,d,m,c,u,p,h,g){"use strict";function f(e){return e=l.getAdministeredFormatted(e),e=l.getContraindicated(e),e=l.getFacilityColor(e),e=l.getStandardizedName(e),e=l.getObservedFormatted(e),e=l.getObservedTimeFormatted(e),e=l.getFacilityColor(e),e=l.getResultedFormatted(e),e=l.getResultedTimeFormatted(e),e=l.getNumericDate(e)}var v,b,w,D,z,M,C,x={},N=[],O=[];D=i.Collection.extend({}),w=[{name:"administeredFormatted",label:"Date",cell:"string",sortable:!1},{name:"summary",cell:"string",label:"Summary",sortable:!1},{name:"reactionName",cell:"string",label:"Reaction",sortable:!1},{name:"seriesName",cell:"string",label:"Series",sortable:!1},{name:"contraindicatedDisplay",cell:"string",label:"Repeat Contraindicated",sortable:!1},{name:"facilityMoniker",label:"Facility",cell:"string",sortable:!1}],x.columns=w,x.appletConfig={name:"immunizations_modal",id:"immunizations-modalView"};var V,R=i.Model.extend({defaults:{fromDate:moment().subtract("years",1).format("YYYY-MM-DD"),toDate:moment().format("YYYY-MM-DD")}}),Y=new R,y=(new s({model:Y}),i.Marionette.ItemView.extend({template:p,tagName:"span",initialize:function(){this.listenTo(this.model,"change",this.render)}}));z=i.Model.extend({defaults:{totalTests:0}});var T=new z,F=i.Marionette.LayoutView.extend({template:c,fetchOptions:{},initialize:function(t){this.loadingView=ADK.Views.Loading.create(),C=t.gridCollection,this.getModals(),this.showNavHeader&&(this.model.attributes.navHeader=!0),this.fetchOptions.resourceTitle="patient-record-immunization",this.fetchOptions.criteria={pid:this.model.attributes.pid},M=this.model.attributes.name;var i=this;this.fetchOptions.collectionConfig={collectionParse:i.filterCollection},this.fetchOptions.pageable=!0,this.fetchOptions.onSuccess=function(a,l){console.log("modalView.js","size of collection is "+a.length),i.collection=a,i.$el.find(".immunizationsNext, .immunizationsPrev").attr("disabled",!1);var o=i.collection.fullCollection.pluck("result");o=n.map(o,function(e){return n.isNaN(1*e)}),o=n.without(o,!1),i.showNavHeader&&(i.model.attributes.navHeader=!0);var s;s=0!==a.length?setInterval(function(){e("#lr-data-table-view").length&&clearInterval(s)},500):setInterval(function(){e("#lr-data-table-view").length&&clearInterval(s)},500),x.collection=i.collection,v=t.model,i.model=t.model,b=t.collection,T.set({totalTests:x.collection.fullCollection.length}),i.dataGrid=ADK.Views.DataGrid.create(x),void 0!==i.leftColumn&&null!==i.leftColumn&&(i.leftColumn.reset(),i.leftColumn.show(i.dataGrid)),x.collection=i.collection,0!==a.length?(i.paginatorView=ADK.Views.Paginator.create({collection:x.collection,windowSize:4}),e(".js-backgrid").append(i.paginatorView.render().el)):e("#data-grid-immunizations-modalView").find("tbody").append(e('<tr class="empty"><td colspan="4">No Records Found</td></tr>'))}},events:{"click .immunizationsNext":"getNextModal","click .immunizationsPrev":"getPrevModal"},getNextModal:function(e){var t=n.indexOf(N,this.model)+1;t>=N.length&&(this.getModals(),t=0);var i=N[t];this.setNextPrevModal(i)},getPrevModal:function(e){var t=n.indexOf(N,this.model)-1;0>t&&(this.getModals(),t=N.length-1);var i=N[t];this.setNextPrevModal(i)},getModals:function(){N=[],O=[],void 0!==C&&n.each(C.models,function(e,t){if(e.get("immunizations")){var i=C.indexOf(e);n.each(e.get("immunizations").models,function(t,a){t.set({inAPanel:!0,parentIndex:i,parentModel:e}),N.push(t)})}else N.push(e)})},setNextPrevModal:function(t){if(this.showNavHeader&&(t.attributes.navHeader=!0),t.get("inAPanel")){var i=e("#data-grid-immunizations > tbody>tr.selectable").eq(t.get("parentIndex"));i.data("isOpen")||i.trigger("click"),e("#data-grid-immunizations > tbody>tr.selectable").not(i).each(function(){var t=e(this);t.data("isOpen")&&t.trigger("click")})}var a=new F({model:t,gridCollection:C,navHeader:this.showNavHeader}),n=(ADK.UserService.getUserSession().get("site"),t.get("pid")?t.get("pid").split(";")[0]:"",{title:"Vaccine - "+t.get("name"),size:"large",headerView:h.extend({model:t,theView:a})}),l=new ADK.UI.Modal({view:a,options:n});l.show()},regions:{leftColumn:".js-backgrid",totalTests:"#total-tests",dateRangeFilter:"#date-range-filter"},resetSharedModalDateRangeOptions:function(){V=new R},onRender:function(){var e;(void 0===V||null===V)&&this.resetSharedModalDateRangeOptions(),e=void 0!==V&&null!==V&&void 0!==V.get("preSelectedDateRange")&&null!==V.get("preSelectedDateRange")?V.clone():new R,new R;var t=new s({model:e,parentView:this});t.setFetchOptions(this.fetchOptions),t.setSharedDateRange(V),this.dateRangeFilter.show(t),this.leftColumn.show(this.loadingView),this.totalTests.show(new y({model:T})),self.collection=ADK.PatientRecordService.fetchCollection(this.fetchOptions)},filterCollection:function(t){t.models.forEach(function(e){e.attributes=f(e.attributes)});var a=[],n=e.unique(t.pluck("name")),l=[],o=(l.filter(function(e){return-1!=n.indexOf(e)}),new i.Collection(t.where({name:M})));return o.each(function(e){e.attributes.numericDate<=moment(V.attributes.toDate).format("YYYYMMDD")&&(e.attributes.numericDate>=moment(V.attributes.fromDate).format("YYYYMMDD")||null===V.attributes.fromDate)&&a.push(e)}),a}});return F});