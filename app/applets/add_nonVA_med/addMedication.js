define(["backbone","marionette","underscore","moment","hbs!app/applets/add_nonVA_med/addMedicationTemplate","hbs!app/applets/add_nonVA_med/visitRegionTemplate","app/applets/add_nonVA_med/opData/opDataUtil","app/applets/add_nonVA_med/utils/util","app/applets/add_nonVA_med/opData/dosageView","app/applets/add_nonVA_med/opData/routeView","app/applets/add_nonVA_med/opData/scheduleView"],function(e,t,i,n,a,d,o,s,r,l,c){"use strict";function p(){u&&u.updateView()}var u,h,m,f,w="changeVisit",g="add-nonVA-med",v="set-visit-success:add-nonVA-med",b="addNonVaMedModal",V="medicationChannel",D=ADK.Messaging.getChannel("visit"),A=e.Marionette.ItemView.extend({tagName:"div",template:d});return e.Marionette.LayoutView.extend({className:"add-medication-styles",template:a,constructor:function(t,i){if(!t||"function"!=typeof t.get||!t.get("IEN")||!t.get("name"))throw new Error('addMedication Constructor Argument Error:\nYou must pass in a backbone model of the medication with "IEN" and "name" attributes.');this.isEdit=i||!1,f=!i,s.setIsEdit(this.isEdit),this.setMed(t),o.setMed(this.med),e.Marionette.LayoutView.prototype.constructor.apply(this,arguments)},regions:{visitRegion:"#visit-region",dosageInput:"#dosages",routeInput:"#routes",scheduleInput:"#schedules",previewOrder:"#previewOrder",errorContainer:"#error-container"},enableLoadingIndicator:function(e){e?this.$el.find("#edit-meds-loading-indicator").show():(this.$el.find("#edit-meds-loading-indicator").hide(),this.$el.find("#edit-meds-loading-indicator").focus())},initialize:function(){if(o.errorView=new ADK.Views.ServerSideError,h=ADK.UserService.getUserSession().get("site"),m=this.med.get("pid")?this.med.get("pid").split(";")[0]:"",this.isEdit)o.resetFetch(),o.fetchScheduleOpData();else{o.fetchOpData();var e=s.getModel();o.model=new e}},update:function(){s.update(),this.buildPreview()},updateData:function(e){var t=e.get("orderable").values.external,i=e.get("orderable").values.internal;this.med.set({name:t,IEN:i,savedMed:e}),o.setMed(this.med),o.fetchDefaultsOpData();var n,a=this;n=setInterval(function(){o.fetchDone()&&(clearInterval(n),a.isDestroyed||a.loadData())},200)},loadData:function(){var e=s.getModel();o.model=new e;var t,i=s.getVisitModel(),a=new A({model:i});this.dosageInput.show(new r),this.routeInput.show(new l),this.scheduleInput.show(new c),this.errorContainer.show(o.errorView),t=this.$("#startDate"),ADK.utils.dateUtils.datepicker(t,{endDate:(new n).format(ADK.utils.dateUtils.defaultOptions().placeholder)}),t.parent().find(".glyphicon-calendar").on("click",function(){t.datepicker("show")}),o.updateInput(this.$el),s.update(),ADK.UserService.hasPermission("edit-patient-med")&&m===h&&(this.$el.find("#medication-form :input[type=text]").removeAttr("readonly"),this.$el.find("#medication-form :input[type=radio]").removeAttr("disabled"),this.$el.find("#medication-form :input[type=checkbox]").removeAttr("disabled"),this.$el.find("textarea").removeAttr("readonly"),this.$el.find("#medication-form :button").removeAttr("disabled"),this.visitRegion.show(a)),this.enableLoadingIndicator(!1)},selectVisit:function(e){u=this,D.command(w,g,{channel:V,command:b,callback:p}),D.once(v,function(){u.updateVisit()})},updateVisit:function(){var e=s.getVisitModel(),t=new A({model:e});this.visitRegion.show(t)},onRender:function(){var e;this.updateVisit(this),this.isEdit?(this.enableLoadingIndicator(!0),this.$el.find("#medication-form :input[type=text]").attr("readonly","readonly"),this.$el.find("#medication-form :input[type=radio]").attr("disabled","disabled"),this.$el.find("#medication-form :input[type=checkbox]").attr("disabled","disabled"),this.$el.find("textarea").attr("readonly","readonly"),this.$el.find("#medication-form :button").attr("disabled","disabled")):(this.enableLoadingIndicator(!1),this.dosageInput.show(new r),this.routeInput.show(new l),this.scheduleInput.show(new c),this.errorContainer.show(o.errorView),e=this.$("#startDate"),ADK.utils.dateUtils.datepicker(e,{endDate:(new n).format(ADK.utils.dateUtils.defaultOptions().placeholder)}),e.parent().find(".glyphicon-calendar").on("click",function(){e.datepicker("show")}),o.updateInput(this.$el))},events:{"change #medication-form":"update","click #add-non-va-med-btn":"selectVisit"},buildPreview:function(){s.buildPreview()},updateView:function(){var e=ADK.Messaging.getChannel(V),t=e.request(b);t.done(function(e){var t=e.view;t.handleChangeVisit(u)})},setMed:function(e){this.med=e},templateHelpers:{isLocal:function(){return ADK.UserService.hasPermission("edit-patient-med")&&m===h?!0:f===!0?!0:!1}}})});