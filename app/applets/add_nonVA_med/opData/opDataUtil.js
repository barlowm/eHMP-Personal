define(["hbs!app/applets/add_nonVA_med/opData/dropdownViewTemplate","moment"],function(e,t){"use strict";function r(e){return""!==e}var n,a=new Backbone.Collection,o=new Backbone.Collection,i=new Backbone.Collection,c=new Backbone.Model,l=!1,d=!1,s={resourceTitle:"med-op-data-defaults",criteria:{},onError:function(e,t){w.errorView.addError(t.responseText),l=!0},onSuccess:function(e,t){e.toJSON()[0].internal.AllDoses?a.reset(e.toJSON()[0].internal.AllDoses):a.reset(),e.toJSON()[0].internal.Route&&o.reset(e.toJSON()[0].internal.Route),c.set(e.toJSON()[0].display),l=!0}},u={resourceTitle:"med-op-data-schedule",criteria:{},onError:function(e,t){w.errorView.addError(t.responseText),d=!0},onSuccess:function(e,t){e.toJSON()?i.reset(e.toJSON()):i.reset(),d=!0}},p=function(e){switch(e.toLowerCase()){case"dose":return a;case"route":return o;case"name":return i;default:return}},v=function(t){return Backbone.Marionette.ItemView.extend({initialize:function(){},template:e,tagName:"li",className:"",templateHelpers:function(){return{data:this.model.get(t)}}})},f=function(){var e={},t={dose:$("#dosage").val()?$("#dosage").val().toUpperCase():""},r={route:$("#route").val()?$("#route").val().toUpperCase():""},n={name:$("#schedule").val()?$("#schedule").val().toUpperCase():""};return e.dose=e.amount=$("#dosage").val(),a.where(t).length>0&&g(t,e),e.route=$("#route").val(),o.where(r).length>0&&(e.route=h(r),e.routeIEN=o.where(r)[0].get("routeien")),e.verb=c.get("Verb")?c.get("Verb")[0].value+" ":"",e.medName=c.get("Medication")?c.get("Medication")[0].value+" ":"",e.schedule=$("#schedule").val(),i.where(n).length>0&&(e.schedule=i.where(n)[0].get("externalValue")||i.where(n)[0].get("name")),e},g=function(e,t){t.doseString=a.where(e)[0].get("dose_desc"),t.doseIEN=a.where(e)[0].get("drugien");var r=a.where(e)[0].get("dose_desc").split("&");t.amount=r[2]+r[3]||r[4],t.strength=r[6]+r[7]||""},h=function(e){var t=o.where(e)[0],r=c.get("Preposition")?c.get("Preposition")[0].value+" ":"";return r+(t.get("outpatient_expansion")||t.get("route"))},m=function(e){if(n.get("savedMed")){var r=n.get("savedMed"),a=r.get("strength"),o=r.get("instr"),i=r.get("route"),l=r.get("schedule"),d=r.get("comment"),s=(r.get("drug"),r.get("orderable"),r.get("sig")),u=r.get("start")&&new t(r.get("start").displayvalue).format(ADK.utils.dateUtils.defaultOptions().placeholder)||"",p=u&&new t(u).format(ADK.utils.dateUtils.defaultOptions().placeholder)||"",v=r.get("statements"),f="Non-VA medication not recommended by VA provider.",g="Non-VA medication recommended by VA provider.",h="Patient wants to buy from Non-VA pharmacy.",m="Medication prescribed by Non-VA provider.";c.get("Verb")?c.get("Verb")[0].value+" ":"";e.find("#dosage").val(o&&o.displayvalue||""),e.find("#route").val(i&&i.displayvalue||""),e.find("#schedule").val(l&&l.displayvalue||""),e.find("#comments").val(d&&d.values.text||""),p?e.find("#startDate").datepicker("update",p):e.find("#startDate").val(""),s&&s.displayvalue&&s.displayvalue.toLowerCase().indexOf("prn")>-1&&e.find("#prn").prop("checked",!0);var w=[];v&&v.displayvalue&&(v.displayvalue.indexOf(f)>-1&&(e.find("#notRecommended").prop("checked",!0),w.push("<p>"+f)),v.displayvalue.indexOf(g)>-1&&(e.find("#recommended").prop("checked",!0),w.push("<p>"+g)),v.displayvalue.indexOf(h)>-1&&(e.find("#nonVApharmacy").prop("checked",!0),w.push("<p>"+h)),v.displayvalue.indexOf(m)>-1&&(e.find("#nonVAprovider").prop("checked",!0),w.push("<p>"+m)));var y=s&&s.displayvalue,D="<p>",N="<p>",S="<p>";D+=n.get("name")||"",N+=a&&a.displayvalue+" "||"",S+=(y&&y+" ")+(u&&"Start Date: "+u+"<p>"||"")+(w&&w+" "||"")+(d&&d.values.text+" "||""),e.find("#previewOrder").html(D+N+S)}},w={setMed:function(e){n=e},getMed:function(){return n},getDate:function(){var e=ADK.PatientRecordService.getCurrentPatient().get("visit")||"";if(r(e)){var t=e.formattedDate,n=new Date(t),a=n.getFullYear()+"-"+n.getMonth()+"1-"+n.getDate();return a}},updateInput:function(e){return m(e)},getPreviewValues:function(){return f()},getCollection:function(e){return p(e)},fetchDone:function(){var e=l&&d;return e},resetFetch:function(){l=!1,d=!1},fetchScheduleOpData:function(e){var t=ADK.PatientRecordService.getCurrentPatient().get("localId"),r={dfn:t};u.criteria.param=JSON.stringify(r),ADK.ResourceService.fetchCollection(u),this.errorView.clearErrors()},fetchDefaultsOpData:function(e){var t=ADK.PatientRecordService.getCurrentPatient().get("localId"),r={oi:n.get("IEN"),pstype:"X",orvp:t,needpi:"Y",pkiactiv:"Y"};s.criteria.param=JSON.stringify(r),ADK.ResourceService.fetchCollection(s)},fetchOpData:function(e){var t=ADK.PatientRecordService.getCurrentPatient().get("localId"),r={dfn:t};u.criteria.param=JSON.stringify(r),r={oi:n.get("IEN"),pstype:"X",orvp:t,needpi:"Y",pkiactiv:"Y"},s.criteria.param=JSON.stringify(r),ADK.ResourceService.fetchCollection(s),ADK.ResourceService.fetchCollection(u),this.errorView.clearErrors()},getComboBoxView:function(e){return Backbone.Marionette.CollectionView.extend({initialize:function(){this.collection=p(e)},collectionEvents:{"sync change reset":"render"},childView:v(e),tagName:"ul",className:"nav nav-pills nav-stacked",attributes:{}})}};return w});