define(["backbone","marionette","underscore","hbs!app/applets/add_nonVA_med/searchMedsResultTemplate","hbs!app/applets/add_nonVA_med/searchMedsTemplate","app/applets/add_nonVA_med/addMedication","app/applets/add_nonVA_med/utils/searchUtil","app/applets/add_nonVA_med/searchMedsEventHandler","app/applets/add_nonVA_med/searchMedsScrollEventHandler","app/applets/add_nonVA_med/addMedicationModalFooterView","app/applets/add_nonVA_med/utils/util"],function(e,t,n,i,a,r,o,d,s,l,c){"use strict";function p(e){u.set({IEN:u.get("internal")},{silent:!0});var t=new r(u,!1);t.errorView=new ADK.Views.ServerSideError;var n=u.get("name")+" "+o.escapeHtml(u.get("desc")||"");l=l.extend({templateHelpers:{isNew:function(){return!0},isLocal:function(){return!0}}});var i={title:n,footerView:l,replaceContents:e,regionName:"addEditDialog",callShow:!0},a=new ADK.UI.Modal({view:t,options:i});a.show(),"No visit set"===$("#locationDisplayName span").text()&&$("#btn-add-non-va-med-accept").prop("disabled",!1)}var m,w=(e.Model.extend({}),e.Collection.extend()),u=(new w,e.Model.extend({})),v=(e.Model.extend({}),{title:"Document Herbal/OTC/Non-VA Medications",replaceContents:!1,regionName:"searchDialog",callShow:!0});l=l.extend({goBack:function(){c.isEdit()?$("#btn-add-non-va-med-cancel").click():g()}});var h=e.Marionette.ItemView.extend({template:i,tagName:"li",events:{click:"selectMed"},selectMed:function(e){e.preventDefault();var t=(ADK.PatientRecordService.getCurrentPatient(),!1);u!==this.model&&(u=this.model,t=!0),p(t)}}),f=e.Marionette.CollectionView.extend({tagName:"ul",className:"nav nav-stacked",attributes:{id:"meds-ul",role:"menu"},childView:h,initialize:function(){this.collection=new e.Collection}}),g=function(){var e=new ADK.UI.Modal({view:new V,options:v});e.show()},V=e.Marionette.LayoutView.extend({modalOptions:v,template:a,className:"add-medication-styles",regions:{searchMedsResults:"#med-results-inner-container",medsSearchError:"#error-container"},initialize:function(){this.errorView=new ADK.Views.ServerSideError},onRender:function(){this.medsSearchError.show(this.errorView);var e=new f;this.medsView=e,this.searchMedsResults.show(e),o.enableLoadingIndicator(!0)},events:{"keyup #medsSearchInput":"submitSearchMeds","keydown input":function(e){13===e.which&&e.preventDefault()}},submitSearchMeds:function(e){9!==e.keyCode&&(d.setView(this),o.performActionWhileTyping(e,"keyup",2,500,d.medsEventHandler))},handleChangeVisit:function(e){var t,n=e.med,i=e.med,a=i.get("name"),d=i.get("IEN");n.set({name:a,IEN:d,savedMed:i}),t=new r(n,!1),t.errorView=new ADK.Views.ServerSideError;var s=a+" "+o.escapeHtml(i.get("desc")),c={title:s,footerView:l,replaceContents:!1,regionName:"addEditDialog",callShow:!0},p=new ADK.UI.Modal({view:t,options:c});p.show(),"Not set"!==$("#locationDisplayName span").text()&&"Not set"!==$("#provider-name span").text()&&$("#btn-add-non-va-med-accept").prop("disabled",!1)},showModal:function(){var e=new ADK.UI.Modal({view:this,options:v});e.show()},editMed:function(e){var t=e.get("qualifiedName");e.set({name:t,IEN:"Loading"}),m=new r(e,!0),m.errorView=new ADK.Views.ServerSideError;var n=m.attributes.pid,i=ADK.UserService.getUserSession().get("site"),a=n?n.split(";")[0]:"";l=l.extend({templateHelpers:{isNew:function(){return!1},isLocal:function(){return ADK.UserService.hasPermission("edit-patient-med")&&a===i?!0:!1}}});var o={title:t,footerView:l,regionName:"addEditDialog",replaceContents:!0},d=new ADK.UI.Modal({view:m,options:o});d.show();var s={patient:ADK.PatientRecordService.getCurrentPatient(),resourceTitle:"med-op-data-orderpresets",criteria:{},onError:function(e,t){},onSuccess:function(e,t){var n=e.models[0];m.updateData(n)}};s.criteria.param=JSON.stringify({orderien:e.get("orderUid")}),ADK.PatientRecordService.fetchCollection(s)}});return V});