define(["underscore","app/applets/add_nonVA_med/opData/opDataUtil","app/applets/add_nonVA_med/utils/validation","moment","backbone"],function(e,t,n,r,i){"use strict";var o,d,a,c,s,l,u,p,m,v,g,f,h,D,A,b,R,S,E,M,P,V,C,I,K=i.Model.extend({});P=function(){return ADK.PatientRecordService.getCurrentPatient().get("localId")},C=function(){var e=ADK.UserService.getUserSession();return e.get("duz")[e.get("site")]},I=function(){return ADK.PatientRecordService.getCurrentPatient().get("visit").locationUid.split(":").splice(-1)[0]},b={error:function(e,n){t.errorView.addError(n.responseText,"Save Failed")},success:function(t,n){var r=ADK.Messaging.getChannel("medicationChannel"),i=r.request("refresh"),o=function(e){var t=e.medicationCollectionHandler;t.fetchAllMeds(),ADK.UI.Modal.hide()};e.delay(i.done,6e3,o)}},g=function(){var e=t.getPreviewValues();R=e.doseString||"",o=e.strength||"",d=e.verb||"",c=e.dose||"",a=e.amount||"",s=e.route||"",l=e.schedule||"",E=e.doseIEN||"",M=e.routeIEN||"",V=e.medName||"",u=$("#prn").is(":checked")?"PRN":"",p=$("#comments").val()||"",m=[],$("#notRecommended").is(":checked")&&m.push("<p>"+$("label[for=notRecommended]").text()),$("#recommended").is(":checked")&&m.push("<p>"+$("label[for=recommended]").text()),$("#nonVApharmacy").is(":checked")&&m.push("<p>"+$("label[for=nonVApharmacy]").text()),$("#nonVAprovider").is(":checked")&&m.push("<p>"+$("label[for=nonVAprovider]").text()),v=$("#startDate").val(),h=(d&&d+" ")+(a&&a+" ")+(s&&s+" ")+(l&&l+" ")+(u&&u+" ")},f=function(){g();var e="<p>",t="<p>",n="<p>";return e+=V,t+=o,n+=(h&&h+" ")+(v&&"Start Date: "+v+" ")+(m&&m+"	")+(p&&p+" "),e+t+n},D=function(){g();var n=t.model;n.set({param:{ien:P(),provider:C(),location:I(),orderDialog:"PSH OERR",displayGroup:48,quickOrderDialog:389,orderID:t.getMed().get("orderUid")||"",ORDIALOG:{medIEN:t.getMed().get("IEN"),strength:o,doseIEN:E,doseString:R,dose:c,routeIEN:M,schedule:l,instructions:h,comment:p,definedComments:e.map(m,function(e){return e.replace(/<p>/g,"")}),ORCHECK:0,ORTS:9,startDate:v,date:new r(v).format("YYYYMMDD")}}},{validate:!0});var i="",d=ADK.PatientRecordService.getCurrentPatient();return i=d.get("icn")?d.get("icn"):d.get("pid")?d.get("pid"):d.get("id"),n.urlRoot=ADK.ResourceService.buildUrl("write-back-save-nonVA-med",{pid:i}),n},A=function(){var e=D();e.save(null,b)};var k={buildPreview:function(){t.model.isValid()&&$("#previewOrder").html(f())},saveMed:function(){A()},setIsEdit:function(e){S=e||!1},isEdit:function(){return S},getVisitModel:function(){var e=new i.Model({visit:ADK.PatientRecordService.getCurrentPatient().get("visit")});return e},getModel:function(){return K.extend(n)},update:function(){t.model.hideClientErrors(),D(),t.model.isValid()?$("#btn-add-non-va-med-accept").prop("disabled",!1):$("#btn-add-non-va-med-accept").prop("disabled",!0)}};return k});