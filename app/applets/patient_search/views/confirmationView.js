define(["backbone","marionette","underscore","hbs!app/applets/patient_search/templates/confirmationTemplate","hbs!app/applets/patient_search/templates/acknowledgeTemplate","hbs!app/applets/patient_search/templates/patientFlagTemplate","hbs!app/applets/patient_search/templates/common/blankTemplate"],function(e,t,n,i,s,a,o){var r=e.Marionette.ItemView.extend({template:o,attributes:{id:"confirmSection"},events:{"click button#ackButton":"ackPatient","click button#confirmFlaggedPatinetButton":"confirmPatient","click button#confirmationButton":"onClickOfConfirm"},initialize:function(e){this.searchApplet=e.searchApplet,this.patientSearchChannel=ADK.Messaging.getChannel("patient_search");var t=this,n={resourceTitle:"authentication-list",cache:!1};n.onError=function(e){},n.onSuccess=function(e,n){t.sites=e},ADK.ResourceService.fetchCollection(n)},updateSelectedPatientModel:function(t){this.currentPatient=t.get("pid"),this.showLoading(),t.on("change:patientImage",this.currentPatientChanged,this),this.model&&this.model.attributes.fullName?(this.patientSearchChannel.stopComplying("confirm_"+this.model.get("pid")),this.model.clear()):this.model=new e.Model;var a={resourceTitle:"authorize-authorize",patient:t};t.has("acknowledged")&&t.unset("acknowledged");var o=this,r={pid:t.get("icn")||t.get("pid")};a.onError=function(e){if(o.model.set(t.attributes),307==e.status||308==e.status){var i;try{i=JSON.parse(e.responseText).message}catch(a){i=e.responseText}o.model.set({ackTitle:"Restricted Record",ackMessage:i.replace(/\s*(\*{3}.*?\*{3})|(?:[*\s]*([^*\s]+ ?)[*\s]*)/g,"$2")}),o.showConfirm(s)}else 403==e.status?o.showUnAuthorized():(o.template=n.template('<br /><p class="error-message padding" role="alert" tabindex="0">'+ADK.ErrorMessaging.getMessage(e.status)+" </p>"),o.render())},a.onSuccess=function(e){o.model.set(t.attributes),o.searchApplet.getPatientPhoto(o.model,r),o.listenTo(o.model,"change:patientImage",o.nonSensitivePatientChanged),o.showConfirm(i)},ADK.PatientRecordService.fetchResponseStatus(a)},nonSensitivePatientChanged:function(e){this.render()},getFullSSN:function(e){var t={resourceTitle:"patient-search-pid",patient:e},n=this;t.onSuccess=function(e){e.length>0?(n.model.set("ssn",e.models[0].get("ssn")),n.render()):(console.log("Error when retrieving full ssn for: "+n.model.get("displayName")),n.render())},ADK.PatientRecordService.fetchCollection(t)},maskSSN:function(e){var t=e.get("ssn").toString().replace(/(?=\d{5})\d/gim,"*");e.set("ssn",t)},updateTemplateToBlank:function(){this.template=o,this.render(),this.$el.parent().hasClass("hidden")||this.$el.parent().addClass("hidden")},showUnAuthorized:function(){this.template=n.template("<div class='unAuthorized well' tabindex='0'><h4 class='text-danger'>You are not authorized to view this record.</h4><h4>Please select another patient.</h4></div>"),this.render(),this.$el.find(".unAuthorized").focus()},showConfirm:function(e){this.template=e,this.getFullSSN(this.model),this.$el.find("#ackButton").is(":visible")?this.$el.find("#ackMessagePanel").focus():this.$el.find("#confirmationButton").focus(),$("#confirmSection").on("affixed.bs.affix",function(){$(this).addClass("col-md-3"),$(this).parent().addClass("noPadding")}),$("#confirmSection").on("affix-top.bs.affix",function(){$(this).hasClass("col-md-3")&&($(this).removeClass("col-md-3"),$(this).parent().removeClass("noPadding"))}),$("#confirmSection").affix({offset:{top:227}})},showLoading:function(){this.$el.parent().hasClass("hidden")&&this.$el.parent().removeClass("hidden"),this.template=n.template('<h5 class="loading"><i class="fa fa-spinner fa-spin"></i> Loading...</h5>'),this.render()},currentPatientChanged:function(e){$("#imageSpinner").hide(),this.render(),this.removeAcknowledgeBox()},ackPatient:function(e){var t=this.model,n={pid:t.get("icn")||t.get("pid"),_ack:!0};this.searchApplet.getPatientPhoto(t,n),this.listenTo(t,"change:patientImage",this.currentPatientChanged),this.model.set({acknowledged:!0});var i={resourceTitle:"patient-search-pid",patient:t},s=this;i.onSuccess=function(e){e.length>0&&(s.model.set("ssn",e.models[0].get("ssn")),s.render()),s.removeAcknowledgeBox()},ADK.PatientRecordService.fetchCollection(i)},removeAcknowledgeBox:function(e){this.$el.find("#ackMessagePanel").removeClass("in"),this.$el.find("#ackButton").addClass("hide"),this.$el.find(".acknowledged").removeClass("hidden"),this.$el.find(".patientDetails").removeClass("hidden"),this.$el.find("#confirmationButton").removeClass("hidden"),this.$el.find("#confirmationButton").is(":visible")&&this.$el.find("#ackMsgTitleId").focus()},onClickOfConfirm:function(t){this.maskSSN(this.model);var i=this,s={resourceTitle:"synchronization-status",patient:this.model};s.onSuccess=function(e,t){},s.onError=function(e,n){404===n.status&&($(t.currentTarget).html("<i class='fa fa-spinner fa-spin'></i> <span> Syncing Patient Data...</span>"),$(t.currentTarget).addClass("disabled").attr("disabled"),i.$el.find("#screenReaderSyncing").addClass("sr-only").removeClass("hidden").focus())},ADK.PatientRecordService.fetchCollection(s);var o=new e.Model({image:this.model.get("patientImage")});ADK.SessionStorage.set.sessionModel("patient-image",o),$(t.currentTarget).button("loading"),i.$el.find("#screenReaderLoading").addClass("sr-only").removeClass("hidden").focus(),this.model.has("acknowledged")&&this.model.set({acknowledged:!0});var r={resourceTitle:"patient-record-patient",patient:this.model};r.onError=function(e,t){var s="";if(""!==t.message||""!==t.responseText)try{var a=JSON.parse(t.responseText);s=n.isObject(a.error)?a.error.message:a.data.error.message}catch(o){s=ADK.ErrorMessaging.getMessage("default")}else s=ADK.ErrorMessaging.getMessage(t.status);i.template=n.template('<br /><p class="error-message padding" role="alert" tabindex="0">'+s+"</p>"),i.render()},r.onSuccess=function(t,s){var o=n.indexOf(t.pluck("pid"),i.currentPatient);-1===o&&(o=n.indexOf(t.pluck("icn"),i.currentPatient));var r=new e.Model({data:t,sites:i.sites});if(console.log(t.models),ADK.SessionStorage.set.sessionModel("patient-domain",r),-1!==o||i.currentPatient===t.models[0].get("icn")){if(-1===o&&(o=0),i.model.has("acknowledged")&&i.model.get("acknowledged")===!0){var l,d;l=i.model.get("ackTitle"),d=i.model.get("ackMessage"),i.model=t.models[o],i.model.set({acknowledged:!0,ackTitle:l,ackMessage:d})}else i.model=t.models[o];c.models[o].has("patientRecordFlag")?(i.model.set("patientRecordFlag",n.sortBy(i.model.attributes.patientRecordFlag,"category")),i.showConfirm(a)):i.patientSearchChannel.command("confirm_"+i.currentPatient)}},this.searchApplet.closeButtonView.model.clear(),this.searchApplet.closeButtonView.render(),this.patientSearchChannel.comply("confirm_"+this.model.get("pid"),function(){i.confirmPatient(t)}),this.listenTo(this,"destroy",function(){this.patientSearchChannel.stopComplying("confirm")});var c=ADK.PatientRecordService.fetchCollection(r)},setPatientStatusClass:function(e){var t="Outpatient";return e.get("admissionUid")&&null!==e.get("admissionUid")&&(t="Inpatient"),e.set("patientStatusClass",t),e},ccowPatientContextChange:function(e,t){var n=this;"ActiveXObject"in window&&"Connected"===ADK.CCOWService.getCcowStatus()?ADK.CCOWService.handleContextChange(e,function(e){e?ADK.Navigation.navigate(ADK.ADKApp.userSelectedDefaultScreen,{trigger:!0}):("Disconnected"===ADK.CCOWService.getCcowStatus()&&ADK.CCOWService.updateCcowStatus("Disconnected"),n.updateTemplateToBlank(),t())}):t()},confirmPatient:function(e){var t=this,n=this.model;t.ccowPatientContextChange(n,function(){t.searchApplet.resetModels(),n=t.setPatientStatusClass(n),ADK.UserDefinedScreens.screensConfigNullCheck(),ADK.Messaging.trigger("patient:selected",n),ADK.Navigation.navigate(ADK.ADKApp.userSelectedDefaultScreen,{trigger:!0})})}});return r});