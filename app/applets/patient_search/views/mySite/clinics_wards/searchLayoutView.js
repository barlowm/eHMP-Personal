define(["backbone","marionette","handlebars","app/applets/patient_search/views/common/searchResultsCollectionView","app/applets/patient_search/views/common/errorMessageView","app/applets/patient_search/views/common/blankView","app/applets/patient_search/views/mySite/clinics_wards/siteResultsCollectionView","hbs!app/applets/patient_search/templates/mySite/clinics_wards/searchViewTemplate","app/applets/patient_search/views/mySite/clinics_wards/dateRangeSelectorView"],function(e,t,i,n,o,s,l,a,r){var c=e.Model.extend({defaults:{filterString:"",locationType:""}}),p=new c,u=new c,h=e.Marionette.ItemView.extend({template:i.compile("<input type='text' placeholder='Filter {{locationType}}' class='form-control padding'></input>"),model:p,initialize:function(e){this.model.set("locationType",e.locationType)},events:{"keyup input":"updateClinicListResults","keydown input":"updateClinicListResults","keypress input":"updateClinicListResults"},updateClinicListResults:function(e){this.model.set({filterString:$(e.currentTarget).val()})}}),d=e.Marionette.LayoutView.extend({template:i.compile("<input type='text' placeholder='Filter {{locationType}}' class='form-control padding'></input><div id='locationDateRange'></div>"),model:u,regions:{locationDateRange:"#locationDateRange"},initialize:function(e){this.model.set("locationType",e.locationType),this.locationDateRangeView=new r({parent:e.parent})},onRender:function(){this.locationDateRange.show(this.locationDateRangeView)},events:{"keyup input":"updateClinicListResults","keydown input":"updateClinicListResults","keypress input":"updateClinicListResults"},updateClinicListResults:function(e){this.model.set({filterString:$(e.currentTarget).val()})}}),w=e.Marionette.LayoutView.extend({searchApplet:void 0,template:a,regions:{patientSearchResults:"#patient-search-results",locationListFilterRegion:"#location-list-filter-input",locationsListErrorRegion:"#location-list-error-message",locationListResultsRegion:"#location-list-results"},initialize:function(e){this.searchApplet=e.searchApplet,this.locationType=e.locationType,"clinics"===this.locationType?this.locationsListFilterView=new d({locationType:e.locationType,parent:this}):this.locationsListFilterView=new h({locationType:e.locationType}),this.locationListResultsView=new l({searchView:this,locationListFilterView:this.locationsListFilterView,locationType:e.locationType})},onRender:function(){this.locationListFilterRegion.show(this.locationsListFilterView),this.locationListResultsRegion.show(this.locationListResultsView)},locationSelected:function(e){var t;t="clinics"===this.locationType?{uid:e.attributes.uid}:{"ref.id":e.attributes.refId,uid:e.attributes.uid},this.searchApplet.confirmationView.updateTemplateToBlank(),this.executeSearch(t)},executeSearch:function(e){t&&(console.log("here"),t.remove=function(){this.collection.on("sync",function(){})},t.remove());var t=new n({searchApplet:this.searchApplet});this.patientSearchResults.show(t),"clinics"===this.locationType&&(e["date.start"]=this.locationsListFilterView.locationDateRangeView.model.get("fromDate"),e["date.end"]=this.locationsListFilterView.locationDateRangeView.model.get("toDate"));var i={resourceTitle:"locations-"+this.locationType+"-search",criteria:e,cache:!0},o=this;i.onError=function(e,i){200===i.status?t.setEmptyMessage("No results found."):t.setEmptyMessage("Error: Unknown"),t.render()},i.onSuccess=function(e){t.setEmptyMessage("No results found."),t.collection=s,t.originalCollection=s,o.refineSearch(o.searchApplet.inputView.filterModel.get("filterString"),t),t.render()};var s=ADK.ResourceService.fetchCollection(i)},refineSearch:function(t,i){if(i.originalCollection&&!i.originalCollection.isEmpty()){if(""!==t){var n=this;i.collection=(new e.Collection).reset(_.filter(i.originalCollection.models,function(e){return n.modelAttributeContainsFilterString(e,"fullName",t)?e:n.modelAttributeContainsFilterString(e,"ssn",t)?e:n.modelAttributeContainsFilterString(e,"birthDate",t)?e:void 0}))}else i.collection=i.originalCollection;i.render()}},modelAttributeContainsFilterString:function(e,t,i){return void 0!==e.attributes[t]&&e.attributes[t].toLowerCase().indexOf(i.toLowerCase())>=0?!0:!1}});return w});