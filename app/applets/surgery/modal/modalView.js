define(["backbone","marionette","underscore","hbs!app/applets/surgery/modal/modalTemplate","app/applets/documents/docUtils"],function(e,t,i,o,s){"use strict";var r=e.Model.extend({}),l=new r,a=e.Marionette.ItemView.extend({template:o,model:r,initialize:function(e){this.filterDocId=e&&e.filterDocId,this.summaryModel=e&&e.summaryModel,this.resourceTitle=e.resourceTitle,this.model=l;var t={};t.resourceTitle=this.resourceTitle,t.viewModel=this.getViewModel(this),this.initialCollection=ADK.PatientRecordService.fetchCollection(t),this.listenTo(this.initialCollection,"sync",this.initialCollectionSynced)},initialCollectionSynced:function(){this.model.set(this.surgeryModel),this.render()},associatedRecordSynced:function(e){if(e&&e.models&&e.models.length){var t=e.models[0],i=t.get("uid");if(this&&l)for(var o=l.get("results"),r=o.length,a=0;r>a;a++)if(o[a].uid===i){o[a].entered=t.get("entered"),o[a].authorDisplayName=t.get("authorDisplayName"),o[a].statusDisplayName=t.get("statusDisplayName"),o[a].text=s.getSummaryModelText(t);var c=o[a].localTitle||a;o[a].hrefId=c.replace(/ /g,"_"),o[a].linkId="LINK_"+o[a].hrefId,this.render();break}}$("#surgeryLoadingDiv").fadeOut(1e3)},getAssociatedResultRecords:function(e){var t=this;if(e){var o=ADK.PatientRecordService.getCurrentPatient,s=i.pluck(e,"uid");i.each(s,function(e){t.assocResults=[];var i={uid:e,collection:{}};t.assocResults.push(i);var s={};s.pid=o,s.uid=e,s.criteria={uid:e},s.resourceTitle="uid",i.collection=ADK.PatientRecordService.fetchCollection(s),t.listenTo(i.collection,"sync",t.associatedRecordSynced)})}},getViewModel:function(){var e=this,t=this.filterDocId,i={parse:function(i){return i.results&&s.hasDocIdRecord(i.results,t)?(l.set(i),e.getAssociatedResultRecords(i.results,e),i):void 0}};return i},resultsAnchorClick:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),i=t.attr("target"),o=$("#"+i),s=$("#mainModal");s&&o&&s.animate({scrollTop:o.offset().top},1e3)},resultsAnchorTopClick:function(e){e.preventDefault(),e.stopPropagation();var t=$("#mainModal");t&&t.animate({scrollTop:0},1e3)},events:{"click .row .js-anchor":"resultsAnchorClick","click .row .js-anchor-top":"resultsAnchorTopClick"}});return a});