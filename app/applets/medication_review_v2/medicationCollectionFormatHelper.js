define(["app/applets/medication_review_v2/appletHelper"],function(e){function t(e,t){var a=new Date(e.date),o=new Date(t.date);return a-o}var a=function(e){for(var a=[],o=0;o<e.length;o++){var s=moment(e[o].get("overallStart"),"YYYYMMDD").valueOf(),n=moment(e[o].get("stopped"),"YYYYMMDD").valueOf(),r=[];if(n>=s)if(0===a.length)a.push([e[0]]);else{for(var i=!1,l=a.length-1;l>=0;l--){i=!1;for(var d=a[l].length-1;d>=0;d--){var g=moment(a[l][d].get("overallStart"),"YYYYMMDD").valueOf(),u=moment(a[l][d].get("stopped"),"YYYYMMDD").valueOf();if(s>=g&&u>s||g>=s&&n>g||g===s&&u===s){i=!0;break}}if(!i){var c={index:l,date:moment(a[l][a[l].length-1].get("overallStart"),"YYYYMMDD").valueOf()};r.push(c)}}if(0===r.length)a.push([e[o]]);else{r.sort(t);var m=r[0];a[m.index].push(e[o])}}}return a},o=function(e){var t=_.filter(e,function(t,a){for(a+=1;a<e.length;a+=1)if(_.isEqual(t.get("uid"),e[a].get("uid")))return!1;return!0});return t},s=function(e,t){var a=e.groupBy(function(e){return e.get("groupbyValue")}),s=_.map(a,function(e,a){var s=new Backbone.Model,n=o(e);s.set("submeds",new d(n));var r=moment();_.each(s.get("submeds").models,function(e){var t=moment(e.get("overallStart"),"YYYYMMDD").valueOf();moment(t).isBefore(r)&&(r=t)}),_.each(s.get("submeds").models,function(e){e.set("greenLineDate",moment(r).format("YYYYMMDD"))});var i=(s.get("submeds").models,ADK.SessionStorage.getModel("globalDate")),l=s.get("submeds").models;return"all-range-global"!==i.get("selectedId")&&t&&(l=_.filter(s.get("submeds").models,function(e){var t=ADK.SessionStorage.getModel("globalDate"),a=moment(t.get("fromDate"),"MM/DD/YYYY").valueOf(),o=moment(e.get("overallStart"),"YYYYMMDD").valueOf(),s=moment(e.get("stopped"),"YYYYMMDD").valueOf(),n=moment(e.get("lastFilled"),"YYYYMMDD").valueOf(),r=moment(e.get("lastAdmin"),"YYYYMMDD").valueOf();if(t.get("fromDate")&&"null"!==t.get("fromDate")){var i=o>=a||n>=a||r>=a||s>=a;return i}if("custom-range-apply-global"===t.get("selectedId")||"custom-range-apply-global"===t.get("selectedId")){var l=moment(t.get("customFromDate"),"MM/DD/YYYY"),d=moment(t.get("customToDate"),"MM/DD/YYYY"),g=(o>=l||n>=l||r>=l)&&d>=s;return g}return!0})),modelToReturn=s.get("submeds").models[0],s.get("submeds").reset(l),modelToReturn.set("submeds",new Backbone.Collection(l)),modelToReturn}),n=_.filter(s,function(e){return e.get("submeds").models.length>0});return n},n=function(e){var t=e.groupBy(function(e){return"key"}),o={},s=_.map(t,function(e,t){return{key:t,sets:a(e)}});_.each(s,function(e){for(var t=e.key,a=0;a<e.sets.length;a++){var s=t+a.toString();0===a&&(s=t+"_topFacilityRow"),o[s]=e.sets[a]}});var n=_.map(o,function(e,t){var a="";t.indexOf("_topFacilityRow")>=0&&(a="grayTopBorder"),e[0].set("topBorderClass",a);var o=new Backbone.Model({topBorderClass:a,firstFacilityMed:e[0],facilityName:e[0].get("facilityName"),facilityMoniker:e[0].get("facilityMoniker"),facilityMeds:new Backbone.Collection(e)});if(o.get("facilityMeds").models.length>1){o.set("secondFacilityMed",o.get("facilityMeds").models[1]);var s=o.get("secondFacilityMed").get("dosages")&&void 0!==o.get("secondFacilityMed").get("dosages")[0]&&void 0!==o.get("secondFacilityMed").get("dosages")[0].dose&&o.get("firstFacilityMed").get("dosages")&&void 0!==o.get("firstFacilityMed").get("dosages")[0]&&void 0!==o.get("firstFacilityMed").get("dosages")[0].dose;s&&(parseFloat(o.get("firstFacilityMed").get("dosages")[0].dose)>parseFloat(o.get("secondFacilityMed").get("dosages")[0].dose)?(o.get("firstFacilityMed").set("changeInMedicationDoseClass","fa fa-arrow-up"),o.set("ariaLabelAdditionalText"," There was an increase in dosage from "+o.get("secondFacilityMed").get("dosages")[0].instructions+" to "+o.get("firstFacilityMed").get("dosages")[0].instructions)):parseFloat(o.get("firstFacilityMed").get("dosages")[0].dose)<parseFloat(o.get("secondFacilityMed").get("dosages")[0].dose)+"."&&(o.get("firstFacilityMed").set("changeInMedicationDoseClass","fa fa-arrow-down"),o.set("ariaLabelAdditionalText"," There was a decrease in dosage from "+o.get("secondFacilityMed").get("dosages")[0].instructions+" to "+o.get("firstFacilityMed").get("dosages")[0].instructions+".")))}return o});return void 0!==n[0]&&n[0].set("topBorderClass",""),n},r=function(t,a){var o=s(t,a),r=[];return _.each(o,function(t){r.push(t.get("displayName"));var a=n(t.get("submeds")),o=e.getGraphTextInfo(a);_.each(a,function(e){e.set("graphInfoText",o)}),t.set("subMedsInternalGroupModels",new Backbone.Collection(a)),void 0!==t.get("subMedsInternalGroupModels").models[0]&&t.get("subMedsInternalGroupModels").models[0].set("isFirstOverlappingMed",!0);var s=(ADK.SessionStorage.getModel("globalDate"),a);t.set("unfilteredCollectionToGraph",new Backbone.Collection(s)),t.set("hasOverLappingMeds",!0)}),{medicationSubGroups:o,groupNames:r}},i={ACTIVE:1,UNRELEASED:1,PENDING:2,EXPIRED:3,DISCONTINUED:4},l=Backbone.Collection.extend({comparator:function(e,t){var a=i[e.get("standardizedVaStatus")]||100,o=i[t.get("standardizedVaStatus")]||100;if(a!==o)return o>a?-1:1;var s=e.get("displayName"),n=t.get("displayName");return n>s?-1:s>n?1:0}}),d=Backbone.Collection.extend({comparator:function(e,t){var a=i[e.get("standardizedVaStatus")]||100,o=i[t.get("standardizedVaStatus")]||100,s=e.get("isNotUserSiteMed")||!1,n=t.get("isNotUserSiteMed")||!1,r="N"===e.get("vaType")&&1===a,l="N"===t.get("vaType")&&1===o;if(r&&l){if(!s)return-1;if(!n)return 1}else{if(r)return-1;if(l)return 1}var d=moment(e.get("stopped"),"YYYYMMDD").valueOf(),g=moment(t.get("stopped"),"YYYYMMDD").valueOf();if(d!==g)return d>g?-1:1;var u=e.get("facilityName"),c=t.get("facilityName");return s!==n?s?1:-1:u!==c?u>c?1:-1:a!==o?o>a?-1:1:0}}),g=function(e,t){var a={};return _.each(e.models,function(e){for(var o=null,s=0;s<e.get("meds").models.length;s++)if(e.get("meds").models[s].get("displayName")===t){o=e.get("meds").models[s];break}"inpatient"===e.get("type").toLowerCase()?a.inpatientMeds=o:a.outpatientMeds=o}),a},u=function(e){var t=[];_.each(e.models,function(e){t=t.concat(e.get("groupNames"))});var a=_.unique(t);return a};return{splitOverLappingMedsConcat:a,removeDuplicateMedsIfPresent:o,groupByMedication:s,groupByFacility:n,groupByMedicationNameThenByFacility:r,medsCollection:l,subMedsCollection:d,getMedicationGroup:g,getMedicationGroupNames:u}});