define(["app/applets/medication_review_v2/appletHelper","app/applets/medication_review_v2/medicationCollectionFormatHelper"],function(e,t){function o(){var e={defaults:{fillsAllowed:"Unk"}};return e}var a=Backbone.Model,n={initialized:!1,fetchAllMeds:function(e,t){var a=this;this.useGlobalDateFilter=e;var n={resourceTitle:"patient-record-med",cache:!1,criteria:{filter:'nin(vaStatus,["CANCELLED", "UNRELEASED"])'},viewModel:o(),collectionConfig:{groupCollectionModels:a.groupCollectionModels,parent:a,useGlobalDateFilter:a.useGlobalDateFilter,collectionParse:a.resetCollections},patient:ADK.PatientRecordService.getCurrentPatient()};return n.onSuccess=function(e,o){_.isUndefined(t)||"function"!=typeof t||t(e)},ADK.PatientRecordService.fetchCollection(n)},resetCollections:function(t){_.each(t.models,function(t){t.attributes=e.parseMedResponse(t.attributes)});var o,a,n,r=this,i=_.filter(t.models,function(e){var t=ADK.SessionStorage.getModel("globalDate"),o=moment(t.get("fromDate"),"MM/DD/YYYY").valueOf(),a=moment(e.get("overallStart"),"YYYYMMDDHHmm").valueOf(),n=moment(e.get("stopped"),"YYYYMMDDHHmm").valueOf(),i=moment(e.get("lastFilled"),"YYYYMMDDHHmm").valueOf(),l=moment(e.get("lastAdmin"),"YYYYMMDDHHmm").valueOf();e.get("qualifiedName");if("all-range-global"!==t.get("selectedId")&&r.useGlobalDateFilter){if(t.get("fromDate")&&"null"!==t.get("fromDate")){var s=a>=o||i>=o||l>=o||n>=o;return s}if("custom-range-apply-global"===t.get("selectedId")){var u=moment(t.get("customFromDate"),"MM/DD/YYYY").valueOf(),c=moment(t.get("customToDate"),"MM/DD/YYYY").valueOf(),d=(a>=u||i>=u||l>=u)&&c>=n;return d}return!0}return!0}),l=new Backbone.Collection(i),s=ADK.SessionStorage.getModel("globalDate");if("all-range-global"===s.get("selectedId")){var u=function(e,t){var o=new Date(e),a=new Date(t);return-1*(o-a)},c=[];_.each(l.models,function(e){n=_.isUndefined(e.get("stopped"))||""===e.get("stopped")?moment().add(6,"months"):e.get("stopped"),_.isUndefined(e.get("overallStart"))||(c.push(moment(e.get("overallStart"),"YYYYMMDDHHmm").valueOf()),c.push(moment(e.get("stopped"),"YYYYMMDDHHmm").valueOf()))}),c.sort(function(e,t){return u(e,t)});var d=_.unique(c);o=_.last(d),a=_.first(d)}else o=moment(s.get("fromDate"),"MM/DD/YYYY").valueOf(),a=moment(s.get("toDate"),"MM/DD/YYYY").valueOf();return _.each(t.models,function(e){e.set("graphRelativeityNewestTime",a),e.set("graphRelativeityOldestTime",o)}),this.parent.shadowCollection=t.clone(),this.groupCollectionModels(t,this.useGlobalDateFilter)},groupCollectionModels:function(e,o){var n=function(e){var t=ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass");return"inpatient"===t.toLowerCase()?"inpatient"===e.toLowerCase()?1:0:"outpatient"===t.toLowerCase()?"outpatient"===e.toLowerCase()?1:0:void 0},r=new Backbone.Model({type:"inpatient",isNonVa:!1,meds:new Backbone.Collection,sortOrderValue:n("inpatient"),firstModel:ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass"),groupNames:[]}),i=new Backbone.Model({type:"outpatient",isNonVa:!1,meds:new Backbone.Collection,sortOrderValue:n("outpatient"),firstModel:ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass"),groupNames:[]}),l=e.groupBy(function(e){return e.get("firstGroupByValue")}),s=_.map(l,function(e,o){return new a({type:o,isNonVa:!1,meds:new t.medsCollection(e),sortOrderValue:n(o),firstModel:ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass")})});_.each(s,function(e){var a=(e.get("type"),t.groupByMedicationNameThenByFacility(e.get("meds"),o));e.set("groupNames",a.groupNames),e.get("meds").reset(a.medicationSubGroups)});var u=ADK.PatientRecordService.getCurrentPatient().get("patientStatusClass");if(0===s.length)s="inpatient"===u.toLowerCase()?[r,i]:[i,r];else if(1===s.length)"inpatient"===u.toLowerCase()?"inpatient"===s[0].get("type").toLowerCase()?s[1]=i:(s[1]=s[0],s[0]=r):"outpatient"===s[0].get("type").toLowerCase()?s[1]=r:(s[1]=s[0],s[0]=i);else if(2===s.length&&s[0].get("type").toLowerCase()!==u.toLowerCase()){var c=s[0];s[0]=s[1],s[1]=c}return s[0].set("expandOnInitialRender",!0),e.comparator=function(e,t){return e.get("sortOrderValue")>t.get("sortOrderValue")?0:1},s}};return n});