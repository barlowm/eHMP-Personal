define(["backbone","marionette","app/applets/medication_review_v2/views/medicationDetailView","app/applets/medication_review_v2/medicationCollectionHandler","hbs!app/applets/medication_review_v2/templates/detailTemplate","app/applets/medication_review_v2/appletHelper","app/applets/medication_review_v2/medicationCollectionFormatHelper"],function(e,i,t,r,o,a,n){function l(e,i){var t=a.getMedicationGroupbyData(i),r="eq("+t.groupbyField+',"'+t.groupbyValue+'")',o=$.Deferred();"name"===t.groupbyField&&(r='ilike(name,"'+t.groupbyValue+'%")');var n={cache:!0,resourceTitle:"patient-record-med",viewModel:d};return n.onSuccess=function(e,t){var r=_.filter(e.models,function(e){return i.get("groupbyValue")===e.get("groupbyValue")});e.reset(r),o.resolve(e)},ADK.PatientRecordService.fetchCollection(n),o.promise()}var c=t.extend({template:o}),d={defaults:{fillsAllowed:"Unk"},parse:function(e){return a.parseMedResponse(e)}},p={initialize:function(i){var t=ADK.Messaging.getChannel(i);t.on("detailView",function(i){if(i.applet){var t={cache:!0,criteria:{uid:i.uid},resourceTitle:"patient-record-med",viewModel:d};t.onSuccess=function(t,r){var o=l(i,t.models[0]);o.done(function(i){var r=i.clone();r.reset(n.removeDuplicateMedsIfPresent(r.models));var o=n.groupByFacility(r);r.reset(o),ADK.showModal(new c({model:new e.Model({meds:i})}),{size:"large",title:"Medication - "+t.first().get("name"),groupedMeds:r})})},ADK.PatientRecordService.fetchCollection(t)}}),t.reply("detailView",function(i){var t=$.Deferred(),r={cache:!0,criteria:{uid:i.uid},resourceTitle:"patient-record-med",viewModel:d};return r.onSuccess=function(r,o){var a=l(i,r.models[0]);a.done(function(i){var o=i.clone();o.reset(n.removeDuplicateMedsIfPresent(o.models));var a=n.groupByFacility(o);o.reset(a);var l=new c({model:new e.Model({meds:i})});t.resolve({view:l,title:"Medication - "+r.first().get("name"),groupedMeds:o})})},ADK.PatientRecordService.fetchCollection(r),t.promise()})}};return p});