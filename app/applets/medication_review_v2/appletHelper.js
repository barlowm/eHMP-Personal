define(["backbone","marionette","underscore"],function(e,t,i){"use strict";var a={setStopped:function(e){if(void 0===e.stopped){var t,i=ADK.SessionStorage.getModel("globalDate"),a=moment.duration({months:6});t="all-range-global"===i.get("selectedId")?moment().add(a).format("YYYYMMDDHHmm"):moment(i.get("toDate"),"MM/DD/YYYY").format("YYYYMMDDHHmm"),e.stopped=t}return e},getGraphTextInfo:function(e){if(0===e.length)return"";var t=e.length,a="",s=moment(e[0].get("firstFacilityMed").get("graphRelativeityOldestTime")).format("MMMM, DD, YYYY"),n=moment(e[0].get("firstFacilityMed").get("graphRelativeityNewestTime")).format("MMMM, DD, YYYY"),r=0;i.each(e,function(e){var t=e.get("facilityName"),i=e.get("facilityMeds").models.length,s="order";r+=i,1!==i&&(s+="s"),a=a+i+" medication "+s+" in "+t+". "}),a="with overlapping orders from "+t+" facilities. "+a,1===t&&(a="with "+r+" orders. ");var o="The Graph Shows Order history from "+s+" to "+n+" ";return o+a},isPRN:function(e){return e.sig&&-1!=e.sig.toString().toUpperCase().indexOf("AS NEEDED")?!0:e.scheduleName&&"PRN"==e.scheduleName.toString()?!0:e.scheduleName&&-1!=e.scheduleName.toString().indexOf("PRN")?!0:!1},hasFillDetail:function(e){return("O"==e.vaType||e.supply)&&e.orders[0].fillsAllowed?!0:!1},hasScheduledTimes:function(e){return"I"==e.vaType?!0:!1},hasDailyDoseInfo:function(e){return e.scheduleFreq&&e.dose&&("O"==e.vaType||"N"==e.vaType)?!0:!1},getDailyOrScheduledDosePrefix:function(e){return this.hasScheduledTimes(e)?"Scheduled Times":this.hasDailyDoseInfo(e)?"Total Daily":!1},getID:function(e){return e.uid.replace(/[:|.]/g,"_")},isNotUserSiteMed:function(e){var t=e.uid.split(":"),i=ADK.UserService.getUserSession().get("site"),a=t[3];return i!==a&&(e.isNotUserSiteMed=!0),e},getDailyOrScheduledDose:function(e){return this.hasScheduledTimes(e)?"No Data":this.hasDailyDoseInfo(e)?1440/e.scheduleFreq*parseInt(e.dose)+" "+e.units:!1},getExpirationLabel:function(e){if(!e.vaStatus)return"";switch(e.vaStatus.toUpperCase()){case"PENDING":return"";case"ACTIVE":return"Expires";case"SUSPEND":return"Ordered";case"HOLD":return"Ordered";case"EXPIRED":return"Expired";case"UNRELEASED":return"";case"DISCONTINUED":return"Discontinued";case"DISCONTINUED/EDIT":return"Discontinued";default:return""}},getFormattedLastAction:function(e){return ADK.utils.getTimeSince(e.lastAction,!0)},getLastDatePrefix:function(e){return"N"==e.vaType?!1:"I"==e.vaType?"Last admin":e.lastFilled||e.supply?"Last filled":!1},getLastDate:function(e){return"N"==e.vaType?"":"I"==e.vaType?e.lastAdmin:"O"==e.vaType||e.supply?e.lastFilled:""},getLastFillStyle:function(e){return this.hasFillDetail(e)?0===e.orders[0].fillsRemaining?"noFillsRemain":e.orders[0].fillsRemaining<=3?"fewFillsRemain":"":""},getLastFillDetails:function(e){return"O"!=e.vaType||e.supply?"":this.hasFillDetail(e)?e.orders[0].fillsRemaining+" Refills ("+e.orders[0].daysSupply+" days each)":""},getPickUpType:function(e){return"W"==e.routing?"Window":"M"==e.routing?"Mail":!1},getStandarizedFacilityCode:function(e){return"DOD"==e.facilityCode?"DOD":"500"==e.facilityCode?"NCH":""},getStandardizedVaStatus:function(e){var t;return e.vaStatus?(t=e.vaStatus.toUpperCase(),"DISCONTINUED/EDIT"==t&&(t="DISCONTINUED"),t):""},getSubcategory:function(e){return this.isPRN(e)?"PRN":"V"==e.vaType?"IV":!1},getFirstGroupByValue:function(e){if(e.supply||e.IMO||"Medication, Clinic Order"===e.kind)return"Outpatient";var t=e.vaType;switch(t.toUpperCase()){case"O":return"Outpatient";case"N":return"Outpatient";case"I":return"Inpatient";case"V":return"Inpatient"}},getSummaryViewDate:function(e){var t=this.getExpirationLabel(e);if(!t)return!1;switch(t){case"Expired":return e.overallStop;case"Expires":return e.overallStop;case"Discontinued":return e.stopped;case"Ordered":return e.orders[0].ordered;default:return!1}},getNextAdminStatus:function(e){var t=e.standardizedVaStatus.toLowerCase();return"expired"===t?"Expired":"discontinued"===t?"Discontinued":"pending"===t?"Pending":"active"===t?"Active":void 0},getNextAdminData:function(e){var t={display:e.nextAdminStatus};if("Expired"===e.nextAdminStatus){var i=ADK.utils.getTimeSince(e.stopped,!0);t.date=i.count+i.timeUnits,t.description="This medication was expired "+i.timeSinceDescription+" ago. ",t.label="label label-danger",t.hasLabel=!0}else if("Discontinued"===e.nextAdminStatus){var a=ADK.utils.getTimeSince(e.stopped,!0);t.date=a.count+a.timeUnits,t.description="This medication was discontinued "+a.timeSinceDescription+" ago. ",t.label="label label-default",t.hasLabel=!0}else"Pending"===status?t.description="This medication is Pending. ":"Active"===e.nextAdminStatus&&(t.description="This medication is Active. ");return t},getFillableStatus:function(e){var t=e.standardizedVaStatus.toLowerCase();return"expired"===t?"Expired":"discontinued"===t?"N"===e.vaType?"Non VA - Discont.":"Discontinued":"pending"===t?"Pending":"N"===e.vaType?"Non VA":0===e.fillsRemaining?"0 Refills":"Fillable for"},getLastFill:function(e){return i.isUndefined(e.lastFilled)?e.fills.length>0?(e.fills.length>1&&i.sortBy(e.fills,function(e){return e.dispenseDate}).reverse(),e.fills[0].dispenseDate):"none":e.lastFilled},getCalculatedFillsRemaining:function(e){return"DOD"===e.facilityName.toUpperCase(),void 0!==e.fillsRemaining?parseInt(e.fillsRemaining):void 0===e.fillsRemaining?void 0!==e.orders[0].fillsRemaining?parseInt(e.orders[0].fillsRemaining):0:void 0},getFillableData:function(e){var t=e.stopped||"none",i=e.daysSupply||e.orders[0].daysSupply,s=a.getLastFill(e),n=e.fillsRemaining,r=e.fillableStatus,o={display:r,hasLabel:!1};if("Fillable for"!==r){if("Expired"===r){var d=ADK.utils.getTimeSince(t,!0);return o.description="This medication was expired "+d.timeSinceDescription+" ago. ",o.date=d.count+d.timeUnits,o.label="label label-danger",o.hasLabel=!0,o}if("0 Refills"===r)return o.description="This medication is active with no refills remaining. ",o.label="label label-danger",o.hasLabel=!0,o;if("Discontinued"===r||"Non VA - Discont."===r){var l=ADK.utils.getTimeSince(t,!0);return o.description="This medication was discontinued "+l.timeSinceDescription+" ago. ","Non VA - Discont."===r&&(o.description="This medication is Non VA and was discontinued "+l.timeSinceDescription+" ago. "),o.date=l.count+l.timeUnits,o.label="label label-default",o.hasLabel=!0,o}if("Pending"===r)return o.description="This medication is Pending. ",o;if("Non VA"===r){e.standardizedVaStatus.toLowerCase();return o.description="This medication is an Active Non VA medication. ",o}return o}var u=moment(),c=moment(s,"YYYYMMDDHHmm"),g=1440*i,p=c.diff(u,"minutes"),m=g*(n-1)+Math.max(p+g,0),f=moment(e.expirationDate,"YYYYMMDDHHmm"),v=f.diff(u,"minutes");v>=0&&m>v&&(m=v);var h=moment.duration(m,"minutes"),y="";60>m?y=m+"'":m>=60&&2880>m?y=parseInt(h.asHours())+"h":m>=2880&&86400>=m?y=parseInt(h.asDays())+"d":m>86400&&1051200>=m?y=parseInt(h.asMonths())+"m":m>1051200&&(y=parseInt(h.asYears())+"y"),o.description="This medication is Active and fillable for "+y+". ",o.date=y;var D=m/1440;return"Fillable for"===r&&90>=D&&(o.label="label label-warning",o.hasLabel=!0),o},getIsActiveNonVA:function(e){return"N"===e.vaType.toUpperCase()&&"ACTIVE"===e.standardizedVaStatus.toUpperCase()&&(e.isActiveNonVA=!0),e},setMedCategory:function(e){return"Inpatient"===e.firstGroupByValue?e.CategoryInpatient=!0:e.CategoryOutpatient=!0,e},getGroupByName:function(e){if(this.hasIngrediantCodeName(e))return e.products[0].ingredientCodeName.toLowerCase();if(e.qualifiedName)return e.qualifiedName.toLowerCase();var t=e.name.split(",")[0];return t.split(" ")[0].toLowerCase()},hasIngrediantCodeName:function(e){var t=e.products&&e.products[0]&&e.products[0].ingredientCodeName;return t},getGroupByValue:function(e){if(this.hasIngrediantCodeName(e))return e.products[0].ingredientCodeName;if(e.qualifiedName)return e.qualifiedName;var t=e.name.split(",")[0];return t.split(" ")[0]},getGroupByField:function(e){return this.hasIngrediantCodeName(e)?"products[].ingredientCodeName":e.qualifiedName?"qualifiedName":"name"},getAriaLabelText:function(e){function t(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function i(e,i,a){return e.replace(new RegExp(t(i),"g"),a)}var a=e.firstGroupByValue.toLowerCase(),s=e.displayName,n=e.vaType;switch(n.toUpperCase()){case"I":n="Inpatient";break;case"O":n="Outpatient";break;case"V":n="IV";break;case"N":n="Non V.A."}e.IMO?n="Clinical Order":e.supply&&(n="Supply");var r="a Sig value of: "+e.doseUnitRouteSchedule+". ";(void 0===e.doseUnitRouteSchedule||""===e.doseUnitRouteSchedule||null===e.doseUnitRouteSchedule)&&(r="no Sig provided. "),r=i(r.toLowerCase(),"inj","injection"),r=i(r.toLowerCase(),"soln","solution"),s=i(s.toLowerCase(),"inj","injection"),s=i(s.toLowerCase(),"soln","solution");var o="You are viewing "+n+" medication: "+s+" with "+r,d=("The Last change for this medication: "+e.lastActionDetails.timeSinceDescription+". ",e.fillableDays.description);return"inpatient"===a&&(d=e.nextAdminData.description),o+d},getSig:function(e){var t="",i="",a="",s="";void 0!==e.strength&&(a=e.strength),void 0!==e.productFormName&&(s=e.productFormName),void 0!==e.sig&&(i=e.sig);var n=a+" "+s+" "+i;if(void 0!==e.dosages)for(var r=0;r<e.dosages.length;r++)if(void 0!==e.dosages[r].dose&&""!==e.dosages[r].dose&&void 0!==e.dosages[r].units&&void 0!==e.dosages[r].routeName&&void 0!==e.dosages[r].scheduleName&&void 0!==e.dosages[r].complexConjunction&&void 0!==e.dosages[r].complexDuration){var o=e.dosages[r].complexConjunction,d=" ";o&&(d="T"===o?"Then":"A"===o?"And":"Except"),t=t+" "+e.dosages[r].dose+e.dosages[r].units+" "+e.dosages[r].routeName+" "+e.dosages[r].scheduleName+" "+e.dosages[r].complexDuration+" "+d}else t=void 0!==e.dosages[r].dose&&""!==e.dosages[r].dose&&void 0!==e.dosages[r].units&&void 0!==e.dosages[r].routeName&&void 0!==e.dosages[r].scheduleName?t+" "+e.dosages[r].dose+e.dosages[r].units+" "+e.dosages[r].routeName+" "+e.dosages[r].scheduleName:void 0!==e.dosages[r].ivRate&&e.dosages[r].ivRate.length>0?e.dosages[r].ivRate:void 0!==e.dosages[r].duration&&e.dosages[r].duration.length>0?e.dosages[r].duration:n;else t=n;return t=t.trim()},sliceString:function(e){return e.slice(e.lastIndexOf(":")+1,-1)},sortCollection:function(e,t,i,a,s){if(a){var n=!1;if(e.at(0).attributes[t])n=!0;else if(e.at(e.length-1).attributes[t])n=!0;else for(var r=1,o=e.length;o-1>r;r++)if(e.at(r).attributes[t]){n=!0;break}var d=!1;if(e.at(0).attributes[i])d=!0;else if(e.at(e.length-1).attributes[i])d=!0;else for(var l=1,u=e.length;u-1>l;l++)if(e.at(l).attributes[i]){d=!0;break}n&&(e.comparator=function(e,n){var r;r=s?1:-1;var o=e.get(t),l=n.get(t),u=e.get(i),c=n.get(i);if("alphanumerical"===a||"numeric"===a||"date"===a||"alphabetical"===a){if(o===l){if(d){if(u>c||void 0===c)return-1;if(c>u)return 1}return 0}return l>o||void 0===l?-1*r:1*r}},e.sort())}},parseMedResponse:function(e){if(void 0!==e.supply?e.groupType="Supplies":void 0!==e.IMO?e.groupType="Clinic Orders":(e.groupType=e.vaType,"V"==e.groupType&&(e.groupType="I")),void 0!==e.name&&(e.name=e.name.toLowerCase()),void 0!==e.products&&void 0!==e.products[0]&&(void 0!==e.products[0].ingredientName&&(e.ingredientName=e.products[0].ingredientName),void 0!==e.products[0].strength&&(e.strength=e.products[0].strength)),void 0!==e.dosages&&void 0!==e.dosages[0]&&(void 0!==e.dosages[0].dose&&(e.dose=e.dosages[0].dose),void 0!==e.dosages[0].units&&(e.dosagesUnits=e.dosages[0].units),void 0!==e.dosages[0].routeName&&(e.routeName=e.dosages[0].routeName),void 0!==e.dosages[0].scheduleName&&(e.scheduleName=e.dosages[0].scheduleName),void 0!==e.dosages[0].start&&(e.start=e.dosages[0].start),void 0!==e.dosages[0].scheduleFreq&&(e.scheduleFreq=e.dosages[0].scheduleFreq),void 0!==e.dosages[0].scheduleType&&(e.scheduleType=e.dosages[0].scheduleType),void 0!==e.dosages[0].instructions&&(e.instructions=e.dosages[0].instructions)),void 0!==e.orders&&void 0!==e.orders[0]&&(void 0!==e.orders[0].fillsAllowed&&(e.fillsAllowed=e.orders[0].fillsAllowed),void 0!==e.orders[0].daysSupply&&(e.daysSupply=e.orders[0].daysSupply),void 0!==e.orders[0].orderUid&&(e.orderUid=this.sliceString(' "'+e.orders[0].orderUid+' "')),void 0!==e.orders[0].fillsRemaining&&(e.fillsRemaining=e.orders[0].fillsRemaining)),void 0!==e.fills&&void 0!==e.fills[0]&&e.fills[0].dispenseDate&&(e.dispenseDate=e.fills[0].dispenseDate,e.routing=e.fills[0].routing),void 0!==e.medStatusName&&(e.medStatusName=e.medStatusName.toUpperCase()),void 0!==e.uid)try{e.detailId=e.uid.replace(/[:|.]/g,"_")}catch(t){}return e=a.isNotUserSiteMed(e),e.id=a.getID(e),e.fillsRemaining=a.getCalculatedFillsRemaining(e),e.dailyOrScheduledDosePrefix=a.getDailyOrScheduledDosePrefix(e),e.dailyOrScheduledDose=a.getDailyOrScheduledDose(e),e.summaryViewDate=a.getSummaryViewDate(e),e.expirationLabel=a.getExpirationLabel(e),e.lastDate=a.getLastDate(e),e.lastDatePrefix=a.getLastDatePrefix(e),e.lastFillStyle=a.getLastFillStyle(e),e.lastFillDetails=a.getLastFillDetails(e),e.pickUpType=a.getPickUpType(e),e.standardizedFacilityCode=a.getStandarizedFacilityCode(e),e.standardizedVaStatus=a.getStandardizedVaStatus(e),e=a.setStopped(e),e.subcategory=a.getSubcategory(e),e.firstGroupByValue=a.getFirstGroupByValue(e),e.genericMedClass=a.getFirstGroupByValue(e).toLowerCase(),e.fillableStatus=a.getFillableStatus(e),e.fillableDays=a.getFillableData(e),e.nextAdminStatus=a.getNextAdminStatus(e),e.nextAdminData=a.getNextAdminData(e),e.lastActionDetails=a.getFormattedLastAction(e),e.doseUnitRouteSchedule=a.getSig(e),e.groupbyField=a.getGroupByField(e),e.groupbyValue=a.getGroupByValue(e),e.facilityName&&(e.groupbyFacility=e.facilityName),e.displayName=a.getGroupByName(e),e.ariaLabelText=a.getAriaLabelText(e),e=a.getIsActiveNonVA(e),e=a.setMedCategory(e),ADK.Enrichment.addFacilityMoniker(e),e},getMedicationGroupbyData:function(e){return{groupbyValue:e.get("groupbyValue"),groupbyField:e.get("groupbyField"),groupbyFacility:e.get("groupbyFacility")}}};return a});