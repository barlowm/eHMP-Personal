define(["jquery","backbone","marionette","highcharts","moment","hbs!app/applets/time_graph/chartView","app/applets/time_graph/appHelper","app/applets/time_graph/debugFlag"],function(t,e,i,s,a,r,n,o){"use strict";function h(t){return t.xAxis?(l&&console.log(t),"nf_master"===o.filtering_mode&&""===n.chartOptions.chart.zoomType?void t.preventDefault():(l&&console.log("Start -->>"+s.dateFormat("%m %d %Y",t.xAxis[0].min)),l&&console.log("Stop  -->>"+s.dateFormat("%m %d %Y",t.xAxis[0].max)),ADK.Messaging.getChannel("time_line_internal").trigger("setFilter"),ADK.Messaging.getChannel("time_line").trigger("setTimeRangeFilter",{type:"time_line_filter",start:s.dateFormat("%d-%B-%Y",t.xAxis[0].min),stop:s.dateFormat("%d-%B-%Y",t.xAxis[0].max),mode:o.filtering_mode}),!0)):void 0}var l=o.flag,g=o.eventsByType;n.chartOptions.chart.events={selection:h};var c=e.Marionette.ItemView.extend({template:r,defaultRange:"",statusFiltered:!1,timeChart:null,htmlTableView:"",chartOptions:n.chartOptions,events:{"click .tl_reset":"buttonReset",keydown:"onKey"},initialize:function(){this._super=e.Marionette.ItemView.prototype;var t=ADK.Messaging.getChannel("time_line");this.listenTo(t,"resetGraph",function(t){this.statusFiltered&&this.buttonReset()},this),this._super.initialize.apply(this,arguments)},buttonReset:function(){l&&console.log("reset->click"),ADK.Messaging.getChannel("time_line").trigger("clearTimeRangeFilter"),ADK.Messaging.getChannel("time_line_internal").trigger("resetFilter")},onKey:function(t){var e=t.keyCode||t.which;l&&console.log("reset->click"),27==e&&this.buttonReset()},setChartData:function(t){var e,i=0,s={};if("ok"==t.msg){var r,o;for(r=0;r<this.chartOptions.series.length;r++)g?(this.chartOptions.series=[],this.chartOptions.legend.enabled=!0):this.chartOptions.series[r].data=[];if(t.nEvents>0){var h=0,c={};if(g){for(o=0;o<t.eventsByType.length;o++)s[t.eventsByType[o][0]]=o,this.chartOptions.series.push({yAxis:0,data:[],name:"",color:"",type:"column"});l&&console.log("eventDictionary----->>"+JSON.stringify(s))}for(r=0;r<t.nEvents;r++)if(g){e=new Date(a(t.agrData[r][0],"YYYYMMDD").format("YYYY"),a(t.agrData[r][0],"YYYYMMDD").format("MM")-1,a(t.agrData[r][0],"YYYYMMDD").format("DD"),12),h=0,c=t.agrData[r][1].eventsByTypes;for(var p in c)h+=2,e.setHours(e.getHours()+h),this.chartOptions.series[s[p]].name=p,this.chartOptions.series[s[p]].color=n.getColorByType(p),this.chartOptions.series[s[p]].data.push([Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),c[p]]),l&&console.log(e+"| event type----->>"+p+" index--->> "+s[p]+" event value---->>"+c[p]),l&&console.log("UTC-->> "+e.getFullYear()+" - "+(e.getMonth()+1)+" - "+e.getDate()),i<c[p]&&(i=c[p])}else e=Date.UTC(a(t.agrData[r][0],"YYYYMMDD").format("YYYY"),a(t.agrData[r][0],"YYYYMMDD").format("MM")-1,a(t.agrData[r][0],"YYYYMMDD").format("DD"),12),this.chartOptions.series[0].data.push([e,t.agrData[r][1].total]),i<t.agrData[r][1].total&&(i=t.agrData[r][1].total);this.chartOptions.yAxis.max=i,l&&console.log("Max Y scale for Chart ----->>"+this.chartOptions.yAxis.max),e=Date.UTC(a(t.firstEvent,"YYYYMMDD").format("YYYY"),a(t.firstEvent,"YYYYMMDD").format("MM")-1,a(t.firstEvent,"YYYYMMDD").format("DD"),12),this.chartOptions.plotOptions.series.pointStart=e,this.chartOptions.plotOptions.column.cropThreshold=t.nEvents,this.tableView()}}},showChart:function(){if(l&&console.log("Show Time-graph chart ----->>"),o.no_data_hide_div&&t(".time-chart-container-header").show(),null!==this.timeChart)if(g){var e,i=this.timeChart.series.length;for(e=0;e<this.timeChart.series.length;e++)this.timeChart.series[0].remove(!1);for(l&&console.log("Time-graph chart series removed ----->> "+e+" from "+i),e=0;e<this.chartOptions.series.length;e++)this.timeChart.addSeries(this.chartOptions.series[e]),l&&console.log("Adding series---> "+e);l&&console.log("Time-graph chart series added ----->> "+e+" from "+this.chartOptions.series.length)}else this.timeChart.series[0].setData(this.chartOptions.series[0].data);else l&&console.log("Time-graph chart series on init ----->> "+this.chartOptions.series.length),this.timeChart=new Highcharts.Chart(this.chartOptions)},tableView:function(){for(var e="<table><tr><th>Time</th><th>"+this.chartOptions.series[0].name+"</th></tr>",i=this.chartOptions.series[0].data.length,s=0;i>s;s++)e+="<tr><td>"+a(this.chartOptions.series[0].data[s][0]).format("YYYY-MM-DD")+"</td><td>"+this.chartOptions.series[0].data[s][1]+"</td><tr>";return e+="</table>",this.htmlTableView=e,l&&console.log("Table view--->>"+e),t("#time-chart-table").html(e),e}});return c});