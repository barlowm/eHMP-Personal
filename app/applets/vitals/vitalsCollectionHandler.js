define(["underscore","backbone","moment","jquery","app/applets/vitals/util","app/applets/vitals/gistConfig","hbs!app/applets/vitals/templates/tooltip"],function(e,t,s,a,r,i,o){"use strict";var n={fetchVitalsCollection:function(){return this},addTooltips:function(e,t){for(var s=0;s<e.models.length;s++){var a=e.models[s].attributes;a.oldValues&&(a.limitedoldValues=a.oldValues.splice(1,t),a.oldValues.length-a.limitedoldValues.length>0&&(a.moreresultsCount=a.oldValues.length-a.limitedoldValues.length)),e.models[s].attributes.tooltip=o(a)}e.reset(e.models)},parseModel:function(e){return e=r.getObservedFormatted(e),e=r.getFacilityColor(e),e=r.getObservedFormattedCover(e),e=r.getResultedFormatted(e),e=r.getDisplayName(e),e=r.getTypeName(e),e=r.noVitlasNoRecord(e),e=r.getFormattedHeight(e),e=r.getResultUnits(e),e=r.getMetricResultUnits(e),e=r.getResultUnitsMetricResultUnits(e),e=r.getReferenceRange(e),e=r.getFormattedWeight(e),e=r.getMetricResult(e),ADK.Enrichment.addFacilityMoniker(e),e},filterCollection:function(s){var o={expanded:["BP","P","R","T","PO2","PN","WT","HT","BMI","CG"],summary:["BP","P","R","T","PO2","PN","WT","BMI"],gist:["BPS","BPD","P","R","T","PO2","PN","WT","HT","BMI"]},l=this,p=[],d=o[this.appletConfig.viewType];if(0===s.length&&"expanded"!==l.dataGridOptions.appletConfig.viewType)return r.setNoRecords(p,d,d);s.models.forEach(function(e){e.set("applet_id",l.dataGridOptions.appletId),e.attributes=n.parseModel(e.attributes)});var u="expanded"!==l.dataGridOptions.appletConfig.viewType;s=r.buildCollection(s,u),s.reset(e.filter(s.models,function(e){return e.has("removed")&&e.get("removed")===!0?!1:!0}));var g=a.unique(s.pluck("displayName")),c=d.filter(function(e){return-1!=g.indexOf(e)});if("expanded"===l.dataGridOptions.appletConfig.viewType)p=e.sortBy(s.models,function(e){return e.get("observed")}),p=p.reverse();else{var h,v=0;c.forEach(function(a){var o=new t.Collection(s.where({displayName:a}));if(o.length>0){o.comparator="observed",o.sort(),e.each(o.models,function(e){var t=r.defaults[a];t&&e.set("observationType",e.get("observationType")||t.observationType)});var n=o.at(o.length-1);if(n.has("observed")&&(h=n.get("observed").substring(0,8),n.set("observedDate",h),(0===v||h>v)&&(v=h)),o.length>1){var l=o.at(o.length-2);l.has("result")&&n.set("previousResult",l.get("result")),n.set("oldValues",o.models.reverse())}switch(a){case"WT":n.set("graphOptions",i.graphOptions.BMI());break;case"BMI":n.set("graphOptions",i.graphOptions.BMI());break;case"PN":n.set("graphOptions",i.graphOptions.PN());break;case"PO2":n.set("graphOptions",i.graphOptions.PO2());break;case"R":n.set("vitalsTypeName","Respiratory Rate"),n.set("graphOptions",i.graphOptions);break;case"HT":n.set("graphOptions",i.graphOptions.HT());break;default:n.set("graphOptions",i.graphOptions)}p[d.indexOf(a)]=n}}),e.each(p,function(e){"undefined"!=typeof e&&null!==e&&(e.get("observedDate")===v?e.set("observedDateLatest","latestVital"):e.set("observedDateLatest","notLatestVital"))});var f=d.filter(function(e){return-1==c.indexOf(e)});f.length>0&&(p=r.setNoRecords(p,f,d))}return p}};return e.extend(n,t.Events),n});