define(["backbone","app/applets/vitals/utils/picklistUtils"],function(e,t){function i(e,t,i,o){e.model.unset(i),e.callControlFunction({controlType:t,controlName:i,functionName:"setPickList",options:{pickList:o}})}var o=e.Model.extend({sync:function(e,t,i){var o={type:"POST",url:t.url(),contentType:"application/json",data:JSON.stringify(t.toJSON()),dataType:"json"};$.ajax(_.extend(o,i))},url:function(){var e=ADK.PatientRecordService.getCurrentPatient().get("pid");return"resource/write-health-data/patient/"+e+"/vitals"}}),a={buildSaveVitalsModel:function(e,t,i,a,p){var l=new o,u=p.get("visit"),n=moment(e.get("dateTakenInput"),"MM/DD/YYYY").format("YYYYMMDD"),r=e.get("time-taken");r&&(r=r.replace(":",""),n+=r),l.set("dateTime",n);var s=p.get("pid").split(";")[1];l.set("dfn",s),u&&l.set("locIEN",u.uid);var g=a.get("duz")[a.get("site")]?a.get("duz")[a.get("site")]:a.get("duz")[0];l.set("enterdByIEN",g);var c=[];return(t||e.get("bpInputValue")||e.get("bp-radio-po"))&&c.push(this.buildVital(e,"bpInputValue",i,"BLOOD PRESSURE",[],["bp-cuff-size-po","bp-location-po","bp-method-po","bp-position-po"],"bp-radio-po",t)),(t||e.get("pulseInputValue")||e.get("pulse-radio-po"))&&c.push(this.buildVital(e,"pulseInputValue",i,"PULSE",[],["pulse-location-po","pulse-method-po","pulse-position-po","pulse-site-po"],"pulse-radio-po",t)),(t||e.get("respirationInputValue")||e.get("respiration-radio-po"))&&c.push(this.buildVital(e,"respirationInputValue",i,"RESPIRATION",[],["respiration-method-po","respiration-position-po"],"respiration-radio-po",t)),(t||e.get("temperatureInputValue")||e.get("temperature-radio-po"))&&c.push(this.buildVital(e,"temperatureInputValue",i,"TEMPERATURE",["F","C"],["temperature-location-po"],"temperature-radio-po",t)),(t||e.get("O2InputValue")||e.get("po-radio-po"))&&c.push(this.buildVital(e,"O2InputValue",i,"PULSE OXIMETRY",[],["po-method-po"],"po-radio-po",t)),(t||e.get("heightInputValue")||e.get("height-radio-po"))&&c.push(this.buildVital(e,"heightInputValue",i,"HEIGHT",["in","cm"],["height-quality-po"],"height-radio-po",t)),(t||e.get("weightInputValue")||e.get("weight-radio-po"))&&c.push(this.buildVital(e,"weightInputValue",i,"WEIGHT",["lb","kg"],["weight-method-po","weight-quality-po"],"weight-radio-po",t)),(t||e.get("pain-value-po")||e.get("pain-radio-po")||e.get("pain-checkbox-po"))&&c.push(this.buildVital(e,"pain-value-po",i,"PAIN",[],[],"pain-radio-po",t)),(t||e.get("circumValue")||e.get("cg-radio-po"))&&c.push(this.buildVital(e,"circumValue",i,"CIRCUMFERENCE/GIRTH",["cm","in"],["cg-site-po","cg-location-po"],"cg-radio-po",t)),l.set("vitals",c),l},addVitals:function(e,t,i,o,a){var p=ADK.PatientRecordService.getCurrentPatient(),l=ADK.UserService.getUserSession(),u=this.buildSaveVitalsModel(e,t,i,l,p);u.save(null,{success:function(){o()},error:function(e,t){a()}})},buildVital:function(e,t,i,o,a,p,l,u){var n={};if(u)n.reading="Pass";else if(e.get(l))n.reading=e.get(l);else{var r=e.get(t);a&&a.length>0&&_.each(a,function(e){var t=r.substring(r.length-e.length,r.length);t===e&&(n.unit=t,r=r.substring(0,r.length-e.length))}),"pain-value-po"===t&&e.get("pain-checkbox-po")&&(r="99 - Unable to Respond"),n.reading=r;var s=[];_.each(p,function(t){var i=e.get(t);i&&s.push(i)}),n.qualifiers=s,"O2InputValue"===t&&e.get("suppO2InputValue")&&(n.flowRate=e.get("suppO2InputValue"))}return n.fileIEN=i[o],n},retrievePickLists:function(o,a){var p={error:function(e,t){a()},success:function(e,a){if(a&&a.data){var p=a.data;o.model.set("vitalsIENMap",t.getIENMap(p)),i(o,"select","bp-location-po",t.getQualifier(p,"BLOOD PRESSURE","LOCATION")),i(o,"select","bp-method-po",t.getQualifier(p,"BLOOD PRESSURE","METHOD")),i(o,"select","bp-position-po",t.getQualifier(p,"BLOOD PRESSURE","POSITION")),i(o,"select","bp-cuff-size-po",t.getQualifier(p,"BLOOD PRESSURE","CUFF SIZE")),i(o,"select","temperature-location-po",t.getQualifier(p,"TEMPERATURE","LOCATION")),i(o,"select","respiration-method-po",t.getQualifier(p,"RESPIRATION","METHOD")),i(o,"select","respiration-position-po",t.getQualifier(p,"RESPIRATION","POSITION")),i(o,"select","pulse-location-po",t.getQualifier(p,"PULSE","LOCATION")),i(o,"select","pulse-method-po",t.getQualifier(p,"PULSE","METHOD")),i(o,"select","pulse-position-po",t.getQualifier(p,"PULSE","POSITION")),i(o,"select","pulse-site-po",t.getQualifier(p,"PULSE","SITE")),i(o,"select","height-quality-po",t.getQualifier(p,"HEIGHT","QUALITY")),i(o,"select","weight-method-po",t.getQualifier(p,"WEIGHT","METHOD")),i(o,"select","weight-quality-po",t.getQualifier(p,"WEIGHT","QUALITY")),i(o,"select","cg-location-po",t.getQualifier(p,"CIRCUMFERENCE/GIRTH","LOCATION")),i(o,"select","cg-site-po",t.getQualifier(p,"CIRCUMFERENCE/GIRTH","SITE")),i(o,"select","po-method-po",t.getQualifier(p,"PULSE OXIMETRY","METHOD"))}}},l=ADK.UserService.getUserSession().get("site"),u="/resource/write-pick-list?site="+l+"&type=vitals",n=e.Model.extend({url:u,parse:function(e){return e.data}}),r=new n;r.fetch(p)}};return a});