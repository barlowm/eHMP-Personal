define(["backbone","marionette","jquery","handlebars"],function(e,t,n,o){var r={createAndShowEieView:function(t,n,o){var i=new e.Model;i.set(o.get("displayName"),!0);var s={title:"Vitals - Entered in Error "+n,showProgress:!1,steps:[{view:r.buildFormView(t,o),viewModel:i,stepTitle:"Step 1"}]},a=new ADK.UI.Workflow(s);a.show()},buildFormView:function(e,t){var i=r.buildVitalItems(e),s={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:[{control:"container",extraClasses:["col-xs-5"],items:[{control:"checkbox",name:"check-all",title:"Check All",label:"Check All",disabled:r.shouldCheckAllBeDisabled(i)}]},{control:"spacer"}]}]},a={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:[{control:"container",extraClasses:["col-xs-6"],template:o.compile("<p><b>Name</b></p>")},{control:"container",extraClasses:["col-xs-6"],template:o.compile("<p><b>Result</b></p>")}]},{control:"spacer"}]},l={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:i}]},c={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:[{control:"spacer"},{control:"container",template:o.compile('<p>NOTE: To mark CLIO records as "Entered in error" use the Flowsheet application.</p>')},{control:"spacer"}]}]},d={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:[{control:"radio",name:"reason",disabled:r.shouldReasonBeDisabled(i,t),title:"Choose a reason for marking entered in error",label:"Reason",options:[{label:"Incorrect date/time",value:"1",title:"Incorrect date/time"},{label:"Incorrect patient",value:"2",title:"Incorrect patient"},{label:"Incorrect reading",value:"3",title:"Incorrect reading"},{label:"Invalid record",value:"4",title:"Invalid record"}]}]}]},h=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[s,a,l,c,d]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-12"],items:[{control:"button",id:"form-cancel-btn",extraClasses:["btn-icon","btn-sm"],type:"button",label:"Cancel",title:"Press enter to leave the form without making any changes"},{control:"button",disabled:!0,extraClasses:["btn-primary","btn-sm"],label:"Enter in Error",name:"submit-entered-in-error",id:"submit-entered-in-error",title:"Press enter to submit entered in error form"}]}]}]}],m=ADK.UI.Form.extend({fields:h,ui:{reason:".reason",submitButton:".submit-entered-in-error"},modelEvents:{"change:check-all":function(e){var t=this,n=_.pluck(r.vitalsAdded,"displayName"),o=this.model.get("check-all");_.each(n,function(e){t.model.set(e,o)})},"change:PN":function(){this.handleItemChecked(this.model.get("PN"))},"change:PO2":function(){this.handleItemChecked(this.model.get("PO2"))},"change:WT":function(){this.handleItemChecked(this.model.get("WT"))},"change:HT":function(){this.handleItemChecked(this.model.get("HT"))},"change:P":function(){this.handleItemChecked(this.model.get("P"))},"change:R":function(){this.handleItemChecked(this.model.get("R"))},"change:T":function(){this.handleItemChecked(this.model.get("T"))},"change:BP":function(){this.handleItemChecked(this.model.get("BP"))},"change:CG":function(){this.handleItemChecked(this.model.get("CG"))},"change:reason":function(){this.model.get("reason")&&this.$(this.ui.submitButton).trigger("control:disabled",!1)}},events:{"click #form-cancel-btn":function(){ADK.UI.Workflow.hide()},"click #submit-entered-in-error":function(e){e.preventDefault();var t=this,o=ADK.PatientRecordService.getCurrentPatient(),i=o.get("icn")||o.get("pid")||o.get("id"),s="resource/write-health-data/patient/"+i+"/vitals/",a=[];_.each(r.vitalsAdded,function(e){t.model.get(e.displayName)&&a.push(e.localId)});var l=JSON.stringify({ien:a.join(","),reason:t.model.get("reason")}),c={type:"PUT",url:s+a[0],contentType:"application/json",data:l,dataType:"json",success:function(){var e=new ADK.UI.Notification({title:"Vitals Entered in Error Submitted",icon:"fa-check",message:"Vitals successfully marked entered in error."});e.show(),ADK.UI.Workflow.hide(),setTimeout(function(){ADK.ResourceService.clearAllCache("vital");ADK.Messaging.getChannel("vitals").request("refreshGridView")},2e3)},error:function(){var e=new ADK.UI.Notification({title:"Vitals Entered in Error Submitted",icon:"fa-remove",message:"Failed to mark vitals entered in error."});e.show(),ADK.UI.Workflow.hide()}};n.ajax(c)}},handleItemChecked:function(e){if(e)this.$(this.ui.reason).trigger("control:disabled",!e);else{var t=this,n=_.pluck(r.vitalsAdded,"displayName"),o=_.every(n,function(n){return t.model.get(n)&&t.model.get(n)!==e?void 0:!0});o&&(this.$(this.ui.submitButton).trigger("control:disabled",!0),this.model.unset("reason"),this.$(this.ui.reason).trigger("control:disabled",!e))}}});return m},shouldReasonBeDisabled:function(e,t){return e&&0===e.length||t&&"BMI"===t.get("displayName")?!0:!1},shouldCheckAllBeDisabled:function(e){return e&&0===e.length},buildVitalItems:function(e){r.vitalsAdded=[];var t=[],n=ADK.UserService.getUserSession().get("site");return _.each(e,function(e){e.get("pid")&&e.get("pid").split(";")[0]===n&&(t.push(r.buildIndividualVitalControl(e)),r.vitalsAdded.push(e.toJSON()))}),t},buildIndividualVitalControl:function(e){var t=[];return t.push({control:"checkbox",extraClasses:["col-xs-6 noPadding bold"],name:e.get("displayName"),title:e.get("typeName"),label:e.get("typeName")}),t.push({control:"container",extraClasses:["col-xs-6"],template:o.compile("<span>"+e.get("resultUnits")+"</span>")}),{control:"container",extraClasses:["col-xs-12"],items:t}}};return r});