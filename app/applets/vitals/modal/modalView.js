define(["jquery","jquery.inputmask","backbone","marionette","underscore","highcharts","app/applets/vitals/util","app/applets/vitals/appletHelpers","hbs!app/applets/vitals/list/dateTemplate","app/applets/vitals/modal/filterDateRangeView","hbs!app/applets/vitals/modal/chartView","hbs!app/applets/vitals/list/observedTemplate","hbs!app/applets/vitals/list/resultTemplate","hbs!app/applets/vitals/modal/dateRangeTemplate","hbs!app/applets/vitals/modal/modalTemplate","hbs!app/applets/vitals/modal/totalTestsTemplate","hbs!app/applets/vitals/list/siteTemplate","hbs!app/applets/vitals/modal/detailsFooterTemplate","app/applets/vitals/modal/modalHeaderView"],function(e,t,a,i,l,s,n,o,r,d,c,h,p,u,v,m,f,g,b){"use strict";function w(e){return e=n.getObservedFormatted(e),e=n.getFacilityColor(e),e=n.getResultedFormatted(e),e=n.getDisplayName(e),e=n.getTypeName(e),e=n.getNumericDate(e),e=n.getResultUnits(e),e=n.getMetricResultUnits(e),e=n.getResultUnitsMetricResultUnits(e),e=n.getReferenceRange(e),e=n.getFormattedHeight(e),e=n.getFormattedWeight(e),ADK.Enrichment.addFacilityMoniker(e),e}function O(e){F=e.length>0?!0:!1}function N(e){return F}var C,x,M,D,y,P,I,k,T,R,V,F,B,H,A={},S=[],Y=[];D=a.Collection.extend({}),M=[{name:"observed",label:"Date",template:r,cell:"handlebars",sortable:!1},{name:"resultUnitsMetricResultUnits",label:"Result",template:p,cell:"handlebars",sortable:!1},{name:"facilityMoniker",label:"Facility",template:f,cell:"handlebars",sortable:!1}],A.columns=M,A.appletConfig={name:"vitals_modal",id:"vitals-modalView"};var L,E=a.Model.extend({defaults:{fromDate:moment().subtract("years",2).format(ADK.utils.dateUtils.defaultOptions().placeholder),toDate:moment().format(ADK.utils.dateUtils.defaultOptions().placeholder)}}),z=new E,K=(new d({model:z}),a.Marionette.ItemView.extend({template:c,id:"chart-container",initialize:function(t){var a=this;if(this.collection=t.collection,this.first=this.collection.first(),this.chartOptions=e.extend(!0,{},t.chartOptions),this.fullCollection=this.collection.fullCollection,k=this.fullCollection.pluck("low"),T=this.fullCollection.pluck("high"),"BP"!==V)k=l.map(k,function(e){return parseFloat(e)}),T=l.map(T,function(e){return parseFloat(e)});else{var i;k=l.map(k,function(e){return void 0!==e&&null!==e?(i=e.split("/"),parseFloat(i[i.length-1])):void 0}),T=l.map(T,function(e){return void 0!==e&&null!==e?(i=e.split("/"),parseFloat(i[0])):void 0})}P=this.fullCollection.pluck("observed"),P=l.map(P,function(e){return o.getDateForChart(e)}),P.reverse(),I=this.fullCollection.pluck("result");var s=[];s=this.fullCollection.pluck("units");var n=[],r=[],d=[];l.each(I,function(e,t){if("BP"!==V)l.isNaN(1*I[t])?d.push(null):"HT"!==V?d.push(1*I[t]):"in"!==s[t]&&"inches"!==s[t]?d.push(Math.floor(.4*I[t])):d.push(1*I[t]);else{var a;void 0!==I[t]?l.isNaN(1*I[t])&&-1===I[t].indexOf("/")?(n.push(null),r.push(null),d.push(null)):(a=I[t].split("/"),n.push(parseFloat(a[a.length-1])),r.push(parseFloat(a[0])),d.push(parseFloat(a[0]))):(n.push(null),r.push(null),d.push(null))}});var c=[];"WT"!==V&&"HT"!==V&&"PN"!==V&&"BMI"!==V&&l.each(d,function(e,t){var a=parseFloat(d[t]);if("BP"==V){var i=parseFloat(n[t]);void 0===i||isNaN(i)||void 0===a||isNaN(a)?c.push([null,null]):void 0===k[t]||void 0===T[t]||isNaN(k[t])||isNaN(T[t])?c.push([null,null]):c.push([k[t],T[t]])}else void 0===a||isNaN(a)||(void 0===k[t]||void 0===T[t]||isNaN(k[t])||isNaN(T[t])?c.push([null,null]):c.push([k[t],T[t]]))}),r.reverse(),n.reverse(),I=d,I.reverse(),c.reverse();var h=[];l.each(d,function(e,t){var a=parseFloat(d[t]);void 0===a||isNaN(a)||null===a||h.push(a)}),O("BP"!==V?h:r),this.chartOptions.series[0].data=[],"BP"!==V?l.forEach(I,function(e,t){moment(P[t]);a.chartOptions.series[0].data.push({y:I[t],dataLabels:{enabled:!1}})}):l.forEach(r,function(e,t){a.chartOptions.series[0].data.push({y:r[t],dataLabels:{enabled:!1}})}),this.chartOptions.xAxis.tickInterval=1,this.fullCollection.length>60?this.chartOptions.xAxis.tickInterval=10:this.fullCollection.length>35?this.chartOptions.xAxis.tickInterval=7:this.fullCollection.length>10&&(this.chartOptions.xAxis.tickInterval=5),this.chartOptions.xAxis.categories=P,this.chartOptions.series[0].zIndex=1,this.chartOptions.yAxis.title.text=this.first.get("units"),"BP"==V?this.chartOptions.series[0].name="SBP":"WT"==V?this.chartOptions.series[0].name="Weight":this.chartOptions.series[0].name=B;var p=[];"BMI"!==V&&(p=this.first.get("units")),this.chartOptions.tooltip={valueSuffix:" "+p,crosshairs:!0,shared:!0,style:{padding:10,zIndex:9999},useHTML:!0},this.chartOptions.series[2]&&(this.chartOptions.series[2].data=[]),this.chartOptions.series[1]&&(this.chartOptions.series[1].data=[]),"BP"==V?(this.chartOptions.series[1]={name:"DBP",data:n,type:"line",linkedTo:":previous",zIndex:1,showInLegend:!1,dataLabels:{enabled:!1}},this.chartOptions.series[2]={name:"Ref Range",data:c,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1}):c.length>0&&(this.chartOptions.series[1]={name:"Ref Range",data:c,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1})},onShow:function(){var t=this,a=setInterval(function(){t.$el.length&&(clearInterval(a),y=new s.Chart(t.chartOptions),e("#lr-data-table-view").on("mouseover","#data-grid-vitals-modalView tbody tr",t.highLightChartPoint),e("#lr-data-table-view").on("mouseout","#data-grid-vitals-modalView tbody tr",t.highLightChartPoint))},500)},onBeforeDestroy:function(){e("body").off(".modalChart")},highLightChartPoint:function(t){switch(t.type){case"mouseover":y.tooltip.shared=!1;var a=e(this),i=a.find("td:eq(1)"),l=a.find("td:eq(0)");if("BP"!==V){var s=1*i.text().replace(/[^\d\.-]/g,""),n=moment(l.text()).format("MMM DD YYYY");e.each(y.series[0].points,function(e,t){return t.y===s&&t.category===n?(t.onMouseOver(),!1):void 0})}else{var o=i.text().split("/"),r=1*o[0].replace(/[^\d\.-]/g,""),d=moment(l.text()).format("MMM DD YYYY");e.each(y.series[0].points,function(e,t){return t.y===r&&t.category===d?(t.onMouseOver(),!1):void 0})}break;default:y.tooltip.shared=!0}}})),U=a.Marionette.ItemView.extend({template:m,tagName:"span",initialize:function(){this.listenTo(this.model,"change",this.render)}});R=a.Model.extend({defaults:{totalTests:0}});var W=new R,q=a.Marionette.LayoutView.extend({template:v,fetchOptions:{},initialize:function(t){this.loadingView=ADK.Views.Loading.create(),this.loadingView2=ADK.Views.Loading.create(),H=t.gridCollection,this.fullScreen=t.fullScreen,this.getModals(),this.showNavHeader&&(this.model.attributes.navHeader=!0),this.showNavHeader&&(this.model.attributes.navHeader=!0),this.fetchOptions.resourceTitle="patient-record-vital";var a=this.model.attributes.typeName;this.model.attributes.typeName.indexOf("Blood")>=0&&(a="Blood Pressure"),this.fetchOptions.criteria={typeName:a,pid:this.model.attributes.pid,filter:"ne(result,Pass)"},B=a,this.model.attributes.modalTitleName=n.getVitalLongName(B),V=this.model.attributes.displayName.indexOf("BP")>=0?"BP":this.model.attributes.displayName;var i=this;this.fetchOptions.collectionConfig={collectionParse:i.filterCollection},this.fetchOptions.pageable=!0,this.fetchOptions.onSuccess=function(a,s){i.collection=a,i.$el.find(".vitalsNext, .vitalsPrev").attr("disabled",!1);var n=i.collection.fullCollection.pluck("result");i.showNavHeader&&(i.model.attributes.navHeader=!0),n=l.map(n,function(e){return l.isNaN(1*e)}),n=l.without(n,!1),i.showNavHeader&&(i.model.attributes.navHeader=!0);var r;if(void 0!==i.chart&&null!==i.chart&&i.chart.reset(),0!==a.length){var d=new K({chartOptions:e.extend(!0,{},o.chartOptions),model:i.model,data:I,collection:i.collection});N()?(r=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(r),e("#lr-data-table-view").removeClass("col-md-12").addClass("col-md-5"),e("#lr-graph").removeClass("hidden"))},500),void 0!==i.chart&&null!==i.chart&&i.chart.show(d)):r=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(r),e("#lr-data-table-view").removeClass("col-md-5").addClass("col-md-12"),e("#lr-graph").addClass("hidden"))},500)}else r=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(r),e("#lr-data-table-view").removeClass("col-md-5").addClass("col-md-12"),e("#lr-graph").addClass("hidden"))},500);A.collection=i.collection,A.filterDateRangeEnabled=!0,C=t.model,i.model=t.model,x=t.collection,W.set({totalTests:A.collection.fullCollection.length}),i.dataGrid=ADK.Views.DataGrid.create(A),void 0!==i.leftColumn&&null!==i.leftColumn&&(i.leftColumn.reset(),i.leftColumn.show(i.dataGrid)),A.collection=i.collection,0!==a.length?(i.paginatorView=ADK.Views.Paginator.create({collection:A.collection,windowSize:4}),e(".js-backgrid").append(i.paginatorView.render().el)):e("#data-grid-vitals-modalView").find("tbody").append(e('<tr class="empty"><td colspan="4">No Records Found</td></tr>'))}},events:{"click .vitalsNext":"getNextModal","click .vitalsPrev":"getPrevModal"},getNextModal:function(e){var t=l.indexOf(S,this.model)+1;t>=S.length&&(t=0);var a=S[t];this.setNextPrevModal(a)},getPrevModal:function(e){var t=l.indexOf(S,this.model)-1;0>t&&(t=S.length-1);var a=S[t];this.setNextPrevModal(a)},setNextPrevModal:function(t){if(this.showNavHeader&&(t.attributes.navHeader=!0),t.get("inAPanel")){var i=e("#data-grid-vitals > tbody>tr.selectable").eq(t.get("parentIndex"));i.data("isOpen")||i.trigger("click"),e("#data-grid-vitals > tbody>tr.selectable").not(i).each(function(){var t=e(this);t.data("isOpen")&&t.trigger("click")})}var l=new q({model:t,gridCollection:H,navHeader:this.showNavHeader,fullScreen:this.fullScreen}),s={title:t.get("typeName"),size:"xlarge",headerView:b.extend({model:t,theView:l}),footerView:a.Marionette.ItemView.extend({template:g,events:{"click #error":"enteredInError"},enteredInError:function(e){var a=ADK.Messaging.getChannel("vitalsEiE");a.trigger("vitalsEiE:clicked",e,{collection:H.models,title:t.attributes.observedFormatted,checked:t.attributes.localId})}}),regionName:"vitalsDetailsDialog",replaceContents:!0},n=new ADK.UI.Modal({view:l,options:s});n.show()},getModals:function(){S=[],Y=[],void 0!==H&&l.each(H.models,function(e,t){if(e.get("vitals")){var a=H.indexOf(e);l.each(e.get("vitals").models,function(t,i){t.set({inAPanel:!0,parentIndex:a,parentModel:e}),S.push(t)})}else S.push(e)})},regions:{leftColumn:".js-backgrid",chart:"#js-chart",totalTests:"#total-tests",dateRangeFilter:"#date-range-filter"},resetSharedModalDateRangeOptions:function(){L=new E},onRender:function(){var e;(void 0===L||null===L)&&this.resetSharedModalDateRangeOptions(),e=void 0!==L&&null!==L&&void 0!==L.get("preSelectedDateRange")&&null!==L.get("preSelectedDateRange")?L.clone():new E,new E;var t=new d({model:e,parentView:this,fullScreen:this.fullScreen});t.setFetchOptions(this.fetchOptions),t.setSharedDateRange(L),this.dateRangeFilter.show(t),this.leftColumn.show(this.loadingView),N()&&this.chart.show(this.loadingView2),this.totalTests.show(new U({model:W})),self.collection=ADK.PatientRecordService.fetchCollection(this.fetchOptions)},filterCollection:function(t){t.models.forEach(function(e){e.attributes=w(e.attributes)});var i=[],l=e.unique(t.pluck("displayName")),s=["BP","P","R","T","PO2","PN","WT","HT","BMI","CG"],n=(s.filter(function(e){return-1!=l.indexOf(e)}),new a.Collection(t.where({displayName:V})));return n.each(function(e){e.attributes.numericDate<=moment(L.attributes.toDate).format("YYYYMMDD")&&(e.attributes.numericDate>=moment(L.attributes.fromDate).format("YYYYMMDD")||null===L.attributes.fromDate)&&i.push(e)}),i}});return q});