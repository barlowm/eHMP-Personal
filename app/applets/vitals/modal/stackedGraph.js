define(["jquery","jquery.inputmask","backbone","marionette","underscore","highcharts","app/applets/vitals/util","app/applets/vitals/appletHelpers","hbs!app/applets/vitals/list/dateTemplate","app/applets/vitals/modal/filterDateRangeView","hbs!app/applets/vitals/modal/chartView","hbs!app/applets/vitals/list/observedTemplate","hbs!app/applets/vitals/list/resultTemplate","hbs!app/applets/vitals/modal/dateRangeTemplate","hbs!app/applets/vitals/modal/modalTemplate","hbs!app/applets/vitals/modal/totalTestsTemplate","hbs!app/applets/vitals/list/siteTemplate","hbs!app/applets/vitals/modal/detailsFooterTemplate","app/applets/vitals/modal/modalHeaderView","hbs!app/applets/vitals/templates/tooltip"],function(t,e,i,a,s,l,o,n,r,p,h,d,c,u,m,f,v,N,y,g){"use strict";function b(t){B=t.length>0?!0:!1}function O(t){return t=o.getObservedFormatted(t),t=o.getFacilityColor(t),t=o.getResultedFormatted(t),t=o.getDisplayName(t),t=o.getTypeName(t),t=o.getNumericDate(t),t=o.getResultUnits(t),t=o.getMetricResultUnits(t),t=o.getResultUnitsMetricResultUnits(t),t=o.getReferenceRange(t),t=o.getFormattedHeight(t),t=o.getFormattedWeight(t)}function D(t){return this.init(t)}function T(t){this.options=t,this.model=t.model,this.fetchOptions={},this.init(t)}var x,B,C=i.Model.extend({defaults:{fromDate:moment().subtract("years",2).format(ADK.utils.dateUtils.defaultOptions().placeholder),toDate:moment().format(ADK.utils.dateUtils.defaultOptions().placeholder)}});return D.prototype={init:function(e){var i=this;this.collection=e.collection,this.first=this.collection.first(),this.chartOptions=t.extend(!0,{},e.chartOptions),this.fullCollection=this.collection.fullCollection,this.chartOptions.xAxis.type="datetime";var a=this.fullCollection.pluck("low"),l=this.fullCollection.pluck("high");if("BP"!==e.modalDisplayName)a=s.map(a,function(t){return parseFloat(t)}),l=s.map(l,function(t){return parseFloat(t)});else{var o;a=s.map(a,function(t){return void 0!==t&&null!==t?(o=t.split("/"),parseFloat(o[1])):void 0}),l=s.map(l,function(t){return void 0!==t&&null!==t?(o=t.split("/"),parseFloat(o[0])):void 0})}var n=this.fullCollection.pluck("observed");n=s.map(n,function(t){return moment(ADK.utils.formatDate(t)).valueOf()}),n.reverse();var r=this.fullCollection.pluck("result"),p=[];p=this.fullCollection.pluck("units");var h=[],d=[],c=[];s.each(r,function(t,i){if("BP"!==e.modalDisplayName)s.isNaN(1*r[i])?c.push(null):"HT"!==e.modalDisplayName?c.push(1*r[i]):"in"!==p[i]&&"inches"!==p[i]?c.push(Math.floor(.4*r[i])):c.push(1*r[i]);else{var a;void 0!==r[i]?s.isNaN(1*r[i])&&-1===r[i].indexOf("/")?(h.push(null),d.push(null),c.push(null)):(a=r[i].split("/"),h.push(parseFloat(a[1])),d.push(parseFloat(a[0])),c.push(parseFloat(a[0]))):(h.push(null),d.push(null),c.push(null))}});var u=[];"WT"!==e.modalDisplayName&&"HT"!==e.modalDisplayName&&"PN"!==e.modalDisplayName&&"BMI"!==e.modalDisplayName&&s.each(c,function(t,i){var s=parseFloat(c[i]);if("BP"==e.modalDisplayName){var o=parseFloat(h[i]);void 0===o||isNaN(o)||void 0===s||isNaN(s)?u.push([null,null]):void 0===a[i]||void 0===l[i]||isNaN(a[i])||isNaN(l[i])?u.push([null,null]):u.push([a[i],l[i]])}else void 0===s||isNaN(s)||(void 0===a[i]||void 0===l[i]||isNaN(a[i])||isNaN(l[i])?u.push([null,null]):u.push([a[i],l[i]]))}),d.reverse(),h.reverse(),r=c,r.reverse(),u.reverse();var m=[];s.each(c,function(t,e){var i=parseFloat(c[e]);void 0===i||isNaN(i)||null===i||m.push(i)}),b("BP"!==e.modalDisplayName?m:d),this.chartOptions.series[0].data=[],"BP"!==e.modalDisplayName?s.forEach(r,function(t,e){moment(n[e]);i.chartOptions.series[0].data.push({y:r[e],x:n[e],dataLabels:{enabled:!1}}),u[e]&&u[e].unshift(n[e])}):s.forEach(d,function(t,e){i.chartOptions.series[0].data.push({y:d[e],x:n[e],dataLabels:{enabled:!1}}),u[e]&&u[e].unshift(n[e])}),this.chartOptions.series[0].zIndex=1,void 0!==this.first?this.chartOptions.yAxis.title.text=this.first.get("units"):this.chartOptions.yAxis.title.text="","BP"==e.modalDisplayName?this.chartOptions.series[0].name="SBP":"WT"==e.modalDisplayName?this.chartOptions.series[0].name="Weight":this.chartOptions.series[0].name=e.model.attributes.typeName;var f=[];return"BMI"!==e.modalDisplayName&&void 0!==this.first&&(f=this.first.get("units")),this.chartOptions.tooltip={valueSuffix:" "+f,crosshairs:!0,shared:!0,style:{padding:4,zIndex:9999},useHTML:!0},this.chartOptions.series[2]&&(this.chartOptions.series[2].data=[]),this.chartOptions.series[1]&&(this.chartOptions.series[1].data=[]),"BP"==e.modalDisplayName?(this.chartOptions.series[1]={name:"DBP",data:[],type:"line",linkedTo:":previous",zIndex:1,showInLegend:!1,dataLabels:{enabled:!1}},s.forEach(h,function(t,e){i.chartOptions.series[1].data.push({y:h[e],x:n[e],dataLabels:{enabled:!1}})}),this.chartOptions.series[2]={name:"Ref Range",data:u,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1}):u.length>0&&(this.chartOptions.series[1]={name:"Ref Range",data:u,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1}),this.chartOptions}},T.prototype={init:function(){var e=this;(void 0===x||null===x)&&this.resetSharedModalDateRangeOptions(),this.fetchOptions.resourceTitle="patient-record-vital";var i=this.model.attributes.typeName;this.model.attributes.typeName.indexOf("Blood")>=0&&(i="Blood Pressure");var a=i;"BMI"===a?this.fetchOptions.criteria={filter:'in(typeName,["WEIGHT","HEIGHT"])'}:this.fetchOptions.criteria={filter:'eq(typeName,"'+this.model.attributes.typeName+'")'},this.model.attributes.displayName.indexOf("BP")>=0?this.modalDisplayName="BP":this.modalDisplayName=this.model.attributes.displayName,this.fetchOptions.collectionConfig={collectionParse:e.filterCollection,comparator:function(t,e){return t.get("observed")>e.get("observed")?-1:t.get("observed")<e.get("observed")?1:0},modalDisplayName:e.modalDisplayName},this.fetchOptions.pageable=!0,this.fetchOptions.cache=!1,this.collection=ADK.PatientRecordService.fetchCollection(this.fetchOptions),this.collection.on("sync",function(){e.collection=this.collection,e.collection.length>0?(e.model.attributes.qualifiedName=e.collection.first().get("qualifiedName"),e.model.set("resultUnits",e.collection.first().get("resultUnits")),e.model.set("observed",e.collection.first().get("observed"))):e.model.set("resultUnits","--"),t.extend(!0,e,e.model.attributes),e.chart=new D({chartOptions:t.extend(!0,{},n.chartOptions),model:e.model,collection:e.collection,modalDisplayName:e.modalDisplayName});var i=e.createTooltipModel(e.collection);t.isEmptyObject(i)||(e.tooltip=g(i.attributes)),ADK.Messaging.getChannel("stackedGraph").trigger("readyToChart",{response:e,time:moment()})},this)},filterCollection:function(e){e.models.forEach(function(t){t.attributes=O(t.attributes)});var a=[],s=t.unique(e.pluck("displayName")),l=["BP","P","R","T","PO2","PN","WT","HT","BMI"],o=(l.filter(function(t){return-1!=s.indexOf(t)}),new i.Collection(e.where({displayName:this.modalDisplayName})));return o.each(function(t){a.push(t)}),a},resetSharedModalDateRangeOptions:function(){x=new C},createTooltipModel:function(e){if(0===e.models.length)return{};for(var i={},a=0;a<e.models.length&&5>a;a++)t.isEmptyObject(i)?s.extend(i,e.models[a]):(void 0===i.attributes.limitedoldValues&&(i.attributes.limitedoldValues=[]),i.attributes.limitedoldValues.push(e.models[a]));return i}},T});