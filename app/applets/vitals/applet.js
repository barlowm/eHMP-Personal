define(["backbone","marionette","jquery","app/applets/vitals/util","app/applets/vitals/gistConfig","app/applets/vitals/vitalsCollectionHandler","app/applets/vitals/modal/modalView","hbs!app/applets/vitals/list/siteTemplate","hbs!app/applets/vitals/list/vitalTypeTemplate","hbs!app/applets/vitals/list/resultTemplate","hbs!app/applets/vitals/list/refRangeTemplate","hbs!app/applets/vitals/list/resultedTemplate","hbs!app/applets/vitals/list/observedTemplate","hbs!app/applets/vitals/list/rowTemplate","hbs!app/applets/vitals/list/itemTemplate","hbs!app/applets/vitals/list/gridTemplate","hbs!app/applets/vitals/list/layoutTemplate","hbs!app/applets/vitals/list/qualifierTemplate","hbs!app/applets/vitals/modal/detailsFooterTemplate","app/applets/vitals/modal/modalHeaderView","hbs!app/applets/vitals/templates/tooltip","app/applets/vitals/modal/stackedGraph","app/applets/vitals/writeback/addVitals","app/applets/visit/writeback/addselectVisit","app/applets/vitals/writeback/enteredInErrorView"],function(e,t,i,l,a,s,n,r,o,p,d,c,u,m,v,g,h,f,b,w,y,T,D,S,V){"use strict";var C={name:"displayName",label:"Vital",cell:"string"},M={name:"resultUnitsMetricResultUnits",label:"Result",cell:"handlebars",template:p,hoverTip:"vitals_result"},N={name:"observedFormatted",label:"Date Observed",cell:"handlebars",template:u,hoverTip:"vitals_dateobserved"},F={name:"observedFormattedCover",label:"Date Observed",cell:"string"},O={name:"facilityMoniker",label:"Facility",cell:"string",hoverTip:"vitals_facility"},A={name:"typeName",label:"Type",cell:"string",hoverTip:"vitals_type"},G={name:"resulted",label:"Date Entered",cell:"handlebars",template:c,hoverTip:"vitals_dateentered"},I={name:"qualifiers",label:"Qualifiers",cell:"handlebars",template:f,hoverTip:"vitals_qualifiers"},P=[C,M,F],R=[N,A,M,G,I,O],x={resourceTitle:"patient-record-vital",pageable:!1,cache:!0,criteria:{}};x.viewModel={parse:function(e){return e}};var U,K,k=a,E=ADK.Applets.BaseGridApplet,q=E.extend({initialize:function(t){var i=this;U=E.prototype;var a={};"expanded"===this.columnsViewType||t.appletConfig.fullScreen?(a.columns=R,x.pageable=!0,a.filterEnabled=!0,a.filterRemoved=!0,i.isFullscreen=!0,t.appletConfig.viewType="expanded"):"gist"===this.columnsViewType?(a.columns=P,a.filterEnabled=!1,i.isFullscreen=!1,a.gistView=!0,a.appletConfiguration=k,x.pageable=!1):(a.summaryColumns=P,a.fullScreenColumns=R,a.filterEnabled=!1,i.isFullscreen=!1,t.appletConfig.viewType="summary"),t.appletConfig.tileSortingUniqueId="typeName",a.enableModal=!0,this.listenTo(ADK.Messaging,"globalDate:selected",function(e){i.isFullscreen?x.criteria={filter:"and(ne(removed, true),"+i.buildJdsDateFilter("observed")+")"}:x.criteria={filter:"and(ne(removed, true),"+i.buildJdsDateFilter("observed")+"), ne(result,Pass)"},x.collectionConfig={collectionParse:function(){return i.filterCollection.apply(i,arguments)}},x.onSuccess=function(e){s.addTooltips(e,4),i.isFullscreen?e.trigger("reset"):e.trigger("vitals:globalDateFetch");var t,l=i.appletConfig.instanceId+"_"+i.appletConfig.id;_.isUndefined(i.dataGridOptions.appletConfiguration)||(t=i.dataGridOptions.appletConfiguration.tileSortingUniqueId),_.isUndefined(t)&&!_.isUndefined(i.dataGridOptions.appletConfig.tileSortingUniqueId)&&(t=i.dataGridOptions.appletConfig.tileSortingUniqueId),_.isUndefined(t)||ADK.TileSortManager.getSortOptions(e,l,t)},ADK.PatientRecordService.fetchCollection(x,i.dataGridOptions.collection)}),x.collectionConfig={collectionParse:function(){return i.filterCollection.apply(i,arguments)}},i.isFullscreen?x.criteria={filter:"and(ne(removed, true),"+i.buildJdsDateFilter("observed")+")"}:x.criteria={filter:"and(ne(removed, true),"+i.buildJdsDateFilter("observed")+"), ne(result,Pass)"},x.onSuccess=function(){s.addTooltips(a.collection,4)},a.appletId="vitals",this.dataGridOptions=a,i.dataGridOptions.collection=ADK.PatientRecordService.fetchCollection(x),K=this,ADK.UserService.hasPermission("add-patient-vital")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(a.onClickAdd=function(t){t.preventDefault();var i=ADK.utils.appletUtils.getAppletView("vitals","writeback"),l=new e.Model,a=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),s={size:"large",title:"Enter Vitals",showProgress:!1,keyboard:!0,steps:[]},n=ADK.PatientRecordService.getCurrentPatient().get("visit");n||s.steps.push({view:S,viewModel:a,title:"Step 1"}),s.steps.push({view:i,viewModel:l,stepTitle:"Step 2"});var r=new ADK.UI.Workflow(s);r.show()});var r=function(t,s){s.preventDefault();var r=new n({model:t,target:s.currentTarget,gridCollection:a.collection,fullScreen:i.isFullscreen});r.resetSharedModalDateRangeOptions();var o;o=t.get("modalTitleName")?t.get("modalTitleName"):l.getVitalLongName(t.get("typeName"));var p={title:o,size:"xlarge",headerView:w.extend({model:t,theView:r}),footerView:e.Marionette.ItemView.extend({template:b,events:{"click #error":"enteredInError"},enteredInError:function(e){ADK.UI.Modal.hide();var l=i.dataGridOptions.collection.where({observed:t.get("observed")});V.createAndShowEieView(l,t.get("observedFormatted"),t)}}),regionName:"vitalsDetailsDialog"},d=new ADK.UI.Modal({view:r,options:p});d.show()};a.onClickRow=function(e,t,i){r(e,t)};var o=e.Marionette.ItemView.extend({tagName:"tr",attributes:function(){return void 0!==this.model.get("observedDateLatest")?{tabindex:"0","class":this.model.get("observedDateLatest")+" clickable"}:{tabindex:"0","class":this.model.get("observedDateLatest")+""}},template:v,events:{"click td":function(e){function t(e,t){r(e.model,t)}ADK.utils.infoButtonUtils.onClickFunc(this,e,t)}}}),p=e.Marionette.CompositeView.extend({initialize:function(e){this.collection=e.collection},template:g,childView:o,childViewContainer:"tbody"}),d=e.Marionette.LayoutView.extend({initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"vitals:globalDateFetch",this.render)},regions:{leftTable:".a-table",rightTable:".b-table"},template:h,onRender:function(){var t=this.collection.length,i=Math.floor(t/2),l=new e.Collection(this.collection.slice(0,i)),a=new e.Collection(this.collection.slice(i,t));this.collection.length>0?(this.leftTable.show(new p({collection:l})),this.rightTable.show(new p({collection:a}))):this.$el.find(".a-table").after('<div class="emptyTextVital">No Records Found</div>')}});a.filterDateRangeEnabled=!0,a.filterDateRangeField={name:"observed",label:"Date",format:"YYYYMMDD"},this.dataGridOptions=a,i.isFullscreen||(this.dataGridOptions.gistView?(this.dataGridOptions.GistView=d,this.dataGridOptions.SummaryView=ADK.Views.VitalsGist.getView(),this.dataGridOptions.SummaryViewOptions={gistModel:k.gistModel,gistHeaders:k.gistHeaders,enableTileSorting:!0,tileSortingUniqueId:"typeName"}):this.dataGridOptions.SummaryView=d),U.initialize.apply(this,arguments)},onRender:function(){U.onRender.apply(this,arguments)},onSync:function(){"summary"===this.columnsViewType?(this.dataGridOptions.tblRowSelector='[data-appletid="vitals"] tr',this.dataGridOptions.tblRowSelectorColumn="td:first"):(this.dataGridOptions.tblRowSelector="#data-grid-vitals tbody tr",this.dataGridOptions.tblRowSelectorColumn="td:nth-child(2)"),U.onSync.apply(this,arguments)},filterCollection:s.filterCollection}),z=ADK.Messaging.getChannel("vitals");z.on("detailView",function(e){var t;t="Blood Pressure Systolic"==e.model.get("typeName")||"Blood Pressure Diastolic"==e.model.get("typeName")?"Blood Pressure":e.model.get("typeName");var i=new ADK.UI.Modal({view:new n({model:e.model,navHeader:!1,fullScreen:self.isFullscreen}),options:{size:"xlarge",title:t}});i.show()}),z.reply("detailView",function(t){var l,a={criteria:{uid:t.uid},patient:new e.Model({icn:t.patient.icn,pid:t.patient.pid}),resourceTitle:"patient-record-vital"},s=i.Deferred(),r=ADK.PatientRecordService.fetchCollection(a);return r.on("sync",function(){l=r.first();var e;ADK.UserService.getUserSession().get("site"),l.get("pid")?l.get("pid").split(";")[0]:"";e="Blood Pressure Systolic"==l.get("typeName")||"Blood Pressure Diastolic"==l.get("typeName")?"Blood Pressure":l.get("typeName"),s.resolve({view:new n({model:l,collection:r,navHeader:!1,fullScreen:self.isFullscreen}),title:e,modalSize:"xlarge"})},this),s.promise()}),z.reply("chartInfo",function(t){var a=l.getDisplayName({typeName:t.typeName}).displayName,s=e.Model.extend({}),n=new s({typeName:t.typeName,displayName:a,requesterInstanceId:t.instanceId,graphType:t.graphType,applet_id:B.id}),r=i.Deferred(),o=new T({model:n,target:null});return r.resolve({view:o}),r.promise()}),z.reply("refreshGridView",function(){var e=!1;return _.isObject(K)===!0&&(K.refresh({}),e=!0),e});var B={id:"vitals",viewTypes:[{type:"summary",view:q.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"gist",view:q.extend({columnsViewType:"gist"}),chromeEnabled:!0},{type:"expanded",view:q.extend({columnsViewType:"expanded"}),chromeEnabled:!0},{type:"writeback",view:D,chromeEnabled:!1}],defaultViewType:"summary"};return B});