define(["backbone","app/applets/lab_panels/util","app/applets/lab_panels/collectionHandler"],function(e,t,a){var n={fetchOptions:{resourceTitle:"patient-record-lab",pageable:!1,cache:!0,criteria:{filter:""},viewModel:{parse:function(e){var a=ADK.utils.getTimeSince(e.observed);return e.age=a.timeSince,e.ageDescription=a.timeSinceDescription,e.interpretationFlag=t.getFlag(e.interpretationCode),!e.typeCode&&e.codes&&e.codes[1]&&(e.typeCode=e.codes[1].code),e.groupUid||(e.groupUid=e.uid),e}}},transformCollection:function(n){var l=e.Model.extend({}),i=e.Model.extend({}),r=new e.Collection,p=n.groupBy(function(e){return e.get("groupUid")}),o=[];_.each(p,function(e,t){var n=a.getPanels(e);_.each(n,function(a){o.push(new l({panelId:a.id,panelName:a.name,panelCodes:a.codes,results:e,groupId:t,panelFacility:e[0].get("facilityMoniker"),panelDate:e[0].get("observed"),panelAge:e[0].get("age"),panelAgeDescription:e[0].get("ageDescription")}))})});var s=_.groupBy(o,function(e){return e.get("panelName")});return s=_.map(s,function(e,a){return new i({applet_id:"lab_panels",panelId:e[0].get("panelId"),panelName:a,panels:e,currentResults:e[0].get("results"),currentFlags:t.getPanelFlags(e[0].get("results"),e[0].get("panelCodes")),panelCodes:e[0].get("panelCodes"),panelAge:e[0].get("panelAge"),panelAgeDescription:e[0].get("panelAgeDescription")})}),_.each(s,function(e){a.afterGroupingParse(e.attributes)}),r.reset(s),r},gistHeaders:{name:{title:"Lab Panel",sortable:!0,sortType:"alphabetical",key:"panelName"},flags:{title:"Flag",sortable:!1},age:{title:"Last",sortable:!0,sortType:"date",key:"panelAge"}},gistModel:[{id:"id",field:"panelId"},{id:"name",field:"panelName"},{id:"flags",field:"currentFlags"},{id:"age",field:"panelAge"},{id:"ageDescription",field:"panelAgeDescription"},{id:"tooltip",field:"tooltip"}],filterFields:["name"]};return n});