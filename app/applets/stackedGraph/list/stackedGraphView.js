define(["backbone","marionette","underscore","highcharts","hbs!app/applets/stackedGraph/list/stackedGraphViewTemplate","app/applets/stackedGraph/list/deleteConfirmationView","app/applets/stackedGraph/list/chartsCompositeView","app/applets/medication_review_v2/medicationCollectionHandler","app/applets/medication_review_v2/medicationResourceHandler","app/applets/stackedGraph/utils/utils","app/applets/lab_results_grid/applet","app/applets/vitals/applet","typeahead","highcharts-more"],function(e,t,i,a,n,r,s,o,c,l){return e.Marionette.LayoutView.extend({template:n,initialize:function(t){function a(e){var t=0,i=setInterval(function(){if(e.length===t)clearInterval(i);else if(l){l=!1;var a,r=e[t],s={typeName:r.typeName,instanceId:n.instanceId,graphType:r.graphType},h=$.Deferred();"Vitals"===r.graphType?(a=ADK.Messaging.getChannel("vitals"),h.resolve({collection:null})):"Lab Tests"===r.graphType?(a=ADK.Messaging.getChannel("lab_results_grid"),h.resolve({collection:null})):"Medications"===r.graphType&&(a=ADK.Messaging.getChannel("meds_review"),o.fetchAllMeds(!1,function(e){c.getMedicationGroupNames(e);h.resolve({collection:e})})),h.done(function(e){s.collection=e.collection,a.request("chartInfo",s),t+=1})}},100)}var n=this;this.predefined=ADK.ADKApp.currentScreen.config.predefined,this.allReadyAdded=[],this.activeCharts=[],this.timeLineCharts=[],this.instanceId=t.appletConfig.instanceId,this.chartOptionsCollection=new e.Collection,this.chartOptionsCollection.on("remove",function(e,t,a){n.activeCharts.splice(a.index,1);var r=i.indexOf(n.allReadyAdded,e.get("typeName").toUpperCase());-1!==r&&n.allReadyAdded.splice(r,1),0===t.length&&n.chartsCompositeView.$noGraph.show()}),this.chartsCompositeView=new s({collection:this.chartOptionsCollection,instanceId:this.instanceId,options:{appletId:t.appletConfig.id,allReadyAdded:n.allReadyAdded},activeCharts:this.activeCharts,timeLineCharts:this.timeLineCharts});var l=!0;this.stackedGraphChannel=ADK.Messaging.getChannel("stackedGraph"),this.stackedGraphChannel.on("readyToChart",function(e){e.response.requesterInstanceId===n.instanceId&&(n.chartsCompositeView.$noGraph.hide(),n.chartOptionsCollection.unshift(e.response),n.allReadyAdded.unshift(e.response.typeName),l=!0)}),this.listenTo(ADK.Messaging,"globalDate:selected",function(e){var t=ADK.SessionStorage.getModel_SessionStoragePreference("globalDate"),a=moment(t.get("fromDate"),"MM/DD/YYYY"),r=moment(t.get("toDate"),"MM/DD/YYYY");r.add(1,"d"),i.each(this.activeCharts,function(e,t){e.xAxis[0].setExtremes(Date.UTC(a.year(),a.month(),a.date()),Date.UTC(r.year(),r.month(),r.date()))}),i.each(n.timeLineCharts,function(e,t){e.xAxis[0].setExtremes(Date.UTC(a.year(),a.month(),a.date()),Date.UTC(r.year(),r.month(),r.date()))})}),this.stackedGraphChannel.on("delete",function(e){if(e.model.attributes.requesterInstanceId===n.instanceId&&"true"!==this.predefined){var t=new r({graphTitle:e.model.attributes.typeName,callback:function(){var t={resourceTitle:"user-defined-stack",fetchType:"DELETE",criteria:{id:ADK.ADKApp.currentScreen.config.id,instanceId:n.instanceId,graphType:e.model.attributes.graphType,typeName:e.model.attributes.typeName.toUpperCase()},onSuccess:function(){var t=n.chartOptionsCollection.filter(function(t){return t.get("typeName").toUpperCase()===e.model.get("typeName").toUpperCase()});n.chartOptionsCollection.remove(t)}};ADK.ResourceService.fetchCollection(t),ADK.UserDefinedScreens.removeOneStackedGraphFromSession(ADK.ADKApp.currentScreen.config.id,n.instanceId,e.model.attributes.graphType,e.model.attributes.typeName.toUpperCase())}}),i={size:"medium",backdrop:!0,keyboard:!0,callShow:!0,footerView:"none"},a=new ADK.UI.Modal({view:t,options:i});a.show()}});var h=ADK.UserDefinedScreens.getStackedGraphForOneAppletFromSession(ADK.ADKApp.currentScreen.config.id,n.instanceId);h&&a(h),ADK.Messaging.on("refresh:applet",function(e){if(n.instanceId===e){var t=ADK.UserDefinedScreens.getStackedGraphForOneAppletFromSession(ADK.ADKApp.currentScreen.config.id,n.instanceId);t&&a(t)}})},onShow:function(){var e=this,t=ADK.SessionStorage.getModel_SessionStoragePreference("globalDate"),i=moment(t.get("fromDate"),"MM/DD/YYYY"),a=moment(t.get("toDate"),"MM/DD/YYYY");a.add(1,"d");var n=setInterval(function(){if(e.$(".placeholder").length>0){clearInterval(n);var t=e.$(".placeholder").highcharts($.extend(!0,{},e.pChartOptions,{xAxis:{labels:{y:-10}}})).highcharts();t.xAxis[0].setExtremes(Date.UTC(i.year(),i.month(),i.date()),Date.UTC(a.year(),a.month(),a.date())),e.timeLineCharts.push(t)}},500),r=setInterval(function(){if(e.$(".footerplaceholder").length>0){clearInterval(r);var t=e.$(".footerplaceholder").highcharts(e.pChartOptions).highcharts();t.xAxis[0].setExtremes(Date.UTC(i.year(),i.month(),i.date()),Date.UTC(a.year(),a.month(),a.date())),e.timeLineCharts.push(t)}},500);this.collectionViewRegion.show(this.chartsCompositeView);var s=(e.$(".crosshairs"),e.$(".stackedGraphPointer"));e.$("*").not(".collectionContainer .renderTo, .highcharts-container").on("mouseover.stackedGraph",function(t){s.css({visibility:"hidden"}),$.each(e.activeCharts,function(e,t){t.tooltip&&t.tooltip.hide(),t.line&&t.line.css({visibility:"hidden"})})}),e.$(".collectionContainer").on({"mouseover.stackedGraph":function(t){t.stopPropagation(),e.activeCharts.length<1||$.each(e.activeCharts,function(e,i){var a=i.pointer.normalize(t);t.pageX;i.pointer.runPointActions(a),i.line&&i.line.attr({x:a.chartX}).css({visibility:"visible"})})},"mousemove.stackedGraph":function(t){if(t.stopPropagation(),!(e.activeCharts.length<1)){$.each(e.activeCharts,function(e,i){var a=i.pointer.normalize(t);t.pageX;i.pointer.runPointActions(a),i.line&&i.line.attr({x:a.chartX})});var i=e.activeCharts[0].pointer.normalize(t);s.text(moment(e.activeCharts[0].xAxis[0].toValue(i.chartX)).format("M/D/YY"));var a=e.$(".pointerContainer").offset(),n=t.pageX-a.left;s.css({left:n-s.eq(0).width(),visibility:"visible"})}}},".highcharts-container")},pChartOptions:{chart:{ignoreHiddenSeries:!1,type:"line",height:40},legend:{enabled:!1},credits:{enabled:!1},title:{text:null},subtitle:{text:null},xAxis:{type:"datetime"},yAxis:{gridLineWidth:0,labels:{enabled:!1},title:null,minPadding:0,maxPadding:0},plotOptions:{},series:[{data:[],visible:!1}]},eventMapper:{refresh:"refreshCollection",add:"onClickAdd"},refreshCollection:function(){this.chartOptionsCollection.reset(),ADK.Messaging.trigger("refresh:applet",this.instanceId)},regions:{collectionViewRegion:".grid-container"},onDestroy:function(){ADK.Messaging.off("refresh:applet"),this.$(".collectionContainer").off(".stackedGraph"),this.$("*").not(".collectionContainer .renderTo, .highcharts-container").off(".stackedGraph"),i.each(this.activeCharts,function(e,t){e.destroy()}),this.activeCharts=[],i.each(this.timeLineCharts,function(e,t){e.destroy()}),this.timeLineCharts=[],this.chartOptionsCollection.reset()}})});