define(["backbone","marionette","underscore","highcharts","hbs!app/applets/stackedGraph/list/rowItemViewTemplate","hbs!app/applets/stackedGraph/list/rowItemViewMedicationsTemplate","app/applets/stackedGraph/utils/utils","app/applets/stackedGraph/tilesorting/rowItemParentView","hbs!app/applets/stackedGraph/list/popoverTemplate","typeahead","highcharts-more"],function(e,t,i,o,s,n,r,a,l){!function(e){function t(e){var t=e.__resizeTriggers__,i=t.firstElementChild,o=t.lastElementChild,s=i.firstElementChild;o.scrollLeft=o.scrollWidth,o.scrollTop=o.scrollHeight,s.style.width=i.offsetWidth+1+"px",s.style.height=i.offsetHeight+1+"px",i.scrollLeft=i.scrollWidth,i.scrollTop=i.scrollHeight}function i(e){return e.offsetWidth!=e.__resizeLast__.width||e.offsetHeight!=e.__resizeLast__.height}function o(e){var o=this;t(this),this.__resizeRAF__&&d(this.__resizeRAF__),this.__resizeRAF__=l(function(){i(o)&&(o.__resizeLast__.width=o.offsetWidth,o.__resizeLast__.height=o.offsetHeight,o.__resizeListeners__.forEach(function(t){t.call(o,e)}))})}function s(){if(!r){var e=(w?w:"")+".resize-triggers { "+(y?y:"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',t=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e)),t.appendChild(i),r=!0}}var n=document.attachEvent,r=!1,a=e.fn.resize;if(e.fn.resize=function(e){return this.each(function(){this==window?a.call(jQuery(this),e):addResizeListener(this,e)})},e.fn.removeResize=function(e){return this.each(function(){removeResizeListener(this,e)})},!n){var l=function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return window.setTimeout(e,20)};return function(t){return e(t)}}(),d=function(){var e=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout;return function(t){return e(t)}}(),p=!1,h="animation",c="",m="animationstart",g="Webkit Moz O ms".split(" "),f="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),u="",_=document.createElement("fakeelement");if(void 0!==_.style.animationName&&(p=!0),p===!1)for(var v=0;v<g.length;v++)if(void 0!==_.style[g[v]+"AnimationName"]){u=g[v],h=u+"Animation",c="-"+u.toLowerCase()+"-",m=f[v],p=!0;break}var b="resizeanim",w="@"+c+"keyframes "+b+" { from { opacity: 0; } to { opacity: 0; } } ",y=c+"animation: 1ms "+b+"; "}window.addResizeListener=function(e,i){n?e.attachEvent("onresize",i):(e.__resizeTriggers__||("static"==getComputedStyle(e).position&&(e.style.position="relative"),s(),e.__resizeLast__={},e.__resizeListeners__=[],(e.__resizeTriggers__=document.createElement("div")).className="resize-triggers",e.__resizeTriggers__.innerHTML='<div class="expand-trigger"><div></div></div><div class="contract-trigger"></div>',e.appendChild(e.__resizeTriggers__),t(e),e.addEventListener("scroll",o,!0)),e.__resizeListeners__.push(i))},window.removeResizeListener=function(e,t){n?e.detachEvent("onresize",t):(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),e.__resizeListeners__.length||(e.removeEventListener("scroll",o),e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)))}}(jQuery);var d=a.extend({tagName:"div",className:"row gistItem",attributes:{tabindex:0},getTemplate:function(){return"Medications"===this.model.get("graphType")?n:s},events:{click:function(e){e.stopPropagation(),$("[data-toggle=popover]").popover("hide")}},templateHelpers:function(){return{displayName:this.model.get("typeName").toLowerCase()}},initialize:function(e){if(void 0!==this.model.attributes.observed?this.model.attributes.last=moment().diff(moment(ADK.utils.formatDate(this.model.attributes.observed)),"days")+" d":this.model.attributes.last="--","Medications"===this.model.get("graphType")){var t,i=this.model.get("subMedsInternalGroupModels").length;switch(i){case 1:t="100px";break;case 2:t="50px";break;case 3:t="33px";break;case 4:t="25px";break;default:t="25px"}this.model.set("sigHeight",t)}this.applet="stackedGraph",this.options=e,this.options.AppletID="stackedGraph",this.activeCharts=e.activeCharts,this.timeLineCharts=e.timeLineCharts,this.pointers=e.pointers,this._base=a.prototype},onDestroy:function(){$.each(this.activeCharts,function(e,t){$(t.container).off(".stackedGraph")}),this._base.onDestroy.apply(this,arguments)},onRender:function(){var e=this,t=e.$(".renderTo"),o=setInterval(function(){if(t.length>0){clearInterval(o);var s=e.model.get("chart");if(void 0===s)return;$.extend(!0,s,{title:{text:null},tooltip:{crosshairs:!1,shared:!0,headerFormat:"",formatter:function(){var e="";return $.each(this.points,function(t,i){"Ref Range"!==this.series.name&&(e+="DBP"===this.series.name||"SBP"===this.series.name?"<b>"+this.series.name+" "+this.y+"</b>"+this.series.tooltipOptions.valueSuffix+"<br/>":"<b>"+this.y+"</b>"+this.series.tooltipOptions.valueSuffix+"<br/>")}),e},positioner:function(e,t,i){var o,s;return o=i.plotX+e>n.plotWidth?i.plotX+n.plotLeft-e-20:i.plotX+n.plotLeft+20,s=0,{x:o,y:s}}},chart:{zoomType:"",panning:!1,margin:0,spacing:0,backgroundColor:"rgba(0,0,0,0)",dontMoveY:!0},xAxis:{labels:{enabled:!1},tickLength:0,lineWidth:0,lineColor:"#FF0000",startOnTick:!1,endOnTick:!1,tickPositions:[],plotLines:[{color:"#FF0000",width:2,value:moment({h:0,m:0,s:0,ms:0}).valueOf()}]},yAxis:{labels:{enabled:!1,title:null}}});var n=t.highcharts(s,function(e){e.line=e.renderer.rect(100,0,2,e.chartHeight).attr({fill:"black",zIndex:6}).css({visibility:"hidden"}).add()}).highcharts();t.resize(function(){var t=$(this).width();n.reflow(),$.each(e.timeLineCharts,function(e,i){i.setSize(t,null),i.reflow()})});var a=ADK.SessionStorage.getModel_SessionStoragePreference("globalDate"),l=moment(a.get("fromDate"),"MM/DD/YYYY"),d=moment(a.get("toDate"),"MM/DD/YYYY");d.add(1,"d"),n.xAxis[0].setExtremes(Date.UTC(l.year(),l.month(),l.date()),Date.UTC(d.year(),d.month(),d.date())),"Medications"!==e.model.get("graphType")&&r.findPointsInBetween(n,l,d),e.activeCharts.unshift(n),i.each(e.timeLineCharts,function(e,i){e.setSize(t.width(),null)}),e.$el.model=e.model,e.$el.$=function(t){return e.$el.find(t)},"Medications"===e.model.get("graphType")&&(e.$el.applet="Medications"),"Lab Tests"===e.model.get("graphType")&&(e.$el.applet="Lab Tests");var p=ADK.Messaging.request("get:current:screen"),h=["infoButton","detailsviewbutton"];p.config.predefined||h.push("deleteStackedGraphButton"),e.tlbrOpts={targetElement:e.$el,buttonTypes:h,appletID:e.model.get("applet_id"),model:e.model},"Medications"!==e.model.get("graphType")&&e.tlbrOpts.buttonTypes.splice(2,0,"quicklookbutton"),e._base.onRender.apply(e,arguments),"Medications"!==e.model.get("graphType")&&e.listenTo(ADK.Messaging,"globalDate:selected",function(e){var t=ADK.SessionStorage.getModel_SessionStoragePreference("globalDate"),i=moment(t.get("fromDate"),"MM/DD/YYYY"),o=moment(t.get("toDate"),"MM/DD/YYYY");r.findPointsInBetween(n,i,o)}),"Medications"===e.model.get("graphType")&&e.listenTo(ADK.Messaging,"globalDate:selected",function(t){var o=e.model.get("medicationGroupType"),s=new e.model.attributes.ChartBuilder(o,!0),r=new e.model.attributes.GraphConfig(s);i.each(n.series,function(e,t){n.series[t].setData(r.series[t].data,!0)})})}},500);this.createPopover()},showPopover:function(e,t){e.stopPropagation(),$("[data-toggle=popover]").not(t).popover("hide"),t.popover("toggle");var i=$(this.el),o=.85*i.width(),s=(i.offset().left,i.width()-o),n=i.offset().left+.5*s;$(".gistPopover").css("left",n.toString()+"px"),$(".gistPopover").width(o)},createPopover:function(){var t=this,i=e.Marionette.ItemView.extend({template:l});this.$el.find("[data-toggle=popover]").popover({trigger:"manual",html:"true",container:"body",template:(new i).template(),placement:"bottom"}).click(function(e){t.showPopover(e,$(this))}).focus(function(e){e.preventDefault(),e.stopImmediatePropagation(),$(this).keyup(function(i){i.preventDefault(),i.stopImmediatePropagation(),(13===i.keyCode||32===i.keyCode)&&t.showPopover(e,$(this))})})},onBeforeDestroy:function(){$("[data-toggle=popover]").popover("hide"),$(".mainAppletToolbar").remove()}});return d});