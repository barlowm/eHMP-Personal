define(["backbone","marionette","underscore","highcharts","hbs!app/applets/stackedGraph/list/chartsCompositeViewTemplate","app/applets/stackedGraph/utils/utils","app/applets/stackedGraph/list/rowItemView","app/applets/medication_review_v2/medicationResourceHandler","app/applets/medication_review_v2/medicationCollectionHandler","app/applets/medication_review_v2/charts/stackedGraph","app/applets/lab_results_grid/applet","app/applets/vitals/applet","typeahead","highcharts-more"],function(e,t,n,i,o,a,s,r,l){function d(e){return null===e?"":""+e}function c(e){return d(e).toLowerCase().replace(/(?:^|\s|-)\S/g,function(e){return e.toUpperCase()})}var p=e.Marionette.CompositeView.extend({template:o,childViewContainer:".collectionContainer",childView:s,events:{reorder:"reorderRows"},eventString:function(){return["focusin."+this.cid,"click."+this.cid].join(" ")},childEvents:{"before:showtoolbar":function(e){this.hidePopovers(),this.closeToolbar()},"after:showtoolbar":function(e,t){this.activeToolbar=t,this.setDocHandler()},"after:hidetoolbar":function(e){this.activeToolbar="",this.hidePopovers(),$(document).off(this.eventString())},"toggle:quicklook":function(e){var t=$(e.ui.popoverEl);this.setDocHandler(),Messaging.getChannel("gists").trigger("close:quicklooks",t),t.popup("toggle")}},setDocHandler:function(){$(document).off(this.eventString()),$(document).on(this.eventString(),{view:this},this.documentHandler)},documentHandler:function(e){var t=e.data.view;t.$(e.target).length||t.options.preventFocusoutClose||(ADK.Messaging.getChannel("gists").trigger("close:gists").trigger("close:quicklooks"),$(document).off(t.eventString()))},initialize:function(e){this.instanceId=e.instanceId,this.allReadyAdded=e.options.allReadyAdded,this.childViewOptions={activeCharts:e.activeCharts,timeLineCharts:e.timeLineCharts},this.listenTo(ADK.Messaging.getChannel("gists"),"close:gists",function(e){this.closeToolbar()}),this.listenTo(ADK.Messaging.getChannel("gists"),"close:quicklooks",function(e){this.$("[data-toggle=popover]").not(e).popup("hide")})},reorderRows:function(e,t){var i=this;if(t.oldIndex!==t.newIndex){var o=this.collection.at(t.oldIndex);this.collection.remove(o),this.collection.add(o,{at:t.newIndex});var s=a.buildUpdateModel(ADK.ADKApp.currentScreen.config.id,i.instanceId,i.collection);s.save(null,{success:function(e,t){var o=ADK.ADKApp.currentScreen.config.id,a=n.findWhere(t.data.userDefinedGraphs,{id:o});if(a){var s=n.findWhere(a.applets,{instanceId:i.instanceId});s&&s.graphs&&ADK.UserDefinedScreens.reorderStackedGraphsInSession(o,i.instanceId,s.graphs)}},error:function(e){}})}this.closeToolbar()},closeToolbar:function(e){var t=this.$childViewContainer;t&&this.activeToolbar&&(this.activeToolbar.hide(),t.find(".toolbarActive").removeClass("toolbarActive")),this.activeToolbar=null},hidePopovers:function(e){this.$("[data-toggle=popover]").popup("hide"),ADK.Messaging.getChannel("gists").trigger("close:quicklooks")},onDestroy:function(){$(this.el).find(".placeholder-tile-sort").remove(),$("#"+this.options.instanceId+"-scroll-top").remove(),$("#"+this.options.instanceId+"-scroll-bottom").remove(),$(document).off(this.eventString())},onShow:function(){var e=this;$(this.el).find(".collectionContainer").append('<div class="placeholder-tile-sort hidden"/>'),$(this.el).find(".placeholder-tile-sort").on("dragover",function(e){e.preventDefault()}),$(this.el).find(".placeholder-tile-sort").on("drop",function(t){var n=t.originalEvent.dataTransfer.getData("text"),i=Number(n),o=$(this).index()-2;$(this).addClass("hidden"),i>o&&o++;var a={oldIndex:i,newIndex:o};e.reorderRows(t,a)});var t=$("#"+this.options.instanceId).find(".grid-applet-panel").first(),i=$(this.el).find(".collectionContainer").first();$('<div id="'+this.options.instanceId+'-scroll-bottom" style="position: relative; top: -50px; height: 10px; background-color: white;"/>').insertAfter($(t)).on("dragenter",function(t){e.bottomInterval=setInterval(function(){var e=$(i).scrollTop();$(i).scrollTop(e+10)},25)}).on("dragleave",function(t){e.bottomInterval&&clearInterval(e.bottomInterval)}),$('<div id="'+this.options.instanceId+'-scroll-top" style="position: relative; top: 50px; height: 10px; z-index: 22;"/>').insertBefore($(this.el).find(".collectionContainer")).on("dragenter",function(t){e.topInterval=setInterval(function(){var e=$(i).scrollTop();$(i).scrollTop(e-10)},25)}).on("dragleave",function(t){e.topInterval&&clearInterval(e.topInterval)}),this.$noGraph=e.$(".noGraph");var o=setInterval(function(){if(e.$el.parents(".panel.panel-primary").find("#pickList").find("#typeahead").length>0){clearInterval(o);var t=e.$el.parents(".panel.panel-primary").find("#pickList").find("#typeahead"),i=function(t,i){return function(o,a){var s,r;s=[],r=new RegExp(o,"i"),$.each(t,function(t,o){if(r.test(o)){var a={value:o,type:i},l=o;"LDL CHOLESTEROL"===o?l="LDL "+c("CHOLESTEROL"):"BMI"!==o&&"HDL"!==o&&(l=c(o)),a.displayValue=l,-1===n.indexOf(e.allReadyAdded,o.toUpperCase())?a.allReadyAdded=!1:a.allReadyAdded=!0,s.push(a)}}),a(s)}},a=$.Deferred(),s=$.Deferred(),d=$.Deferred(),p={resourceTitle:"operational-data-type-vital",onSuccess:function(e){a.resolve({coll:e})}};ADK.ResourceService.fetchCollection(p);var h={resourceTitle:"operational-data-type-laboratory",onSuccess:function(e){s.resolve({coll:e})}};ADK.ResourceService.fetchCollection(h);l.fetchAllMeds(!1,function(e){var t=r.getMedicationGroupNames(e);d.resolve({coll:t,collection:e})});var u=function(e,t){return t>e?-1:e>t?1:0};$.when(a,s,d).done(function(o,a,s){var r=o.coll.pluck("name");r.push("BMI"),r.sort(u);var l=a.coll.pluck("name");l.sort(u);var d=[];d=s.coll,d.sort(u);var c='<div style="margin: 0px -15px; width: 271px; display: flex;"><div style="width: 228px"><p class="text-capitalize" style="white-space:normal;"><%= displayValue %> <i class="text-muted"><%= type %></i></p></div><div style="width: 42px"><span class="text-muted small"><% if(!allReadyAdded){ %><i class="fa fa-plus"></i> Add</span></div><% } else{ %><i class="fa fa-minus"></i> Delete</span></div><% } %></div>';t.typeahead({hint:!1,highlight:!0,minLength:3},{name:"vitals",displayKey:"displayValue",source:i(r,"Vitals"),templates:{suggestion:n.template(c)}},{name:"labs",displayKey:"displayValue",source:i(l,"Lab Tests"),templates:{suggestion:n.template(c)}},{name:"meds",displayKey:"displayValue",source:i(d,"Medications"),templates:{suggestion:n.template(c)}}).on("typeahead:opened",function(){var e=t.parents(".twitter-typeahead").find(".tt-dropdown-menu");0===e.find(".youTyped").length&&e.prepend($("<p/>",{"class":"youTyped text-muted",text:"Hello"}))}).on("typeahead:selected",function(t,n,i){if(n.allReadyAdded){var o=e.collection.find(function(e){return e.get("typeName")===n.value.toUpperCase()});ADK.Messaging.getChannel("stackedGraph").trigger("delete",{model:o})}else{var a={typeName:n.value,instanceId:e.instanceId,graphType:n.type},r={resourceTitle:"user-defined-stack",fetchType:"POST",criteria:{id:ADK.ADKApp.currentScreen.config.id,instanceId:e.instanceId,graphType:n.type,typeName:n.value.toUpperCase()}};ADK.ResourceService.fetchCollection(r),ADK.UserDefinedScreens.addOneStackedGraphToSession(ADK.ADKApp.currentScreen.config.id,e.instanceId,n.type,n.value.toUpperCase()),$(this).typeahead("val","");var l;"Vitals"===n.type?(l=ADK.Messaging.getChannel("vitals"),deferredResponse=l.request("chartInfo",a)):"Lab Tests"===n.type?(l=ADK.Messaging.getChannel("lab_results_grid"),deferredResponse=l.request("chartInfo",a)):"Medications"===n.type&&(l=ADK.Messaging.getChannel("meds_review"),a.collection=s.collection,deferredResponse=l.request("chartInfo",a))}}).click(function(e){e.stopPropagation()}).on("keyup keydown",function(e){32===e.keyCode&&e.stopPropagation()}).on("keyup",function(e){var n=$(this).val();t.parents(".twitter-typeahead").find(".tt-dropdown-menu .youTyped").text("Search for "+n)})}),t.parents(".dropdown").on("hidden.bs.dropdown",function(){t.typeahead("val","")}),t.parents(".dropdown").on("click",function(){window.setTimeout(function(){t[0].focus()},0)})}},500)}});return p});