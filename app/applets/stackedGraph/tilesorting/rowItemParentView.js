define(["backbone","marionette","underscore","main/components/appletToolbar/appletToolbarView"],function(e,t,o,r){var i,n=e.Marionette.LayoutView.extend({regions:{toolbarView:".toolbarContainer"},ui:{popoverEl:"[data-toggle=popover]",toolbarToggler:".selectable:not([data-toggle=popover])"},events:{"click .selectable:not([data-toggle=popover])":function(e){this.toggleToolbar()},keydown:function(e){var t=e.which||e.keyCode;/(13|32)/.test(t)&&(this.ui.toolbarToggler.trigger("click"),e.preventDefault(),e.stopPropagation())},"keydown [data-toggle=popover]":function(e){var t=e.which||e.keyCode;/(13|32)/.test(t)&&($(e.target).trigger("click"),e.preventDefault(),e.stopPropagation())},dragstart:function(e){var t=$(this.el).parent().find(".row").index(this.el).toString();e.originalEvent?(i=e.currentTarget,e.originalEvent.dataTransfer.setData("text",t)):this.performManualDragStart(t)},dragover:function(e){if(e.preventDefault(),e.stopImmediatePropagation(),i.style.display="none","placeholder-tile-sort"!==e.target.className){var t=$(this.el).parent().find(".placeholder-tile-sort");$(t).removeClass("hidden"),1===$(this.el).index()?$(t).insertBefore($(this.el)):$(t).insertAfter($(this.el))}},drop:function(e){e.preventDefault(),e.stopImmediatePropagation(),originalIndex=Number(this.manualOriginalIndex),targetIndex=$(this.el).parent().find(".row").index(this.el);var t={oldIndex:originalIndex,newIndex:targetIndex};$(this.el).trigger("reorder",t)},dragend:function(e){e.preventDefault(),$(this.el).parent().parent().find(".placeholder-tile-sort").addClass("hidden"),i.style.display="block"}},onRender:function(){var e=ADK.Messaging.request("get:current:screen"),t=!e.config.predefined;$(this.el).attr("draggable",t),t?this.tlbrOpts&&this.tlbrOpts.buttonTypes&&t&&(this.tlbrOpts.buttonTypes.unshift("tilesortbutton"),this.tlbrOpts.isStackedGraph=!0):($(this.el).unbind("dragstart"),$(this.el).unbind("drop"),$(this.el).unbind("dragover"));var o=new r(this.tlbrOpts);this.toolbarView.show(o)},performManualDragStart:function(e){this.manualOriginalIndex=e},onDestroy:function(){this.ui.popoverEl.popup("destroy")},createPopover:function(){this.ui.popoverEl.popup({trigger:"click",html:"true",container:"body",template:popoverTemplate(this.model),placement:"bottom",referenceEl:this.$el})},toggleToolbar:function(){this.toolbarView.currentView;this.$el.hasClass("toolbarActive")?this.hideToolbar():this.showToolbar()},showToolbar:function(){var e=this.toolbarView.currentView;this.trigger("before:showtoolbar"),e.show(),this.$el.addClass("toolbarActive"),this.trigger("after:showtoolbar",e)},hideToolbar:function(){var e=this.toolbarView.currentView;this.trigger("before:hidetoolbar"),e.hide(),this.$el.removeClass("toolbarActive"),this.trigger("after:hidetoolbar")}});return n.extend=function(t){var r=e.Marionette.LayoutView.extend.apply(this,arguments);return"function"==typeof this.prototype.events?r.prototype.events=o.extend({},this.prototype.events(),t.events):r.prototype.events=o.extend({},this.prototype.events,t.events),r},n});