define(["backbone","app/applets/appointments/util","app/applets/appointments/modal/modalView","app/applets/appointments/modal/modalHeaderView","app/applets/appointments/toolBar/toolBarView","hbs!app/applets/appointments/list/dateTimeCellTemplate"],function(e,t,i,a,l,n){"use strict";var o,s={name:"dateTimeFormatted",label:"Date",cell:"string",sortValue:function(e,t){return e.get("dateTime")},hoverTip:"visits_date"},r={name:"formattedDescription",label:"Description",cell:"string",hoverTip:"visits_description"},c={name:"locationName",label:"Location",cell:"string",hoverTip:"visits_location"},d={name:"appointmentStatus",label:"Status",cell:"string",hoverTip:"visits_status"},p={name:"providerDisplayName",label:"Provider",cell:"string",hoverTip:"visits_provider"},m={name:"facilityMoniker",label:"Facility",cell:"string",hoverTip:"visits_facility"},u={name:"formattedTypeName",label:"Type",cell:"string",hoverTip:"visits_type"},f={name:"reasonName",label:"Reason",cell:"string",hoverTip:"visits_reason"},v=[s,r,c,d,m],h=[s,r,c,d,u,p,f,m],D={pageable:!0,resourceTitle:"patient-record-appointment",cache:!0,criteria:{filter:'and(ne(categoryName,"Admission"),ne(locationOos,true))'},viewModel:{parse:function(e){return e=t.getDateTimeFormatted(e),e=t.getFacilityColor(e),e=t.getProviderDisplayName(e),e=t.getFormattedDisplayTypeName(e),e=t.getFormattedDecription(e),e.reason&&!e.reasonName&&(e.reasonName=e.reason),e}}},w=e.Model.extend({defaults:{site:"ALL",siteLabel:"All VA + DOD",show:!0,active:!0}}),y=e.Collection.extend({model:w}),g=new y([{site:"LOCAL",siteLabel:"Local VA",show:!0,active:!0},{site:"ALLVA",siteLabel:"All VA",show:!0,active:!1},{site:"ALL",siteLabel:"All VA + DOD",show:!0,active:!1}]),T=(new $.Deferred,ADK.Applets.BaseGridApplet),b=T.extend({siteHash:null,initialize:function(t){var i=this,a=new $.Deferred;i.siteHash=ADK.UserService.getUserSession().get("site"),a.resolve(i.siteHash),o=T.prototype;var n={},s=new l({collection:n.collection,filterValue:r,siteMenuItems:g});"expanded"===this.columnsViewType?(n.columns=h,this.isFullscreen=!0,n.toolbarView=s):"summary"===this.columnsViewType?(n.columns=v,this.isFullscreen=!1):(n.summaryColumns=v,n.fullScreenColumns=h,this.isFullscreen=!1),n.enableModal=!0,n.filterEnabled=!0,n.filterDateRangeEnabled=!0,n.filterDateRangeField={name:"dateTime",label:"Date",format:"YYYYMMDD"},n.collection=ADK.PatientRecordService.createEmptyCollection(D),this.listenTo(ADK.Messaging,"globalDate:selected",function(t){i.dataGridOptions.collection.fetchOptions.criteria.filter='and(ne(categoryName,"Admission"),ne(locationOos,true),'+i.buildJdsDateFilter("dateTime")+")",i.dataGridOptions.collection.fetchOptions.onSuccess=function(e){i.isFullscreen&&s.filterResultsDefault(e)};var a=i.dataGridOptions.collection;i.loading(),i.dataGridView=ADK.Views.DataGrid.create(i.dataGridOptions),a instanceof e.PageableCollection?a.fullCollection.reset():a.reset(),ADK.PatientRecordService.fetchCollection(a.fetchOptions,a)}),D.criteria={filter:this.buildJdsDateFilter("dateTime")},n.onClickRow=function(e,t){i.onClickRowHandler(e,t,n.collection)},i.dataGridOptions=n,o.initialize.call(i,t);var r;a.done(function(e){r=":"+e+":",D.criteria={filter:'and(ne(categoryName,"Admission"),ne(locationOos,true),'+i.buildJdsDateFilter("dateTime")+")",customFilter:'and(ne(categoryName,"Admission"),ne(locationOos,true))'},D.onSuccess=function(e){if(i.isFullscreen){var t=g.findWhere({active:!0}),a=t.get("site");s.filterResults(a,e,r)}},ADK.PatientRecordService.fetchCollection(D,i.dataGridOptions.collection),s.collection=n.collection,s.filterValue=r})},onBeforeDestroy:function(){D.onSuccess=null,this.dataGridOptions.onClickRow=null},onRender:function(){o.onRender.apply(this,arguments)},onClickRowHandler:function(e,l,n){var o=new i({model:e,collection:n}),s={title:t.getModalTitle(e),size:"normal",headerView:a.extend({model:e,theView:o})},r=new ADK.UI.Modal({view:o,options:s});r.show()}}),A={id:"appointments",viewTypes:[{type:"summary",view:b.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:b.extend({columnsViewType:"expanded"}),chromeEnabled:!0}],defaultViewType:"summary"};return A});