define(["backbone","marionette","underscore","moment","app/applets/addOrder/helpers/opDataUtil","app/applets/addOrder/helpers/validation","hbs!app/applets/addOrder/templates/alertTemplate"],function(e,t,r,n,i,a,d){"use strict";var o,s,l,c,u,p,v,m,g,f,h,D,O,b,I,M,w,y,A,E,R,S,P,C=e.Model.extend({});S=function(){return ADK.PatientRecordService.getCurrentPatient().get("localId")},y={error:function(e,t){$("#btn-add-order-accept").html('<span class="sr-only"> Press enter to </span>Accept Order'),$("#btn-add-order-accept").removeClass("disabled"),alert(t.responseText)},success:function(t,n){var i="Saved Successfully. Order#: "+n.data.items.split(";")[0],a=new e.Model;a.set("message",i);var o=e.Marionette.ItemView.extend({template:d}),s=new o({model:a}),l={size:"small"},c=ADK.Messaging.getChannel("medicationChannel"),u=c.request("refresh"),p=function(e){var t=e.medicationCollectionHandler;t.fetchAllMeds(),ADK.UI.Modal.hide()};r.delay(u.done,6e3,p);var v=new ADK.UI.Modal({view:s,options:l});v.show()}},O=function(){var e=i.getPreviewValues();A=e.doseString||"",o=e.strength||"",s=e.verb||"",l=e.amount||"",c=e.route||"",u=e.schedule||"",E=e.drugIEN||"",R=e.routeIEN||"",P=e.medName||"",v=e.supply||"",m=e.quantity||"",g=e.refills||"",f=e.pickup||"",h=e.priority||"",p=$("#prn").is(":checked")?"AS NEEDED":"",D=$("#comments").val()||"",I=(s&&s+" ")+(l&&l+" ")+(c&&c+" ")+(u&&u+" ")+(p&&p+" ")},b=function(){O();var e="<p>",t="<p>",r="<p>";return e+=P+" "+(o&&o+" "),t+=(I&&I+" ")+(D&&D+" "),r+="Quantity: "+m+" Refills: "+g,e+t+r},M=function(){O();var e=i.model;e.set({param:{ien:S(),provider:10000000226,location:23,orderDialog:"PSO OERR",displayGroup:4,quickOrderDialog:147,orderID:"",ORDIALOG:{medIEN:i.getMed().get("IEN"),strength:o,drugIEN:E,doseString:A,dose:o,routeIEN:R,schedule:u,supply:v,quantity:m,refills:g,pickup:f,priority:h,instructions:I,comment:D,ORCHECK:0,ORTS:0}}},{validate:!0});var t="",r=ADK.PatientRecordService.getCurrentPatient();return t=r.get("icn")?r.get("icn"):r.get("pid")?r.get("pid"):r.get("id"),e.urlRoot=ADK.ResourceService.buildUrl("write-back-outpatient-med-save",{pid:t}),e},w=function(){var e=M();e.save(null,y)};var K={buildPreview:function(){i.model.isValid()&&$("#previewOrder").html(b())},saveMed:function(){w()},getVisitModel:function(){var t=new e.Model({visit:ADK.PatientRecordService.getCurrentPatient().get("visit")});return t},getModel:function(){return C.extend(a)},update:function(){M(),$("#btn-add-order-accept").prop("disabled",!1)}};return K});