define(["backbone","marionette","jquery","handlebars","moment","../collectionHandler"],function(e,t,i,s,o,n){var a,l,r,c=new e.Collection([{}]),m={locations:new e.Collection,providers:new e.Collection,appointments:new e.Collection([{}]),admissions:new e.Collection([{}])},d=new e.Collection([{}]),p=e.Model.extend({defaults:{locationUid:"",locationDisplayName:"",dateTime:"",formattedDate:"",isHistorical:"off",existingVisit:!1,selectedProvider:{}}}),u={control:"container",extraClasses:["row select-encounter-container"],items:[{control:"container",extraClasses:["col-md-6"],items:[{control:"select",label:"Select Encounter Provider",srOnlyLabel:!1,name:"selectEncounterProvider",placeholder:"Please wait while the list is loading.",disabled:!0,pickList:a,showFilter:!0,groupEnabled:!0}]}]},h={title:"Clinic Appointments",items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12","marginTopButtom"],template:'<span class="sr-only">{{preSelectSRText}}</span><span>Viewing {{clinicAppointmentsFromDate}} to {{clinicAppointmentsThroughDate}}<span>'}]},{control:"container",extraClasses:["row"],items:[{control:"selectableTable",name:"appointmentsModel",id:"selectableTableAppointments",collection:c,columns:[{title:"Date",id:"formatteddateTime"},{title:"Details",id:"summary"},{title:"Facility",id:"facilityDisplay"},{title:"Location",id:"locationDisplayName"}],extraClasses:["special-class"]}]}]},g={title:"Hospital Admissions",items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12","marginTopButtom"],template:"<span>Viewing {{hospitalAdmissionFromDate}} to {{hospitalAdmissionCurrent}}</span>"}]},{control:"container",extraClasses:["row"],items:[{control:"selectableTable",name:"admissionsModel",id:"selectableTableAdmissions",collection:d,columns:[{title:"Date",id:"formatteddateTime"},{title:"Details",id:"reasonName"},{title:"Facility",id:"facilityDisplay"},{title:"Location",id:"locationDisplayName"}],extraClasses:["special-class"]}]}]},b={title:"New Visit",items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12"],template:"<h6>New Visit</h6>"}]},{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-6"],items:[{control:"select",label:"New Encounter Location",srOnlyLabel:!1,name:"selectnewencounterLocation",disabled:!0,pickList:l,showFilter:!0,groupEnabled:!0}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"container",extraClasses:["col-md-6"],items:[{control:"datepicker",name:"newVisitDate",srOnlyLabel:!1,label:"Date"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"timepicker",placeholder:"HH:MM",name:"newVisitTime",srOnlyLabel:!1,label:"Time of Visit"}]},{control:"container",extraClasses:["col-md-12"],items:[{control:"alertBanner",name:"newVisitDateTimeWarning",type:"warning"}]},{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12"],items:[{control:"checkbox",name:"isHistorical",label:"Historical Visit: a visit that occurred at some time in the past or at some other location (possibly non-VA) but is not used for workload credit."}]}]}]}]}]},v={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12"],items:[{control:"container",tagName:"h5",extraClasses:["encounters-sub-heading"],template:"Select Encounter Location"},{control:"tabs",id:"tabs-container",tabs:[h,g,b]}]}]},f=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[v,u]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"button",type:"button",id:"cancel-btn",label:"Cancel",extraClasses:["btn-default"],name:"cancel"},{control:"button",id:"viewEncounters-btn",label:"Set and View",disabled:!0,extraClasses:["btn-primary"],name:"ok"},{control:"button",id:"setClose-btn",label:"Set and Close",disabled:!0,extraClasses:["btn-primary"],name:"ok"}]}],D=e.Marionette.ItemView.extend({template:s.compile('{{ui-button "Cancel" classes="btn-default" title="Click button to cancel your action!"}}{{ui-button "Continue" classes="btn-primary" title="Click button to continue your action!"}}'),events:{"click .btn-primary":function(){ADK.UI.Alert.hide(),ADK.UI.Workflow.hide()},"click .btn-default":function(){ADK.UI.Alert.hide()}},tagName:"span"}),w=e.Marionette.ItemView.extend({template:s.compile("You will lose all work in progress if you delete this task. Would you like to proceed?"),tagName:"p"}),A=(e.Marionette.ItemView.extend({template:s.compile("You will lose all work in progress if you close this task. Would you like to proceed?"),tagName:"p"}),ADK.UI.Form.extend({fields:f,events:{submit:"submitForm","click #cancel-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to cancel?",icon:"fa-exclamation-triangle",messageView:w,footerView:D});t.show()},"click #viewEncounters-btn":function(e){e.preventDefault(),this.submitForm(e);var t=ADK.Messaging.getChannel("encounterFormRequestChannel");t.command("openEncounterForm")},"show.bs.tab .tab-container":"tabChanged"},modelEvents:{"change:newVisitDate":"validateNewVisitDateTime","change:newVisitTime":"validateNewVisitDateTime","change:selectEncounterProvider":"validateForm","change:admissionsModel":"setAdmission","change:appointmentsModel":"setAppointment","change:selectnewencounterLocation":"setnewencounterLocation"},submitForm:function(e){if(e.preventDefault(),this.model.isValid()){this.model.unset("formStatus");var t=ADK.PatientRecordService.getCurrentPatient(),i=new ADK.UI.Notification({title:"Visit context",icon:"fa-check",type:"success",message:"The visit context was succesfully set."}),s=this.workflow.options.model.get("steps").findWhere({currentStep:!0});switch(this.setProvider(this.model),this.currentTab){case"New-Visit-tab-panel":r.set("isHistorical",this.model.get("isHistorical")),r.set("dateTime",o(this.model.get("newVisitDate")+" "+this.model.get("newVisitTime")).format("YYYYMMDDhhmm")),r.set("formatteddateTime",o(r.get("dateTime"),"YYYYMMDDHHmm").format("MM/DD/YYYY HH:mm"))}t.set({visit:JSON.parse(JSON.stringify(this.model.get("visit")))}),ADK.SessionStorage.addModel("patient",t),s&&(s.get("numberOfSteps")===s.get("currentIndex")?ADK.UI.Workflow.hide():this.workflow.goToNext()),i.show()}else this.model.set("formStatus",{status:"error",message:self.model.validationError})},tabChanged:function(e){e.target.attributes["aria-controls"]&&(this.currentTab=e.target.attributes["aria-controls"].value),"Clinic-Appointments-tab-panel"===this.currentTab?this.setAppointment(this.model):"Hospital-Admissions-tab-panel"===this.currentTab?this.setAdmission(this.model):"New-Visit-tab-panel"===this.currentTab&&this.setnewencounterLocation(this.model)},validateNewVisitDateTime:function(){var e=o(this.model.get("newVisitDate")+" "+this.model.get("newVisitTime")),t=o();e.isValid()&&e.isAfter(t)?i(".newVisitDateTimeWarning").show():i(".newVisitDateTimeWarning").hide(),this.validateForm()},validateForm:function(){var e={enc:void 0!==this.model.get("selectEncounterProvider")&&""!==this.model.get("selectEncounterProvider"),loc:this.model.get("visit")&&void 0!==this.model.get("visit").attributes.locationDisplayName&&""!==this.model.get("visit").attributes.locationDisplayName,nloc:void 0!==r.attributes.existingVisit&&""!==r.attributes.locationDisplayName,nvtime:""!==this.model.get("newVisitTime"),nvdate:""!==this.model.get("newVisitDate")},t=!1;t=("Clinic-Appointments-tab-panel"===this.currentTab||"Hospital-Admissions-tab-panel"===this.currentTab)&&e.enc&&e.loc?!0:"New-Visit-tab-panel"===this.currentTab&&e.enc&&e.nloc&&e.nvdate&&e.nvdate?!0:!1,this.$el.find(this.ui.setCloseButton.selector).trigger("control:disabled",!t),this.$el.find(this.ui.encountersButton.selector).trigger("control:disabled",!t)},setAdmission:function(e){e.get("admissionsModel")?(e.set("visit",e.get("admissionsModel")),e.get("visit").set("existingVisit",!0)):e.set("visit",void 0),this.validateForm()},setAppointment:function(e){e.get("appointmentsModel")?(e.set("visit",e.get("appointmentsModel")),e.get("visit").set("existingVisit",!0)):e.set("visit",void 0),this.validateForm()},setnewencounterLocation:function(e){var t=e.get("selectnewencounterLocation"),i=m.locations.findWhere({uid:t});if(i){r.set(i.attributes),r.set({existingVisit:!1,locationDisplayName:i.get("displayName"),locationUid:t});var s=t.split(":").pop();s&&n.getServiceCategory(s,0,this.setServiceCategory)}else r.unset("existingVisit"),r.unset("locationDisplayName"),r.unset("locationUid"),r.unset("serviceCategory");this.model.set("visit",r),this.validateForm()},setServiceCategory:function(e){r.set("serviceCategory",e.models[0].get("serviceCategory"))},setProvider:function(e){var t=m.providers.findWhere({code:e.get("selectEncounterProvider")});t?e.get("visit").set("selectedProvider",t.toJSON()):e.get("visit").set("selectedProvider",{})},setDatesAppointments:function(e){var t=this.model.get("clinicAppointmentsFromDate"),i=this.model.get("clinicAppointmentsThroughDate"),s=n.collectionDateFilter(m.appointments,t,i);c.set(s),0===s.length?(this.$el.find("#selectableTableAppointments .no-results").html("No appointments/visit found."),this.$el.find("#selectableTableAppointments .no-results").show()):this.$el.find("#selectableTableAppointments .no-results").hide()},setDatesHospital:function(e){var t=this.model.get("hospitalAdmissionFromDate"),i=this.model.get("hospitalAdmissionCurrent"),s=n.collectionDateFilter(m.admissions,t,i);d.set(s),0===s.length?(this.$el.find("#selectableTableAdmissions .no-results").html("No admissions found."),this.$el.find("#selectableTableAdmissions .no-results").show()):this.$el.find("#selectableTableAdmissions .no-results").hide()},ui:{selectEncounterProvider:"#selectEncounterProvider",selectnewencounterLocation:"#selectnewencounterLocation",setCloseButton:"#setClose-btn",encountersButton:"#viewEncounters-btn"},currentTab:"Clinic-Appointments-tab-panel",initialize:function(){var e=ADK.UserService.getUserSession(),t=e.get("provider");t&&this.model.set("selectEncounterProvider",e.get("duz")[e.get("site")]);var i=o(),s=o(),a=o(),l=o();s=s.subtract("days",30),a=a.add("days",30),l=l.subtract("years",10),this.model.set("newVisitDate",i.format("MM/DD/YYYY")),r=new p,this.model.set("visit",r),this.model.set("clinicAppointmentsFromDate",s.format("MM/DD/YYYY")),this.model.set("clinicAppointmentsThroughDate",a.format("MM/DD/YYYY")),this.model.set("hospitalAdmissionCurrent",i.format("MM/DD/YYYY")),this.model.set("hospitalAdmissionFromDate",l.format("MM/DD/YYYY"));var u=this.model.get("contextVisit");u&&(this.model.set("appointmentsModel",u),this.setAppointment(this.model),this.model.set("preSelectSRText","Appointment "+u.get("formatteddateTime")+" "+u.get("locationDisplayName")+" "+u.get("facilityDisplay")+" pre-selected from current Encounter."));var h=this;this._super=ADK.UI.Form.prototype,this._super.initialize.apply(this,arguments),n.getProvidersPicklist(function(e){h.isDestroyed||(h.updateprovidersPickList(h,n.providerParser(e)),h.$el.find(h.ui.selectEncounterProvider.selector).trigger("control:disabled",!1),m.providers.set(e.models))}),n.getLocations(function(e){h.isDestroyed||(h.updatelocationsPickList(h,n.locationsParser(e)),h.$el.find(h.ui.selectnewencounterLocation.selector).trigger("control:disabled",!1),m.locations.set(e.models))}),n.getAdmissions(function(e){m.admissions.set(n.admissionsParser(e).models),d.set(n.admissionsParser(e).models),h.model.set("hospitalAdmissionFromDate",l.format("MM/DD/YYYY")),h.model.set("hospitalAdmissionCurrent",i.format("MM/DD/YYYY")),e.length>0&&h.setDatesHospital()});var g=ADK.SessionStorage.get.sessionModel("user","SessionStorage");n.getAppointments(g.attributes.site,function(e){m.appointments.set(n.appointmentsParser(e).models),c.set(n.appointmentsParser(e).models),h.model.set("clinicAppointmentsFromDate",s.format("MM/DD/YYYY")),h.model.set("clinicAppointmentsThroughDate",a.format("MM/DD/YYYY")),e.length>0&&h.setDatesAppointments()})},onAttach:function(){0===i("#selectableTableAppointments .no-results").length&&i("#selectableTableAppointments").append('<div class="no-results">Loading...</div>'),0===i("#selectableTableAdmissions .no-results").length&&i("#selectableTableAdmissions").append('<div class="no-results">Loading...</div>')},updateprovidersPickList:function(e,t){e.callControlFunction({controlType:"select",controlName:"selectEncounterProvider",functionName:"setPickList",options:{pickList:t}})},updatelocationsPickList:function(e,t){e.callControlFunction({controlType:"select",controlName:"selectnewencounterLocation",functionName:"setPickList",options:{pickList:t}})}}));return A});