define(["underscore","hbs!app/applets/problems_add_edit/addEditProblem","app/applets/visit/typeaheadView","hbs!app/applets/problems_add_edit/problemComment","moment","typeahead","app/applets/problems_add_edit/util/addEditBloodhound"],function(e,t,i,o,a,n,s){function d(e,t){var i=ADK.PatientRecordService.getCurrentPatient();m=e,h=t,i.get("visit")?r():(v.command("openVisitSelector","problem_add_edit"),v.on("set-visit-success:problem_add_edit",function(){$("#mainModal").one("hidden.bs.modal",r)}))}function r(){var e={};"problem_edit"===m?e.title="Edit Problem: "+h.get("summary"):e.title="Add Problem: "+h.get("problemText"),e.footerView=l(),e.size="medium",c=new w({model:h});var t=new ADK.UI.Modal({view:c,options:e});t.show(),$("#modal-lg-region").empty(),setTimeout(function(){$("#active").focus()},1e3)}function l(){function t(e){return e?e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():""}var i;i="problem_edit"===m?'<button id="cancelBtn" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button><button type="button" id="editProblemUpdate" class="btn btn-primary">Update Active Problem</button>':'<div class="pull-left"><button type="button" class="btn btn-default" id="addProblemBackBtn">Back</button></div><div class="pull-right"><button id="cancelBtn" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button><button type="button" id="addProblemSubmitBtn" class="btn btn-primary">Add Active Problem</button></div>',gatherInput=function(){var i=c.model,o=p,a=g,n=c.commentsView.collection,s={},d=ADK.PatientRecordService.getCurrentPatient(),r=ADK.UserService.getUserSession(),l=r.get("duz")[r.get("site")]?r.get("duz")[r.get("site")]:r.get("duz")[0];"problem_add"===m&&(s.patientIEN=d.get("localId"),s.patientName=d.get("fullName"),s.enteredByIEN=l,s.enteredBy=r.get("lastname")+","+r.get("firstname")),a?(-1!==a.get("localId")&&(s.responsibleProviderIEN=a.get("localId"),s.providerIEN=a.get("localId")),s.responsibleProvider=a.get("name")):(s.responsibleProviderIEN=l,s.providerIEN=l,s.responsibleProvider=r.get("lastname")+","+r.get("firstname")),s.userIEN=l,s.status=$("#status .btn.active").data("value"),s.lexiconCode=i.get("lexiconCode")||"",s.problemName=i.get("problem")||i.get("problemText"),s.problemText=i.get("problemText"),i.get("problemNumber")?s.problemNumber=i.get("problemNumber"):i.get("uid")&&(s.problemNumber=i.get("uid").split(":").pop()),o&&o.get("localId")&&(s.service=o.get("localId")+"^"+o.get("name")),$("#problem").val()||"problem_edit"!==m||(s.service="0"),"problem_add"===m?s.dateRecorded=ADK.utils.dateUtils.getRdkDateTimeFormatter().getCurrentDate():s.dateLastModified=ADK.utils.dateUtils.getRdkDateTimeFormatter().getCurrentDate();var h=$("#dp-problem").val();h&&(s.dateOfOnset=ADK.utils.dateUtils.getRdkDateTimeFormatter().getDateFromDateString(h));var u=d.get("visit");if(u&&u.selectedProvider&&(s.recordingProvider=u.selectedProvider.name,s.recordingProviderIEN=u.selectedProvider.localId),s.acuity=$("#problemAcuitySelect .btn.active").data("value"),"yes"===i.get("showRadiation")&&(s.radiation=t($("#tf-radiation .btn.active").data("value"))),"yes"===i.get("showAgentOrange")&&(s.agentOrange=t($("#tf-agentorange .btn.active").data("value"))),"yes"===i.get("showSouthwestAsiaConditions")&&(s.southwestAsiaConditions=t($("#tf-swasiaconditions .btn.active").data("value"))),"yes"===i.get("showHeadNeckCancer")&&(s.headOrNeckCancer=t($("#tf-headneckcancer .btn.active").data("value"))),"yes"===i.get("showMST")&&(s.MST=t($("#tf-mst .btn.active").data("value"))),"yes"===i.get("showServiceConnected")&&(s.serviceConnected=t($("#tf-serviceconnected .btn.active").data("value"))),"yes"===i.get("showShipboardHazard")&&(s.shipboard=t($("#tf-shipboardhazard .btn.active").data("value"))),i.get("snomed")&&(s.snomedCode=i.get("snomed")),s.comments=[],"problem_add"===m)e.each(n.models,function(e,t,i){s.comments.push(e.get("comment"))});else{e.each(n.models,function(e,t,i){var o=e.get("comment"),a=e.get("old");a?s.comments.push({old:a,"new":o}):""!==o&&s.comments.push({old:"","new":o})})}return s},buildSaveObject=function(){var e,t=gatherInput();return e="problem_edit"===m?new f(t):new C(t)};var o=Backbone.Marionette.ItemView.extend({template:e.template(i),events:{"click #editProblemUpdate":"submitEdit","click #addProblemBackBtn":"navToSearch","click #addProblemSubmitBtn":"submitNewProblem","keydown #cancelBtn":"handleKeyPress"},submitEdit:function(){$("#addEditProblemForm #error-container").text("");var e=buildSaveObject();e.save(null,{success:function(){ADK.UI.Modal.hide(),setTimeout(function(){$('div[data-appletid="problems"] .applet-refresh-button').trigger("click")},2e3)},error:function(e){$("#addEditProblemForm #error-container").text("Save Failed")}})},handleKeyPress:function(e){9===e.keyCode&&e.shiftKey&&c.commentsView.collection.length>0&&$(".problem-comment-actions").last().removeClass("hidden")},submitNewProblem:function(){$("#addEditProblemForm #error-container").text("");var e=buildSaveObject();e.save(null,{success:function(){ADK.UI.Modal.hide(),setTimeout(function(){$('div[data-appletid="problems"] .applet-refresh-button').trigger("click")},2e3)},error:function(e,t){400===t.status?($("#addEditProblemForm #error-container").text("Save Failed: Please provide all required fields."),$("#respProviderBlock div").addClass("has-error")):$("#addEditProblemForm #error-container").text("Save Failed")}})},navToSearch:function(e){u.command("openProblemSearch","problem_search")}});return o}var m,c,h,u=ADK.Messaging.getChannel("problem-add-edit"),v=ADK.Messaging.getChannel("visit");u.comply("openProblemAdd",d),u.comply("openProblemEdit",d);var p,g,b=Backbone.Model.extend({defaults:{}}),f=Backbone.Model.extend({sync:function(t,i,o){var a={type:"POST",url:i.url(),contentType:"application/json",data:JSON.stringify(i.toJSON()),dataType:"json"};$.ajax(e.extend(a,o))},url:function(){var e=ADK.PatientRecordService.getCurrentPatient().get("pid");return ADK.ResourceService.buildUrl("problems-UpdateProblem",{pid:e})}}),C=Backbone.Model.extend({sync:function(t,i,o){var a={type:"PUT",url:i.url(),contentType:"application/json",data:JSON.stringify(i.toJSON()),dataType:"json"};$.ajax(e.extend(a,o))},url:function(){var e=ADK.PatientRecordService.getCurrentPatient().get("pid");return ADK.ResourceService.buildUrl("problems-AddProblem",{pid:e})}}),y=Backbone.Marionette.ItemView.extend({model:b,tagName:"li",template:o,className:"clearfix",events:{"click .remove-comment":"removeComment","click .edit-comment":"editComment","click .cancel-comment":"cancelComment","click .save-comment":"saveComment","keyup .commentText":"handleCommentTyping","keydown .remove-comment":"handleKeyPress","keydown .cancel-comment":"handleKeyPress","keydown .save-comment":"handleKeyPress","keydown .edit-comment":"handleKeyPress",mouseenter:"makeActionsVisible",mouseleave:"makeActionsInvisible","focus .commentText":"makeActionsVisible","focus .problem-comment-actions span":"makeActionsVisible","focusout .commentText":"makeActionsInvisible","focusout .problem-comment-actions span":"makeActionsInvisible"},initialize:function(){var e=ADK.UserService.getUserSession();"new"===this.model.get("type")?(this.model.set("entered",new a(new Date).format("YYYYMMDD")),this.model.set("enteredByName",e.get("lastname")+", "+e.get("firstname")),this.enterEditMode()):(this.model.set("type","existing"),this.model.set("edit-mode",""))},onDomRefresh:function(){this.model.get("removed")||($(this.el).find(".commentText").focus(),$(this.el).find(".commentText")[0].setSelectionRange(60,60),this.handleCommentTyping())},makeActionsVisible:function(){$(this.el).find(".problem-comment-actions").removeClass("hidden")},makeActionsInvisible:function(e){if("mouseleave"===e.type){var t=$(this.el).find(":focus");t.length<1&&$(this.el).find(".problem-comment-actions").addClass("hidden")}else $(this.el).find(".problem-comment-actions").addClass("hidden")},handleKeyPress:function(e){if(13===e.keyCode||32===e.keyCode)$(e.currentTarget).click();else if(9===e.keyCode){var t=e.currentTarget.className;if(!e.shiftKey||"edit-comment"!==t&&"save-comment"!==t){if(!e.shiftKey&&("cancel-comment"===t||"remove-comment"===t)){var i=$(this.el).next();i.length>0&&$(i).find(".problem-comment-actions").removeClass("hidden")}}else{var o=$(this.el).prev();o.length>0&&$(o).find(".problem-comment-actions").removeClass("hidden")}}},removeComment:function(){this.model.set("removed","yes"),this.model.set("comment",""),"new"===this.model.get("type")?this.trigger("comment:removefromlist",this):($(this.el).addClass("hidden"),this.leaveEditMode())},cancelComment:function(){"new"===this.model.get("type")?this.trigger("comment:removefromlist",this):(this.model.set("comment",this.model.get("previousComment")),this.leaveEditMode())},editComment:function(){this.enterEditMode()},saveComment:function(){this.model.get("canSave")&&(this.model.set("comment",$(this.el).find(".commentText").val()),this.leaveEditMode())},handleCommentTyping:function(){var e=$(this.el).find(".commentText").val().trim().length;$(this.el).find(".commentCharsRemaining").text(60-e),e>0?($(this.el).find(".save-comment b").removeClass("disabled"),this.model.set("canSave","yes")):($(this.el).find(".save-comment b").addClass("disabled"),this.model.set("canSave",""))},enterEditMode:function(){this.model.set("edit-mode","yes"),this.model.set("previousComment",this.model.get("comment")),this.render()},leaveEditMode:function(){this.model.set("edit-mode",""),this.render(),this.trigger("comment:finishedEditing")}}),k=Backbone.Marionette.CollectionView.extend({tagName:"ul",childView:y,childEvents:{"comment:removefromlist":"removeItem","comment:finishedEditing":"focusAddButton"},focusAddButton:function(){$("#addCommentBtn").focus()},removeItem:function(e){this.collection.remove(e.model),this.focusAddButton()},addNewComment:function(){var e=new Backbone.Model({comment:"",type:"new"});this.collection.add(e)}}),w=Backbone.Marionette.LayoutView.extend({template:t,regions:{service:"#serviceBlock",comments:"#comment-list",provider:"#respProviderBlock"},events:{"click #addCommentBtn":"handleAddComment","click #date-picker-icon":"openDatePicker","click .toggle-btn":"handleToggleButton","keydown #addCommentBtn":"handleKeyPress"},initialize:function(){var t=ADK.PatientRecordService.getCurrentPatient();if(this.model.get("comments")){var i=[];e.each(this.model.get("comments"),function(e,t,o){i[t]=e,i[t].old=e.comment}),this.commentsView=new k({collection:new Backbone.Collection(i)})}else this.commentsView=new k({collection:new Backbone.Collection});var o=ADK.UserService.getUserSession().get("site"),a=ADK.UserService.getUserSession(),n={};n.resourceTitle="locations-clinics",n.criteria={"site.code":o,limit:10};var s;if("problem_edit"===m&&this.model.get("locationName"))s=new Backbone.Model({name:this.model.get("locationName")});else if("problem_add"===m&&t.get("visit")&&t.get("visit").locationUid){var d=t.get("visit").locationUid.split(":").pop();s=new Backbone.Model({name:t.get("visit").locationName,localId:d})}else s=new Backbone.Model;this.model.set("serviceLocationName",s.get("name"));var r;if(this.model.get("providerName")){var l=-1;this.model.get("providerUid")&&(l=this.model.get("providerUid").split(":").pop()),r=new Backbone.Model({name:this.model.get("providerName"),localId:l})}else if(a.get("provider")){var c=a.get("lastname")+","+a.get("firstname"),h=a.get("duz")[a.get("site")]?a.get("duz")[a.get("site")]:a.get("duz")[0];r=new Backbone.Model({name:c,localId:h}),this.model.set("serviceVisitProvider",c)}var u=t.get("exposure");if(u)for(var v=0;v<u.length;v++){var p=u[v].name;u[v].uid.indexOf("urn:va:ionizing-radiation")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showRadiation","yes"),this.model.set("treatmentFactor-radiation",u[v].name)):u[v].uid.indexOf("urn:va:agent-orange")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showAgentOrange","yes"),this.model.set("treatmentFactor-agentOrange",u[v].name)):u[v].uid.indexOf("urn:va:sw-asia")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showSouthwestAsiaConditions","yes"),this.model.set("treatmentFactor-swAsia",u[v].name)):u[v].uid.indexOf("urn:va:head-neck-cancer")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showHeadNeckCancer","yes"),this.model.set("treatmentFactor-headNeckCancer",u[v].name)):u[v].uid.indexOf("urn:va:mst")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showMST","yes"),this.model.set("treatmentFactor-mst",u[v].name)):u[v].uid.indexOf("urn:va:combat-vet")>-1?"NO"!==p.toUpperCase()&&(this.model.set("showServiceConnected","yes"),this.model.set("treatmentFactor-serviceConnected",u[v].name)):u[v].uid.indexOf("urn:va:shipboard")>-1&&"NO"!==p.toUpperCase()&&(this.model.set("showShipboardHazard","yes"),this.model.set("treatmentFactor-shipboardHazard",u[v].name))}},setExistingDataAndDefaults:function(){var e=this.model.get("statusName")||"Active",t=(this.model.get("locationName"),this.model.get("providerName"),this.model.get("acuityName")||"Unknown");"Inactive"===e?this.$("#inactive").addClass("active"):this.$("#active").addClass("active"),this.$("#"+t.toLowerCase()).addClass("active"),"yes"===this.model.get("treatmentFactor-radiation")?this.$("#radiationYes").addClass("active"):this.$("#radiationNo").addClass("active"),"yes"===this.model.get("treatmentFactor-agentOrange")?this.$("#agentOrangeYes").addClass("active"):this.$("#agentOrangeNo").addClass("active"),"yes"===this.model.get("treatmentFactor-swAsia")?this.activateRadioButton("swAsiaConditionsYes"):this.activateRadioButton("swAsiaConditionsNo"),"yes"===this.model.get("treatmentFactor-headNeckCancer")?this.$("#headNeckCancerYes").addClass("active"):this.$("#headNeckCancerNo").addClass("active"),"yes"===this.model.get("treatmentFactor-mst")?this.$("#mstYes").addClass("active"):this.$("#mstNo").addClass("active"),"yes"===this.model.get("treatmentFactor-serviceConnected")?this.$("#serviceConnectedYes").addClass("active"):this.$("#serviceConnectedNo").addClass("active"),"yes"===this.model.get("treatmentFactor-shipboardHazard")?this.$("#shipboardHazardYes").addClass("active"):this.$("#shipboardHazardNo").addClass("active"),this.model.get("onset")?this.$("#dp-problem").datepicker("update",new a(this.model.get("onset"),"YYYYMMDD").format(ADK.utils.dateUtils.defaultOptions().placeholder)):this.$("#dp-problem").datepicker("update",(new a).format(ADK.utils.dateUtils.defaultOptions().placeholder))},onRender:function(){this.comments.show(this.commentsView),ADK.utils.dateUtils.datepicker(this.$("#dp-problem"));var e=s.VisitProviderBloodhound;e.initialize(),$(this.el).find("#respProvider").typeahead({minLength:1,highlight:!0,hint:!0},{name:"visit-search-item",displayKey:"value",source:e.ttAdapter()}).on("typeahead:selected",function(e,t){g=new Backbone.Model({name:t.value,localId:t.localId})});var t=s.LocationSearchBloodhound;t.initialize(),$(this.el).find("#serviceLocation").typeahead({minLength:1,highlight:!0,hint:!0},{name:"location-search-item",displayKey:"value",source:t.ttAdapter()}).on("typeahead:selected",function(e,t){p=new Backbone.Model({name:t.value,localId:t.localId})}),this.setExistingDataAndDefaults()},handleKeyPress:function(e){13===e.keyCode||32===e.keyCode?$(e.currentTarget).click():9===e.keyCode&&!e.shiftKey&&this.commentsView.collection.length>0&&$(".problem-comment-actions").first().removeClass("hidden")},handleAddComment:function(e){this.commentsView.addNewComment()},handleToggleButton:function(e){$(e.target).siblings().removeClass("active"),$(e.target).addClass("active")},openDatePicker:function(){this.$("#dp-problem").datepicker("show")},activateRadioButton:function(e){this.$("#"+e).first().attr("checked",!0),this.$('label[for="'+e+'"]').first().addClass("active")}});return w});