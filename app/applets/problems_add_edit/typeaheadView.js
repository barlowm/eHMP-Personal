define(["jquery","underscore","handlebars"],function(e,t,o){var i={generate:function(i,l,n,a,s,d){var c=Backbone.Marionette.ItemView.extend({template:o.compile("{{"+a+"}}"),tagName:"li",className:"list-group-item",attributes:function(){return{id:this.model.cid,role:"menuitem",tabindex:-1,"data-name":this.model.get(a),"data-icd9":this.model.get("icd9")}},onRender:function(){e("#uncoded").is(":checked")||"799.9"!=this.$el.attr("data-icd9")||this.$el.css("display","none")}}),r=Backbone.Marionette.CompositeView.extend({template:o.compile('<div class="input-group"><label class="sr-only" for="'+i+'">Enter search term or SNOMED number</label><span class="input-group-addon"><i class="fa fa-search"></i></span><input class="form-control" autocomplete="off" id="'+i+'" tabindex="0" data-uid="" placeholder="Enter search term or SNOMED number" value="{{searchTerm}}"/></div><div class="input-group uncoded-tool-tip" data-toggle="tooltip" data-placement="right" title="Expands search results to include problems which do not have SNOMED codes and/or have ICD 9 code of 799.9"><label for="uncoded"></label><input type="checkbox" id="uncoded" value="1" {{uncoded}}> Extend Search</div><div id="problemsNoResults" aria-hidden="true"><span><i>No results</i></span></div><div id="problemSearchLoadingIndicator" aria-hidden="true"><span><h5><i class="fa fa-spinner fa-spin"></i> Loading...</h5></span></div><div id="'+i+'-typeahead-list"><ul role="menu" class="list-group"></ul></div><div id="'+i+'-error"></div>'),childViewContainer:"ul",childView:c,events:function(){var e={};return e["keyup #"+i]="searchItems",e["click #uncoded"]="handleCodeCheck",e["keydown #uncoded"]="handleCheckboxKeyPress",e["keyup ul"]="searchItems",e["click li"]="setModel",e["blur #"+i]="clearModelIfEmpty",e["keydown li"]="handleItemKeyPress",e},searchItems:function(e){38===e.keyCode||40===e.keyCode?this.handleArrowSelection(e):9!==e.keyCode&&(this.selectedModel=void 0,this.performActionWhileTyping(e,"keyup",2,500,this.handleTextEntered,this))},handleItemKeyPress:function(t){t.preventDefault(),t.stopPropagation(),13===t.keyCode||32===t.keyCode?this.setModel(t):9===t.keyCode&&(t.shiftKey?e("#uncoded").focus():e("#cancelBtn").focus())},setModel:function(t){var o=t.target.id,l=this.collection.get(o);this.selectedModel=l,e("#problem").attr("data-uid",this.model.get("uid")),this.trigger("selected_typeahead:"+i);var n=e(document).find("a, button, :input, [tabindex]"),a=e("#"+i),s=e(n).index(a);s===n.length-1?n[0].focus():n[s+1].focus()},initialize:function(e){this.resultLimit=50,this.currentRequestCount=0,this.masterCollection=new Backbone.Collection,this.codedCollection=new Backbone.Collection,this.collection=new Backbone.Collection;var t=function(e){return e.get("problem").toLowerCase()};this.masterCollection.comparator=t,this.codedCollection.comparator=t,this.model=new Backbone.Model({uncoded:"",searchTerm:""})},onRender:function(){var e=this;this.$el.find("#problemSearchLoadingIndicator").hide(),this.$el.find("#problemsNoResults").hide(),this.$el.find("#problem-typeahead-list").on("scroll",e,e.handleScroll)},handleScroll:function(t){var o=e("#problem-typeahead-list"),i=t.data.model.get("uncoded");if(o[0].scrollHeight-o.scrollTop()-25<o.height()){var l;if(l=i?t.data.resultLimit+50<=t.data.masterCollection.length?t.data.resultLimit+50:t.data.masterCollection.length-1:t.data.resultLimit+50<=t.data.codedCollection.length?t.data.resultLimit+50:t.data.codedCollection.length-1,t.data.resultLimit<l)for(var n=t.data.resultLimit+1;l>=n;n++)i?t.data.collection.push(t.data.masterCollection.at(n)):t.data.collection.push(t.data.codedCollection.at(n));t.data.resultLimit=l}},handleTextEntered:function(t){var o=e("#"+i).val()||"";t.search(o)},performActionWhileTyping:function(o,i,l,n,a,s){if(o.type===i){var d=o.target?o.target:o.srcElement;e(d).val().length<=l&&"undefined"!=typeof timeoutHandle?(clearTimeout(timeoutHandle),this.collection.set([])):e(d).val().length>l&&("undefined"==typeof timeoutHandle?timeoutHandle=t.delay(a,n,s):(clearTimeout(timeoutHandle),timeoutHandle=t.delay(a,n,s)))}},handleCodeCheck:function(t){this.model.set("uncoded",e("#uncoded").is(":checked")?"checked":""),this.setInitialVisibleCollection(this.model.get("uncoded"))},handleCheckboxKeyPress:function(t){if(!t.shiftKey&&9===t.keyCode)if(t.preventDefault(),t.stopPropagation(),0===this.collection.length)e("#cancelBtn").focus();else{e("#problem-typeahead-list li.focused").removeClass("focused");var o=e("#problem-typeahead-list li").first();o.focus(),o.addClass("focused")}},search:function(o){this.collection.set([]),this.codedCollection.set([]),this.masterCollection.set([]),e("#problemSearchLoadingIndicator").show(),e("#problemSearchLoadingIndicator").focus(),e("#uncoded").attr("disabled",!0),this.model.set("searchTerm",o),e("#searchProblemModal #error-container").text(""),e("#problemsNoResults").hide();var i=this;n.onError=function(t,o){e("#searchProblemModal #error-container").text("Search Failed"),i.currentRequestCount--,e("#problemSearchLoadingIndicator").hide()},n.onSuccess=function(e,o){i.codedCollection.set([]),i.currentRequestCount--,t.each(e.models,function(e){e.get("problem")&&i.codedCollection.push(e)}),i.codedCollection.sort(),0===i.currentRequestCount&&(i.model.get("uncoded")?i.setInitialVisibleCollection(!0):i.setInitialVisibleCollection(!1))},n.criteria[s]=o,e.when(ADK.ResourceService.fetchCollection(e.extend(!0,{},n,{criteria:{uncoded:1}}),this.masterCollection)).done(function(){i.currentRequestCount++;var t=/^[a-zA-Z\s]+$/;if(t.test(o)){var l=new Backbone.Collection;l.on("add",function(e){!e.get("No data")&&e.get("problem")&&i.masterCollection.push(e)},this),n.onSuccess=function(){i.masterCollection.sort(),i.currentRequestCount--,0===i.currentRequestCount&&(i.model.get("uncoded")?i.setInitialVisibleCollection(!0):i.setInitialVisibleCollection(!1))},n.onError=function(){i.currentRequestCount--,e("#problemSearchLoadingIndicator").hide()},i.currentRequestCount++,ADK.ResourceService.fetchCollection(n,l)}else i.masterCollection.sort()}).fail(function(){})},setInitialVisibleCollection:function(t){if(this.collection.set([]),e("#problemSearchLoadingIndicator").hide(),t){this.resultLimit=this.masterCollection.length>=50?50:this.masterCollection.length-1;for(var o=0;o<=this.resultLimit;o++){var i=this.masterCollection.at(o);i.get("problem")&&"Invalid"!==i.get("problem")&&this.collection.push(i)}}else{this.resultLimit=this.codedCollection.length>=50?50:this.codedCollection.length-1;for(var l=0;l<=this.resultLimit;l++){var n=this.codedCollection.at(l);n.get("problem")&&"Invalid"!==n.get("problem")&&this.collection.push(n)}}0===this.collection.length&&this.model.get("searchTerm")&&(e("#problemsNoResults").show(),e("#problemsNoResults").focus()),e("#uncoded").attr("disabled",!1)},clearModelIfEmpty:function(){var t=e("#"+i).val();t||(this.model.set("searchTerm",""),e("#problemsNoResults").hide())},handleArrowSelection:function(t){t.preventDefault(),t.stopPropagation();var o=e(this.el).find("li.focused");if(o[0]){o.removeClass("focused");var i;i=40===t.keyCode?o.next():e(this.el).find("li:first-child")[0].id===o[0].id?e(this.el).find("li:last-child"):o.prev(),i.addClass("focused"),i.focus()}else{t.preventDefault();var l=e(this.el).find("li:first-child");l.addClass("focused"),l.focus()}}});return r}};return i});