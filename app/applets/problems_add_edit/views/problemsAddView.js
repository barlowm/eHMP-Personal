define(["backbone","marionette","jquery","moment","handlebars","app/applets/problems_add_edit/utils/parseUtils"],function(e,t,o,a,n,r){var i={createForm:function(){var t={control:"typeahead",name:"problemTerm",label:"Select a Problem",placeholder:"Search for available Problems",required:!0,matcher:function(e,t){return function(t,o){var a=[];e.each(function(e){a.push(e.toJSON())});var n=_.sortBy(a,"label");o(n)}}},i={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-8"],items:[{control:"container",template:n.compile("<h4>{{problemLabel}}</h4>"),modelListeners:["problemLabel"]}]},{control:"container",extraClasses:["col-md-4"],items:[{control:"button",extraClasses:["btn-icon","btn-icon-mini"],type:"button",id:"change-problem-btn",label:"Change problem..."}]},{control:"spacer"}]},l={control:"container",extraClasses:["col-md-12"],items:[{control:"container",tagName:"p",template:"* indicates as a required field."}]},s={control:"container",extraClasses:["col-md-12"],items:[{control:"radio",required:!0,name:"statusRadioValue",label:"Status",options:[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"}]}]},c={control:"container",extraClasses:["col-md-12"],items:[{control:"radio",required:!0,name:"immediacyRadioValue",label:"Immediacy",options:[{label:"Acute",value:"acute"},{label:"Chronic",value:"chronic"},{label:"Unknown",value:"unknown"}]}]},m={control:"container",extraClasses:["col-md-6"],items:[{control:"datepicker",name:"onset-date",label:"Onset Date",options:{startDate:new a(ADK.PatientRecordService.getCurrentPatient().get("birthDate"),"YYYYMMDD").format("MM/DD/YYYY"),endDate:"0d"}}]},d=function(){var e=ADK.PatientRecordService.getCurrentPatient();return e.get("inPatient")?"Service":"Clinic"},u={control:"container",extraClasses:["col-md-6"],items:[{control:"typeahead",name:"clinic",label:d(),matcher:function(e,t){return function(t,o){var a=[];if(t.length>=3){var n=new RegExp(t,"i");e.each(function(e){n.test(e.get("label"))&&a.push(e.toJSON())})}var r=_.sortBy(a,"label");o(r)}}}]},b={control:"container",extraClasses:["col-md-12"],items:[{control:"typeahead",name:"resProvider",label:"Resp Provider *",matcher:function(e,t){return function(t,o){var a=[];if(t.length>=3){var n=new RegExp(t,"i");e.each(function(e){n.test(e.get("label"))&&a.push(e.toJSON())})}var r=_.sortBy(a,"label");o(r)}}}]},p=function(){var e=ADK.PatientRecordService.getCurrentPatient(),t=e.get("exposure"),o={"ionizing-radiation":{label:"Radiation"},"agent-orange":{label:"Agent Orange"},"sw-asia":{label:"Southwest Asia Conditions"},"head-neck-cancer":{label:"Head and/or Neck Cancer"},mst:{label:"MST"},"combat-vet":{label:"Service Connected"},shipboard:{label:"Shipboard Hazard and Defense"}},a=[];if(t)for(var n=0;n<t.length;n++){var r=t[n].name,i=t[n].uid.match(/^urn:va:(.*):/)[1];"NO"!==r.toUpperCase()&&a.push({name:i,label:o[i].label,value:!1})}return a},v=({control:"container",extraClasses:["col-md-12"],items:[{control:"container",tagName:"h6",template:"Treatment Factors"},{control:"container",extraClasses:["well"],items:[{control:"container",items:[{name:"testYN",control:"yesNoChecklist",collection:p(),attributeMapping:{unique:"name",value:"value",label:"label"}}]}]}]},{control:"container",extraClasses:["col-md-12"],items:[{control:"container",tagName:"h6",template:"Annotate"},{control:"nestedCommentBox",name:"diagnosis",label:"Selected Diagnosis",commentHeaderTitle:"Comments",itemHeaderTitle:"Diagnosis",additionalColumns:[{title:"Add to CL",name:"addToCL",control:"checkbox"},{title:"Primary",name:"primary",control:"button",extraClasses:["btn-link"],type:"button",label:"Primary"}],collection:new e.Collection([{id:"diagnosisGroup1",label:"Diagnosis Group 1",listItems:new e.Collection([{id:"group1-diagnosis1",label:"group1 Diagnosis 1",selectedValue:!0,addToCL:!0,comments:new e.Collection([]),primary:!0},{id:"group1-diagnosis2",label:"group1 Diagnosis 2",selectedValue:!0,addToCL:!1,comments:new e.Collection([{commentString:"This might be a non-causative symptom",author:{name:"USER,PANORAMA",duz:{"9E7A":"10000000255"}},timeStamp:"12/12/2014 11:12PM"}]),primary:!1}])}]),attributeMapping:{collection:"listItems",commentsCollection:"comments",comment:"commentString",value:"selectedValue",label:"label",unique:"id",author:"author",timeStamp:"timeStamp"}}]}),f={control:"container",extraClasses:["row"],items:[l,s,c,m,u,b,v]},h=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[t]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-3"]},{control:"container",extraClasses:["col-md-9"],items:[{control:"button",id:"delete-btn",extraClasses:["btn-icon"],type:"button",icon:"fa-trash-o fa-lg",label:""},{control:"button",id:"nextBtn",extraClasses:["btn-primary","btn-sm"],label:"Next",name:"nextBtn",disabled:!0}]}]}]}],g=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[i,f]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-3"],items:[{control:"container",tagName:"p",template:'<span id="id="problems-administered-saved-at">Saved {{savedDay}} at {{savedTime}}<span>'}]},{control:"container",extraClasses:["col-md-9"],items:[{control:"button",id:"delete-btn",extraClasses:["btn-icon"],type:"button",icon:"fa-trash-o fa-lg",label:""},{control:"button",id:"close-btn",extraClasses:["btn-primary","btn-sm"],label:"Close",type:"button",name:"close-btn"},{control:"button",id:"back-btn",extraClasses:["btn-primary","btn-sm"],label:"Back",type:"button",name:"back"},{control:"button",id:"add-btn",extraClasses:["btn-primary","btn-sm"],label:"Add",name:"add"}]}]}]}],C=e.Model.extend({defaults:{statusRadioValue:"active",immediacyRadioValue:"unknown",savedTime:"00:00",problemLabel:""}}),w=e.Marionette.ItemView.extend({template:n.compile("You will lose all work in progress if you delete this task. Would you like to proceed?"),tagName:"p"}),y=e.Marionette.ItemView.extend({template:n.compile("You will lose all work in progress if you close this task. Would you like to proceed?"),tagName:"p"}),x=e.Marionette.ItemView.extend({template:n.compile('{{ui-button "Cancel" classes="btn-default" title="Click button to cancel your action!"}}{{ui-button "Continue" classes="btn-primary" title="Click button to continue your action!"}}'),events:{"click .btn-primary":function(){ADK.UI.Alert.hide(),ADK.UI.Workflow.hide()},"click .btn-default":function(){ADK.UI.Alert.hide()}},tagName:"span"}),k=ADK.UI.Form.extend({ui:{problemTerm:"#problemTerm",nextBtn:".nextBtn"},fields:h,events:{"click #delete-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to delete?",icon:"fa-exclamation-triangle",messageView:w,footerView:x}),o=new ADK.UI.Alert(t);o.show()},submit:function(e){e.preventDefault();var t=this;this.model.unset("formStatus");var o=D.getFormView(1),a=ADK.UserService.getUserSession(),n=a.get("site"),i=ADK.PatientRecordService.getCurrentPatient(),l=i.get("visit");if(!o.clinic){l.locationName&&(o.clinic=l.locationName,t.model.set("clinic",o.clinic));var s={resourceTitle:"locations-clinics",criteria:{"site.code":n},onSuccess:function(e,t){o.clinic=r.getClinic(t),o.callControlFunction({controlType:"typeahead",controlName:"clinic",functionName:"setPickList",options:{pickList:o.clinic}})}};ADK.PatientRecordService.fetchCollection(s)}if(!o.resProvider){l.selectedProvider&&(o.resProvider=l.selectedProvider.name,t.model.set("resProvider",o.resProvider,{silent:!0}));var c={resourceTitle:"visits-providers",criteria:{"facility.code":n},onSuccess:function(e,t){o.resProvider=r.getResProvider(t),o.callControlFunction({controlType:"typeahead",controlName:"resProvider",functionName:"setPickList",options:{pickList:o.resProvider}})}};ADK.PatientRecordService.fetchCollection(c)}this.workflow.goToNext()},"typeahead:selected #problemTerm":function(){this.model.set("matchedTerm",!0),this.$(this.ui.nextBtn).find("button").attr("disabled",!1).removeClass("disabled"),this.model.set("problemLabel",this.$(this.ui.problemTerm).val())},"input #problemTerm":function(e){if(this.model.get("matchedTerm")&&(this.model.set("matchedTerm",!1),this.$(this.ui.nextBtn).find("button").attr("disabled",!0).addClass("disabled")),e.currentTarget.value.length>=3){var t=ADK.UserService.getUserSession().get("site");o.ajax({method:"GET",url:"/resource/write-pick-list",data:{type:"problems-lex",view:"PLS",site:t,searchString:e.currentTarget.value},success:function(t,a,n){var i=D.getFormView(0);i.pickList=r.getProblemTermPickList(t),i.callControlFunction({controlType:"typeahead",controlName:"problemTerm",functionName:"setPickList",options:{pickList:i.pickList}}),o("#problemTerm").typeahead("val",e.currentTarget.value);var l=o.Event("keydown");return l.keyCode=l.which=40,o("#problemTerm").trigger(l).focus(),!0},error:function(e,t,o){console.info("Refresh Session Error")},async:!0})}}}}),P=ADK.UI.Form.extend({ui:{clinic:".clinic",resProvider:".resProvider"},fields:g,events:{submit:function(e){if(e.preventDefault(),this.model.isValid()){this.model.unset("formStatus");var t=new ADK.UI.Alert({title:"Problem Submitted",notificationAlert:!0,icon:"fa-check",message:"Problem successfully submitted with no errors.",type:"sucess"});t.show(),ADK.UI.Workflow.hide()}else this.model.set("formStatus",{status:"error",message:self.model.validationError})},"click #delete-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to delete?",icon:"fa-exclamation-triangle",messageView:w,footerView:x});t.show()},"click #close-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to close this form?",icon:"fa-exclamation-triangle",messageView:y,footerView:x});t.show()},"click #back-btn":function(e){return e.preventDefault(),this.model.isValid()?(this.model.unset("formStatus"),this.workflow.goToPrevious()):this.model.set("formStatus",{status:"error",message:self.model.validationError}),!1},"click #change-problem-btn":function(e){return e.preventDefault(),this.model.isValid()?(this.model.unset("formStatus"),this.workflow.goToPrevious()):this.model.set("formStatus",{status:"error",message:self.model.validationError}),!1}}}),S=new C,A={size:"large",title:"Enter Problem",showProgress:!0,keyboard:!0,steps:[{view:k,viewModel:S,stepTitle:"Select a Problem"},{view:P,viewModel:S,stepTitle:"Enter Problem Info"}]},D=new ADK.UI.Workflow(A);D.show()},handleShowView:function(){var e=ADK.Messaging.getChannel("visit"),t=ADK.PatientRecordService.getCurrentPatient();e.on("set-visit-success:problems_add_edit",i.createForm),t.get("visit")?i.createForm():e.command("openVisitSelector","problems_add_edit")}};return i});