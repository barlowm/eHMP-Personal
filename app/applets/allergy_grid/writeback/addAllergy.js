define(["backbone","marionette","jquery","handlebars","app/applets/allergy_grid/writeback/validationUtils","app/applets/allergy_grid/writeback/writebackUtils"],function(e,t,i,o,s,a){var r=[{group:"Group 1",pickList:[{value:"opt1",label:"Option 1"},{value:"opt2",label:"Option 2"}]},{group:"Group 2",pickList:[{value:"opt3",label:"Option 3"},{value:"opt4",label:"Option 4"},{value:"opt5",label:"Option 5"},{value:"opt6",label:"Option 6"}]},{group:"Group 3",pickList:[{value:"opt7",label:"Option 7"},{value:"opt8",label:"Option 8"},{value:"opt9",label:"Option 9"}]}],n={control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["container-fluid"],template:o.compile("<h5>Select an Allergy</h5>")},{control:"container",extraClasses:"",items:[{control:"container",extraClasses:["col-md-9"],items:[{control:"select",name:"allergen",label:"",options:{minimumInputLength:0},pickList:r,required:!1,showFilter:!0,groupEnabled:!0}]}]}]},l={control:"container",extraClasses:["row"],items:[{control:"container",items:[{control:"container",extraClasses:["col-md-3","col-xs-3"],items:[{control:"radio",name:"allergyType",options:[{value:"o",label:"Observed"},{value:"h",label:"Historical"}],label:"",required:!0,extraClasses:["top-padding-md","pull-left"]}]},{control:"container",extraClasses:["col-md-2","col-xs-2","left-padding-no"],items:[{control:"datepicker",name:"reaction-date",label:"Reaction Date",required:!0,disabled:!0,options:{endDate:"0d"}}]},{control:"container",extraClasses:["col-md-2","col-xs-2"],items:[{control:"timepicker",name:"reaction-time",label:"Time",placeholder:"HH:MM",disabled:!0,options:{defaultTime:!1}}]},{control:"container",extraClasses:["col-md-2","col-xs-2","pixel-height-22"],items:[{control:"select",name:"severity",label:"Severity",required:!1,disabled:!0,pickList:[]}]},{control:"container",extraClasses:["col-md-2","col-xs-2","right-padding-no"],items:[{control:"select",name:"nature-of-reaction",label:"Nature of Reaction",required:!1,disabled:!1,pickList:[]}]},{control:"spacer"}]}]},c={control:"container",extraClasses:["row","section-divider"],items:[{control:"container",extraClasses:["col-md-12","left-padding-md","right-padding-md"],items:[{name:"signsSymptoms",label:"Signs / Symptoms (Required if Observed)",control:"multiselectSideBySide",extraClasses:["top-margin-xs"],attributeMapping:{unique:"id",value:"booleanValue",label:"description"},selectedItems:[{headerName:"Date",control:"datepicker",name:"symptom-date",label:"Date",srOnlyLabel:!0,options:{endDate:"0d"}},{headerName:"Time",control:"timepicker",name:"symptom-time",label:"Time",placeholder:"HH:MM",srOnlyLabel:!0,options:{defaultTime:!1}}]}]},{control:"container",extraClasses:["col-md-12"],items:[{control:"textarea",rows:4,name:"moreInfo",label:"Comments",title:"Please enter in comments",maxlength:255}]}]},m=({control:"container",items:[{control:"container",extraClasses:["col-xs-12"],template:o.compile("<h6>Signs/Symptoms (Required if Observed)</h6>"),items:[{control:"container",template:o.compile("<h4>Multi-Select Side By Side with date and time picker</h4>")}]},{control:"textarea",name:"comments",label:"Comments",rows:3}]},[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["container-fluid"],items:[n,l,c]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-xs-6"],template:o.compile('<p aria-hidden="true">(* indicates a required field.)</p>{{#if savedTime}}<p><span id="allergies-saved-at">Saved at: {{savedTime}}</span></p>{{/if}}')},{control:"container",extraClasses:["col-xs-6"],items:[{control:"button",id:"form-cancel-btn",extraClasses:["btn-primary","btn-sm","left-margin-xs"],label:"Cancel",type:"button",title:"Press enter to cancel",name:"cancelBtn"},{control:"button",id:"form-close-btn",extraClasses:["btn-primary","btn-sm","left-margin-xs"],label:"Close",type:"button",title:"Press enter to close",name:"closeBtn"},{control:"button",extraClasses:["btn-primary","btn-sm","left-margin-xs"],label:"Add",name:"addBtn",title:"Press enter to add",disabled:!0}]}]}]}]),d=e.Model.extend({defaults:{allergen:"opt1",signsSymptoms:[],severity:"","nature-of-reaction":"",moreInfo:"",errorModel:new e.Model},validate:function(e,t){return s.validateModel(this)}}),u=e.Marionette.ItemView.extend({template:o.compile("You will lose all work in progress if you cancel this task. Would you like to proceed?"),tagName:"p"}),p=e.Marionette.ItemView.extend({template:o.compile("Your progress will be saved and remain in draft status. Would you like to proceed with closing this observation?"),tagName:"p"}),g=e.Marionette.ItemView.extend({template:o.compile('{{ui-button "Cancel" classes="btn-default btn-sm" title="Click button to cancel your action!"}}{{ui-button "Continue" classes="btn-primary btn-sm" title="Click button to continue your action!"}}'),events:{"click .btn-primary":function(){ADK.UI.Alert.hide(),ADK.UI.Workflow.hide()},"click .btn-default":function(){ADK.UI.Alert.hide()}},tagName:"span"}),h=e.Marionette.ItemView.extend({template:o.compile("We're sorry. "+this.msg),msg:"There was an error submitting your form.",tagName:"p"}),b=e.Marionette.ItemView.extend({template:o.compile('{{ui-button "Ok" classes="btn-primary" title="Click button to close modal"}}'),events:{"click .btn-primary":function(){ADK.UI.Alert.hide()}},tagName:"span"}),f=ADK.UI.Form.extend({initialize:function(){this._super=ADK.UI.Form.prototype,this.model=new d,this._super.initialize.apply(this,arguments)},ui:{inProgressContainer:".inProgressContainer",dateTimeSeverity:".reaction-date, .reaction-time, .severity, .signsSymptoms",dateTimeRequired:".reaction-date, .severity",initialDisabledFields:".reaction-date, .reaction-time, .signsSymptoms, .moreInfo, .allergyType",allergyType:".allergyType",severity:".severity",natureOfReaction:".nature-of-reaction",signsSymptoms:".signsSymptoms",addBtn:".addBtn"},fields:m,onRender:function(){if(this.model.get("renderedFirstTime"))this.setPickLists(),this.setDisabledFields();else{var t=this,i=ADK.UserService.getUserSession().get("site"),o="/resource/write-pick-list?type=allergies-symptoms-all-with-top-ten&site="+i,s=e.Model.extend({url:o}),r={error:function(e,t){var i=new ADK.UI.Alert({title:"Failed to load picklist data.",icon:"fa-exclamation-triangle",messageView:h.extend({msg:"There was an error loading the form."}),footerView:b});i.show()},success:function(e,i){t.natureOfReactionList=a.parseOperationalDataList(i,"Nature of Reaction"),t.severityList=a.parseOperationalDataList(i,"Severity");var o=a.parseSymptomList(i);t.model.set("signsSymptoms",o),t.render()}},n=new s;n.fetch(r),this.model.set("renderedFirstTime","true")}},events:{"click #form-cancel-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to cancel?",icon:"fa-warning",messageView:u,footerView:g});t.show()},"click #form-close-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to close this form?",icon:"fa-exclamation-triangle",messageView:p,footerView:g});t.show()},submit:function(e){if(e.preventDefault(),this.model.isValid()){this.model.unset("formStatus");var t=new ADK.UI.Notification({title:"Allergy Submitted",icon:"fa-check",message:"Allergy successfully submitted with no errors.",type:"success"});t.show(),ADK.UI.Workflow.hide()}else this.model.set("formStatus",{status:"error",message:this.model.validationError})}},setPickLists:function(){this.callControlFunction({controlType:"select",controlName:"nature-of-reaction",functionName:"setPickList",options:{pickList:this.natureOfReactionList}}),this.callControlFunction({controlType:"select",controlName:"severity",functionName:"setPickList",options:{pickList:this.severityList}})},setDisabledFields:function(){this.model.get("allergen")?this.$(this.ui.dateTimeSeverity.selector).trigger("control:disabled",!0):this.$(this.ui.initialDisabledFields.selector).trigger("control:disabled",!0)},showInProgress:function(e){this.model.set("inProgressMessage",e),this.$(".inProgressContainer").removeClass("hidden")},hideInProgress:function(){this.$(".inProgressContainer").addClass("hidden"),this.model.unset("inProgressMessage")},modelEvents:{"change:allergyType":function(e){var t=e.get("allergyType");this.$(this.ui.natureOfReaction.selector).trigger("control:disabled",!1),this.$(this.ui.natureOfReaction.selector).trigger("control:required",!0),"o"===t?(this.$(this.ui.dateTimeSeverity.selector).trigger("control:disabled",!1),this.$(this.ui.dateTimeRequired.selector).trigger("control:required",!0),this.model.set("reaction-date",moment().format("MM/DD/YYYY"))):(this.$(this.ui.dateTimeSeverity.selector).trigger("control:disabled",!0),this.$(this.ui.dateTimeRequired.selector).trigger("control:required",!1),this.model.unset("reaction-date"),this.model.unset("reaction-time"))},"change:allergen":function(e){var t=e.get("allergen");t&&(this.$(this.ui.addBtn.selector).find("button").attr("disabled",!1),this.showInProgress("Loading..."),this.model.unset("reaction-date"),this.model.unset("reaction-time"))}}});return f});