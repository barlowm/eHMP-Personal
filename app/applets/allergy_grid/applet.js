define(["app/applets/allergyEiE/applet","hbs!app/applets/allergy_grid/details/detailsFooterTemplate","hbs!app/applets/allergy_grid/list/expirationCellTemplate","app/applets/allergy_grid/modal/modalView","app/applets/allergy_grid/util","hbs!app/applets/allergy_grid/list/severityTemplate","hbs!app/applets/allergy_grid/list/summaryItemViewTemplate","hbs!app/applets/allergy_grid/list/summaryViewTemplate","hbs!app/applets/allergy_grid/list/siteTemplate","hbs!app/applets/allergy_grid/list/commentTemplate","app/applets/allergy_grid/modal/modalHeaderView","app/applets/allergy_grid/writeback/addAllergy","app/applets/visit/writeback/addselectVisit"],function(e,t,i,a,l,r,n,o,s,c,p,d,g){"use strict";function m(e){e.preventDefault();var t=ADK.utils.appletUtils.getAppletView("allergy_grid","writeback"),i=new Backbone.Model,a=new Backbone.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),l={size:"large",title:"Allergies",showProgress:!1,keyboard:!0,steps:[]},r=ADK.PatientRecordService.getCurrentPatient().get("visit");r||l.steps.push({view:g,viewModel:a,title:"Step 1"}),l.steps.push({view:t,viewModel:i,stepTitle:"Step 2"});var n=new ADK.UI.Workflow(l);n.show()}var u=[{name:"summary",label:"Allergen Name",cell:"string",hoverTip:"allergies_allergenName"},{name:"reaction",label:"Reaction",cell:"string",hoverTip:"allergies_reaction"},{name:"acuityName",label:"Severity",cell:"handlebars",template:r,hoverTip:"allergies_severity"}],v=u.concat([{name:"drugClassesNames",label:"Drug Class",cell:"string",hoverTip:"allergies_drugClass"},{name:"originatorName",label:"Entered By",cell:"string",hoverTip:"allergies_enteredBy"},{name:"facilityName",label:"Facility",cell:"string",hoverTip:"allergies_facility"},{name:"",cell:"handlebars",template:c}]);v.splice(1,0,{name:"standardizedName",label:"Standardized Allergen",cell:"string",hoverTip:"allergies_standardizedAllergen"});var y,h,f,w={parse:function(e){return e.products&&(e=ADK.utils.extract(e,e.products[0],{name:"name"})),e.observations&&(e=ADK.utils.extract(e,e.observations[0],{acuityName:"severity",observed:"date"}),e=l.getAcuityName(e),8==e.observed.length?e.observedDate=ADK.utils.formatDate(e.observed,"MM/DD/YYYY"):e.observedDate=ADK.utils.formatDate(e.observed,"MM/DD/YYYY - HH:mm")),e=l.getDrugClasses(e),e.entered&&(e.originatedFormatted=ADK.utils.formatDate(e.entered,"MM/DD/YYYY - HH:mm")),e=l.getReactions(e),e=l.getFacilityColor(e),e=l.getStandardizedName(e),e=l.getSeverityCss(e),e=l.getCommentBubble(e)}},b={resourceTitle:"patient-record-allergy",viewModel:w,criteria:{filter:"ne(removed, true)"},cache:!1,pageable:!1},D={fetchOptions:{resourceTitle:"patient-record-allergy",viewModel:w,criteria:{filter:"ne(removed, true)"},cache:!1,pageable:!1}},A=[{id:"name",field:"summary"},{id:"severity",field:"severityCss"}],C=function(e,i){var r;r=f?f:ADK.PatientRecordService.fetchCollection(b);var n=new a({model:e,collection:r}),o=[{title:l.getModalTitle(e)}],s=ADK.UserService.getUserSession().get("site"),c=e.get("pid")?e.get("pid").split(";")[0]:"";o[1]={title:l.getModalTitle(e),headerView:p.extend({model:e,theView:n}),footerView:Backbone.Marionette.ItemView.extend({template:t,onRender:function(){},events:{"click #error":"enteredInError"},enteredInError:function(t){var i=ADK.Messaging.getChannel("allergyEiE");i.trigger("allergyEiE:clicked",t,e,h)},templateHelpers:function(){return ADK.UserService.hasPermission("remove-patient-allergy")&&c===s?{data:!0}:{data:!1}}}),callShow:!0};var d=new ADK.UI.Modal({view:n,options:o[1]});d.show()},V=Backbone.Marionette.ItemView.extend({tagName:"div",className:"summaryItem",attributes:function(){return{tabindex:"0"}},template:n,events:{"click span":function(e){C(this.model,e)}}}),K=(Backbone.Marionette.CompositeView.extend({initialize:function(e){this.collection=e.collection,this.maximizeScreen=e.appletConfig.maximizeScreen},template:o,childView:V,childViewContainer:".allergyBubbleView",events:{"click a.seeAll":function(e){e.preventDefault(),ADK.Navigation.navigate(this.maximizeScreen)}},onRender:function(){this.collection.length>0||this.$el.find(".allergyBubbleView").after('<div class="emptyTextAllergy">No Records Found</div>')}}),ADK.Applets.BaseGridApplet),S=K.extend({className:"app-size",initialize:function(e){y=K.prototype;var t={};t.enableModal=!0,t.filterEnabled=!1,t.tblRowSelector="#data-grid-allergy_grid tbody tr","summary"===this.columnsViewType?(t.columns=u,t.gistView=!1,t.appletConfiguration=D):(b.pageable=!0,t.columns=v,t.gistView=!1,t.appletConfiguration=D),t.collection=ADK.PatientRecordService.fetchCollection(b),f=t.collection,ADK.UserService.hasPermission("add-patient-allergy")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(t.onClickAdd=function(e){m(e)}),this.listenTo(t.collection,"sync",function(){t.collection.comparator=function(e,t){var i=e.get("acuityName")||"",a=t.get("acuityName")||"";if(0!==a.localeCompare(i))return a.localeCompare(i);var l=e.get("entered")||"",r=t.get("entered")||"";return r.localeCompare(l)},t.collection.sort()}),t.onClickRow=C,this.dataGridOptions=t,h=this,y.initialize.apply(this,arguments)},onRender:function(){y.onRender.apply(this,arguments)}}),T=ADK.Messaging.getChannel("allergy_grid");T.on("getDetailView",function(e){C(e.model)});var M=ADK.Messaging.getChannel("allergy_grid");M.reply("detailView",function(e){var i,r={criteria:{uid:e.uid},patient:new Backbone.Model({icn:e.patient.icn,pid:e.patient.pid}),resourceTitle:"patient-record-allergy",viewModel:w},n=$.Deferred(),o=ADK.PatientRecordService.fetchCollection(r);return o.on("sync",function(){i=o.first();var e=ADK.UserService.getUserSession().get("site"),r=i.get("pid")?i.get("pid").split(";")[0]:"";n.resolve({view:new a({model:i,collection:o}),title:l.getModalTitle(i),modalSize:"medium",footerView:Backbone.Marionette.ItemView.extend({template:t,onRender:function(){},events:{"click #error":"enteredInError"},enteredInError:function(e){var t=ADK.Messaging.getChannel("allergyEiE");t.trigger("allergyEiE:clicked",e,model,h)},templateHelpers:function(){return ADK.UserService.hasPermission("remove-patient-allergy")&&r===e?{data:!0}:{data:!1}}})})},this),n.promise()});var k={fetchOptions:{pageable:!1}},N=ADK.AppletViews.PillsGistView.extend({className:"app-size",initialize:function(e){var t=this;this._super=ADK.AppletViews.PillsGistView.prototype,_.extend(b,k.fetchOptions),this.appletOptions={gistModel:A,collection:ADK.PatientRecordService.fetchCollection(b)},ADK.UserService.hasPermission("add-patient-allergy")&&ADK.PatientRecordService.isPatientInPrimaryVista()&&(this.appletOptions.onClickAdd=function(e){m(e)}),this.listenTo(this.appletOptions.collection,"sync",function(){t.appletOptions.collection.comparator=function(e,t){var i=e.get("acuityName")||"",a=t.get("acuityName")||"";if(0!==a.localeCompare(i))return a.localeCompare(i);var l=e.get("entered")||"",r=t.get("entered")||"";return r.localeCompare(l)},t.appletOptions.collection.sort()}),this._super.initialize.apply(this,arguments)}}),x={id:"allergy_grid",viewTypes:[{type:"gist",view:N,chromeEnabled:!0},{type:"summary",view:S.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:S.extend({columnsViewType:"expanded"}),chromeEnabled:!0},{type:"writeback",view:d,chromeEnabled:!1}],defaultViewType:"summary"};return x});