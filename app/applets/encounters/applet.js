define(["handlebars","underscore","backbone","marionette","crossfilter","app/applets/encounters/GistView","app/applets/encounters/appConfig","app/applets/encounters/appUtil","app/applets/encounters/gistConfig","app/applets/encounters/writeback/encounterForm"],function(e,t,i,o,n,r,a,s,l,g){"use strict";function d(e,o){p&&console.log("EncGist ----->> preare collection (grouping)");var r=e.toJSON(),a="";r.length>0&&"undefined"!=typeof r[0].dateTime&&(a=t.sortBy(r,v.dateTimeSort).slice(0,1)[0].dateTime),p&&console.log("First Event for Patient  ------->>"+a);var l=new n(r);e.reset(),e.comparator="order";var g=null,d=null,c=l.dimension(function(e){return e.kind});p&&console.log("EncGist ----->> crossfilter.size = "+l.size()),p&&console.log("EncGist ----->> number of types = "+c.group().size());var u,f,D,C,S={},k={},y={},_={},A={},b=0,K={},T={},E=[],M=[],V=[],L=i.Collection.extend(),G=c.group().all();p&&console.log(JSON.stringify(G));for(var N=0;N<G.length;N++){if(V=[],S={kind:"",elKind:"",count:"",firstEvent:s.selectStartStopPoint(a).start,lastEvent:"",timeSinceLast:"",chartData:[],firstEventDisplay:"",lastEventDisplay:"",maxChart:s.selectStartStopPoint(a).stop,processed:!0,order:0},S.kind=G[N].key,S.elKind=s.clanUpItem(S.kind),S.count=G[N].value,k=c.filterExact(S.kind),window.tempChartData=[],V=t.sortBy(k.top(1/0),v.dateTimeSort).reverse(),S.timeSinceLast=ADK.utils.getTimeSince(V[0].dateTime).timeSince,h[S.kind.toLowerCase()]&&"future"===h[S.kind.toLowerCase()].sort_direction&&(S.timeSinceLast=ADK.utils.getTimeSince(s.getTimeSinceForFuture(V)).timeSince),k.top(1/0).forEach(v.prepareChartData),g=new n(window.tempChartData),d=g.dimension(v.dimentionByDateTime),p&&console.log("EncGist ----->> temp crossfilter.size = "+g.size()),y=d.group().order(v.orderValue).all(),S.lastEvent=V[0].dateTime,S.firstEventDisplay=s.displayDate(S.firstEvent),S.lastEventDisplay=s.displayDate(S.lastEvent),V.forEach(v.changeDateFormat),m[S.kind.toLowerCase()].specialChart)S.allData=V,t.isUndefined(m[S.kind.toLowerCase()].parser)||m[S.kind.toLowerCase()].parser(S);else for(b=0;b<y.length;b++)S.chartData.push([s.convertChartDate(y[b].key),y[b].value]);if(S.recent=V.slice(0,5),S.futureTime=!1,h[S.kind.toLowerCase()]&&"future"===h[S.kind.toLowerCase()].sort_direction){var F=s.getRecentForFuture(V);S.futureTime=F.bFutureTime}if(h[S.kind.toLowerCase()]&&(S.order=h[S.kind.toLowerCase()].order),p&&console.log(S.kind.toLowerCase()),_={},m[S.kind.toLowerCase()]){window.dimentionProp=m[S.kind.toLowerCase()].grouping[0].field,_=l.dimension(v.subGrouping),S[S.kind.toLowerCase()]=!0;var P=_.group().top(1/0);S.grouping={title:m[S.kind.toLowerCase()].grouping[0].title,group:t.filter(P,v.zeroFilter)};var O=[],U={};for(D=0;D<S.grouping.group.length;D++){M=[],window.filterVal=S.grouping.group[D].key,M=t.filter(_.top(1/0),v.filterSubItems),O=[],M.length>0&&(O=t.sortBy(M,v.dateTimeSort).reverse(),S.grouping.group[D].allData=O,S.grouping.group[D].recent=O.slice(0,5),t.isUndefined(m[S.kind.toLowerCase()].sort_direction)?S.grouping.group[D].time=ADK.utils.getTimeSince(O[0].dateTime).timeSince:"future"===m[S.kind.toLowerCase()].sort_direction?S.grouping.group[D].time=ADK.utils.getTimeSince(s.getTimeSinceForFuture(O)).timeSince:S.grouping.group[D].time=ADK.utils.getTimeSince(O[0].dateTime).timeSince,S.grouping.group[D].sort_time=O[0].dateTime),S.grouping.group[D].kind=S.kind,S.grouping.group[D].elKind=S.elKind,S.grouping.group[D].subKind=""!==S.grouping.group[D].key.trim()?S.grouping.group[D].key:"UNKNOWN",S.grouping.group[D].elSubKind=s.clanUpItem(S.grouping.group[D].subKind),S.grouping.group[D].count=S.grouping.group[D].value,S.grouping.group[D].processed=!0,S.grouping.group[D][S.kind.toLowerCase()]=!0,S.grouping.group[D].kind=h[S.kind.toLowerCase()].title,p&&console.log("EncGist---secondery level--->"+S.kind+"/"+S.grouping.group[D].key+"-"+S.grouping.group[D].value+"/array elements-"+M.length),S.grouping.group[D].value+0!==M.length&&p&&console.log("ERROR ------>>> Crossfilter grouping!!!"),window.tempChartData=[],M.forEach(v.prepareChartData),p&&console.log("EncGist---secondery level--->"+S.kind+"/"+S.grouping.group[D].key+"- events:"+window.tempChartData.length),U=new n(window.tempChartData);var B=[],I=0,x=0;if(S.grouping.group[D].firstEvent=s.selectStartStopPoint(a).start,S.grouping.group[D].maxChart=s.selectStartStopPoint(a).stop,S.grouping.group[D].elSubKind.length>50&&(S.grouping.group[D].elSubKind=S.grouping.group[D].elSubKind.substring(0,50)+"-"+Math.round(100*Math.random())),S.grouping.group[D].id="encounters-"+S.grouping.group[D].elKind+"-"+S.grouping.group[D].elSubKind,!m[S.kind.toLowerCase()].specialChart){S.grouping.group[D].chartData=U.dimension(v.dimentionByDateTime).group().order(v.orderValue).all();for(var Y=0;Y<S.grouping.group[D].chartData.length;Y++)x=S.grouping.group[D].chartData[Y].value,B.push([s.convertChartDate(S.grouping.group[D].chartData[Y].key),S.grouping.group[D].chartData[Y].value]),x>I&&(I=x)}S.grouping.group[D].graphData={series:B,nowMaxCount:I,oldestDate:s.convertChartDate(S.grouping.group[D].firstEvent),newestDate:s.convertChartDate(S.grouping.group[D].maxChart)},K.allGroupedEncounters=[],t.isUndefined(m[S.kind.toLowerCase()].parser)||m[S.kind.toLowerCase()].parser(S.grouping.group[D]);var z=[];z=t.isUndefined(m[S.kind.toLowerCase()].sort_direction)?t.sortBy(S.grouping.group,v.timeSort).reverse():"future"===m[S.kind.toLowerCase()].sort_direction?t.sortBy(S.grouping.group,v.timeSort):t.sortBy(S.grouping.group,v.timeSort).reverse(),z=t.sortBy(S.grouping.group,v.timeSort).reverse(),S.node=new L({kind:S.grouping.group[D].kind,collection:new L(z)}),_.filterAll()}_.dispose()}A={};var q=[];if(w[S.kind.toLowerCase()]){for(A=c.filterExact(S.kind).top(1/0),S[S.kind.toLowerCase()]=!0,E=[],u=0;u<A.length;u++){for(K={},T={},f=0;f<w[S.kind.toLowerCase()].showing.length;f++)C=w[S.kind.toLowerCase()].showing[f],K[C.field]=A[u][C.field];K.kind=h[S.kind.toLowerCase()].title,K.recent_model=A[u],t.isUndefined(w[S.kind.toLowerCase()].parser)||w[S.kind.toLowerCase()].parser(K),K.elKind=s.clanUpItem(K.kind),K.id="encounters-"+K.elKind+"-"+Math.round(1e10*Math.random()),q=[],q.push([s.convertChartDate(K.dateTime),1]),K.graphData={series:q,nowMaxCount:0,oldestDate:s.convertChartDate(S.firstEventDisplay),newestDate:s.convertChartDate(S.maxChart)},E.push(K)}S.showingTitles=T,S.showing=t.sortBy(E,v.dateTimeSort).reverse(),S.node=new L({kind:h[S.kind.toLowerCase()].title,collection:new L(S.showing)})}h[S.kind.toLowerCase()]&&(S.kind=h[S.kind.toLowerCase()].title,S.elKind=s.clanUpItem(S.kind)),e.add(S),p&&console.log(S),k.filterAll()}s.addEmptyTiles(e,a),r=null,g=null,d=null,c=null,k=null,l=null,p&&console.log(e.toJSON()),ADK.Messaging.getChannel("encounters_internal").trigger("data_aggregated",e,o)}function c(e){var t=e.clone();ADK.Messaging.getChannel("encounters_internal").trigger("data_original",t),d(e),D&&ADK.Messaging.getChannel("encounters_internal").trigger("filter_collection",D)}function u(t){var o=ADK.PatientRecordService.getCurrentPatient();if(o.get("visit")&&""!==o.get("visit").locationUid){var n=ADK.utils.appletUtils.getAppletView("encounters","writeback"),r=i.Model.extend({defaults:{}}),a=new r({serviceConnected:"%",ratedDisabilities:"",selectedModifier:"",providerList:new i.Collection,availableVisitModifiers:new i.Collection,visitTypeSelection:"",prevVisitTypeSelection:"",visitCollection:new i.Collection,selectedModifiersForVisit:[],diagnosesSection:"",addOtherDiagnosisSearchString:"",DiagnosisCollection:new i.Collection,procedureSection:"",addOtherProcedureSearchString:"",ProcedureCollection:new i.Collection}),s={title:"Encounter Form",size:"large",showProgress:!1,keyboard:!0,steps:[{view:n,viewModel:a,stepTitle:"Step 1",showHeader:!1}]},l=new ADK.UI.Workflow(s);l.show()}else{var g=i.Marionette.ItemView.extend({template:e.compile('{{ui-button "Continue" classes="btn-primary alert-continue" title="Click to continue"}}'),events:{"click button":function(){ADK.UI.Alert.hide()}}}),d=new ADK.UI.Alert({title:"Missing Encounter Location",messageView:i.Marionette.ItemView.extend({template:e.compile("<p>You must set an encounter location before accessing the encounter form.</p>")}),footerView:g});d.show()}}var p=a.debug,m=a.groupBy,w=a.showBy,h=a.eventOrder;p&&console.log("EncGist initialization ----->>Start");var f;window.tempChartData=[],window.dimentionProp="",window.aggregationScale="",window.subGistViews={},window.filterVal="";var D,C={parse:function(e){return p&&console.log(e),e.eventDate=s.parseDate(s.getActivityDateTime(e),window.aggregationScale),e.showDate=s.displayDate(s.parseDate(s.getActivityDateTime(e))),e.encProvider=s.encounterProvider(e),s.isAppointment(e)&&(e.kind="Appointment",e.custom_filter_field=e.stopCodeName),s.isDoDAppointment(e)&&(s.isDoDAppointmentFuture(e)?e.kind="Appointment":e.kind="Visit",e.stopCodeName=e.stopCodeName||"UNKNOWN",e.custom_filter_field=e.stopCodeName),s.isDoDEncounter(e)&&(e.kind="Visit",e.stopCodeName=e.stopCodeName||"UNKNOWN",e.appointmentStatus=e.appointmentStatus||"Unknown",e.custom_filter_field=e.stopCodeName),s.isProcedure(e)&&(e.service=e.service||"Unknown",e.procName=e.name||e.consultProcedure||"Unknown",e.custom_filter_field=e.procName),s.isAdmission(e)&&(e.reasonName=s.admissionDiagnosis(e),e.custom_filter_field=e.reasonName),s.isVisit(e)&&(t.isUndefined(e.stopCodeName)&&(e.stopCodeName="UNKNOWN"),e.appointmentStatus=e.appointmentStatus||"Unknown",e.custom_filter_field=e.stopCodeName),p&&console.log(e),e}},v={dimentionByDateTime:function(e){return e.dateTime},prepareChartData:function(e,t){window.tempChartData.push({dateTime:e.eventDate})},orderValue:function(e){return e.key},zeroFilter:function(e){return e.value>0},subGrouping:function(e){return p&&(console.log("subGrouping---->> start"),console.log(window.dimentionProp),console.log(e[window.dimentionProp]),console.log(e),console.log("subGrouping---->> stop")),e[window.dimentionProp]||""},dateTimeSort:function(e){return e.dateTime},timeSort:function(e){return e.sort_time},showDateSort:function(e){return e.dateTime.value},filterSubItems:function(e){return e[window.dimentionProp]===window.filterVal},changeDateFormat:function(e,t){e.showDate=moment(e.showDate,"YYYY-MM-DD").format("MM/DD/YYYY")}},S={queryCollection:function(e){var t,i;e&&e.filterView&&(D=e.filterView.getFilterRegExp());var o=ADK.SessionStorage.getModel("globalDate");return"all-range-global"===o.get("selectedId")?(i=moment().add(6,"M").format("MM/DD/YYYY"),t=e.buildJdsDateFilter("dateTime",{isOverrideGlobalDate:!0,fromDate:o.get("fromDate"),toDate:i})):t=e.buildJdsDateFilter("dateTime"),this.enCollection=ADK.PatientRecordService.fetchCollection({resourceTitle:"patient-record-timeline",onSuccess:c,pageable:!1,filterEnabled:!0,viewModel:C,cache:!1,criteria:{filter:'or(eq(kind, "Visit"),eq(kind, "Admission"),eq(kind, "Procedure"),eq(kind, "DoD Appointment"),eq(kind, "Appointment"),eq(kind, "DoD Encounter")),and('+t+")",order:"dateTime DESC"}}),this.enCollection}},k=ADK.Applets.BaseGridApplet,y=k.extend({initialize:function(e){p&&console.log("EncGist initialization ----->>"),f=k.prototype;var t={};t.enableModal=!0,t.filterEnabled=!0,t.shadowCollection=new i.Collection;this.trgStart=!0,t.refresh=function(e){S.queryCollection(e)},ADK.Messaging.on("globalDate:selected",this.onGlobalDateSelected,this),ADK.Messaging.getChannel("encounters_internal").on("data_aggregated",this.onDataAggregated,this),ADK.Messaging.getChannel("encounters_internal").on("data_original",this.onDataOriginal,this),ADK.Messaging.getChannel("encounters_internal").on("filter_collection",this.onFilterCollection,this),ADK.Messaging.getChannel("encounters_internal").on("clear_filter",this.onClearFilter,this),p&&console.log(ADK.SessionStorage.getModel_SessionStoragePreference("globalDate").get("selectedId")),window.aggregationScale=s.setAggregationScale(ADK.SessionStorage.getModel_SessionStoragePreference("globalDate").get("selectedId")),this.dataGridOptions=t,this.dataGridOptions.collection=S.queryCollection(this),this.dataGridOptions.SummaryView=r,window.appletConfig=e.appletConfig,window.showInfoButton=!1,ADK.Messaging.getChannel("enc_detail_v_a").on("detailView",this.showVisitDetail,this),ADK.Messaging.getChannel("enc_detail_p").on("detailView",this.showDocumentDetail),f.initialize.apply(this,arguments)},onGlobalDateSelected:function(e){p&&console.log(JSON.stringify(e)),this.loading(),window.aggregationScale=s.setAggregationScale(e.get("selectedId")),S.queryCollection(this)},onDataAggregated:function(e,t){p&&console.log("EncGist data ----->> aggregated"),p&&console.log(e);var i=!t;this.dataGridOptions.collection.set(e.models,{silent:i}),this.dataGridView.isDestroyed&&(this.dataGridView=new this.dataGridOptions.SummaryView(this.dataGridOptions));var o={};o.preventDestroy=this.gridContainer.currentView==this.loadingView,this.gridContainer.show(this.dataGridView,o)},onDataOriginal:function(e){p&&console.log("EncGist data ----->> clone"),p&&console.log(e),this.dataGridOptions.shadowCollection.set(e.models)},onFilterCollection:function(e){if(p&&console.log("EncGist filter ----->> custom filter"),p&&console.log(e),this.trgStart)return void(this.trgStart=!1);var t=this.dataGridOptions.shadowCollection.filter(function(t){return e.test(t.get("custom_filter_field"))}),o=new i.Collection(t);d(o,!0)},onClearFilter:function(e){p&&console.log("EncGist filter ----->> clear_filter");var t=new i.Collection(this.dataGridOptions.shadowCollection.models);d(t,!0),e&&this.onFilterCollection(e)},showVisitDetail:function(e){p&&console.log("detailView --->>visitDetail"),t.isUndefined(e.model)||e.model.get("isCPTdomain")&&e.model.set("recent_model",s.getCPTprocedureDetailViewModel(this,e.uid)),s.showDetailView(e,"visitDetail")},showDocumentDetail:function(e){p&&console.log("detailView --->>documents"),s.showDetailView(e,"documents")},onBeforeDestroy:function(){ADK.Messaging.off("globalDate:selected",this.onGlobalDateSelected,this);var e=ADK.Messaging.getChannel("encounters_internal");e.off("data_aggregated",this.onDataAggregated,this),e.off("data_original",this.onDataOriginal,this),e.off("filter_collection",this.onFilterCollection,this),e.off("clear_filter",this.onClearFilter,this),ADK.Messaging.getChannel("enc_detail_v_a").off("detailView",this.showVisitDetail),ADK.Messaging.getChannel("enc_detail_p").off("detailView",this.showDocumentDetail),"function"==typeof f.onBeforeDestroy&&f.onBeforeDestroy.apply(this,this.arguments)}}),_=ADK.Messaging.getChannel("encounterFormRequestChannel");_.comply("openEncounterForm",u);var A={id:"encounters",viewTypes:[{type:"gist",view:y,chromeEnabled:!0},{type:"writeback",view:g,chromeEnabled:!1}],defaultViewType:"gist"};return A});