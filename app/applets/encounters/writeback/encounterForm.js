define(["backbone","marionette","jquery","underscore","handlebars","moment","app/applets/encounters/writeback/formFields","app/applets/encounters/writeback/modelUtil","hbs!app/applets/encounters/writeback/selectedDiagnosisBodyTemplate","hbs!app/applets/encounters/writeback/selectedProceduresTemplate"],function(e,t,i,r,o,s,d,n,a,c){var l=e.Marionette.ItemView.extend({template:o.compile("You will lose all work in progress if you delete this task. Would you like to proceed?"),tagName:"p"}),u=(e.Marionette.ItemView.extend({template:o.compile("You will lose all work in progress if you close this task. Would you like to proceed?"),tagName:"p"}),e.Marionette.ItemView.extend({template:o.compile('{{ui-button "Cancel" id="alert-cancel-btn" classes="btn-default" title="Click button to cancel your action!"}}{{ui-button "Continue" id="alert-continue-btn" classes="btn-primary" title="Click button to continue your action!"}}'),events:{"click #alert-continue-btn":function(){ADK.UI.Alert.hide(),ADK.UI.Workflow.hide()},"click #alert-cancel-btn":function(){ADK.UI.Alert.hide()}},tagName:"span"})),h=ADK.UI.Form.extend({ui:{ProviderCheckboxes:".providerList input",PrimaryDiagnosisCheckboxes:".nestedCommentBox-control .Primary-Diagnoses-region .checkbox-control.primary",ProcedureChecklist:".procChecklist input",VisitChecklistCheckboxes:".visit-checklist input",SearchAddOtherDiagnosis:".add-other-diagnosis-popover #add-other-diagnosis-search-btn",SelectAddOtherDiagnosis:".add-other-diagnosis-popover #addOtherDiagnosisSelect",CancelAddOtherDiagnosis:".add-other-diagnosis-popover #add-other-diagnosis-cancel-btn",AddOtherDiagnosisPopover:".add-other-diagnosis-popover #add-other-diagnosis-add-btn",SearchAddOtherProcedure:".add-other-procedure-popover #add-other-procedure-search-btn",SelectAddOtherProcedure:".add-other-procedure-popover #addOtherProcedureSelect",CancelAddOtherProcedure:".add-other-procedure-popover #add-other-procedure-cancel-btn",AddOtherProcedurePopover:".add-other-procedure-popover #add-other-procedure-add-btn",CloseAddVisitModifiers:".add-visit-modifiers-popover #add-visit-modifiers-close-btn",CloseAddProcedureModifiers:".add-procedure-modifiers-close-btn",ProviderList:".providerList li button i"},fields:d,PRIMARY_PROVIDER_CHECK:"-primaryProviderCheck",onRender:function(){n.retrieveProcedureItems(this),n.retrieveDiagnosisItems(this),n.retrieveProviders(this),n.retrieveRatedDisabilties(this),n.retrieveVisitRelated(this),n.retrieveVisitType(this),i(this.el).find("#available-Providers-modifiers-filter-results").attr("placeholder","Select Provider"),ADK.UserService.hasPermission("add-patient-encounter")||ADK.UserService.hasPermission("edit-patient-encounter")?i(this.el).find("#ok-btn.btn-save-encounter").trigger("control:disabled",!1):i(this.el).find("#ok-btn.btn-save-encounter").trigger("control:disabled",!0)},modelEvents:{"change:availableVisitModifiers":function(){this.model.set("selectedModifiersForVisit",[]),this.model.set("selectedModifiersForVisit",r.map(this.model.get("availableVisitModifiers").where({value:!0}),function(e){return e.get("label")}))},"change:availableProcedureModifiers":function(){this.model.set("selectedModifiersForProcedure",[]),this.model.set("selectedModifiersForProcedure",r.map(this.model.get("availableProcedureModifiers").where({value:!0}),function(e){return e.get("label")}))},"change:selectAddOtherDiagnosis":function(){""!==this.model.get("selectAddOtherDiagnosis")&&"None"!==this.model.get("selectAddOtherDiagnosis")?i("#add-other-diagnosis-add-btn").trigger("control:disabled",!1):i("#add-other-diagnosis-add-btn").trigger("control:disabled",!0)},"change:selectAddOtherProcedure":function(){""!==this.model.get("selectAddOtherProcedure")&&"None"!==this.model.get("selectAddOtherProcedure")?i("#add-other-procedure-add-btn").trigger("control:disabled",!1):i("#add-other-procedure-add-btn").trigger("control:disabled",!0)},"change:visitTypeSelection":function(){var e=this.model.get("selectedModifier");if(this.model.set("selectedModifier",""),""!==this.model.get("prevVisitTypeSelection")&&""!==e){this.model.get("availableVisitModifiers").originalModels=[],this.model.get("availableVisitModifiers").reset(),this.model.set("selectedModifiersForVisit",[]);var t=this.model.get("visitCollection").get(this.model.get("prevVisitTypeSelection")),i=t.attributes.items.get(e);i.set("value",!1),t.set("prev",i)}},"change:providerList":function(){for(var t=new e.Collection,r=this.model.get("providerList").where({value:!0}),o=0;o<r.length;o++)t.add({value:r[o].attributes.label,label:r[o].attributes.label});i(".ProcedureCollection .panel-container .panel-title .select-control").trigger("control:picklist:set",t)}},events:{"focus .drilldown-select-region":function(e){var t=i(e.currentTarget);t.keyup(function(e){39===e.keyCode&&i(e.currentTarget).next().find("input")[0].focus()})},"focus .drilldown-checklist-region":function(e){var t=i(e.currentTarget);t.keyup(function(e){37===e.keyCode&&i(e.currentTarget).prev().find("select").focus()})},"click .popover-control":function(e){e.preventDefault();var t=this.$(".control.popover-control");if(self=this,i.each(t,function(t,i){i!==e.currentTarget&&self.$(i).trigger("control:popover:hidden",!0)}),"block"===i(e.currentTarget).find(".popover").css("display")&&(i(e.currentTarget).hasClass("itemModifiers")||i(e.currentTarget).hasClass("add-other-procedure-popover"))&&i(e.currentTarget).hasClass("itemModifiers")){var r=i(e.currentTarget).parent().parent().parent().parent().parent().find(".ncb-descriptive-text-region span").html();i(e.currentTarget).find(".popover .popover-title").html(r)}},"click .add-other-diagnosis-popover .btn":function(e){var t=function(){i("#addOtherDiagnosisSearchString").blur(),i("#add-other-diagnosis-search-btn").trigger("click")};i("#addOtherDiagnosisSearchString").keyup(function(e){13===e.keyCode&&t()})},"click .add-other-procedure-popover .btn":function(e){var t=function(){i("#addOtherProcedureSearchString").blur(),i("#add-other-procedure-search-btn").trigger("click")};i("#addOtherProcedureSearchString").keyup(function(e){13===e.keyCode&&t()})},"click #ok-btn":function(e){if(e.preventDefault(),this.model.isValid()){this.model.unset("formStatus");var t=new ADK.UI.Notification({title:"Encounter Submitted",icon:"fa-check",message:"Encounter successfully submitted with no errors.",type:"success"});t.show(),ADK.UI.Workflow.hide()}else this.model.set("formStatus",{status:"error",message:self.model.validationError})},"click #cancel-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to cancel?",icon:"fa-warning",messageView:l,footerView:u});t.show()},"click @ui.CancelAddOtherDiagnosis":function(e){e.preventDefault(),this.closeAddOtherPopover("Diagnosis")},"click @ui.CancelAddOtherProcedure":function(e){e.preventDefault(),this.closeAddOtherPopover("Procedure")},"click @ui.CloseAddProcedureModifiers":function(e){e.preventDefault(),i(".itemModifiers").trigger("control:popover:hidden",!0)},"click @ui.CloseAddVisitModifiers":function(e){e.preventDefault(),i("#visit-modifiers-popover").trigger("control:popover:hidden",!0)},"click @ui.SearchAddOtherDiagnosis":function(e){e.preventDefault(),this.searchForOther("Diagnosis")},"click @ui.SearchAddOtherProcedure":function(e){e.preventDefault(),this.searchForOther("Procedure")},"click @ui.AddOtherDiagnosisPopover":function(e){e.preventDefault(),this.addAddOtherPopover("Diagnosis")},"click @ui.AddOtherProcedurePopover":function(e){e.preventDefault(),this.addAddOtherPopover("Procedure")},"click @ui.PrimaryDiagnosisCheckboxes":function(e){if(i(i(e.currentTarget).find("input")[0]).prop("reset"))return i(i(e.currentTarget).find("input")[0]).prop("reset",!1),void i(i(e.currentTarget).find("input")[0]).removeProp("checked");for(var t=this.$el.find(this.ui.PrimaryDiagnosisCheckboxes.selector+" input:checked"),r=t.length,o=0;r>o;o++)i(e.currentTarget).find("input")[0]!==t[o]&&(i(t[o]).prop("reset",!0),i(t[o]).click())},"click @ui.VisitChecklistCheckboxes":function(e){this.model.get("availableVisitModifiers").originalModels=[],this.model.get("availableVisitModifiers").reset(),this.model.set("selectedModifiersForVisit",[]),e.target.checked&&n.retrieveVisitModifiers(this,e.target.attributes.getNamedItem("name").nodeValue);var t=this.model.get("selectedModifier");if(""!==t){var i=this.model.get("visitCollection").get(this.model.get("visitTypeSelection")),r=i.attributes.items.get(t);r.set("value",!1),i.set("prev",r)}this.model.set("selectedModifier",e.target.attributes.getNamedItem("name").nodeValue),this.model.set("prevVisitTypeSelection",this.model.get("visitTypeSelection"))},"click @ui.ProcedureChecklist":function(e){var t=this.model.get("ProcedureCollection").get(this.model.get("procedureSection")),i=t.attributes.listItems.get(e.target.attributes.getNamedItem("name").nodeValue);this.setProcedureProviderPicklist(i),e.target.checked&&n.retrieveProcedureModifiers(this,e.target.attributes.getNamedItem("name").nodeValue,i)},"click @ui.ProviderCheckboxes":function(e){if(e.target.checked)for(var t=this.model.get("providerList").where({value:!0}),i=0;i<t.length;i++){var r=e.target.attributes.getNamedItem("name").nodeValue;r=r.substring(0,r.length-this.PRIMARY_PROVIDER_CHECK.length);var o=t[i].attributes.name+this.PRIMARY_PROVIDER_CHECK;t[i].attributes.name!==r&&t[i].attributes[o]&&t[i].set(o,!1)}}},setProcedureProviderPicklist:function(t){for(var r=new e.Collection,o=this.model.get("providerList").where({value:!0}),s=0;s<o.length;s++)r.add({value:o[s].attributes.label,label:o[s].attributes.label}),o[s].attributes[o[s].attributes.name+this.PRIMARY_PROVIDER_CHECK]&&t.set("provider",o[s].attributes.label);i(".ProcedureCollection .panel-container .panel-title .select-control").trigger("control:picklist:set",r)},closeAddOtherPopover:function(e){this.model.unset("addOther"+e+"SearchString"),this.model.set("selectAddOther"+e,""),i("#selectAddOther"+e).trigger("control:picklist:set",[{}]),i(".add-other-"+e.toLowerCase()+"-popover").trigger("control:popover:hidden",!0),i("#addOther"+e+"Btn").focus()},searchForOther:function(e){var t=this.model.get("addOther"+e+"SearchString");t&&t.length>0&&("Diagnosis"===e?n.retrieveDiagnosisLexicon(this,t,e):n.retrieveProcedureLexicon(this,t,e))},addAddOtherPopover:function(t){var r=this.model.get("selectAddOther"+t),o=i("#selectAddOther"+t+' option[value="'+r+'"]').text()||r||"";if("Procedure"===t){var s=this.model.get("ProcedureCollection").get("OtherProcedure");s.attributes.listItems.add({id:r,label:o,value:!0,quantity:1,provider:"",comments:new e.Collection,modifiers:new e.Collection}),this.model.trigger("change:ProcedureCollection");var d=s.attributes.listItems.get(r);this.setProcedureProviderPicklist(d),n.retrieveProcedureModifiers(this,r,d)}else this.model.get(t+"Collection").add({id:"",value:"other",label:"Other Diagnoses",listItems:new e.Collection([{id:r,label:o,value:!0,addToCL:!1,comments:new e.Collection,primary:!1}])});this.closeAddOtherPopover(t)}});return h});