define(["backbone","marionette","jquery","underscore","moment"],function(e,t,r,i,o){"use strict";var s={retrievePrevEncounter:function(){},retrieveProcedureItems:function(t){var i=ADK.PatientRecordService.getCurrentPatient().attributes.visit.locationUid;if(void 0!==i){i=i.split(":").splice(-1);var o="resource/write-pick-list?type=encounters-procedure-types",s=ADK.PatientRecordService.getCurrentPatient().attributes.visit.dateTime,n=moment(s,"YYYYMMDDHHmm").format("MMDDYYYY"),c=ADK.UserService.getUserSession().attributes.site;o+="&ien="+i+"&visitDate="+n+"&site="+c;var a=new e.Collection;a.url=o,a.fetch({error:function(e,t){console.log("error: "+t.responseText),a.reset()},success:function(i,o){for(var s=t.model.get("ProcedureCollection"),n=0;n<o.data.length;n++){var c=o.data[n],a=new e.Collection;if(void 0!==c.cptCodes)for(var l=0;l<c.cptCodes.length;l++)a.add({id:c.cptCodes[l].ien,label:c.cptCodes[l].name,name:c.cptCodes[l].ien,value:!1,quantity:1,comments:new e.Collection([]),modifiers:new e.Collection([])});s.add({id:c.categoryName,value:c.categoryName,label:c.categoryName,listItems:a})}r("#procedureSection").trigger("control:picklist:set",s),s.add({id:"OtherProcedure",value:"other",label:"Other Procedure",listItems:new e.Collection}),0!==s.length&&t.model.set("procedureSection",s.models[0].attributes.label)}})}},retrieveProcedureModifiers:function(t,r,i){var o="resource/write-pick-list?type=encounters-procedures-cpt-modifier",s=ADK.PatientRecordService.getCurrentPatient().attributes.visit.dateTime,n=moment(s,"YYYYMMDDHHmm").format("MMDDYYYY"),c=ADK.UserService.getUserSession().attributes.site;o+="&site="+c+"&cpt="+r+"&visitDate="+n;var a=new e.Collection;a.url=o,a.fetch({error:function(e,t){console.log("error: "+t.responseText),a.reset()},success:function(e,r){for(var o=(t.model.get("ProcedureCollection"),i.get("modifiers")),s=0;s<r.data.length;s++){var n=r.data[s];o.add({unique:n.ien,label:n.name,value:!1})}}})},retrieveProviders:function(t){var r=ADK.UserService.getUserSession(),i=r.get("firstname")+" "+r.get("lastname"),o=ADK.UserService.getUserSession().attributes.site,s="resource/write-pick-list?type=new-persons&new-persons-type=PROVIDER&searchString=OPTIONAL~&dateTime=OPTIONAL&site="+o,n=new e.Collection;n.url=s,n.fetch({error:function(e,t){console.log("error: "+t.responseText),n.reset()},success:function(e,r){var o=t.model.get("providerList");o.add({id:i,name:i,label:i,value:!0}),o.get(i).set(i+"-primaryProviderCheck",!0);for(var s=0;s<r.data.length;s++){var n=r.data[s];o.add({name:n.code,label:n.name,value:!1})}}})},retrieveProcedureLexicon:function(t,i,o){r("#selectAddOther"+o).trigger("control:loading:show");var s="resource/write-pick-list?type=encounters-procedures-lexicon-lookup",n=ADK.UserService.getUserSession().attributes.site;s+="&site="+n+"&searchString="+i;var c=new e.Collection;c.url=s,c.fetch({error:function(t,i){console.log("error: "+i.responseText),r("#selectAddOther"+o).trigger("control:loading:hide");var s=new e.Collection;s.add({value:"None",label:"No Procedures Found.",id:"None"}),r("#selectAddOther"+o).trigger("control:picklist:set",s),c.reset()},success:function(t,i){r("#selectAddOther"+o).trigger("control:loading:hide");for(var s,n=new e.Collection,c=0;c<i.data.length;c++)s=i.data[c],n.add({value:s.lexIen,label:s.prefText,id:s.lexIen});r("#selectAddOther"+o).trigger("control:picklist:set",n)}})},retrieveDiagnosisItems:function(t){var i=ADK.PatientRecordService.getCurrentPatient().attributes.visit.locationUid,o="resource/write-pick-list?type=encounters-diagnosis-codes-for-clinic",s=ADK.UserService.getUserSession().attributes.site;i=i.split(":").splice(-1);var n=this;o+="&site="+s+"&clinic="+i;var c=new e.Collection;c.url=o,c.fetch({error:function(e,t){console.log("error: "+t.responseText),c.reset(),r("#diagnosesSection").focus()},success:function(e,i){n.addToDiagnosisList(t,i.data),r("#diagnosesSection").trigger("control:picklist:set",t.model.get("DiagnosisCollection")),t.model.set("diagnosesSection",t.model.get("DiagnosisCollection").models[0].attributes.label),r("#diagnosesSection").focus()}})},addToDiagnosisList:function(t,r){for(var i=t.model.get("DiagnosisCollection"),o=!1,s=0;s<r.length;s++){var n=r[s];if(o||""!==n.categoryName){o=!0;var c=new e.Collection;if(void 0!==n.values)for(var a=0;a<n.values.length;a++)c.add({id:n.values[a].icdCode,name:n.values[a].icdCode,label:n.values[a].name+" ("+n.values[a].icdCode+")",value:!1,addToCL:!1,comments:new e.Collection([]),primary:!1});i.add({value:n.categoryName,label:n.categoryName,listItems:c})}}},retrieveDiagnosisLexicon:function(t,i,o){r("#selectAddOther"+o).trigger("control:loading:show");var s="resource/write-pick-list?type=encounters-diagnosis-lexicon-lookup",n=ADK.UserService.getUserSession().attributes.site;s+="&site="+n+"&searchString="+i;var c=new e.Collection;c.url=s,c.fetch({error:function(t,i){console.log("error: "+i.responseText),r("#selectAddOther"+o).trigger("control:loading:hide");var s=new e.Collection;s.add({value:"None",label:"No Diagnoses Found."}),r("#selectAddOther"+o).trigger("control:picklist:set",s),r("#selectAddOther"+o).focus(),c.reset()},success:function(t,i){r("#selectAddOther"+o).trigger("control:loading:hide");for(var s,n=new e.Collection,c=0;c<i.data.length;c++)s=i.data[c],n.add({value:s.prefText,label:s.prefText});r("#selectAddOther"+o).trigger("control:picklist:set",n),r("#selectAddOther"+o).focus()}})},retrieveRatedDisabilties:function(t){var r="resource/patient/record/service-connected/serviceconnectedrateddisabilities?",i=ADK.PatientRecordService.getCurrentPatient().attributes.pid,o=ADK.PatientRecordService.getCurrentPatient().attributes.acknowledged;r+="pid="+i,o===!0&&(r+="&_ack="+o);var s=new e.Collection;s.url=r,s.fetch({error:function(e,t){console.log("error: "+t.responseText),s.reset()},success:function(e,r){var i=r.data;if("NO"===i.serviceConnected)t.model.set("serviceConnected",i.serviceConnected),t.model.set("ratedDisabilities",i.disability);else{t.model.set("serviceConnected",i.scPercent+"%");for(var o="",s=0;s<i.disability.length;s++)o+="<li>"+i.disability[s].name+" "+i.disability[s].disPercent+"%</li>";t.model.set("ratedDisabilities",o)}}})},retrieveVisitRelated:function(t){var r="resource/patient/record/service-connected/serviceconnectedserviceexposurelist?",i=ADK.PatientRecordService.getCurrentPatient().attributes.pid,o=ADK.PatientRecordService.getCurrentPatient().attributes.acknowledged;r+="pid="+i,o===!0&&(r+="&_ack="+o);var s=this,n=new e.Collection;n.url=r,n.fetch({error:function(e,t){console.log("error: "+t.responseText),n.reset()},success:function(e,r){for(var i=r.data.exposure,o=0;o<i.length;o++){var n=i[o].uid.split(":")[2];"No"===i[o].name?t.model.set(n,"no"):"Yes"===i[o].name?t.model.set(n,"yes"):t.model.set(n,"undefined")}s.retrieveHidden(t)}})},retrieveHidden:function(t){var i=ADK.PatientRecordService.getCurrentPatient().attributes.visit.locationUid;if(void 0!==i){i=i.split(":").splice(-1);var o="resource/write-pick-list?type=encounters-visit-service-connected",s=ADK.UserService.getUserSession().attributes.site,n=ADK.PatientRecordService.getCurrentPatient().attributes.localId,c=ADK.PatientRecordService.getCurrentPatient().attributes.visit.dateTime,a=moment(c,"YYYYMMDDHHmm").format("MMDDYYYY");o+="&site="+s+"&dfn="+n+"&visitDate="+a+"&loc="+i;var l=new e.Collection;l.url=o,l.fetch({error:function(e,t){console.log("error: "+t.responseText),l.reset()},success:function(e,t){var i=t.data;"1"===i.SC&&r(".service-connected").trigger("control:hidden",!1),"1"===i.AO&&r(".agent-orange").trigger("control:hidden",!1),"1"===i.IR&&r(".ionizing-radiation").trigger("control:hidden",!1),"1"===i.SHD&&r(".shad").trigger("control:hidden",!1),"1"===i.MST&&r(".mst").trigger("control:hidden",!1),"1"===i.HNC&&r(".head-neck-cancer").trigger("control:hidden",!1),"1"===i.CV&&r(".combat-vet").trigger("control:hidden",!1),"1"===i.SAC&&r(".sw-asia").trigger("control:hidden",!1)}})}},retrieveVisitType:function(t){r("input#available-Providers-modifiers-filter-results").attr("placeholder","Select Provider");var i="resource/write-pick-list?type=encounters-visit-categories",o=ADK.PatientRecordService.getCurrentPatient().attributes.visit.dateTime,s=moment(o,"YYYYMMDDHHmm").format("MMDDYYYY"),n=ADK.PatientRecordService.getCurrentPatient().attributes.visit.locationUid.split(":").splice(-1),c=ADK.UserService.getUserSession().attributes.site;i+="&ien="+n+"&visitDate="+s+"&site="+c;var a=new e.Collection;a.url=i,a.fetch({error:function(e,t){console.log("error: "+t.responseText),a.reset()},success:function(i,o){for(var s=t.model.get("visitCollection"),n=0;n<o.data.length;n++){var c=o.data[n],a=new e.Collection;if(void 0!==c.cptCodes)for(var l=0;l<c.cptCodes.length;l++)a.add({id:c.cptCodes[l].ien,name:c.cptCodes[l].ien,label:c.cptCodes[l].name,value:!1});s.add({id:c.categoryName,label:c.categoryName,value:c.categoryName,items:a})}r("#visitTypeSelection").trigger("control:picklist:set",s),0!==s.length&&t.model.set("visitTypeSelection",s.models[0].attributes.label)}})},retrieveVisitModifiers:function(t,r){var i="resource/write-pick-list?type=encounters-procedures-cpt-modifier",o=ADK.PatientRecordService.getCurrentPatient().attributes.visit.dateTime,s=moment(o,"YYYYMMDDHHmm").format("MMDDYYYY"),n=ADK.UserService.getUserSession().attributes.site;i+="&site="+n+"&cpt="+r+"&visitDate="+s;var c=new e.Collection;c.url=i,c.fetch({error:function(e,t){console.log("error: "+t.responseText),c.reset()},success:function(r,i){for(var o=new e.Collection,s=0;s<i.data.length;s++){var n=i.data[s];o.add({name:n.ien,label:n.name,value:!1})}t.model.get("availableVisitModifiers").originalModels=o.models,t.model.get("availableVisitModifiers").set(o.models)}})}};return s});