define(["underscore","moment","crossfilter","app/applets/encounters/appConfig"],function(e,t,i,n){"use strict";var r=n.debug,o=n.eventOrder,s={parseDate:function(e,t){var i=moment(e,"YYYYMMDDHHmmssSSS").format("YYYYMMDD");if("undefined"!=typeof t)switch(r&&console.log("Chart data aggregation ---->>"+t),t.toLowerCase()){case"y":i=moment(e,"YYYYMMDDHHmmssSSS").format("YYYY");break;case"ym":i=moment(e,"YYYYMMDDHHmmssSSS").format("YYYYMM");break;case"ymd":i=moment(e,"YYYYMMDDHHmmssSSS").format("YYYYMMDD")}return i},stringSplitter:function(t){e.isUndefined(t)&&(t="");var i=t.split(",");return i.length>1?i.join(", "):t},slashSplitter:function(t){e.isUndefined(t)&&(t="");var i=t.split("/");return i.length>1?i.join("/ "):t},encounterProvider:function(t){var i=[],n=[],r=[],o="Unknown";if(t.providers){for(var s=0;s<t.providers.length;s++)t.providers[s].primary&&t.providers[s].providerDisplayName&&n.push(this.stringSplitter(t.providers[s].providerDisplayName)),t.providers[s].providerDisplayName&&i.push(this.stringSplitter(t.providers[s].providerDisplayName));0!==n.length?(r=e.difference(i,n),r.unshift(n)):r=i,0!==r.length&&(o=r[0])}else t.providerDisplayName&&(o=e.isEmpty(t.providerDisplayName)?"Unknown":t.providerDisplayName);return o},admissionDiagnosis:function(t){var i,n="Unknown",r=[];return e.isUndefined(t.dischargeDiagnosis)?i=t.reasonName||n:(e.each(t.dischargeDiagnosis,function(t){e.isUndefined(t.icdName)||(""===t.icdName?r.push(n):r.push(t.icdName))}),i=r.length>0?r.join(";//"):n),i},getTimeSinceForFuture:function(e){for(var t,i=e.length-1;i>0;i--)if(t=moment(e[i].dateTime,"YYYYMMDDHHmm"),t.isAfter())return e[i].dateTime;return e[i].dateTime},getRecentForFuture:function(e){for(var t,i=[],n=0,r=!1,o=0,s=e.length-1;s>0;s--)t=moment(e[s].dateTime,"YYYYMMDDHHmm"),t.isAfter()&&(r=!0,n=s,s=0);if(r)if(e.length-(n+1)>0)for(var a=n;a>=0;a--)i.push(e[a]),o++,o>=5&&(a=-1);else i=e.slice(0,5),r=!1;else i=e.slice(0,5);return{aResult:i,bFutureTime:r}},setAggregationScale:function(e){var t="ymd";return t},displayDate:function(e){return moment(e,"YYYYMMDD").format("YYYY-MM-DD")},isAppointment:function(e){return-1!==e.uid.indexOf("appointment")&&this.isVisit(e)?!0:-1!==e.uid.indexOf("visit")&&this.isVisit(e)&&moment(e.dateTime,"YYYYMMDDHHmm").isAfter(moment())?!0:!1},isProcedure:function(e){return-1!==e.kind.indexOf("Procedure")?!0:!1},isAdmission:function(e){return-1!==e.kind.indexOf("Admission")?!0:!1},isDoDAppointment:function(e){return-1!==e.kind.indexOf("DoD Appointment")?!0:!1},isDoDAppointmentFuture:function(e){return-1!==e.kind.indexOf("DoD Appointment")&&moment(e.dateTime,"YYYYMMDDHHmm").isAfter(moment())?!0:!1},isDoDEncounter:function(e){return-1!==e.kind.indexOf("DoD Encounter")?!0:!1},getCPTprocedureDetailViewModel:function(t,i){var n,r;return e.isUndefined(t.dataGridOptions.shadowCollection)||(r=t.dataGridOptions.shadowCollection.findWhere({kind:"Visit",uid:i}),n=e.isUndefined(r)?{fError:!0,summary:"Error",errorMsg:"Sorry, there is no detailed information about this event!"}:r.toJSON()),n},showDetailView:function(e,t){var i=e,n=(i.model=new Backbone.Model(i.model.get("recent_model")),new ADK.UI.Modal({view:ADK.Views.Loading.create(),options:{size:"large",title:"Loading..."}}));n.show();var r=ADK.Messaging.getChannel(t),o=r.request("detailView",i);o.done(function(e){var t=new ADK.UI.Modal({view:e.view,options:{size:"large",title:e.title}});t.show(),$("#mainModal").modal("show")})},clanUpItem:function(e){return e.replace(/[\s\\/()!?*&:;,.^'"<>%]/g,"")},selectStartStopPoint:function(e){var t=ADK.SessionStorage.getModel_SessionStoragePreference("globalDate").get("selectedId"),i=moment(ADK.SessionStorage.getModel_SessionStoragePreference("globalDate").get("fromDate"),"MM/DD/YYYY").format("YYYYMMDD"),n=moment(ADK.SessionStorage.getModel_SessionStoragePreference("globalDate").get("toDate"),"MM/DD/YYYY").format("YYYYMMDD"),r=moment().add(6,"M"),o=moment().add(1,"d");return"all-range-global"===t?{start:e,stop:moment(r).format("YYYYMMDD")}:"custom-range-apply-global"===t?{start:i,stop:n}:{start:i,stop:moment(o).format("YYYYMMDD")}},getEmpty:function(e){return{kind:"",elKind:"",count:0,firstEvent:this.selectStartStopPoint(e).start,lastEvent:"",timeSinceLast:"None",chartData:[],firstEventDisplay:"",lastEventDisplay:"",maxChart:this.selectStartStopPoint(e).stop,processed:!0,empty:!0,order:0}},addEmptyTiles:function(e,t){var i=[],n=[];for(var r in o)i.push(o[r].title),n.push(r);for(var s=0;s<i.length;s++)if(0===e.where({kind:i[s]}).length){var a=this.getEmpty(t);o[n[s]]&&(a.kind=i[s],a.elKind=this.clanUpItem(a.kind),a.order=o[n[s]].order),e.add(a)}},filterAppointments:function(e){var t,n,o=[],s=new i(e.toJSON()),a=s.dimension(this.crossfilterStuff.dimKind),d=a.filterExact("Visit").top(1/0);a.filterAll();var m=a.filterExact("Appointment").top(1/0);for(a.filterAll(),t=0;t<m.length;t++)for(n=0;n<d.length;n++)m[t].dateTime.toLowerCase()==d[n].dateTime.toLowerCase()&&m[t].stopCodeName.toLowerCase()==d[n].stopCodeName.toLowerCase()&&m[t].facilityName.toLowerCase()==d[n].facilityName.toLowerCase()&&(r&&console.log("Appointment duplication ----->>>"+d[n].dateTime.toLowerCase()+" | "+m[t].facilityName+" | "+d[n].facilityName),o.push(e.findWhere({uid:m[t].uid})));return a.dispose(),s=null,e.remove(o),o.length},crossfilterStuff:{dimKind:function(e){return e.kind}},isHospitalization:function(e){return"urn:va:encounter-category:AD"===e.categoryCode},isDischargedOrAdmitted:function(e){if(void 0===e.stay)throw"stay is required for this method!";return void 0!==e.stay.dischargeDateTime},isVisit:function(e){return this.isKindTypeHelper(e,"visit")},isKindTypeHelper:function(e,t){if(void 0===e)return!1;var i=e.kind;return e instanceof Backbone.Model&&(i=e.get("kind")),void 0===i?!1:(i=i.toLowerCase(),i===t)},getActivityDateTime:function(e){return this.isVisit(e)&&this.isHospitalization(e)&&this.isDischargedOrAdmitted(e)?e.stay.dischargeDateTime:e.dateTime},convertChartDate:function(e){return moment.utc(e,"YYYYMMDD").valueOf()},nowChart:function(){var e=moment().format("YYYYMMDDHHmmssSSS");return this.convertChartDate(e)}};return s});