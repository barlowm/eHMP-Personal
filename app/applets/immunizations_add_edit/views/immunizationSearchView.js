define(["underscore","handlebars","app/applets/immunizations_add_edit/views/immunizationVisitView","app/applets/immunizations_add_edit/views/addEditImmunizationView","hbs!app/applets/immunizations_add_edit/templates/searchImmunizationTemplate"],function(i,e,t,n,a){function s(i){var e=ADK.PatientRecordService.getCurrentPatient();l=i,m.on("set-visit-success:immunizations_search",function(){$("#mainModal").one("hidden.bs.modal",o)}),e.get("visit")?o():m.command("openVisitSelector","immunizations_search")}function o(){var i={title:"Find an Immunization",footerView:r};d=new u;var e=new ADK.UI.Modal({view:d,options:i});e.show()}var l,d,m=(ADK.Messaging.getChannel("immunization"),ADK.Messaging.getChannel("visit")),r=Backbone.Marionette.ItemView.extend({template:i.template('<button class="btn btn-default pull-right" data-dismiss="modal">Cancel</button>')}),c=Backbone.Marionette.ItemView.extend({template:e.compile("{{name}}"),tagName:"li",className:"list-group-item",attributes:{tabindex:-1},events:{click:"handleItemSelected",keyup:"handleKeyPress"},handleItemSelected:function(){n.handleMessage("immunization_add",this.model)},handleKeyPress:function(i){if(13===i.keyCode)this.handleItemSelected();else if(40===i.keyCode){var e=$("#immunization-search-list li:last-child")[0];$(this.el)[0]===e?$("#immunization-search-list li:first-child").focus():$(this.el).next().focus()}else if(38===i.keyCode){var t=$("#immunization-search-list li:first-child")[0];$(this.el)[0]===t?$("#immunization-search-list li:last-child").focus():$(this.el).prev().focus()}}}),h=Backbone.Marionette.CompositeView.extend({template:a,events:{"keyup #immunization-search-term":"handleSearchTermTyping"},childViewContainer:"ul",childView:c,initialize:function(){var i={resourceTitle:"immunization-crud-getPatientImmunizations",onError:function(){$("#immunization-loading").addClass("hidden").attr("aria-hidden",!0),$("#immunization-loading-error").removeClass("hidden").attr("aria-hidden",!1)},onSuccess:function(){$("#immunization-loading").addClass("hidden").attr("aria-hidden",!0),$("#immunization-search-term").attr("disabled",!1),setTimeout(function(){$("#immunization-search-term").focus()},700)}};this.masterCollection=ADK.ResourceService.fetchCollection(i),this.masterCollection.comparator="name",this.collection=new Backbone.Collection},handleSearchTermTyping:function(e){if(40===e.keyCode&&this.collection.length>0)$(this.el).find("#immunization-search-list li:first-child").focus();else if(38===e.keyCode&&this.collection.length>0)$(this.el).find("#immunization-search-list li:last-child").focus();else if($("#immunization-search-term").val().trim().length>=3){var t=this.masterCollection.models;if(this.collection.reset(),$(this.el).find("#immunizations-no-results").addClass("hidden").attr("aria-hidden",!0),9!==e.keyCode){var n=$("#immunization-search-term").val();if(n.trim().length>0){var a=i.filter(t,function(i){return~i.get("name").toLowerCase().indexOf(n.toLowerCase())});a.length>0?this.collection.add(a):$(this.el).find("#immunizations-no-results").removeClass("hidden")}}}else $(this.el).find("#immunizations-no-results").addClass("hidden").attr("aria-hidden",!0),this.collection.reset()}}),u=Backbone.Marionette.LayoutView.extend({regions:{visit:"#immunization-visit",search:"#search-view"},template:i.template('<div id="immunization-visit"></div><div id="search-view"></div>'),initialize:function(){this.visitsView=new t,this.searchView=new h},onRender:function(){this.visit.show(this.visitsView),this.search.show(this.searchView)}}),f={handleMessage:s};return f});