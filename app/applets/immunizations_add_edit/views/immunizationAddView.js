define(["backbone","marionette","jquery","handlebars","app/applets/immunizations_add_edit/utils/parseUtils","app/applets/immunizations_add_edit/utils/validationUtil"],function(e,t,i,n,o,r){var a={createForm:function(){var t=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[{control:"container",extraClasses:["row","section-divider"],items:[{control:"container",extraClasses:["col-md-12"],template:n.compile('<p class="required-note">* indicates a required field.</class></p>'),items:[{control:"radio",name:"immunizationOption",label:"1. Choose an option.",required:!0,options:[{value:"administered",label:"Administered"},{value:"historical",label:"Historical"}]},{control:"typeahead",name:"immunizationType",label:"2. Select an immunization type.",required:!0,disabled:!0,placeholder:"Search for available immunization types...",options:{minLength:2},matcher:function(e,t){return function(t,i){var n=[],r=new RegExp(t,"i"),a="administered"===f.get("immunizationOption");e.each(function(e){o.doesItemMatch(r,e,a)&&n.push(e.toJSON())}),i(n)}}}]}]}]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",items:[{control:"container",extraClasses:["col-md-3"]},{control:"button",id:"delete-btn",extraClasses:["btn-icon"],label:"",icon:"fa-trash-o fa-lg",type:"button",title:"Press enter to delete order"},{control:"button",extraClasses:["btn-primary","btn-sm"],label:"Next",id:"nextBtn",name:"nextBtn",disabled:!0,title:"Press enter to proceed to the next step"}]}]}]}],s=[{control:"container",extraClasses:["modal-body"],items:[{control:"container",extraClasses:["scroll-enter-form"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-12"],template:n.compile('<h5>{{immunizationLabel}}</h5><span class="text-uppercase">{{immunizationOption}}</span>'),modelListeners:["immunizationOption","immunizationLabel"]},{control:"spacer"}]},{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["form-highlight"],items:[{control:"container",extraClasses:["col-md-12"],items:[{control:"input",name:"lotNumberHistoric",label:"Lot Number",type:"text",required:!1,title:"Please enter in lot number"},{control:"select",name:"lotNumberAdmin",label:"Lot Number",options:[],required:!0}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"datepicker",name:"expirationDate",label:"Expiration Date"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"input",name:"manufacturerAdmin",label:"Manufacturer"},{control:"typeahead",name:"manufacturerHistorical",label:"Manufacturer",options:{minLength:3}}]},{control:"container",extraClasses:["col-md-12"],items:[{control:"select",name:"informationSource",label:"Information Source"}]}]}]},{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-6"],items:[{control:"datepicker",name:"administrationDate",label:"Administration Date",title:"Please enter in a date in the following format, MM/DD/YYYY"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"typeahead",name:"administeringProvider",label:"Administering Provider",options:{minLength:3}}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"typeahead",name:"orderingProvider",label:"Ordering Provider",options:{minLength:3}}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"typeahead",name:"encounterLocation",label:"Encounter Location",required:!0,options:{minLength:3}}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"select",name:"routeOfAdministration",label:"Route of Administration"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"select",name:"anatomicLocation",label:"Anatomic Location"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"input",type:"decimal",name:"dose",label:"Dose",units:"mL"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"select",name:"series",label:"Series"}]}]},{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-6"],items:[{control:"select",multiple:!0,name:"informationStatement",label:"Vaccine Information Statement(s) (VIS)"}]},{control:"container",extraClasses:["col-md-6"],items:[{control:"datepicker",name:"visDateOffered",label:"VIS Date Offered",title:"Please enter in a date in the following format, MM/DD/YYYY"}]}]},{control:"container",extraClasses:["row"],items:[{control:"textarea",extraClasses:["col-md-12"],name:"comments",label:"Comments",maxlength:245}]}]}]},{control:"container",extraClasses:["modal-footer"],items:[{control:"container",extraClasses:["row"],items:[{control:"container",extraClasses:["col-md-3"],template:n.compile('<p><span id="notes-saved-at-view2">Saved at {{savedTime}}</span></p>'),modelListeners:["savedTime"]},{control:"container",extraClasses:["col-md-9"],items:[{control:"button",id:"delete-btn",extraClasses:["btn-icon"],label:"",icon:"fa-trash-o fa-lg",title:"Press enter to delete order",type:"button"},{control:"button",type:"button",extraClasses:["btn-primary","btn-sm"],label:"Close",title:"Press enter to close immunization",id:"close-btn"},{control:"button",type:"button",extraClasses:["btn-primary","btn-sm"],label:"Back",title:"Press enter to go back to the previous step",id:"back-btn"},{control:"button",extraClasses:["btn-primary","btn-sm"],label:"Add",title:"Press enter to add immunization",id:"add-btn"}]}]}]}],l=e.Model.extend({defaults:{savedTime:"00:00",immunizationOption:"",immunizationLabel:"",validProviderSelected:!1,errorModel:new e.Model},validate:function(e,t){return r.validateModel(this)}}),c=e.Marionette.ItemView.extend({template:n.compile("You will lose all work in progress if you delete this task. Would you like to proceed?"),tagName:"p"}),m=e.Marionette.ItemView.extend({template:n.compile("You will lose all work in progress if you close this task. Would you like to proceed?"),tagName:"p"}),d=e.Marionette.ItemView.extend({template:n.compile('{{ui-button "Cancel" classes="btn-default" title="Click button to cancel your action!"}}{{ui-button "Continue" classes="btn-primary" title="Click button to continue your action!"}}'),events:{"click .btn-primary":function(){ADK.UI.Alert.hide(),ADK.UI.Workflow.hide()},"click .btn-default":function(){ADK.UI.Alert.hide()}},tagName:"span"}),u=ADK.UI.Form.extend({ui:{immunizationType:"#immunizationType",nextBtn:".nextBtn"},fields:t,events:{"click #delete-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to delete?",icon:"fa-exclamation-triangle",messageView:c,footerView:d});t.show()},submit:function(e){e.preventDefault();var t=this;this.model.unset("formStatus");var n=v.getFormView(1);n.callControlFunction({controlType:"select",controlName:"series",functionName:"setPickList",options:{pickList:o.getSeriesList(this.model.get("maxInSeries"))}}),n.callControlFunction({controlType:"select",controlName:"informationStatement",functionName:"setPickList",options:{pickList:this.model.get("immInfoStatements")}});var r=(ADK.PatientRecordService.getCurrentPatient().get("visit"),ADK.UserService.getUserSession()),a=r.get("lastname")+","+r.get("firstname"),s=r.get("duz")[r.get("site")];if(n.$(n.ui.administeringProviderInput).typeahead("val",a),this.model.set("administeringProvider",a,{silent:!0}),this.model.set("administeringProviderPredefinedId",s),this.model.set("validProviderSelected",!0),!n.anatomicLocationList){var l={resourceTitle:"immunization-crud-anatomicalLocations",onSuccess:function(e,t){n.anatomicLocationList=o.getAnatomicLocationList(t),n.callControlFunction({controlType:"select",controlName:"anatomicLocation",functionName:"setPickList",options:{pickList:n.anatomicLocationList}})}};ADK.PatientRecordService.fetchCollection(l)}if(!n.encounterLocationList){var c={resourceTitle:"locations-clinics",criteria:{"site.code":ADK.UserService.getUserSession().get("site")},onSuccess:function(e,t){n.encounterLocationList=o.getEncounterLocationList(t),n.callControlFunction({controlType:"typeahead",controlName:"encounterLocation",functionName:"setPickList",options:{pickList:n.encounterLocationList}});var i=ADK.PatientRecordService.getCurrentPatient().get("visit");n.$(n.ui.encounterLocationInput).typeahead("val",i.locationDisplayName),n.model.set("encounterLocation",i.locationUid,{silent:!0})}};ADK.PatientRecordService.fetchCollection(c)}if(!n.routeOfAdministrationList){var m={resourceTitle:"immunization-crud-routeOfAdministration",onSuccess:function(e,t){n.routeOfAdministrationList=o.getRouteOfAdministrationList(t),n.callControlFunction({controlType:"select",controlName:"routeOfAdministration",functionName:"setPickList",options:{pickList:n.routeOfAdministrationList}})}};ADK.PatientRecordService.fetchCollection(m)}if(!n.orderingProviderList){var d={resourceTitle:"visits-providers",criteria:{"facility.code":ADK.UserService.getUserSession().get("site")},onSuccess:function(e,t){n.orderingProviderList=o.getOrderingProviderList(t),n.callControlFunction({controlType:"typeahead",controlName:"orderingProvider",functionName:"setPickList",options:{pickList:n.orderingProviderList}})}};ADK.PatientRecordService.fetchCollection(d)}if("administered"===this.model.get("immunizationOption")){this.model.set("administrationDate",moment().format("MM/DD/YYYY"));var u={resourceTitle:"immunization-crud-lotNumbers",criteria:{uri:this.model.get("immunizationType")},onSuccess:function(e,r){n.lotNumberList=o.getLotNumberPickList(r),n.callControlFunction({controlType:"select",controlName:"lotNumberAdmin",functionName:"setPickList",options:{pickList:n.lotNumberList}}),i("#lotNumberAdmin").attr("required","required"),t.model.set("lotNumberAdmin",i("#lotNumberAdmin").val())}};ADK.PatientRecordService.fetchCollection(u)}else{if(!n.manufacturerList){var h={resourceTitle:"immunization-crud-manufacturers",onSuccess:function(e,t){n.manufacturerList=o.getManufacturerList(t),n.callControlFunction({controlType:"typeahead",controlName:"manufacturerHistorical",functionName:"setPickList",options:{pickList:n.manufacturerList}})}};ADK.PatientRecordService.fetchCollection(h)}if(!n.informationSourceList){var f={resourceTitle:"immunization-crud-informationSources",onSuccess:function(e,t){n.informationSourceList=o.getInformationSourceList(t),n.callControlFunction({controlType:"select",controlName:"informationSource",functionName:"setPickList",options:{pickList:n.informationSourceList}})}};ADK.PatientRecordService.fetchCollection(f)}}this.workflow.goToNext()},"typeahead:selected #immunizationType":function(e,t,i){this.model.set("maxInSeries",t.maxInSeries),this.model.set("immInfoStatements",t.informationStatements),this.model.set("matchedTerm",!0),this.$(this.ui.nextBtn).find("button").attr("disabled",!1).removeClass("disabled"),this.model.set("immunizationLabel",this.$(this.ui.immunizationType).val())},"typeahead:autocompleted #immunizationType":function(e,t,i){this.model.set("maxInSeries",t.maxInSeries),this.model.set("immInfoStatements",t.informationStatements),this.model.set("matchedTerm",!0),this.$(this.ui.nextBtn).find("button").attr("disabled",!1).removeClass("disabled"),this.model.set("immunizationLabel",this.$(this.ui.immunizationType).val())},"input #immunizationType":function(e){this.model.get("matchedTerm")&&(this.model.set("matchedTerm",!1),this.$(this.ui.nextBtn).find("button").attr("disabled",!0).addClass("disabled"))}},modelEvents:{"change:immunizationOption":function(e){var t,i=e.get("immunizationOption"),n=e.get("immunizationType");n&&(t=_.findWhere(a.pickList,{value:n})),i&&(this.$(this.ui.immunizationType).attr("disabled",!1),t&&"administered"===i&&t.isInactive&&(e.unset("immunizationType",{silent:!0}),this.$(this.ui.immunizationType).val(""),this.$(this.ui.nextBtn).find("button").attr("disabled",!0).addClass("disabled")))}}}),h=ADK.UI.Form.extend({ui:{lotNumberHistoric:".lotNumberHistoric",lotNumberAdmin:".lotNumberAdmin",manufacturerAdmin:".manufacturerAdmin",manufacturerHistorical:".manufacturerHistorical",expirationDate:".expirationDate",administrationDate:".administrationDate",administeringProvider:".administeringProvider",administeringProviderInput:"#administeringProvider",orderingProvider:".orderingProvider",encounterLocation:".encounterLocation",encounterLocationInput:"#encounterLocation",informationSource:".informationSource",routeOfAdministration:".routeOfAdministration",anatomicLocation:".anatomicLocation",dose:".dose",informationStatement:".informationStatement",visDateOffered:".visDateOffered"},fields:s,events:{"click #delete-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to delete?",icon:"fa-exclamation-triangle",messageView:c,footerView:d});t.show()},"click #back-btn":function(e){this.model.get("lotNumberAdmin")&&(this.model.unset("lotNumberAdmin"),this.model.unset("manufacturerAdmin"),this.model.unset("manufacturerHistorical"),this.model.unset("expirationDate")),this.model.set("series",""),this.model.set("informationStatement",""),this.model.unset("formStatus"),this.workflow.goToPrevious()},"keyup #administeringProvider":function(e){9!==e.keyCode&&13!==e.keyCode&&37!==e.keyCode&&38!==e.keyCode&&39!==e.keyCode&&40!==e.keyCode&&27!==e.keyCode&&(this.model.set("validProviderSelected",!1),this.model.set("administeringProviderPredefinedId",""),this.performActionWhileTyping(e,2,1e3))},"click #close-btn":function(e){e.preventDefault();var t=new ADK.UI.Alert({title:"Are you sure you want to close this form?",icon:"fa-exclamation-triangle",messageView:m,footerView:d});t.show()},submit:function(e){var t=this;if(e.preventDefault(),this.model.isValid()){this.model.unset("formStatus");var i=new ADK.UI.Notification({title:"Immunization Added",icon:"fa-check",message:this.model.get("immunizationLabel"),type:"success"});i.show(),ADK.UI.Workflow.hide()}else this.model.set("formStatus",{status:"error",message:t.model.validationError});var n=function(){var e=new Date,t="",i="";return t=e.getHours()<10?"0"+e.getHours():e.getHours(),i=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),t+":"+i};return this.model.set("savedTime",n()),!1},"typeahead:selected #administeringProvider":function(){this.model.set("validProviderSelected",!0)},"typeahead:autocompleted #administeringProvider":function(){this.model.set("validProviderSelected",!0)}},performActionWhileTyping:function(e,t,n){var o=e.target?e.target:e.srcElement,r=v.getFormView(1);r.termInProgress=i(o).val(),i(o).val().length<=t&&"undefined"!=typeof timeoutHandle?clearTimeout(timeoutHandle):i(o).val().length>t&&("undefined"==typeof timeoutHandle?timeoutHandle=_.delay(this.search,n,r):(clearTimeout(timeoutHandle),timeoutHandle=_.delay(this.search,n,r)))},search:function(e){var t=i("#administeringProvider").val();e.retrieveAdminsteringProviders(t,e)},retrieveAdminsteringProviders:function(e,t){var n={type:"GET",url:"resource/write-pick-list",data:{type:"new-persons",site:"9E7A",searchString:e},dataType:"json"},r=i.ajax(n);r.done(function(n){if(t.termInProgress===e){t.administeringProviderList=o.getAdministeringProviderList(n),t.callControlFunction({controlType:"typeahead",controlName:"administeringProvider",functionName:"setPickList",options:{pickList:t.administeringProviderList}}),i("#administeringProvider").typeahead("val",e),i("#administeringProvider").focus();var r=i.Event("keydown");r.keyCode=r.which=40,i("#administeringProvider").trigger(r),i("#administeringProvider")[0].setSelectionRange(e.length,e.length)}})},modelEvents:{"change:immunizationOption":function(e){var t=e.get("immunizationOption");"administered"===t?(this.$(this.ui.administrationDate).trigger("control:required",!0),this.$(this.ui.administeringProvider).trigger("control:required",!0),this.$(this.ui.encounterLocation).find("input").attr("required",!0),this.$(this.ui.routeOfAdministration).trigger("control:required",!0),this.$(this.ui.anatomicLocation).trigger("control:required",!0),this.$(this.ui.dose).trigger("control:required",!0),this.$(this.ui.informationStatement).trigger("control:hidden",!1),this.$(this.ui.visDateOffered).trigger("control:hidden",!1),this.$(this.ui.informationSource).addClass("hidden"),this.$(this.ui.lotNumberHistoric).addClass("hidden"),this.$(this.ui.lotNumberAdmin).removeClass("hidden"),this.$(this.ui.manufacturerAdmin).removeClass("hidden"),this.$(this.ui.manufacturerHistorical).addClass("hidden"),this.$(this.ui.expirationDate).find("input").attr("disabled",!0),this.$(this.ui.manufacturerAdmin).find("input").attr("disabled",!0)):(this.$(this.ui.administrationDate).trigger("control:required",!1),this.$(this.ui.informationSource).removeClass("hidden"),this.$(this.ui.expirationDate).find("input").attr("disabled",!1),this.$(this.ui.manufacturerAdmin).find("input").attr("disabled",!1),this.$(this.ui.routeOfAdministration).trigger("control:required",!1),this.$(this.ui.anatomicLocation).trigger("control:required",!1),this.$(this.ui.dose).trigger("control:required",!1),this.$(this.ui.informationStatement).trigger("control:hidden",!0),this.$(this.ui.visDateOffered).trigger("control:hidden",!0),this.$(this.ui.lotNumberAdmin).addClass("hidden"),this.$(this.ui.lotNumberAdmin).find("select").attr("required",!1),this.$(this.ui.lotNumberHistoric).removeClass("hidden"),this.$(this.ui.manufacturerAdmin).addClass("hidden"),this.$(this.ui.manufacturerHistorical).removeClass("hidden"),this.$(this.ui.administeringProvider).trigger("control:required",!1),this.$(this.ui.encounterLocation).find("input").attr("required",!1))},"change:lotNumberAdmin":function(e){var t=e.get("lotNumberAdmin");if(t){var i=_.findWhere(this.lotNumberList,{value:t});e.set("expirationDate",i.expirationDate,{silent:!0}),e.set("manufacturerAdmin",i.manufacturer,{silent:!0}),this.$(this.ui.expirationDate).find("input").val(i.expirationDate),this.$(this.ui.manufacturerAdmin).find("input").val(i.manufacturer)}else e.unset("expirationDate",{silent:!0}),e.unset("manufacturerAdmin",{silent:!0}),this.$(this.ui.expirationDate).find("input").val(""),this.$(this.ui.manufacturerAdmin).find("input").val("")},"change:encounterLocation":function(e){var t=ADK.PatientRecordService.getCurrentPatient().get("visit");-1===e.get("encounterLocation").indexOf("urn:va:location")&&-1!==e.previous("encounterLocation").indexOf("urn:va:location")&&e.get("encounterLocation")===t.locationDisplayName&&e.set("encounterLocation",t.locationUid,{silent:!0})}}}),f=new l,p={size:"large",title:"Enter Immunization",showProgress:!0,keyboard:!0,steps:[{view:u,viewModel:f,stepTitle:"Select an Immunization type"},{view:h,viewModel:f,stepTitle:"Enter Immunization Info"}]},v=new ADK.UI.Workflow(p);v.show();var g={resourceTitle:"immunization-crud-immunizationTypes",onSuccess:function(e,t){var i=v.getFormView(0);a.pickList=o.getImmunizationTypePickList(t),i.callControlFunction({controlType:"typeahead",controlName:"immunizationType",functionName:"setPickList",options:{pickList:a.pickList}}),f.get("immunizationOption")&&i.$(i.ui.immunizationType).attr("disabled",!1)}};ADK.PatientRecordService.fetchCollection(g)},handleShowView:function(){var e=ADK.Messaging.getChannel("visit"),t=ADK.PatientRecordService.getCurrentPatient();e.on("set-visit-success:immunizations_add_edit",a.createForm),t.get("visit")?a.createForm():e.command("openVisitSelector","immunizations_add_edit")}};return a});