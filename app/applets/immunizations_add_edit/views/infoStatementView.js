define(["underscore","handlebars"],function(e,t){var i=Backbone.Marionette.ItemView.extend({template:t.compile("{{name}}"),tagName:"option",attributes:function(){return{"data-name":this.model.get("name")}}}),l=Backbone.Marionette.CompositeView.extend({template:t.compile('<select class="form-control pull-left"></select>{{#unless isFirst}}<span class="info-source-remove pull-right"><b class="fa fa-times"></b></span>{{/unless}}</div>'),childViewContainer:"select",childView:i,events:{change:"handleChanged","click .info-source-remove":"removeSelect","keyup .info-source-remove":"handleRemoveKeyPress"},tagName:"div",className:"clearfix info-source-block",initialize:function(){this.collection=new Backbone.Collection,this.collection.add({name:""}),this.collection.add(this.model.get("items").models)},handleRemoveKeyPress:function(e){13===e.keyCode&&this.removeSelect()},handleChanged:function(){this.collection.length>2&&$(this.el).trigger("addSelect",this)},removeSelect:function(){$(this.el).trigger("removeSelect",this)}});return Backbone.Marionette.CollectionView.extend({tagName:"div",childView:l,events:{addSelect:"addAnotherSelect",removeSelect:"removeSelect"},initialize:function(){this.collection=new Backbone.Collection},setFirstModel:function(e){var t=new Backbone.Model({isFirst:"yes",items:new Backbone.Collection(e)});this.collection.add(t)},addAnotherSelect:function(e,t){var i=$(t.el).find("select").val();if(i){$(t.el).find("select").attr("disabled",!0);var l=this.buildNewCollection();this.collection.add(new Backbone.Model({items:l})),$(this.el).find("select").last().focus()}},removeSelect:function(e,t){if(this.collection.remove(t.model),1===this.collection.length)$(this.el).find("select").first().attr("disabled",!1).focus();else{var i=$(this.el).find("select").last().find("option:selected").attr("data-name");this.collection.remove(this.collection.models[this.collection.models.length-1]);var l=this.buildNewCollection();this.collection.add(new Backbone.Model({items:l})),i&&$(this.el).find("select").last().find('option[data-name="'+i+'"]').attr("selected",!0),$(this.el).find("select").last().focus()}},buildNewCollection:function(){var t=new Backbone.Collection,i=this.collection.models[0].get("items").models,l=$(".info-source-block select option:selected").map(function(){return $(this).text()}).get();return e.each(i,function(i){e.contains(l,i.get("name"))||t.add(i)}),t}})});