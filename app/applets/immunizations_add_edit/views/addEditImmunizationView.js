define(["underscore","app/applets/visit/typeaheadView","app/applets/immunizations_add_edit/selectViewGenerator","app/applets/immunizations_add_edit/immCollectionUtil","app/applets/immunizations_add_edit/views/infoStatementView","hbs!app/applets/immunizations_add_edit/templates/addEditImmunizationsTemplate","moment","jquery.inputmask"],function(e,i,t,a,n,o,r,s){function d(e,i){var t=ADK.PatientRecordService.getCurrentPatient();m=e,u=i,v.on("set-visit-success:immunizations_add_edit",l),t.get("visit")?v.command("openVisitSelector","immunizations_add_edit"):l(i)}function l(e){var i={footerView:g};"immunization_edit"===m?i.title="Edit Immunization: "+e.get("name"):i.title="Add Immunization: "+e.get("name"),c=new b({model:u});var t=new ADK.UI.Modal({view:c,options:i});t.show()}var m,c,u,h=ADK.Messaging.getChannel("immunization"),v=ADK.Messaging.getChannel("visit"),g=Backbone.Marionette.ItemView.extend({template:e.template('<button class="btn btn-default pull-left" id="imm-back-btn">Back</button><div class="pull-right"><button class="btn btn-default" data-dismiss="modal">Cancel</button><button class="btn btn-primary" id="imm-submit" disabled>Submit Immunization</button></div>'),events:{"click #imm-back-btn":"goBack","click #imm-submit":"submitImmunization"},goBack:function(){h.command("openImmunizationSearch",m)},submitImmunization:function(){a.removePreviousErrors();var e=a.validateFormInputAndShowErrors(c);if(e){var i=a.buildSubmitModel(u);i.save(null,{success:function(){ADK.UI.Modal.hide(),setTimeout(function(){$('div[data-appletid="immunizations"] .applet-refresh-button').trigger("click")},2e3)},error:function(e,i){$("#add-edit-imm-error").removeClass().addClass("error").attr("aria-hidden",!1)}})}}}),b=Backbone.Marionette.LayoutView.extend({template:o,regions:{adminProvider:"#admin-provider-region",orderingProvider:"#ordering-provider-region",location:"#location-region",infoSource:"#info-source-region",routeAdmin:"#route-admin-region",anatomicLocation:"#anatomic-location-region",reaction:"#reaction-region",series:"#series-region",lotNumObserved:"#lot-num-obs-region",infoStatement:"#info-statement-region"},events:{"click #immunization-btn-observer":"displayObserver","click #immunization-btn-historical":"displayHistorical"},initialize:function(){var o,r=this,s=ADK.UserService.getUserSession(),d=s.get("site"),l={resourceTitle:"visits-providers",criteria:{"facility.code":d,limit:10}};if(e.contains(s.get("vistaKeys"),"PROVIDER")){var m=s.get("lastname")+","+s.get("firstname"),c=s.get("duz")[s.get("site")]?s.get("duz")[s.get("site")]:s.get("duz")[0];o=new Backbone.Model({name:m,localId:c})}else o=new Backbone.Model;var h=i.generate("admin-provider","Administering Provider",l,"name","pname",o);this.adminProviderView=new h;var v=i.generate("ordering-provider","Ordering Provider",l,"name","pname");this.orderingProviderView=new v;var g={resourceTitle:"locations-clinics",criteria:{"site.code":d,limit:10}},b=ADK.PatientRecordService.getCurrentPatient(),f="";b.get("visit").locationUid&&(f=b.get("visit").locationUid.split(":").pop());var p=new Backbone.Model({name:b.get("visit").locationName,localId:f}),w=i.generate("location","Location",g,"name","name",p);this.locationView=new w,this.infoSourceView=t.createSelectView("info-source","Information Source","source","HL7Code"),this.routeAdminView=t.createSelectView("route-admin","Route of Administration","route","hl7Code",a.checkFormReadyForSubmit),this.anatomicLocationView=t.createSelectView("anatomic-location","Anatomic Location","site","hl7Code",a.checkFormReadyForSubmit),this.reactionView=t.createSelectView("reaction","Reaction","DisplayText","Value"),this.seriesView=t.createSelectView("series","Series","DisplayText","Value"),this.lotNumObsView=t.createSelectView("lot-num-obs","Lot Number","lotNumber","lotNumber",a.changeLotNumber),this.infoStatementView=new n;var k={resourceTitle:"immunization-crud-getImmunizationsOperationalData",criteria:{name:u.get("name"),searchforID:u.get("localId")},onSuccess:function(e,i){$("#immunization-add-loading").attr("aria-hidden",!0).addClass("hidden"),$("#add-edit-imm").attr("aria-hidden",!1).removeClass("grayed-out");var t=e.models[0],n=a.modifyInfoSourceCollection(t.get("infoSource"));r.infoSourceView.collection.add(n.models),r.routeAdminView.collection.add(new Backbone.Collection(t.get("routeOfAdministration")).models),r.anatomicLocationView.collection.add(new Backbone.Collection(t.get("anatomicLocation")).models),r.reactionView.collection.add(new Backbone.Collection(t.get("reaction")).models),r.seriesView.collection.add(new Backbone.Collection(t.get("series")).models);var o=a.filterOutInactiveLotNumbers(t.get("lotNumbers")),s=a.filterOutHistoricalInfoStatements(t.get("vaccineInformationStatement"));o.models.length>0&&r.lotNumObsView.collection.add(o.models),s.models&&s.models.length>0?r.infoStatementView.setFirstModel(s.models):($("#vis-padding-column").removeClass("hidden").attr("aria-hidden",!1),$("#vis-region").addClass("hidden").attr("aria-hidden",!0),$("#info-statement-block").addClass("hidden").attr("aria-hidden",!0))},onError:function(){}};ADK.ResourceService.fetchCollection(k)},onRender:function(){var e=ADK.PatientRecordService.getCurrentPatient();this.adminProvider.show(this.adminProviderView),this.orderingProvider.show(this.orderingProviderView),this.location.show(this.locationView),this.infoSource.show(this.infoSourceView),this.routeAdmin.show(this.routeAdminView),this.anatomicLocation.show(this.anatomicLocationView),this.reaction.show(this.reactionView),this.series.show(this.seriesView),this.lotNumObserved.show(this.lotNumObsView),this.infoStatement.show(this.infoStatementView);var i=e.get("birthDate");this.initDatePicker("admin-date-time",i),this.initDatePicker("vis-date-offered",i),this.initDatePicker("expiration-date",i),this.$("#admin-provider").attr("maxlength","75"),this.$("#ordering-provider").inputmask("Regex",{regex:"^[ A-Za-z,.-]*$"}),this.listenTo(this.adminProviderView,"selected_typeahead:admin-provider",function(){$("#admin-provider").attr("maxlength","75")}),this.listenTo(this.orderingProviderView,"selected_typeahead:ordering-provider",function(){$("#ordering-provider").inputmask("Regex",{regex:"^[ A-Za-z,.-]*$"})}),"immunization_add"===m&&this.setDefaults()},displayObserver:function(){a.removePreviousErrors(),$("#immunization-btn-observer").attr("data-is-active","true"),$("#immunization-btn-historical").attr("data-is-active","false"),$("#immunization-btn-observer").removeClass("toggle-off"),$("#immunization-btn-observer").addClass("toggle-on"),$("#immunization-btn-historical").removeClass("toggle-on"),$("#immunization-btn-historical").addClass("toggle-off"),$("#lot-num-historical-region").addClass("hidden").attr("aria-hidden",!0),$("#lot-num-obs-region").removeClass("hidden").attr("aria-hidden",!1),$("#info-source-region").addClass("hidden").attr("aria-hidden",!0),$("#imm-submit").attr("disabled",!0),$("#imm-data-entry").removeClass("hidden").attr("aria-hidden",!1),this.setLotFieldsEnabled(!1)},displayHistorical:function(){a.removePreviousErrors(),$("#immunization-btn-historical").attr("data-is-active","true"),$("#immunization-btn-observer").attr("data-is-active","false"),$("#immunization-btn-historical").removeClass("toggle-off"),$("#immunization-btn-historical").addClass("toggle-on"),$("#immunization-btn-observer").removeClass("toggle-on"),$("#immunization-btn-observer").addClass("toggle-off"),$("#lot-num-obs-region").addClass("hidden").attr("aria-hidden",!0),$("#lot-num-historical-region").removeClass("hidden").attr("aria-hidden",!1).find("input").val(""),$("#info-source-region").removeClass("hidden").attr("aria-hidden",!1),$("#admin-provider").val(""),$("#lot-num-obs option:first-child").attr("selected",!0),$("#imm-submit").attr("disabled",!1),$("#imm-data-entry").removeClass("hidden").attr("aria-hidden",!1),this.setLotFieldsEnabled(!0)},initDatePicker:function(e,i){var t=this.$("#"+e);ADK.utils.dateUtils.datepicker(t,{endDate:(new r).format(ADK.utils.dateUtils.defaultOptions().placeholder),startDate:new r(i,"YYYYMMDD").format(ADK.utils.dateUtils.defaultOptions().placeholder)}),this.enableDatePickerClick(e)},disableDatePickerClick:function(e){var i=this.$("#"+e);i.parent().find("#date-picker-icon").unbind("click")},enableDatePickerClick:function(e){var i=this.$("#"+e);i.attr("placeholder",ADK.utils.dateUtils.defaultOptions().placeholder),i.parent().find("#date-picker-icon").on("click",function(){i.datepicker("show")})},setLotFieldsEnabled:function(e){$(this.el).find("#expiration-date").val("").attr("disabled",!e),$(this.el).find("#manufacturer").val("").attr("disabled",!e),e?this.enableDatePickerClick("expiration-date"):this.disableDatePickerClick("expiration-date")},setDefaults:function(){var e=(new r).format(ADK.utils.dateUtils.defaultOptions().placeholder);this.$("#admin-date-time").val(e),this.$("#vis-date-offered").val(e)}}),f={handleMessage:d};return f});