define(["jquery","jquery.inputmask","bootstrap-datepicker","moment","backbone","marionette","underscore","hbs!app/applets/narrative_lab_results_grid/modal/dateRangeTemplate","hbs!app/applets/narrative_lab_results_grid/modal/dateRangeHeaderTemplate"],function(e,t,a,i,r,s,n,o,l){"use strict";var d=r.Marionette.ItemView.extend({template:l,className:"row",initialize:function(){if(this.listenTo(this.model,"change",this.render),ADK.SessionStorage.getAppletStorageModel("search","useTextSearchFilter")){var e=ADK.SessionStorage.getAppletStorageModel("search","modalOptions");this.model.set("selectedId",e.selectedId),"custom-range-apply"===e.selectedId&&(this.model.set("customFromDate",e.customFromDate),this.model.set("customToDate",e.customToDate))}}}),c=r.Marionette.LayoutView.extend({fetchOptions:{},sharedDateRange:{},hasCustomDateRangeFieldsBeenInitialized:!1,template:o,initialize:function(e){this.parentView=e.parentView,this.fullScreen=e.fullScreen},regions:{dateRangeHeaderRegion:"#dateRangeHeader"},events:{"click button":"applyDateRange","keydown button":"handleEnterOrSpaceBar","keyup input":"monitorCustomDateRange","blur input":"monitorCustomDateRange","change input":"monitorCustomDateRange"},setSharedDateRange:function(e){this.sharedDateRange=e},getSharedDateRange:function(){return this.sharedDateRange},monitorCustomDateRange:function(e){this.checkCustomRangeCondition()?this.$el.find("#custom-range-apply").removeAttr("disabled"):this.$el.find("#custom-range-apply").prop("disabled",!0)},setDatePickers:function(e,t){this.$(".input-group.date#custom-date-range1").datepicker({format:"mm/dd/yyyy"}),null!==e&&this.$(".input-group.date#custom-date-range1").datepicker("update",e),this.$(".input-group.date#custom-date-range2").datepicker({format:"mm/dd/yyyy"}),null!==t&&this.$(".input-group.date#custom-date-range2").datepicker("update",t),this.$("#filter-from-date").datepicker("remove"),this.$("#filter-to-date").datepicker("remove")},applyDateRange:function(e){var t,a,r=!0;switch(this.setDateRangeValues=function(e,r,s){t=i().subtract(e,r).format("MM/DD/YYYY"),a=i().format("MM/DD/YYYY"),this.model.set("selectedId",s)},-1!==e.currentTarget.id.indexOf("-range")&&-1===e.currentTarget.id.indexOf("custom-range-apply")&&(this.$el.find("#filter-from-date").val(""),this.$el.find("#filter-to-date").val(""),this.$el.find("#custom-range-apply").prop("disabled",!0)),e.currentTarget.id){case"custom-range-apply":var s=i(this.$el.find("#filter-from-date").val()),n=i(this.$el.find("#filter-to-date").val());n>=s?(t=s.format("MM/DD/YYYY"),a=n.format("MM/DD/YYYY")):(a=s.format("MM/DD/YYYY"),t=n.format("MM/DD/YYYY")),this.sharedDateRange.set("customFromDate",t),this.sharedDateRange.set("customToDate",a),this.model.set("selectedId","custom-range-apply");break;case"2yr-range":this.setDateRangeValues("years",2,"2yr-range");break;case"1yr-range":this.setDateRangeValues("years",1,"1yr-range");break;case"3mo-range":this.setDateRangeValues("months",3,"3mo-range");break;case"1mo-range":this.setDateRangeValues("months",1,"1mo-range");break;case"7d-range":this.setDateRangeValues("days",7,"7d-range");break;case"72hr-range":this.setDateRangeValues("days",3,"72hr-range");break;case"24hr-range":this.setDateRangeValues("days",1,"24hr-range");break;case"all-range":t=null,a=i().format("MM/DD/YYYY"),this.model.set("selectedId","all-range")}var o="date.start",l="date.end";this.fetchOptions.criteria.filter=this.fetchOptions.criteria.filterHold,void 0!==t&&null!==t?(this.fetchOptions.criteria[o]=i(t).format("YYYYMMDD"),this.fetchOptions.criteria.filter+=",gt(observed,"+this.fetchOptions.criteria[o]+")"):delete this.fetchOptions.criteria[o],void 0!==a&&null!==a?(this.fetchOptions.criteria[l]=i(a).format("YYYYMMDD"),this.fetchOptions.criteria.filter+=",lt(observed,"+this.fetchOptions.criteria[l]+")"):delete this.fetchOptions.criteria[l],this.model.set("fromDate",t),this.model.set("toDate",a),this.sharedDateRange.set("fromDate",t),this.sharedDateRange.set("toDate",a),this.$el.find("button").removeClass("active-range"),"custom-range-apply"!==e.currentTarget.id&&this.$el.find("#"+e.currentTarget.id).addClass("active-range"),r&&this.fetchDateRangeFilteredCollection()},onBeforeDestroy:function(e){this.sharedDateRange.set("fromDate",this.model.get("fromDate")),this.sharedDateRange.set("toDate",this.model.get("toDate")),this.sharedDateRange.set("customFromDate",this.model.get("customFromDate")),this.sharedDateRange.set("customToDate",this.model.get("customToDate")),this.sharedDateRange.set("selectedId",this.model.get("selectedId"))},checkCustomRangeCondition:function(){var e=!0,t=this.$el.find("#filter-from-date").val(),a=this.$el.find("#filter-to-date").val();return i(t,"MM/DD/YYYY",!0).isValid()?(this.model.set("customFromDate",t),this.sharedDateRange.set("fromDate",t)):e=!1,i(a,"MM/DD/YYYY",!0).isValid()?(this.model.set("customToDate",a),this.sharedDateRange.set("toDate",a)):e=!1,e},handleEnterOrSpaceBar:function(e){var t=e&&e.which?e.which:e.keyCode;if(13==t||32==t){var a=this.$el.find("#"+e.currentTarget.id);a.focus(),a.trigger("click")}},onRender:function(t){this.$("#filter-from-date").inputmask("m/d/y",{placeholder:"MM/DD/YYYY"}),this.$("#filter-to-date").inputmask("m/d/y",{placeholder:"MM/DD/YYYY"}),this.dateRangeHeaderRegion.show(new d({model:this.model}));var a=this.model.get("selectedId"),i=this.model.get("customFromDate"),r=this.model.get("customToDate");if(void 0===this.parentView.isFromPanel&&void 0===this.parentView.isFromNonPanel&&(a=ADK.SessionStorage.getAppletStorageModel("narrative_lab_results_grid","modal_selectedId"),i=ADK.SessionStorage.getAppletStorageModel("narrative_lab_results_grid","modal_customFromDate"),r=ADK.SessionStorage.getAppletStorageModel("narrative_lab_results_grid","modal_customToDate")),void 0!==a&&null!==a)this.setDatePickers(i,r),this.$el.find("#"+a).click();else{if(this.fullScreen)a=e("[data-appletid='narrative_lab_results_grid'] .grid-filter-daterange .active-range").attr("id")||"custom-range-apply",i=e("[data-appletid='narrative_lab_results_grid'] .grid-filter-daterange #filter-from-date-narrative_lab_results_grid").val(),r=e("[data-appletid='narrative_lab_results_grid'] .grid-filter-daterange #filter-to-date-narrative_lab_results_grid").val();else{var s=ADK.SessionStorage.getModel("globalDate");a=s.get("selectedId"),i=s.get("customFromDate"),r=s.get("customToDate")}this.model.set("selectedId",a),this.model.set("customFromDate",i),this.model.set("customToDate",r),this.setDatePickers(i,r),void 0!==a&&null!==a&&a.trim().length>0&&(a.indexOf("2yr-range")>=0?this.$el.find("#2yr-range").click():a.indexOf("1yr-range")>=0?this.$el.find("#1yr-range").click():a.indexOf("3mo-range")>=0?this.$el.find("#3mo-range").click():a.indexOf("1mo-range")>=0?this.$el.find("#1mo-range").click():a.indexOf("7d-range")>=0?this.$el.find("#7d-range").click():a.indexOf("72hr-range")>=0?this.$el.find("#72hr-range").click():a.indexOf("24hr-range")>=0?this.$el.find("#24hr-range").click():a.indexOf("all-range")>=0?this.$el.find("#all-range").click():a.indexOf("custom-range-apply")>=0&&(this.$el.find("custom-range-apply").prop("disabled")||this.$el.find("#custom-range-apply").click()))}},fetchDateRangeFilteredCollection:function(){ADK.PatientRecordService.fetchCollection(this.fetchOptions),this.parentView.leftColumn.show(ADK.Views.Loading.create())},setFetchOptions:function(e){this.fetchOptions=e}});return c});