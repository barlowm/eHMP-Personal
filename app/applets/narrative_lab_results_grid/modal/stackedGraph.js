define(["jquery","moment","backbone","marionette","underscore","app/applets/narrative_lab_results_grid/appletHelpers","hbs!app/applets/narrative_lab_results_grid/templates/tooltip"],function(t,e,i,s,o,l,r){"use strict";function n(t){return this.init(t)}function a(t){this.options=t,this.model=t.model,this.fetchOptions={},this.init(t)}var c,h,u,d,p,f,m,b=i.Model.extend({defaults:{fromDate:e().subtract("years",2).format(ADK.utils.dateUtils.defaultOptions().placeholder),toDate:e().format(ADK.utils.dateUtils.defaultOptions().placeholder)}});return n.prototype={init:function(t){var i=this;this.collection=t.collection,this.first=this.collection.first(),this.chartOptions=t.chartOptions,this.fullCollection=this.collection.fullCollection,this.chartOptions.xAxis={type:"datetime",labels:{enabled:!1},title:{text:null},tickLength:0,lineWidth:0},d=this.fullCollection.map(function(t){return t.has("low")?t.get("low"):null}),p=this.fullCollection.map(function(t){return t.has("high")?t.get("high"):null}),d=o.map(d,function(t){return null===t?t:1*t}),p=o.map(p,function(t){return null===t?t:1*t});var s=[];o.each(d,function(t,e){var i=[];i.push(d[e]),i.push(p[e]),s.push(i)}),s.reverse(),f=this.fullCollection.pluck("observed"),f=o.map(f,function(t){return l.getDateForChart(t)}),f.reverse(),m=this.fullCollection.pluck("result"),m=o.map(m,function(t){return o.isNaN(1*t)?null:1*t}),m.reverse();var r=[];r=this.fullCollection.pluck("units");var n=this.fullCollection.pluck("flagTooltip");n.reverse();var a=this.fullCollection.pluck("labelClass");a.reverse();var c=this.fullCollection.pluck("interpretationCode");c.reverse();var h=this.fullCollection.pluck("showFlagIcon");return h.reverse(),this.chartOptions.series[0].data=[],o.forEach(n,function(t,o){var l=e(f[o]);if(t){var r=a[o];r=r.match("warning")?"#f0ad4e":"#d9534f",i.chartOptions.series[0].data.push({y:m[o],dataLabels:{enabled:!0,useHTML:!1,backgroundColor:r,borderRadius:2.25,y:-6,padding:2.5,formatter:function(){return c[o]},style:{color:"#ffffff",fontSize:"9px"}},x:Date.UTC(l.year(),l.month(),l.date(),l.hour(),l.minute())})}else i.chartOptions.series[0].data.push({y:m[o],dataLabels:{enabled:!1},x:Date.UTC(l.year(),l.month(),l.date(),l.hour(),l.minute())});s[o].unshift(Date.UTC(l.year(),l.month(),l.date(),l.hour(),l.minute()))}),this.chartOptions.series[0].zIndex=1,this.chartOptions.yAxis.title.text=void 0!==this.first?this.first.get("units"):"",this.chartOptions.tooltip={valueSuffix:" "+(void 0!==this.first?this.first.get("units"):""),crosshairs:!0,shared:!0,style:{padding:4,zIndex:9999},useHTML:!0,xDateFormat:"%m/%d/%Y %H:%M"},this.chartOptions.series[1]={name:"Ref Range",data:s,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1},this.chartOptions.showAxes=!1,this.chartOptions}},a.prototype={init:function(){var i=this;(void 0===u||null===u)&&this.resetSharedModalDateRangeOptions(),this.fetchOptions.resourceTitle="patient-record-labsbytype";var s=this.model.attributes.typeName;this.fetchOptions.criteria={"type.name":this.model.attributes.typeName,"date.end":e().format("YYYYMMDD")},this.fetchOptions.viewModel={parse:l.parseLabResponse},h=s,c=this.model.attributes.displayName,this.fetchOptions.pageable=!0,this.fetchOptions.cache=!1,this.fetchOptions.collectionConfig={comparator:function(t,e){return t.get("observed")>e.get("observed")?-1:t.get("observed")<e.get("observed")?1:0}},this.collection=ADK.PatientRecordService.fetchCollection(this.fetchOptions),this.collection.on("sync",function(){i.collection.length>0?(i.model.attributes.qualifiedName=i.collection.first().get("qualifiedName"),i.model.set("resultUnits",i.collection.first().get("result")+" "+i.collection.first().get("units")),i.model.set("observed",i.collection.first().get("observed"))):i.model.set("resultUnits","--"),t.extend(!0,i,i.model.attributes),i.chart=new n({chartOptions:t.extend(!0,{},l.chartOptions),model:i.model,collection:i.collection});var e=i.createTooltipModel(i.collection);t.isEmptyObject(e)||(i.tooltip=r(e.attributes)),ADK.Messaging.getChannel("stackedGraph").trigger("readyToChart",{response:i})},this)},resetSharedModalDateRangeOptions:function(){u=new b},createTooltipModel:function(e){if(0===e.models.length)return{};for(var i={},s=0,r=0;r<e.models.length&&5>s;r++)void 0!==e.models[r].attributes.kind&&"Laboratory"===e.models[r].attributes.kind&&(s+=1,e.models[r].attributes.observedFormatted=l.getObservedFormatted(e.models[r].attributes.observed),t.isEmptyObject(i)?o.extend(i,e.models[r]):(void 0===i.attributes.limitedoldValues&&(i.attributes.limitedoldValues=[]),i.attributes.limitedoldValues.push(e.models[r])));return i}},a});