define(["jquery","jquery.inputmask","moment","backbone","marionette","underscore","highcharts","highcharts-more","app/applets/narrative_lab_results_grid/appletHelpers","hbs!app/applets/narrative_lab_results_grid/list/dateTemplate","hbs!app/applets/narrative_lab_results_grid/list/resultTemplate","hbs!app/applets/narrative_lab_results_grid/list/siteTemplate","hbs!app/applets/narrative_lab_results_grid/list/flagTemplate","hbs!app/applets/narrative_lab_results_grid/list/referenceRangeTemplate","hbs!app/applets/narrative_lab_results_grid/modal/modalTemplate","hbs!app/applets/narrative_lab_results_grid/modal/chartView","hbs!app/applets/narrative_lab_results_grid/modal/totalTestsTemplate","app/applets/narrative_lab_results_grid/modal/filterDateRangeView"],function(e,t,a,l,i,r,o,s,n,d,h,c,u,p,f,m,g,b){"use strict";var v,w,C,_,y,O,D,x,T,V,R,I={};_=l.Collection.extend({}),C=[{name:"observed",label:"Date",template:d,cell:"handlebars",sortable:!1},{name:"flag",label:"Flag",template:u,cell:"handlebars",sortable:!1},{name:"result",label:"Result",template:h,cell:"handlebars",sortable:!1},{name:"facilityMoniker",label:"Facility",template:c,cell:"handlebars",sortable:!1}],I.columns=C,I.appletConfig={name:"narrative_lab_results_modal",id:"narrative_lab_results_grid-modalView"};var L,k=l.Model.extend({defaults:{fromDate:null,toDate:null,customFromDate:null,customToDate:null,selectedId:null}}),F=new k,M=(new b({model:F}),function(){L=new k}),S=l.Marionette.ItemView.extend({template:m,id:"chart-container",initialize:function(e){var t=this;this.collection=e.collection,this.first=this.collection.first(),this.chartOptions=e.chartOptions,this.fullCollection=this.collection.fullCollection,x=this.fullCollection.map(function(e){return e.has("low")?e.get("low"):null}),T=this.fullCollection.map(function(e){return e.has("high")?e.get("high"):null}),x=r.map(x,function(e){return null===e?e:1*e}),T=r.map(T,function(e){return null===e?e:1*e});var l=[];r.each(x,function(e,t){var a=[];a.push(x[t]),a.push(T[t]),l.push(a)}),l.reverse(),O=this.fullCollection.pluck("observed"),O=r.map(O,function(e){return n.getDateForChart(e)}),O.reverse(),D=this.fullCollection.pluck("result"),D=r.map(D,function(e){return r.isNaN(1*e)?null:1*e}),D.reverse();var i=this.fullCollection.pluck("flagTooltip");i.reverse();var o=this.fullCollection.pluck("labelClass");o.reverse();var s=this.fullCollection.pluck("interpretationCode");s.reverse();var d=this.fullCollection.pluck("showFlagIcon");d.reverse(),this.chartOptions.series[0].data=[],r.forEach(i,function(e,i){var r=a(O[i]);if(e){var n=o[i];n=n.match("warning")?"#f0ad4e":"#d9534f",t.chartOptions.series[0].data.push({y:D[i],dataLabels:{enabled:!0,useHTML:!1,backgroundColor:n,borderRadius:2.25,formatter:function(){return s[i]},style:{color:"#ffffff",fontSize:"9px",padding:"1.8px 5.4px 2.7px 5.4px"}},x:Date.UTC(r.year(),r.month(),r.date(),r.hour(),r.minute())})}else t.chartOptions.series[0].data.push({y:D[i],dataLabels:{enabled:!1},x:Date.UTC(r.year(),r.month(),r.date(),r.hour(),r.minute())});l[i].unshift(Date.UTC(r.year(),r.month(),r.date(),r.hour(),r.minute()))}),this.chartOptions.series[0].zIndex=1,this.chartOptions.yAxis.title.text=this.first.get("units"),this.chartOptions.tooltip={valueSuffix:" "+this.first.get("units"),crosshairs:!0,shared:!0,style:{padding:10,zIndex:9999},useHTML:!0,xDateFormat:"%m/%d/%Y %H:%M"},this.chartOptions.series[1]={name:"Ref Range",data:l,type:"arearange",lineWidth:0,linkedTo:":previous",color:"#5CB85C",fillOpacity:.3,zIndex:0,showInLegend:!1}},onShow:function(){var t=this,a=setInterval(function(){t.$el.length&&(clearInterval(a),y=new o.Chart(t.chartOptions),e("body").on("mouseover.modalChart","#data-grid-narrative_lab_results_grid-modalView tbody tr",t.highLightChartPoint),e("body").on("mouseout.modalChart","#data-grid-narrative_lab_results_grid-modalView tbody tr",t.highLightChartPoint))},500)},onBeforeDestroy:function(){e("body").off(".modalChart")},highLightChartPoint:function(t){switch(t.type){case"mouseover":y.tooltip.shared=!1;var l=e(this),i=l.find("td:eq(2)"),r=(l.find("td:eq(0)"),1*i.text().replace(/[^\d\.-]/g,"")),o=a(n.getDateForChart(l.data("model").get("observed")));o=Date.UTC(o.year(),o.month(),o.date(),o.hour(),o.minute()),e.each(y.series[0].points,function(e,t){return t.y===r&&t.x===o?(t.onMouseOver(),!1):void 0});break;default:y.tooltip.shared=!0}}}),N=l.Marionette.ItemView.extend({template:g,tagName:"span",initialize:function(){this.listenTo(this.model,"change",this.render)}});V=l.Model.extend({defaults:{totalTests:0}});var H=new V,P=l.Marionette.LayoutView.extend({template:f,fetchOptions:{},initialize:function(t){var a=this;this.tableLoadingView=ADK.Views.Loading.create(),this.chartLoadingView=ADK.Views.Loading.create(),this.isFromPanel=t.isFromPanel,this.isFromNonPanel=t.isFromNonPanel,this.fullScreen=t.fullScreen,R=t.gridCollection,this.showNavHeader&&(this.model.attributes.navHeader=!0),this.fetchOptions.resourceTitle="patient-record-lab",this.fetchOptions.criteria={pid:this.model.attributes.pid},"DOD"===this.model.attributes.facilityCode&&a.model.attributes.codes[0].code?this.fetchOptions.criteria.filter='eq("codes[].code",'+a.model.attributes.codes[0].code+")":this.model.attributes.typeCode?this.fetchOptions.criteria.filter='eq(typeCode,"'+a.model.attributes.typeCode+'")':this.fetchOptions.criteria.filter="eq(typeName,"+a.model.attributes.typeName+")",this.fetchOptions.criteria.filterHold=this.fetchOptions.criteria.filter,this.fetchOptions.viewModel={parse:n.parseLabResponse},this.fetchOptions.pageable=!0,this.fetchOptions.cache=!1,this.fetchOptions.onSuccess=function(l,i){a.collection=l,a.$el.find(".labResultsNext, .labResultsPrev").attr("disabled",!1);var o=a.collection.fullCollection.pluck("result");o=r.map(o,function(e){return r.isNaN(1*e)}),o=r.without(o,!1),a.showNavHeader&&(a.model.attributes.navHeader=!0);var s;void 0!==a.chart&&null!==a.chart&&a.chart.reset(),0!==l.length&&o.length!==a.collection.fullCollection.length?(s=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(s),e("#lr-data-table-view").removeClass("col-md-12").addClass("col-md-5"),e("#lr-graph").removeClass("hidden"))},500),a.chart.show(new S({chartOptions:n.chartOptions,model:a.model,data:D,collection:a.collection}))):s=setInterval(function(){e("#lr-data-table-view").length&&(clearInterval(s),e("#lr-data-table-view").removeClass("col-md-5").addClass("col-md-12"),e("#lr-graph").addClass("hidden"))},500),I.collection=a.collection,I.filterDateRangeEnabled=!0,v=t.model,a.model=t.model,w=t.collection,H.set({totalTests:I.collection.fullCollection.length}),a.dataGrid=ADK.Views.DataGrid.create(I),void 0!==a.leftColumn&&null!==a.leftColumn&&(a.leftColumn.reset(),a.leftColumn.show(a.dataGrid)),I.collection=a.collection,0!==l.length?(a.paginatorView=ADK.Views.Paginator.create({collection:I.collection,windowSize:4}),e(".js-backgrid").append(a.paginatorView.render().el)):e("#data-grid-narrative_lab_results_grid-modalView").find("tbody").append(e('<tr class="empty"><td colspan="4">No Records Found</td></tr>'))}},regions:{leftColumn:".js-backgrid",chart:"#js-chart",totalTests:"#total-tests",dateRangeFilter:"#date-range-filter"},resetSharedModalDateRangeOptions:M,onRender:function(){var e;(void 0===L||null===L)&&this.resetSharedModalDateRangeOptions(),e=void 0!==L&&null!==L&&void 0!==L.get("selectedId")&&null!==L.get("selectedId")?L.clone():new k;var t=new b({model:e,parentView:this,fullScreen:this.fullScreen});t.setFetchOptions(this.fetchOptions),t.setSharedDateRange(L),this.dateRangeFilter.show(t),this.leftColumn.show(this.tableLoadingView),this.chart.show(this.chartLoadingView),this.totalTests.show(new N({model:H}))},onShow:function(){}});return{ModalView:P,resetSharedModalDateRangeOptions:M}});