define(["backbone","marionette","underscore","app/applets/narrative_lab_results_grid/appletHelpers","app/applets/narrative_lab_results_grid/appletUiHelpers","app/applets/narrative_lab_results_grid/details/detailsView","app/applets/narrative_lab_results_grid/modal/modalView","app/applets/narrative_lab_results_grid/meta/columns","hbs!app/applets/narrative_lab_results_grid/templates/tooltip","app/applets/orders/writeback/addOrders","app/applets/visit/writeback/addselectVisit"],function(e,t,a,r,i,l,s,n,o,p,c){var d={resourceTitle:"patient-record-labsbypanel",pageable:!0,cache:!1,viewModel:{parse:function(e){var t=[],a=[];e.codes&&e.codes.forEach(function(e){-1!=e.system.indexOf("loinc")&&(t.push(" "+e.code),a.push(" "+e.display))}),e.loinc=t,e.stdTestNames=a;var r=e.low,i=e.high;if(r&&i&&(e.referenceRange=r+"-"+i),e.interpretationCode){var l=e.interpretationCode.split(":").pop(),s="",n="label-danger";"HH"===l&&(l="H*",s="Critical High"),"LL"===l&&(l="L*",s="Critical Low"),"H"===l&&(s="Abnormal High",n="label-warning"),"L"===l&&(s="Abnormal Low",n="label-warning"),e.interpretationCode=l,e.flagTooltip=s,e.labelClass=n}if(e.categoryCode){var o=e.categoryCode.slice(e.categoryCode.lastIndexOf(":")+1);switch(o){case"EM":case"MI":case"SP":case"CY":case"AP":e.result="View Report",e.typeName||(e.typeName=e.categoryName),e.pathology=!0}}return e}}},u=e.Model.extend({parse:d.viewModel.parse});e.Model.extend({defaults:{type:"panel"}});return ADK.AppletViews.GridView.extend({initialize:function(t){this._super=ADK.AppletViews.GridView.prototype,this.summaryColumns=[n.dateCol(),n.testCol(),n.flagCol(),n.resultAndUnitCol()],this.fullScreenColumns=[n.dateCol(),n.testCol(),n.flagCol(),n.resultNoUnitCol(),n.unitCol(),n.refCol(),n.facilityCol()];var r={filterFields:["observed","typeName","flag","result","specimen","groupName","isPanel","units","referenceRange","facilityMoniker","labs.models",this.getLoincValues],formattedFilterFields:{observed:function(e,t){var a=e.get(t);return a=a.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/,"$2/$3/$1 $4:$5")}},DetailsView:l,filterDateRangeField:{name:"observed",label:"Date",format:"YYYYMMDD"},onClickAdd:function(t){t.preventDefault();var a=(ADK.utils.appletUtils.getAppletView("orders","writeback"),new e.Model),r=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),i={size:"large",title:"Order a Lab Test",showProgress:!1,keyboard:!0,steps:[]},l=ADK.PatientRecordService.getCurrentPatient().get("visit");l||i.steps.push({view:c,viewModel:r}),i.steps.push({view:p,viewModel:a});var s=new ADK.UI.Workflow(i);s.show()},onClickRow:function(e,a,l){if(a.preventDefault(),"expanded"===t.appletConfig.viewType?e.set("isFullscreen",!0):e.set("isFullscreen",!1),e.get("isPanel")){if($(a.currentTarget).data("isOpen")){var s=$(a.currentTarget).data("isOpen");s=!s,$(a.currentTarget).data("isOpen",s)}else $(a.currentTarget).data("isOpen",!0);var n=$(a.currentTarget).find(".js-has-panel i");n.length&&(n.hasClass("fa-chevron-up")?(n.removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(a.currentTarget).data("isOpen",!0)):(n.removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(a.currentTarget).data("isOpen",!1))),l.expandRow(e,a)}else i.getDetailView(e,a.currentTarget,r.collection,!0,i.showModal,i.showErrorModal)},tblRowSelector:"#data-grid-narrative_lab_results_grid tbody tr"};"expanded"===this.columnsViewType?r.columns=this.fullScreenColumns:"summary"===this.columnsViewType?r.columns=this.summaryColumns:(r.summaryColumns=this.summaryColumns,r.fullScreenColumns=this.fullScreenColumns);var s=this;d.onSuccess=function(t){var i=t.fullCollection||t;i.each(function(t){t.set("infobuttonContext","LABRREV");var r=a.values(t.attributes);if("object"==typeof r[0][0]){var i=r[0],l=i[0],s=a.keys(t.attributes)[0],n=s,o=(n.replace(/\s/g,""),""),p="",c="";a.each(i,function(e,t){e=new u(u.prototype.parse(e)),"H*"==e.attributes.interpretationCode?(o="H*",p="Critical High",c="label-danger"):"L*"==e.attributes.interpretationCode?("H"==o||"L"==o||""===o)&&(o="L*",p="Critical Low",c="label-danger"):"H"==e.attributes.interpretationCode?("L"==o||""===o)&&(o="H",p="Abnormal High",c="label-warning"):"L"==e.attributes.interpretationCode&&""===o&&(o="L",p="Abnormal Low",c="label-warning"),i[t]=e});var d=s.replace(/\s/g,"")+"_"+l.groupUid.replace(/\s/g,"");d=d.replace("#",""),t.set({labs:new e.Collection(i),observed:l.observed,isPanel:"Panel",typeName:n,panelGroupName:s,facilityCode:l.facilityCode,facilityMoniker:l.facilityMoniker,interpretationCode:o,flagTooltip:p,labelClass:c,uid:d,type:"panel"})}});var l=a.sortBy(i.models,function(e){return e.attributes.observed}).reverse();i.reset(l),"expanded"===r.appletConfig.viewType&&r.collection.setPageSize(i.length)};var o='ne(categoryCode , "urn:va:lab-category:CH")';d.criteria={filter:this.buildJdsDateFilter("observed")+","+o},this.listenTo(ADK.Messaging,"globalDate:selected",function(e){s.dateRangeRefresh("observed",{customFilter:o})}),this.gridCollection=ADK.PatientRecordService.fetchCollection(d),r.collection=this.gridCollection,this.appletOptions=r,this._super.initialize.apply(this,arguments);var g=ADK.Messaging.getChannel("narrative_lab_results");g.reply("gridCollection",function(){return s.gridCollection})},getLoincValues:function(e){if(void 0===e.codes)return"";var t=a.filter(e.codes,function(e){return"http://loinc.org"===e.system});return a.pluck(t,"code").join(" ")},onBeforeDestroy:function(){var e=ADK.Messaging.getChannel("narrative_lab_results");e.stopReplying("gridCollection"),d.onSuccess=null}})});