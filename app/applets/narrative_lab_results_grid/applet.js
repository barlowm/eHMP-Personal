define(["backbone","marionette","underscore","app/applets/narrative_lab_results_grid/appletHelpers","app/applets/narrative_lab_results_grid/appletUiHelpers","app/applets/narrative_lab_results_grid/gridView","app/applets/narrative_lab_results_grid/details/detailsView","app/applets/narrative_lab_results_grid/modal/modalView","hbs!app/applets/narrative_lab_results_grid/list/dateTemplate","hbs!app/applets/narrative_lab_results_grid/list/labTestCoverSheetTemplate","hbs!app/applets/narrative_lab_results_grid/list/labTestSinglePageTemplate","hbs!app/applets/narrative_lab_results_grid/list/resultTemplate","hbs!app/applets/narrative_lab_results_grid/list/siteTemplate","hbs!app/applets/narrative_lab_results_grid/list/flagTemplate","hbs!app/applets/narrative_lab_results_grid/list/referenceRangeTemplate","hbs!app/applets/narrative_lab_results_grid/templates/tooltip","app/applets/narrative_lab_results_grid/modal/stackedGraph","app/applets/orders/writeback/addOrders","app/applets/visit/writeback/addselectVisit"],function(e,t,a,i,r,s,l,o,d,n,p,u,c,m,b,g,v,h,f){var y,w={resourceTitle:"patient-record-lab",pageable:!0,cache:!1,viewModel:{parse:function(e){var t=[],a=[];e.codes&&e.codes.forEach(function(e){-1!=e.system.indexOf("loinc")&&(t.push(" "+e.code),a.push(" "+e.display))}),e.loinc=t,e.stdTestNames=a;var i=e.low,r=e.high;if(i&&r&&(e.referenceRange=i+"-"+r),e.interpretationCode){var s=e.interpretationCode.split(":").pop(),l="",o="label-danger";"HH"===s&&(s="H*",l="Critical High"),"LL"===s&&(s="L*",l="Critical Low"),"H"===s&&(l="Abnormal High",o="label-warning"),"L"===s&&(l="Abnormal Low",o="label-warning"),e.interpretationCode=s,e.flagTooltip=l,e.labelClass=o}if(e.categoryCode){var d=e.categoryCode.slice(e.categoryCode.lastIndexOf(":")+1);switch(d){case"EM":case"MI":case"SP":case"CY":case"AP":e.result="View Report",e.typeName||(e.typeName=e.categoryName),e.pathology=!0}}return e}}},_={gistModel:[{id:"shortName",field:"shortName"},{id:"displayName",field:"normalizedName"},{id:"result",field:"result"},{id:"previousInterpretationCode",field:"previousInterpretationCode"},{id:"previousResult",field:"previousResult"},{id:"units",field:"units"},{id:"timeSince",field:"timeSince"},{id:"observationType",field:"observationType"},{id:"tooltip",field:"tooltip"}],filterFields:["shortName","typeName","normalizedName","timeSince","result","units"],gistHeaders:{header1:{title:"Lab Test",sortable:!0,sortType:"alphabetical",key:"shortName",hoverTip:"labresults_description"},header2:{title:"Result",sortable:!0,sortType:"numeric",key:"result",hoverTip:"labresults_results"},header3:{title:"",sortable:!1},header4:{title:"Last",sortable:!0,sortType:"date",key:"observed",hoverTip:"labresults_last"}},defaultView:"observation",enableHeader:"true",graphOptions:{height:"19",width:"90",id:"",hasCriticalInterpretation:!0}},C=e.Model.extend({parse:w.viewModel.parse}),T=(ADK.Applets.BaseGridApplet.extend({initialize:function(t){this._super=ADK.Applets.BaseGridApplet.prototype;var i={filterFields:_.filterFields,formattedFilterFields:{observed:function(e,t){var a=e.get(t);return a=a.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/,"$2/$3/$1 $4:$5")}},gistView:!0,appletConfiguration:_,DetailsView:l,onClickRow:function(e,t,a){if(t.preventDefault(),e.get("isPanel")){if($(t.currentTarget).data("isOpen")){var s=$(t.currentTarget).data("isOpen");s=!s,$(t.currentTarget).data("isOpen",s)}else $(t.currentTarget).data("isOpen",!0);var l=$(t.currentTarget).find(".js-has-panel i");l.length&&(l.hasClass("fa-chevron-up")?(l.removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(t.currentTarget).data("isOpen",!0)):(l.removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(t.currentTarget).data("isOpen",!1))),a.expandRow(e,t)}else r.getDetailView(e,t.currentTarget,i.collection,!0,r.showModal,r.showErrorModal)},onClickAdd:function(t){t.preventDefault();var a=(ADK.utils.appletUtils.getAppletView("orders","writeback"),new e.Model),i=new e.Model({encounterProvider:"Not Specified",encounterLocation:"Not Specified",visit:{}}),r={size:"large",title:"Order a Lab Test",showProgress:!1,keyboard:!0,steps:[]},s=ADK.PatientRecordService.getCurrentPatient().get("visit");s||r.steps.push({view:f,viewModel:i}),r.steps.push({view:h,viewModel:a});var l=new ADK.UI.Workflow(r);l.show()},filterDateRangeEnabled:!0,filterDateRangeField:{name:"observed",label:"Date",format:"YYYYMMDD"}},s=this;this.listenTo(ADK.Messaging,"globalDate:selected",function(e){var a=ADK.SessionStorage.getModel("globalDate").get("selectedId");"all-range-global"!==a?s.dataGridOptions.collection.fetchOptions.criteria.filter=s.buildJdsDateFilter("observed",t):delete s.dataGridOptions.collection.fetchOptions.criteria.filter,s.loading(),s.createDataGridView(),ADK.ResourceService.fetchCollection(s.dataGridOptions.collection.fetchOptions,s.dataGridOptions.collection)}),w.onSuccess=function(r){var l=r.fullCollection||r;l.each(function(t){var i=a.values(t.attributes);if("object"==typeof i[0][0]&&!i[0][0].code){var r=i[0],s=r[0],l=a.keys(t.attributes)[0],o=l,d=(o.replace(/\s/g,""),""),n="",p="";a.each(r,function(e,t){e=new C(C.prototype.parse(e)),"H*"==e.attributes.interpretationCode?(d="H*",n="Critical High",p="label-danger"):"L*"==e.attributes.interpretationCode?("H"==d||"L"==d||""===d)&&(d="L*",n="Critical Low",p="label-danger"):"H"==e.attributes.interpretationCode?("L"==d||""===d)&&(d="H",n="Abnormal High",p="label-warning"):"L"==e.attributes.interpretationCode&&""===d&&(d="L",n="Abnormal Low",p="label-warning"),r[t]=e});var u=l.replace(/\s/g,"")+"_"+s.groupUid.replace(/\s/g,"");u=u.replace("#",""),t.set({labs:new e.Collection(r),observed:s.observed,isPanel:"Panel",typeName:o,panelGroupName:l,facilityCode:s.facilityCode,facilityMoniker:s.facilityMoniker,interpretationCode:d,flagTooltip:n,labelClass:p,uid:u,type:"panel"})}});var o=a.sortBy(l.models,function(e){return-e.attributes.observed});if(l.set(o),void 0!==t.appletConfig&&void 0!==t.appletConfig.viewType&&"gist"===t.appletConfig.viewType){var d=s.modifyModel(l);d=s.addTooltips(d,4),l.set(d.models)}i.collection.setPageSize(l.length)},w.criteria={filter:this.buildJdsDateFilter("observed")+',eq(categoryCode , "urn:va:lab-category:CH")'},i.collection=ADK.PatientRecordService.fetchCollection(w),this.listenTo(i.collection,"sync",function(){s.onSync()}),this.dataGridOptions=i,s.isFullscreen||i.gistView===!0&&(this.dataGridOptions.SummaryView=ADK.Views.LabresultsGist.getView(),this.dataGridOptions.SummaryViewOptions={gistHeaders:_.gistHeaders,enableTileSorting:!0}),this._super.initialize.apply(this,arguments),ADK.Messaging.getChannel("narrative_lab_results_grid").on("addItem",function(e){var t=ADK.Messaging.getChannel("addALabOrdersRequestChannel");t.trigger("addLabOrdersModal",event,y)}),ADK.Applets.BaseGridApplet.prototype.initialize.apply(this,arguments);var o=ADK.Messaging.getChannel("narrative_lab_results");o.reply("gridCollection",function(){return s.gridCollection})},onDestroy:function(){ADK.Messaging.getChannel("narrative_lab_results_grid").off("addItem")},onRender:function(){this._super.onRender.apply(this,arguments)},addTooltips:function(e,t){for(var a=0;a<e.models.length;a++){var i=e.models[a].attributes;i.oldValues&&(i.limitedoldValues=i.oldValues.splice(0,t-1),i.oldValues.length-i.limitedoldValues.length>0&&(i.moreresultsCount=i.oldValues.length-i.limitedoldValues.length)),e.models[a].attributes.tooltip=g(i)}return e},modifyModel:function(e){var t={},r=this.dataGridOptions.appletId;a.extend(t,e),t.models=[];for(var s=0;s<e.models.length;s++)if(void 0!==e.models[s].attributes.kind&&"Laboratory"===e.models[s].attributes.kind)if(e.models[s].attributes.applet_id=r,e.models[s].attributes.timeSince=i.setTimeSince(e.models[s].attributes.observed),e.models[s].attributes.observedFormatted=i.getObservedFormatted(e.models[s].attributes.observed),e.models[s].attributes.numericTime=i.getNumericTime(e.models[s].attributes.timeSince),e.models[s].attributes.observationType="labs",e.models[s].attributes.shortName=e.models[s].attributes.typeName,e.models[s].attributes.typeName.indexOf(",")>=0&&(e.models[s].attributes.shortName=e.models[s].attributes.typeName.substring(0,e.models[s].attributes.typeName.indexOf(","))),e.models[s].attributes.graphOptions=_.graphOptions,e.models[s].attributes.normalizedName=e.models[s].attributes.typeName.replace(/\W/g,"_"),0===t.models.length)t.models.push(e.models[s]);else{for(var l=!1,o=0;o<t.models.length;o++)("DOD"===t.models[o].attributes.facilityCode&&"DOD"===e.models[s].facilityCode&&t.models[o].attributes.codes[0].code===e.models[s].attributes.codes[0].code||t.models[o].attributes.typeCode&&t.models[o].attributes.typeCode===e.models[s].attributes.typeCode||t.models[o].attributes.typeName===e.models[s].attributes.typeName)&&(void 0===t.models[o].attributes.oldValues&&(t.models[o].attributes.oldValues=[],t.models[o].attributes.previousResult=e.models[s].attributes.result,t.models[o].attributes.previousInterpretationCode=e.models[s].attributes.interpretationCode),t.models[o].attributes.oldValues.push(e.models[s]),l=!0);l||t.models.push(e.models[s])}return t.length=t.models.length,t}}),{id:"narrative_lab_results_grid",viewTypes:[{type:"summary",view:s.extend({columnsViewType:"summary"}),chromeEnabled:!0},{type:"expanded",view:s.extend({columnsViewType:"expanded"}),chromeEnabled:!0},{type:"writeback",view:h,chromeEnabled:!1}],defaultViewType:"summary"}),D=ADK.Messaging.getChannel(T.id);return D.on("detailView",function(e){var t=new o.ModalView({model:e.model,navHeader:!1}),a={fullScreen:self.isFullscreen,size:"large",title:e.model.get("typeName")},i=new ADK.UI.Modal({view:t,options:a});i.show()}),D.reply("chartInfo",function(t){var a=t.typeName,i=e.Model.extend({}),r=new i({typeName:t.typeName,displayName:a,requesterInstanceId:t.instanceId,graphType:t.graphType,applet_id:T.id}),s=$.Deferred(),l=new v({model:r,target:null});return s.resolve({view:l}),s.promise()}),T});