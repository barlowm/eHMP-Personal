$(function(){"use strict";function e(t){var n=t||Q.defer(),a=i.mainModel.get("rdkPath");return a?(n.resolve(a),n.promise):($.ajax({url:"/app.json",dataType:"json",mimeType:"application/json; charset=utf-8"}).done(function(t){var a=t.resourceDirectoryPathFetch;a=a.match(/(.*)resourcedirectory$/)[1]||"",/resource/.test(a)||(a+="resource/"),a+="docs/",i.mainModel.set("rdkPath",a),e(n)}).fail(function(){return n.reject()}),n.promise)}var t;window.markdownit?(t=window.markdownit({html:!0,langPrefix:"language-",highlight:function(e,t){"HTML"===t&&(t="markup");try{var i=Prism.languages[t.toLowerCase()];return i?Prism.highlight(e,i):""}catch(n){}return""}}).use(window.markdownitContainer,"page-description").use(window.markdownitContainer,"callout").use(window.markdownitContainer,"side-note").use(window.markdownitContainer,"definition").use(window.markdownitContainer,"showcode",{validate:function(e){return e.trim().match(/^showcode\s+(.*)$/)},render:function(e,t){var i=e[t].info.trim().match(/^showcode\s+(.*)$/);return 1===e[t].nesting?"<details><summary>"+i[1]+"</summary>\n":"</details>\n"}}),console.log("Rendering with markdown-it")):window.marked?console.log("Rendering with marked"):window.markdown&&console.log("Rendering with markdown-js");var i={};i.sectionDelimiter="#",i.MarkdownModel=Backbone.Model.extend({sync:function(e,t,i){"read"===e&&Backbone.sync(e,t,i)},url:function(e){return(e||this.get("page"))+".md"},defaults:{page:"",html:"<h1>No markdown loaded</h1>",text:"# No markdown loaded",rewriteRules:[]},initialize:function(e){e=e||{},this.set("rewriteRules",e.rewriteRules||this.defaults.rewriteRules),this.set("page",e.page||this.defaults.page),this.on("error",this.handleFailedFetch)},handleFailedFetch:function(){this.set({html:"<h1>Error loading page</h1>",text:"# Error loading page"}),this.trigger("sync")},fetch:function(e){if(""===this.get("page"))return this.set("html",this.defaults.html),this.set("text",this.defaults.text),void this.trigger("sync");this.set({html:'<h1>Loading <div style="display: inline-block; vertical-align: middle;"><div class="sk-spinner sk-spinner-cube-grid"><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div></div></div></h1>',text:"# Loading"}),this.trigger("sync");var t=this,i=this.get("rewriteRules"),n=t.get("page");Q.any(_.map(i,function(e){var t=Q.defer();if(!e.find||!e.rewriter)return t.reject(),t.promise;if(!e.find.test(n))return t.reject(),t.promise;if(!_.isFunction(e.rewriter)){var i=n.replace(e.find,e.rewriter);return t.resolve(i),t.promise}return e.rewriter(n,t),t.promise})).then(function(e){return e},function(){return n}).then(function(i){e=_.extend(e||{},{dataType:"text",mimeType:"text/plain; charset=utf-8",cache:"false",url:t.url(i)}),t.constructor.__super__.fetch.call(t,e)})},parse:function(e){return e={html:this.processCompiledMarkdown(window.markdownit&&t.render(e)||window.marked&&window.marked(e)||window.markdown&&window.markdown.toHTML(e)),text:e}},processCompiledMarkdown:function(e){function t(e){if(e.is("h1,h2,h3,h4,h5,h6")&&!e.attr("id")){e.attr("id",e.text().trim().replace(/[^a-zA-Z0-9]/g,"-"));for(var t=1;_.contains(l,e.attr("id"));t++)e.attr("id",e.attr("id")+"-"+t);l.push(e.attr("id"))}}function n(e){e.attr("id")&&e.attr("id","/"+o.get("page")+s+e.attr("id"))}function a(e){var t=/^#.+/.test(e.attr("href"));t&&e.attr("href","#/"+o.get("page")+s+e.attr("href").slice(1))}function r(e){var t=e.prop("href")||e.prop("src")||"",n=e.attr("href")||e.attr("src")||"",a=(window.location.pathname.match(/(.*)\/[^\/]*$/)||[])[1]||"",r=window.location.protocol+"//"+window.location.host+a,d=-1!==t.indexOf(r),l=(o.get("page").match(/(.*)\/[^\/]*$/)||[])[1];if(e.is("a")&&d&&n.match(/.+\.md/)){var c=e.attr("href").match(new RegExp("^(.+)\\.md(?:(#|"+s+")(.*))?")),h=c[1],m=c[2],u=c[3];m&&u&&(h+=s+u),e.attr("href",_.compact(["#",l,h]).join("/"))}if(e.is("img")&&d){var f=i.markdownModel.get("page"),g=f.match(/^[^\/]*/)[0];if("rdk"===g){var v=i.mainModel.get("rdkPath");e.attr("src",v+n)}else e.attr("src",_.compact([l,n]).join("/"))}}var o=this,d=$("<div />").append($(e)),s=i.sectionDelimiter,l=[];d.find("*").each(function(){var e=$(this);t(e),n(e),a(e),r(e)});var c=d.html();return c}}),i.MarkdownView=Backbone.View.extend({initialize:function(){i.markdownModel.on("sync",this.render,this)},render:function(){this.$el.html(this.model.get("html")),this.$el.find("table").addClass("table table-striped table-bordered"),i.markdownModel.trigger("markdownViewRendered",this.$el),this.scrollIntoView()},scrollIntoView:function(){var e=i.id,t=i.loadedDelimiter;if(t===i.sectionDelimiter&&""===e)window.scrollTo(0,0);else if(e.length>0){var n=document.getElementById(i.fragment);n&&n.scrollIntoView(!0)}}}),i.WaypointView=Backbone.View.extend({headingSelector:_.map(["h1","h2","h3"],function(e){var t=["blockquote",".side-note",".callout",".page-description",".definition"],i=t.map(function(e){return e+" *"}).join(","),n=e+"[id]:not("+i+")";return n}).join(","),initialize:function(){_.bindAll(this,"makeToc"),i.markdownModel.on("markdownViewRendered",this.refreshWaypoints,this)},render:function(){var e=this,t=e.makeToc(e.model.get("html")),n=$('<a onclick="window.scrollTo(0, 0)"/>').attr("href","#/"+i.markdownModel.get("page")+"#").addClass("back-to-top").html("Back to top &uarr;"),a=$("<div />");a.append(t),$(t).find("li").length&&a.append(n),this.$el.html(a);var r=this.$("li");r.addClass("active activechild");var o=r.outerWidth(!0)+5,d=this.$("a.nav-page-title:first").width(),s=Math.max(o,d);r.removeClass("active activechild"),this.$el.find("ul").outerWidth(s),e.$el.affix({offset:{top:0,bottom:function(){var e=235;return-$(document).height()+$("body").height()+e}}}),this.$el.css("position","fixed")},refreshWaypoints:function(e){this.render(),this.highlightVisibleHeadings(e)},highlightSingleHeading:function(e){var t=this,i=e.find(this.headingSelector);i.each(function(e,i){var n=$(i),a=t.getTocElemFromContentsElem(n);n.waypoint(function(e){t.$el.find(".active").removeClass("active");var i;"up"===e&&(i=a.prev().find("li:last-child").addBack(),0===i.length&&(i=a.parentsUntil(t.$el,"li").first())),"down"===e&&(i=a),i.addClass("active"),i.parentsUntil(t.$el,"li").addClass("active")},{offset:"20"})})},highlightVisibleHeadings:function(e){var t=this,i=e.find(this.headingSelector);i.each(function(e,n){var a=i[e+1],r=$(n),o=t.getTocElemFromContentsElem(r),d=o.parentsUntil(t.$el,"li"),s=o.siblings();if(r.waypoint(function(e){"down"===e&&(o.addClass("active"),d.addClass("activechild"))},{offset:0}),r.waypoint(function(e){"up"===e&&(o.removeClass("active"),o.removeClass("activechild")),"down"===e&&(o.addClass("active"),d.addClass("activechild"))},{offset:"bottom-in-view"}),a){var l=$(a);l.waypoint(function(e){"up"===e&&(o.addClass("active"),d.addClass("activechild")),"down"===e&&(o.removeClass("active"),s.hasClass("active")||d.removeClass("activechild"))},{offset:1})}else r.waypoint(function(e){"up"===e&&o.removeClass("active")},{offset:"bottom-in-view"})})},getTocElemFromContentsElem:function(e){if(!e.attr("id"))return $(null);var t="#"+e.attr("id").replace(/[!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~]/g,"\\$&"),i=this.$('a[href="'+t+'"]').parents("li").first();return i},makeToc:function(e){var t=$('<ul class="nav" data-heading-ref="H1">'),n=this.headingSelector,a=$("<div />").append(e);for(a.find(n).each(function(e,i){var n=$(i),a=t.children().last(),r=$("<a>").attr("href","#"+n.attr("id")).text(n.text());if(n.prop("tagName")>t.attr("data-heading-ref")){var o=$('<ul class="nav">').attr("data-heading-ref",n.prop("tagName"));a.length?(a.append(o),t=o):t.attr("data-heading-ref",n.prop("tagName"))}for(;n.prop("tagName")<t.attr("data-heading-ref");)t.parent().parent().length>0?t=t.parent().parent():t.attr("data-heading-ref",n.prop("tagName"));t.append($("<li>").append(r))});t.parent().length>0;)t=t.parent();var r=a.find(".page-description h1:first").first();if(r.length){var o=$('<a onclick="window.scrollTo(0, 0)"/>').attr("href","#/"+i.markdownModel.get("page")+"#").addClass("nav-page-title").text(r.text().trim());t.prepend(o)}return $("<div />").append(t).html()}}),i.HeaderModel=Backbone.Model.extend({defaults:{currentConfig:{},rdk:{},adk:{},sdk:{}},initialize:function(e){_.isObject(e)&&this.set(e)},updateNavigationConfig:function n(){var t=this,a=i.markdownModel.get("page"),r=a.match(/^[^\/]*/)[0];return _.isEmpty(this.get(r))?void Q.fcall(function(){return"adk"===r?"./adk/":"rdk"===r?e():"./"}).then(t.getNavConfig).then(function(e){return t.set(r,e),n.bind(t)()}):void this.set("currentConfig",this.get(r))},getNavConfig:function(e){var t=Q.defer();return $.ajax({url:e+"navigation-config.json",dataType:"json",mimeType:"application/json; charset=utf-8"}).done(function(e){t.resolve(e)}).fail(function(){return t.reject()}),t.promise}}),i.HeaderView=Backbone.View.extend({el:$("#header"),initialize:function(){this.model=new i.HeaderModel,i.markdownModel.on("change:page",this.updateHeader,this),this.model.on("change:currentConfig",this.render,this)},render:function(){var e=i.markdownModel.get("page").match(/^[^\/]*/)[0];$("body").removeClass("adk rdk sdk").addClass(e);var t="";t+=this.model.get("currentConfig").showHomeButton?'<a alt="back to SDK Documentation" href="./" class="home-button"><i class="fa fa-home"></i></a>':"",t+='<div class="navbar-header"><a id="headline" href="'+this.model.get("currentConfig").titleLink+'" class="navbar-brand">'+this.model.get("currentConfig").title+'</a><div class="navbar-collapse bs-navbar-collapse collapse" id="main-navbar"><ul class="nav navbar-nav">',_.each(this.model.get("currentConfig").left_nav_items,function(e){t+='<li><a href="'+e.url+'">'+e.name+"</a></li>"}),t+='</ul><ul class="nav navbar-nav navbar-right">',_.each(this.model.get("currentConfig").right_nav_items,function(e){t+='<li><a href="'+e.url+'">'+e.name+"</a></li>"}),t+="</ul></div></div>",this.$el.html(t),this.renderFooterView()},updateHeader:function(){this.model.updateNavigationConfig()},renderFooterView:function(){var e="";_.each(this.model.get("currentConfig").footer_nav_items,function(t){e+='<li><a href="'+t.url+'">'+t.name+"</a></li>"}),$("footer .nav").html(e)}}),i.MainModel=Backbone.Model.extend({defaults:{indexPage:"index"},initialize:function(e){_.isObject(e)&&this.set(e)}}),i.mainModel=new i.MainModel,i.MainView=Backbone.View.extend({el:$("#container"),initialize:function(){this.markdownView=new i.MarkdownView({model:i.markdownModel}),this.waypointView=new i.WaypointView({model:i.markdownModel}),i.markdownModel.on("change:page",this.render,this)},render:function(){var e=i.mainModel.get("indexPage")===i.markdownModel.get("page");return e?(this.$el.html('<div class="bump-header bump-footer container"><div class="row"><div id="markdown" class="col-md-12"></div></div></div>'),void(this.markdownView.$el=this.$("#markdown"))):(this.$el.html('<div id="mainContent" class="container"><div class="row"><div id="markdown" class="col-md-8"></div><div class="col-md-4"><div id="toc"></div></div><div class="row" id="bottom-row"><img class="img-responsive center-block hidden very-special" src="dist/image/manatee_watches_you_scroll.png" style="position: fixed;top: 0;right: '+(document.body.clientWidth-350)+'px;" /><div class="specialButton" onClick="$(\'.very-special\').toggleClass(\'hidden\')" style="position:fixed;bottom:30px;right:0;background-color:transparent;height:20px;width:20px;"></div></div></div></div><div id="bottomImage"></div>'),this.markdownView.$el=this.$("#markdown"),void(this.waypointView.$el=this.$("#toc")))}}),i.markdownModel=new i.MarkdownModel({rewriteRules:[{find:/^rdk\/(.*)/,rewriter:function(t,i){var n=this;e().then(function(e){var a=e+t.replace(n.find,"$1");return i.resolve(a)}).fail(function(){return i.reject()})}}]}),i.Router=Backbone.Router.extend({initialize:function(){i.mainModel.set("indexPage","sdk"),this.lastFile="",this.header=new i.HeaderView,this.container=new i.MainView},routes:{"":"index","/vx-api":"vxApi","*markdownFile":"markdownFile"},index:function(){this.navigate("/"+i.mainModel.get("indexPage"),{replace:!0,trigger:!0})},vxApi:function(){e().then(function(e){var t=e+"vx-api";window.location.href=t})},markdownFile:function(e){var t=e.match(new RegExp("/?(.+?)("+i.sectionDelimiter+"|$)(.*$)")),n=t[1],a=t[2],r=t[3];i.id=r,i.loadedDelimiter=a,i.fragment=e,this.lastFile!==n&&(this.lastFile=n,i.markdownModel.set("page",n),i.markdownModel.fetch())}}),_.extend(Backbone.History.prototype,{getFragment:function(e,t){var i=/^#|\s+$/g;if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=decodeURI(this.location.pathname+this.location.search);var n=/\/$/,a=this.root.replace(n,"");e.indexOf(a)||(e=e.slice(a.length))}else e=this.getHash();return e.replace(i,"")}}),i.router=new i.Router,Backbone.history.start(),window.ReadmeApp=i});